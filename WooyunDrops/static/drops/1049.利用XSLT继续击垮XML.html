<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">利用XSLT继续击垮XML</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">小飞</a> <span class="bull">·</span> <time title="2016/02/23 11:26" ui-time="" datetime="2016/02/23 11:26" class="published ng-binding ng-isolate-scope">2016/02/23 11:26</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 介绍</h1><hr><h3>XSL</h3><p>首先我们要说的是，这个XSLT应该这么断句：XSL-T。XSL指的是EXtensible Stylesheet Language，中文被很直白地翻译成扩展样式表语言。这种语言和xml有莫大关系：XSL之于XML相当于CSS之于HTML。HTML的每个元素都是预定义好的，比如<code>&lt;table&gt;</code>用来定义表格，浏览器也知道怎么识别这个标签，此时CSS就能轻松地告诉浏览器该怎么显示这个表格，然而由于XML里面的任何标签都可以由程序员自己定义，所以<strong>需要一种XSL语言来描述如何显示xml文档。</strong> 这是一篇web安全文章，所以我们还是讨论web相关的xsl安全，而支持在web上调用的是xslt v1，所以我们只讨论version1发生的故事。</p><h3>XSLT</h3><p>XSL包括三个部分：XSLT,XPath，XSL-FO。在安全领域，Xpath已经有前人的研究 (<a href="https://www.owasp.org/index.php/XPATH_Injection">xpath injection</a>)，而其他两个几乎无人问津。去年black hat黑客大会，终于有安全组织(IOActive)共享出自己的研究成果<a href="https://www.blackhat.com/docs/us-15/materials/us-15-Arnaboldi-Abusing-XSLT-For-Practical-Attacks-wp.pdf">Abusing XSLT</a>。 XSLT顾名思义，就是用来将XML转换成XHTML或者是其他XML文档。</p><p>当用XML来生成其他文档时(e.g. xhtml)，XSL可以作为XML的引用。同时，XSL能够内嵌到XML中发挥作用。</p><p>既然谈XSLT安全，就得考虑他们的应用场景，这篇文章我们将从客户端和服务端两个方面分析XSLT实现的脆弱性。为了简化讨论，我们讨论这几个vendor的安全问题：</p><ul><li>libxslt:libxslt为后端的Python,PHP,PERL,RUBY及前端的safari,opera,chrome提供XSL解析。</li><li>Transformiix：讨论它是因为它被firefox调用，用来处理xsl</li><li>Microsoft：不用解释也能明白，微软自家的IE,肯定用的是自己的解析库了。</li></ul><h1>0x01 攻击模型</h1><hr><h3>客户/服务端：数字表示及运算风险</h3><p>XSL对数学有自己的一套"独特"的理解.我们先讨论下它对大整数的处理：</p><h4>Large Integers</h4><p>比如</p><p><img alt="p1" img-src="221c822f18382bcb3618a86d868560e89f114395.jpg"></p><p>以及它的样式</p><p><img alt="p2" img-src="d259fee4888dece9cf603c7efceff5100ecf0c66.jpg"></p><p>在诸如Xsltproc, Php, Perl, Ruby, Python, Safari, Chrome和Opera的libxslt系的处理软件上，都会将上面这段xml解释成这样(chrome)：</p><p><img alt="p3" img-src="bb4dac1a90841649e0341f710ffee9866ee0bf14.jpg"></p><p>问题很明显了。</p><p>IOActive给出了他们研究调查的结果</p><p><img alt="p4" img-src="c93e24918f595253f70079f72740b7135f849618.jpg"></p><h3>随机数</h3><p>同样的，xsl的某些vendor对于随机数的生成也是相当写意的。而这个粗糙的vendor竟然还是应用最广泛的libxslt，由于这个库在生成随机数的时候根本就没有IV，所以每一次生成的随机数，都是根本不变的。</p><p><img alt="p5" img-src="df40c72f07412e6bbfc3bfb0cddca4cc72765af1.jpg"></p><p>让我们将这个和PRG一起hi起来。。。</p><h3>客户端：Safari SOP绕过</h3><p>Safari的同源策略同样可能被这个xml的样式语言被破坏。</p><p>前面提到过，safari早就支持xml和xhtml的转换。然而利用XSLT中的document(), 我们能够带着相应的cookies跨域读取safari其他域内的资源。 这样一来，我们就能可以通过 document()->value-of()/copy-of()这个流程被窃取到其他网站的用户信息，最终，通过JavaScript发送给攻击者。</p><p>我复现了ioactive的poc，然而结果却和IOActive不一样：</p><p>在IOActive的报告中</p><p><img alt="p6" img-src="a366d414d83a612928a31ee079a70335553c116a.jpg"></p><p>无疑成功取到了结果，成功BYPASS。</p><p>而我本地测试的时候却在Safari控制塔得到这样的提示</p><p><img alt="p7" img-src="498ebb9f69c8ebab44043dc0a5092b3672aca97d.jpg"></p><p>无疑是被sop ban掉了。</p><p>是apple修复了，还是利用姿势不对，我将<a href="http://evilshadow-wordpress.stor.sinaapp.com/uploads/2016/02/Archive.zip">POC</a>放到了文章最后，大家可以下载下来研究。</p><h3>服务端：任意文件读取</h3><p>XSLT文档在执行错误的时候回立即终止，它和他的兄弟XML类似，一小丁点错误就会抛出一个错误。然而错误信息也是能够给攻击者带来一些有用的信息的。</p><p>XSLT提供了三个用来读文件的方法</p><ul><li>document(): 用来访问另一个xml文档内的信息（刚刚的跨域中同样用到）</li><li>include(): 用来将两个样式表合并</li><li>import(): 用来将一个样式表覆盖另一个</li></ul><p>比如如下这个样式表A</p><pre><code>#!xml
&lt;?xml-stylesheet type="text/xsl" href="2-9-Reading_Non-XML-Files.xsl"?&gt;
&lt;file&gt;/etc/passwd&lt;/file&gt;
</code></pre><p>和B</p><pre><code>#!xml
&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt; &lt;xsl:template match="/"&gt;
&lt;xsl:value-of select="document(file)"/&gt; &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</code></pre><p>当B被解析时，会尝试调用A表，而A表会试着用document()读取/etc/passwd的内容,很明显这不是一个xml文档，所以不可能读取，幸运的是在输出的错误信息里面，我们可以看到目标文本的第一行被输出了。</p><p><img alt="p8" img-src="d189bf1b4dc148de6a57a59a4703e32a01df9d73.jpg"></p><p>虽然只有第一行，但是第一行能够获取的铭感信息可不少了</p><ul><li>/etc/passwd: Linux root password</li><li>/etc/shadow: Linux root password</li><li>.htpasswd: Apache password</li><li>.pgpass: PostgreSQL password</li></ul><p>这次，xsltproc php perl ruby这四种语言的所有方法（document() ，import() ，include()）都受到影响 （php不愧是世界上最好的语言，什么事儿都有他的份）</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/5799" rel="bookmark" id="re1">WebShell系列(一)---XML</a></li><li><a href="http://drops.wooyun.org/tips/3827" rel="bookmark" id="re2">PHP文件包含漏洞总结</a></li><li><a href="http://drops.wooyun.org/tips/2420" rel="bookmark" id="re3">下载文件的15种方法</a></li><li><a href="http://drops.wooyun.org/tips/870" rel="bookmark" id="re4">hackyou2014 CTF web关卡通关攻略</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Layman2077</span> <span class="weibo"></span> <span class="reply-time">2016-02-23 17:44:15</span></div><p></p><p>对文中最后一句表示不服！</p><p></p></div></div></div></div></div></main>