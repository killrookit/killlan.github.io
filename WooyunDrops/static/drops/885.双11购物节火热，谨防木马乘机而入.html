<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">双11购物节火热，谨防木马乘机而入</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">腾讯电脑管家</a> <span class="bull">·</span> <time title="2015/11/12 16:24" ui-time="" datetime="2015/11/12 16:24" class="published ng-binding ng-isolate-scope">2015/11/12 16:24</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 概况</h1><hr><p>近期11.11购物节，无数的网页、软件都充斥着“血拼双11”的广告，这时的电脑桌面如果多了几个双11相关的快捷方式，或者浏览器主页被锁定成推送网购内容的导航网站，你会不会认为这也是正常的呢？真实的情况却是你的电脑很有可能中马了。近期腾讯反病毒实验室拦截到流氓软件“多彩便签”正在大量推广一个伪装成“阿里妈妈推广程序”的木马，该木马强对抗杀软，恶意锁主页，危害十分严重。</p><h1>0x01 木马分析</h1><hr><ul><li><strong>文件名</strong>：AlimamaAgent.exe</li><li><strong>MD5</strong>：7c428f8759b9015409e87acfa50646c2</li><li><strong>推广渠道</strong>：多彩便签</li></ul><h2>母体AlimamaAgent.exe行为</h2><p>木马母体伪装成阿里妈妈推广程序，其资源中放有三个文件，一个是真正的阿里妈妈推广程序AlimamaAgent.exe，一个是木马文件，另一个是配置文件。<strong>母体运行后首先判断系统启动了多久，如果不超过5分钟的话则释放出木马并执行，然后再释放阿里妈妈推广程序；如果已经超过5分钟的话则只释放阿里妈妈推广程序，不释放木马。</strong>此方法可以绕过很多未重启的自动化分析系统、沙盒等。同时系统刚启动的数分钟内通常是安全软件防御的薄弱时期，此时木马往往可以乘虚而入，执行敏感操作。</p><p><img alt="" img-src="72bd71a6f2e6c18eac7259f7b3d318976b174e18.jpg"></p><p>图1. 木马母体的资源信息</p><p><img alt="" img-src="e6dedf784562489fc9f66fea91958ceea415cf57.jpg"></p><p>图2. 木马只在开机5分钟内运行，用于绕过安全软件主防和自动分析系统等</p><p><img alt="" img-src="f03607b612a5df61d55ed306a7d114e709e298a6.jpg"></p><p>图3. 释放真正AlimamaAgent.exe并执行，该文件是阿里妈妈官方推广程序，主要功能是在桌面释放两个快捷方式进行相关推广，双11是其推广的主题</p><h2>木马sbffdm.exe行为</h2><p>Sbffdm.exe是木马的安装程序，其功能是释放出木马的主功能文件并加载，总共会释放3个驱动文件、1个exe文件和1个dll文件。同时该木马会判断自身文件名，如果不符合规则，则直接退出程序，可能是用于绕过自动分析软件的分析。</p><p><img alt="" img-src="2467bc704546c931c3a1c9d32dd92bd30e19478c.jpg"></p><p>图4. 判断文件名，如果不符合规则就退出</p><p><img alt="" img-src="dba75850bbfa78ec956c2ea74cfd1c6984f8e5c8.jpg"></p><p>图5. 释放CmBatt2.sys、secdrv2.sys、stisvc2.sys、zystatic.exe、zyinstall.dll五个文件,木马会首先判断系统类型，如果是64位系统，则释放的驱动为64位驱动，功能类似</p><p><img alt="" img-src="760629a26d70a2f294002d6c932ef5914d08587c.jpg"></p><p>图6. 调用zyinstall.dll的接口，实现加载3个驱动文件</p><p><img alt="" img-src="5b59757d16a9a2e06aeafbcd032b1d26b7e07af9.jpg"></p><p>图7. Zyinstall.dll的接口实现，主要功能是以服务的方式加载驱动</p><h2>驱动CmBatt2.sys行为</h2><p>CmpBatt2.sys主要用于锁定浏览器主页，锁主页的方式是通过注册创建进程回调，在回调函数中比较进程名的CRC32值，如果在列表中（木马内置了一个各种浏览器进程名的CRC32列表），则通过添加命令行的方式进行主页锁定。同时，该文件还负责清除与主页保护相关的其它文件。</p><p><img alt="" img-src="2c88f1c95968cb1883222ad3c566b88f50a02339.jpg"></p><p>图8. 通过创建回调的方式进行主页锁定</p><p><img alt="" img-src="135918ea538b8c237be4b8abed0fcecb0c4bfdb5.jpg"></p><p>图9. 可能为了免杀，该木马并未内置浏览器名称，而是内置了相应的CRC32值列表</p><p><img alt="" img-src="80cb8af3fd3abbf02dce194143890c99a030dc38.jpg"></p><p><img alt="" img-src="9b9311254e220d7a5883db5ca036792deb7967f6.jpg"></p><p>图10. 通过添加命令行的方式实现主页锁定</p><p><img alt="" img-src="0baf643a4df7fa1e8b3cbd011204faf039337c5c.jpg"></p><p>图11.通过fsd hook，将与主页保护相关的其它文件设置成不可访问，以独霸主页</p><h2>驱动Secdrv2.sys行为</h2><p>Secdrv2.sys的主要功能是通过atapi hook，保护木马的3个驱动文件不被访问、删除等。</p><p><img alt="" img-src="4aa949af88f0709a51452d51b0c645559d19a8f5.jpg"></p><p><img alt="" img-src="8bf6f1a37aa4be00f76633dac5674cfe6c5401c2.jpg"></p><p>图12. 通过Hook保护3个驱动文件</p><h2>驱动stisvc2.sys行为</h2><p>Stisvc2.sys的主要功能是通过hook系统各种关键点对抗安全软件，主要的hook点有：</p><p>1） fsd hook：判断对木马目录zyprotect的查询是否来自安全软件，是则阻止。过滤所有文件的创建操作，如果创建的是安全软件驱动，则阻止。<br>2） Ssdthook：hook了<code>NtQueryInformationProcess</code>，<code>NtQuerySystemInformation</code>，<code>NtReadfile</code>，判断操作者是否为安全软件进程，如果是则阻止。</p><p><img alt="" img-src="4e80667086e678a7f6cbf113ecb36b048d0a3540.jpg"></p><p>图13. 阻止安全软件对木马目录的访问</p><p><img alt="" img-src="fd650d9adb2c454438d4943ee462f758622d0443.jpg"></p><p>图14. 阻止安全软件相关文件的创建</p><p><img alt="" img-src="4e4de6fd96a3d3cead2ccef8fba9aa65efcbacaa.jpg"></p><p>图15. 木马最终实现的锁主页效果</p><h1>0x02 总结</h1><hr><p>木马总是借着各种热点进行传播，在各大网站和各种圈子都被双11购物节刷屏的时候，管家提醒用户更要保护电脑安全，注意桌面图标、浏览器主页的变化，木马有可能借着双11的契机在你电脑上安家落户。如果发现主页被锁或者桌面莫名增加了图标，请及时检查杀毒。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/10673" rel="bookmark" id="re1">“会说话的键盘”:一个恶意推广木马的详细分析</a></li><li><a href="http://drops.wooyun.org/papers/7109" rel="bookmark" id="re2">HackingTeam源码泄漏——语音监控分析</a></li><li><a href="http://drops.wooyun.org/tips/13079" rel="bookmark" id="re3">域渗透——Hook PasswordChangeNotify</a></li><li><a href="http://drops.wooyun.org/papers/12803" rel="bookmark" id="re4">iOS冰与火之歌番外篇 - 在非越狱手机上进行App Hook</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">飘</span> <span class="reply-time">2016-05-29 13:09:09</span></div><p></p><p>6</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">猛狼时代</span> <span class="reply-time">2015-12-03 16:50:12</span></div><p></p><p>我都被你们搞晕了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Murk Emissary</span> <span class="reply-time">2015-11-26 10:10:41</span></div><p></p><p>电脑管家人员是如何获取到木马源代码的呢？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">默之</span> <span class="reply-time">2015-11-12 18:43:36</span></div><p></p><p>我电脑上突然多出个双十一天猫，看了一下不懂就删了，想着应该是病毒，直接下载到c盘的programfile文件夹下，估计是利用某个漏洞下载的吧</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">金馆长</span> <span class="reply-time">2015-11-12 18:23:41</span></div><p></p><p>电脑昨天莫名其妙就有个爱淘宝，，</p><p></p></div></div></div></div></div></main>