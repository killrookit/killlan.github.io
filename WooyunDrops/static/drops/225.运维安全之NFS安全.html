<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">运维安全之NFS安全</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">rootsecurity</a> <span class="bull">·</span> <time title="2014/04/20 14:46" ui-time="" datetime="2014/04/20 14:46" class="published ng-binding ng-isolate-scope">2014/04/20 14:46</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>说起NFS是（Network File System）的缩写，相信这很多人都知道。其最大的优点就是可以在网络里使不同的主机，不同的操作系统来互相分享文件。由于NFS不像WEB那样经常使用，一般也就用到的时候去网上随便找篇文档安装一下，剩下的就是能用就行了。所以安全性往往是比较容易忽略的问题。</p><p>NFS的联动进程有nfsd，rpc.mountd，rpc.statd， locked，rpc.idmapd，rpc.gssd，rpc.svcgssd，其主进程nfsd使用的是TCP/UDP的2049端口，其中TCP协议是在V3版本才引入的。下面是NFS的发展历程：</p><pre><code>NFS V1是SUN公司研发，包含在SUN操作系统里。
NFS V2是最原始的NFS协议，在RFC1904中有相关描述，这个版本是基于UDP的，单个文件最大支持4G
NFS V3在RFC1813中描述，相对于V2增加了TCP协议的相关支持，安全异步，服务端ACL，V3相对于V2来说性能上有一个很大的提升，但是安全性并没有多少改进。
NFS V4在RFC3530中描述，相对于V3版本，它把lock喝mount整合进协议中，开发了新的AC L控制机制，引入对UTF-8字符集的支持，NFS V4要求所有实现都必须支持kerberos的身份验证，替代了原有的基于UID/GID的身份验证
</code></pre><h3>下面阐述一下V3的连接过程：</h3><p>NFSv3协议的服务器端是无状态的，所以就算机器重启了，NFS服务起来以后，客户端依然可以拿着旧文件句柄继续读写文件。但是服务器端的lockd进程是有状态的，重启就有点麻烦，解决方案是服务器端的rpc.statd让客户端报告自己手里的锁，然后重新让lockd恢复锁状态。</p><p>客户端问服务器端的portmap：rpc.mount目前的用哪个端口？客户端向服务器端的rpc.mount请求挂载NFS； 服务器端的rpc.mount判断权限后给客户端一个文件句柄； 客户端使用这个句柄与服务器端的nfsd交流（使用TCP/UDP的2049端口），以读写文件。</p><h3>NFS V3的验证机制及安全：</h3><p>NFS V3及其附属协议采用标准的RPC AUTH&#95;SYS（又称AUTH&#95;UNIX）机制验证挂载后的客户端对具体文件的权限，服务器完全信任客户端声名的自己的权限（其实不能被称为是“验证”了</p><p>大概过程就是客户端会在读写之前告诉服务器自己的UID和GID，然后NFS就把这些ID视同自己系统上的ID来验证权限；</p><p>客户端可以很容易伪造出高权限的ID以达到攻击的目的，防御的临时解决之道是不让NFS暴露在公有网络上且不打开NFS的root权限（是比较弱的防御）</p><p>还有一个麻烦是，不同客户端上同一个username的UID想保持同步是件不容易的事。</p><p>不要把包含配置文件的目录export出去</p><p>export整个文件系统的根出去，而不是export文件系统中某个目录出去。因为即使只是export一个目录出去，攻击者也可能通过猜测的方式得到文件系统中其它目录的读写权限。比如说一个ext3挂载在/mnt/下了，用NFS export/mnt/data1/出去，攻击者就可能读写/mnt/data2/下的文件。这显然不是我们希望的，因此不如干脆共享整个文件系统（也就是/mnt/）出去。或者也可以使用NFS的substree_check来帮我们做检查来防止这种入侵，但是这个选项会较大幅度降低NFS的性能</p><p>如果一个文件系统挂载点是另一个文件系统的子目录，那么父系统开启crossmnt或者子系统开启nohide就可以把两个文件系统都共享出去，使用这个选项的时候要小心，别共享了自己不想共享的内容出去</p><p>虽然nfsd固定使用2049端口，但是lockd、mountd、statd都使用portmap随机分配的端口，这让防火墙很难配置，而且还可能占用还没起来的其它服务的端口。可以在/etc/sysconfig/nfs中把这些进程的端口都配置成固定的，这样配置防火墙（只放行自己信任的IP）就容易了</p><p>rpcinfo -p可以查看portmap分配出去的端口。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/8659" rel="bookmark" id="re1">NFS配置不当那些事</a></li><li><a href="http://drops.wooyun.org/tips/1670" rel="bookmark" id="re2">SQL SERVER 2008安全配置</a></li><li><a href="http://drops.wooyun.org/tips/2014" rel="bookmark" id="re3">批量网站DNS区域传送漏洞检测——bash shell实现</a></li><li><a href="http://drops.wooyun.org/tips/2866" rel="bookmark" id="re4">lnmp虚拟主机安全配置研究</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Tea</span> <span class="reply-time">2015-09-24 17:40:07</span></div><p></p><p>这种服务怎么解决内网IP地址泄漏，比如如下配置：<br>/nfstest 192.168.1.*(rw,no_root_squash,no_all_squash,sync,insecure)<br>外网showmount -e 222.222.222.222<br>就会泄漏机器的内网IP段了，如：<br>Export list for 222.222.222.222:<br>/nfstest 192.168.1.*<br>虽然不能mount，除了直接阻止外网IP访问这个服务端口（mount也就内网的可以mount了），比如iptables等，配置上还有什么办法隐藏这些信息什么的？<br>这东西貌似在泄漏内网IP上，并没有什么人注意，更多的人注意的是能否成功远程mount，然后读写文件。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sipcer</span> <span class="reply-time">2014-04-25 11:23:32</span></div><p></p><p>不明觉厉</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">霍大然</span> <span class="reply-time">2014-04-24 11:20:21</span></div><p></p><p>一般在/etc/exports文件内做访问控制吧</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小贱人</span> <span class="reply-time">2014-04-24 00:15:57</span></div><p></p><p>mark</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">winsyk</span> <span class="reply-time">2014-04-22 16:11:27</span></div><p></p><p>只有最后一句是重点。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">啊哈哈</span> <span class="reply-time">2014-04-21 20:24:14</span></div><p></p><p>我不会告诉你，可以showmount 然后 nfs 挂载到本地。啊哈哈。。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">我是壮丁</span> <span class="reply-time">2014-04-21 12:14:11</span></div><p></p><p>我就不发表观点了。。。。。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Spy4man</span> <span class="reply-time">2014-04-21 10:50:38</span></div><p></p><p>111,2049</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">yangff</span> <span class="reply-time">2014-04-21 08:34:32</span></div><p></p><p>比如说一个ext3挂载在/mnt/下了，用NFS export/mnt/data1/出去，攻击者就可能读写/mnt/data2/下的文件。这显然不是我们希望的，因此不如干脆共享整个文件系统（也就是/mnt/）出去。</p><p>这是什么逻辑……</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">yangff</span> <span class="reply-time">2014-04-21 08:31:24</span></div><p></p><p>它把lock[喝]mount</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xsser</span> <span class="reply-time">2014-04-20 14:50:39</span></div><p></p><p>洞主怎么扫描啊</p><p></p></div></div></div></div></div></main>