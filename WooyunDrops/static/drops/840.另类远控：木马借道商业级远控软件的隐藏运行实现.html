<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">另类远控：木马借道商业级远控软件的隐藏运行实现</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">360安全卫士</a> <span class="bull">·</span> <time title="2015/10/20 13:51" ui-time="" datetime="2015/10/20 13:51" class="published ng-binding ng-isolate-scope">2015/10/20 13:51</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>提起远控木马，灰鸽子、Gh0st等等都是臭名昭著。与这些木马相比，商业级远控软件的监控能力毫不逊色，只不过这类软件有着合法身份，并且在安装和运行时都会有明显提示。</p><p>但如果商业级远控软件能够被黑客玩坏，让它实现隐藏运行，那么它就会变成威力巨大的远控木马，因为这类商业级软件会被大多数安全厂商识别为合法程序。</p><p>360QVM团队就数次发现商业级远控软件遭恶意利用的情况，在此进行详细分析。</p><h1>0x01 样本概况</h1><hr><p><img alt="" img-src="b04602e20fd435ba94af40240e3a11901f8e5300.jpg"></p><p><img alt="" img-src="b6aeb5badf3a01d51df09aab2756fc6d63c75f96.jpg"></p><p><img alt="" img-src="ee90736d4ef4a457588619a80f72d97be6063284.jpg"></p><p>样本是个常见的使用色情诱惑类名称的压缩包“我们小姐的相片”，在解压后得到一个批处理文件和一个隐藏的文件夹。依靠色情等擦边球传播，这是木马病毒惯用的手段。</p><p>隐藏文件夹内文件如下：</p><p><img alt="" img-src="c0f21a6c482172d203be2ca60016082b6550c4ad.jpg"></p><p>批处理文件经过混淆加密，用以对抗静态检测：</p><p><img alt="" img-src="d2795b6331148bf0243fcd4d0f4996ec8f22834e.jpg"></p><h1>0x02 批处理流程</h1><hr><p>对批处理文件的解密结果：</p><p><img alt="" img-src="ad4b0ee472d0542bf710e1b8c0383b2b74abff39.jpg"></p><h2>其中主要命令为：</h2><h3>Part 1：</h3><p><img alt="" img-src="50a266e0bd4745c4e3ef8d2fc495b2c23c9c528f.jpg"></p><p>获得当前日期时间并保存到ok.txt，形如201510151742；</p><p><img alt="" img-src="9ef700230fdae2836965116c252a153c7ac21d6e.jpg"></p><p>带参数运行ge.log，即进入命令行版的rar；</p><p><img alt="" img-src="f84ac4d9ab957e58c465cb0a3e8f3efb58356d05.jpg"></p><p>解压文件user.txt到文件夹user，并删除源文件。</p><h3>Part 2：</h3><p>之后则是创建文件夹c:\user0和c:\78g并复制解压的文件。</p><p>user0目录：</p><p><img alt="" img-src="0645de86072ee38aec0b66f2c6a504f9cfa397ca.jpg"></p><p>78g目录：</p><p><img alt="" img-src="a21e2894415bb3e611d64c991e5a4f3c4e783c04.jpg"></p><p>此时另外两个文件开始运行：</p><p><img alt="" img-src="492af75913d034f191dd2e22e1b4283579363bf6.jpg"></p><p><img alt="" img-src="e24358abaa443cb5df6b305f15638b8ecd69c998.jpg"></p><p>ok.txt是之前命令运行生成的包含当前日期时间的文件，tu1.txt是user目录中原有文件。</p><p><img alt="" img-src="672cb216bd82d2b094873b70e90fbe754a073c71.jpg"></p><p><img alt="" img-src="3c4ffbadb396c0ca8e0ac8aaf2fce420b59754e1.jpg"></p><p>再运行pb.bat，此时该目录下仅剩一个名为照片的快捷方式。</p><h3>Part 3：</h3><p>pb.bat中内容同样是混淆加密的：</p><p><img alt="" img-src="75bca2046eb7ad2ba3f4a96fcd7945ac47d2a360.jpg"></p><p>解密后命令：</p><p><img alt="" img-src="7829fc5d587a3652735119aa3769997a8b7b5ee5.jpg"></p><p>ok.txt是之前保存有当前日期时间的文本，此处通过查找字符来判断样本激活时间是否在指定时间范围内。</p><p><img alt="" img-src="0ac9866ce7885a8d9a9f9d31556fb0ae44eafc58.jpg"></p><p>添加注册表。此处添加的内容将在下面介绍。</p><p><img alt="" img-src="f42f8fe13df1ab5ae2b7e3b677d15adea3e86647.jpg"></p><p>打开一张图片，此时的“照片”，方才成为真正的图片。</p><p><img alt="" img-src="7100d410d7e24bd6221a6e10a2fc4d5809dd86e4.jpg"></p><p>至此，批处理的命令已经结束，全程不存在病毒。当用户想再次打开“照片”时，则会运行“照片.lnk”指向的程序。</p><h1>0x03 利用小众软件隐藏远控程序</h1><hr><p>照片所指，是一款名为装模作样的窗口隐藏工具，usersys.ini是该软件的配置文件。</p><p><img alt="" img-src="168d8047f850edfe9f872bd61ebcce8fe6f15f7e.jpg"></p><p><img alt="" img-src="ca17cc861adee54d8da9d23912c19c42c2b759de.jpg"></p><p>该软件也并不是病毒，其配置文件具备“指定启动时自动隐藏并运行指定程序”的功能。</p><p><img alt="" img-src="504199aee87bb17650424307a1b6346d81a6902d.jpg"></p><p><img alt="" img-src="7fc7424aaae262f1c40418d7e5cca78d8d4974e1.jpg"></p><p>样本预设的配置，使svchnst.exe运行时便会启动C:\user0\svchest.exe并隐藏这两个程序的界面。</p><p>而svchest.exe实为一款名为“网灵”的商业远控受控端。对于具有合法身份的商业远控，很多杀毒软件原则上也是不报毒的。</p><p><img alt="" img-src="c8dec4f3beec3a5b54a56a8c6640e5d812034d41.jpg"></p><p>该程序运行时原本有明确提示；但由于svchnst的隐藏运行，该远控受控端的图标和提示便被隐藏。</p><p><img alt="" img-src="3a35efe56d6cb2e694e0f7b4fdd4676f6a08320e.jpg"></p><p>因为网灵受控端安装包在安装时需要填入网灵服务id和密码，并将这些信息保存到注册表hklm\software\anypc01中：</p><p><img alt="" img-src="2f15bff03224fa45dbdde19d4bed83af885c8d8d.jpg"></p><p>这也可以解释上述批处理命令中，需要添加注册表的原因。</p><h1>0x04 总结</h1><hr><p>病毒作者事先在一台电脑上用商业远控配置好受控端，使用批处理来添加同等配置信息；再借助一款窗口隐藏工具，隐藏商业远控端开启时的提示。这样，受害者在不知不觉间，就遭到了攻击者的毒手；而攻击者也无需编写恶意程序，通过合法商业远控的隐藏实现就控制了受害者的电脑。 在此我们提醒广大网友：木马并不只是exe等可执行程序，类似.bat这样的脚本文件同样很危险。如果遇到不熟悉的文件格式或是陌生人发来的可疑文件，切莫轻易点击运行。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xs</span> <span class="reply-time">2015-10-23 10:39:38</span></div><p></p><p>@无花果<br>你不是进去了吗</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">无花果</span> <span class="reply-time">2015-10-20 23:12:15</span></div><p></p><p>我只想说现在初中生把易语言玩的很好啊。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">001</span> <span class="reply-time">2015-10-20 23:12:15</span></div><p></p><p>@小平___ 不要把软件用坏了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小常</span> <span class="reply-time">2015-10-20 17:02:47</span></div><p></p><p>自启动才是关键，没有自启动的木马都是鸡肋。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Yd0str</span> <span class="weibo"></span> <span class="reply-time">2015-10-20 15:16:01</span></div><p></p><p>用批处理文本形式带进去远控和隐藏软件的方式的方式，终端动静也不小吧，而且略显啰嗦，不过黑样本及其流量黑用白的方式确实经久不衰～～</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小平___</span> <span class="weibo"></span> <span class="reply-time">2015-10-20 15:14:57</span></div><p></p><p>求样本</p><p></p></div></div></div></div></div></main>