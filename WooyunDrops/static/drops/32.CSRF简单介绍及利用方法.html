<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">CSRF简单介绍及利用方法</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">VIP</a> <span class="bull">·</span> <time title="2013/07/02 12:24" ui-time="" datetime="2013/07/02 12:24" class="published ng-binding ng-isolate-scope">2013/07/02 12:24</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h3>0x00 简要介绍</h3><hr><p>CSRF（Cross-site request forgery）跨站请求伪造，由于目标站无token/referer限制，导致攻击者可以用户的身份完成操作达到各种目的。根据HTTP请求方式，CSRF利用方式可分为两种。</p><h3>0x01 GET类型的CSRF</h3><hr><p>这种类型的CSRF一般是由于程序员安全意识不强造成的。GET类型的CSRF利用非常简单，只需要一个HTTP请求，所以，一般会这样利用：</p><pre><code>&lt;img src=http://wooyun.org/csrf.php?xx=11 /&gt; 
</code></pre><p>如下图，在访问含有这个img的页面后，成功向http://wooyun.org/csrf.php?xx=11发出了一次HTTP请求。所以，如果将该网址替换为存在GET型CSRF的地址，就能完成攻击了。</p><p><img alt="20130701174309_63157.jpg" img-src="a49e0490554eb8ab7a1e621d3c9e63bd75b41070.jpg"></p><p>乌云相关案例：</p><p>http://wooyun.org/bugs/wooyun-2010-023783</p><p>http://wooyun.org/bugs/wooyun-2010-027258 (还未公开)</p><h3>0x02 POST类型的CSRF</h3><hr><p>这种类型的CSRF危害没有GET型的大，利用起来通常使用的是一个自动提交的表单，如：</p><pre><code>&lt;form action=http://wooyun.org/csrf.php method=POST&gt;
&lt;input type="text" name="xx" value="11" /&gt;
&lt;/form&gt;
&lt;script&gt; document.forms[0].submit(); &lt;/script&gt; 
</code></pre><p>访问该页面后，表单会自动提交，相当于模拟用户完成了一次POST操作。</p><p>乌云相关案例：</p><p>http://wooyun.org/bugs/wooyun-2010-026622</p><p>http://wooyun.org/bugs/wooyun-2010-022895</p><h3>0x03 其他猥琐流CSRF</h3><hr><p>过基础认证的CSRF(常用于路由器):</p><p>POC:</p><pre><code>&lt;img src=http://admin:<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="abcacfc6c2c5eb9a9299859a9d93859a859a">[email&#160;protected]</a> /&gt; 
</code></pre><p>加载该图片后，路由器会给用户一个合法的SESSION，就可以进行下一步操作了。</p><p>乌云相关案例：</p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2013-026825">WooYun: TP-LINK路由器CSRF，可干许多事（影响使用默认密码或简单密码用户）</a></p><h3>0x04 如何修复</h3><hr><p>针对CSRF的防范，有以下几点要注意：</p><h4>关键操作只接受POST请求</h4><h4>验证码</h4><p>CSRF攻击的过程，往往是在用户不知情的情况下构造网络请求。所以如果使用验证码，那么每次操作都需要用户进行互动，从而简单有效的防御了CSRF攻击。</p><p>但是如果你在一个网站作出任何举动都要输入验证码会严重影响用户体验，所以验证码一般只出现在特殊操作里面，或者在注册时候使用</p><h4>检测refer</h4><p>常见的互联网页面与页面之间是存在联系的，比如你在www.baidu.com应该是找不到通往www.google.com的链接的，再比如你在论坛留言，那么不管你留言后重定向到哪里去了，之前的那个网址一定会包含留言的输入框，这个之前的网址就会保留在新页面头文件的Referer中</p><p>通过检查Referer的值，我们就可以判断这个请求是合法的还是非法的，但是问题出在服务器不是任何时候都能接受到Referer的值，所以Refere Check 一般用于监控CSRF攻击的发生，而不用来抵御攻击。</p><h4>Token</h4><p>目前主流的做法是使用Token抵御CSRF攻击。下面通过分析CSRF 攻击来理解为什么Token能够有效</p><p>CSRF攻击要成功的条件在于攻击者能够预测所有的参数从而构造出合法的请求。所以根据不可预测性原则，我们可以对参数进行加密从而防止CSRF攻击。</p><p>另一个更通用的做法是保持原有参数不变，另外添加一个参数Token，其值是随机的。这样攻击者因为不知道Token而无法构造出合法的请求进行攻击。</p><p>Token 使用原则</p><pre><code>Token要足够随机————只有这样才算不可预测
Token是一次性的，即每次请求成功后要更新Token————这样可以增加攻击难度，增加预测难度
Token要注意保密性————敏感操作使用post，防止Token出现在URL中
</code></pre><h3>0x05 测试CSRF中注意的问题</h3><hr><p>如果同域下存在xss的话，除了验证码，其他的方式都无法防御这个问题。</p><p>有个程序后端可能是用REQUEST方式接受的，而程序默认是POST请求，其实改成GET方式请求也可以发送过去，存在很严重的隐患。</p><p>当只采用refer防御时，可以把请求中的修改成如下试试能否绕过：</p><p>原始refer：<code>http://test.com/index.php</code></p><p>测试几种方式（以下方式可以通过的话即可能存在问题）：</p><pre><code>http://test.com.attack.com/index.php
http://attack.com/test.com/index.php
[空]
</code></pre><p>refer为空构造的方法：</p><pre><code>由于浏览器特性，跨协议请求时不带refer（Geckos内核除外），比如https跳到http，如果https环境不好搭建的话，ftp其实也是可以的：）

&lt;iframe src="data:text/html,&lt;script src=http://www.baidu.com&gt;&lt;/script&gt;"&gt; //IE不支持

利用 xxx.src='javascript:"HTML代码的方式"'; 可以去掉refer，IE8要带。
&lt;iframe id="aa" src=""&gt;&lt;/iframe&gt;
&lt;script&gt;
document.getElementById("aa").src='javascript:"&lt;html&gt;&lt;body&gt;wooyun.org&lt;scr'+'ipt&gt;eval(你想使用的代码)&lt;/scr'+'ipt&gt;&lt;/body&gt;&lt;/html&gt;"';
&lt;/script&gt;
//来自于二哥gainover
</code></pre><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/154" rel="bookmark" id="re1">由参数URL想到的</a></li><li><a href="http://drops.wooyun.org/papers/104" rel="bookmark" id="re2">Clickjacking简单介绍</a></li><li><a href="http://drops.wooyun.org/papers/346" rel="bookmark" id="re3">终端机的安全性</a></li><li><a href="http://drops.wooyun.org/papers/345" rel="bookmark" id="re4">在线支付逻辑漏洞总结</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">龙</span> <span class="reply-time">2016-05-13 19:49:27</span></div><p></p><p>@xiete 根本没办法判断一个请求是浏览器发出的还是程序模拟的，所有协议头都可以伪造。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">smalldragonluo</span> <span class="reply-time">2016-04-24 23:34:57</span></div><p></p><p>@xiete 网站后台拿到 token 跟用户没关系的，这个 token 只属于某个用户</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">爸爸</span> <span class="reply-time">2016-04-11 22:22:18</span></div><p></p><p>@xiete cookie也是可以伪造的呀</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xiete</span> <span class="reply-time">2016-03-09 21:03:42</span></div><p></p><p>事实是文章所说的token也是不安全的，用户访问危险网站B，网站B完全可以在后台模拟用户请求获取到目标网站的token，返回给用户，然后在浏览器端模拟用户提交。最安全的方式还是通过cookie限定危险网站B的访问</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">毛毛虫</span> <span class="reply-time">2016-02-25 15:49:29</span></div><p></p><p>很好</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">毛毛虫</span> <span class="reply-time">2015-12-25 12:53:56</span></div><p></p><p>学习了，写的很好</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">111</span> <span class="reply-time">2015-11-16 11:26:14</span></div><p></p><p>&quot;&lt;iframe src=&quot;data:text/html,&lt;script src=http://www.baidu.com&gt;&lt;/script&gt;&quot;&gt; //IE不支持</p><p>利用 xxx.src=&#039;javascript:&quot;HTML代码的方式&quot;&#039;; 可以去掉refer，IE8要带。<br>&lt;iframe id=&quot;aa&quot; src=&quot;&quot;&gt;&lt;/iframe&gt;<br>&lt;script&gt;<br>document.getElementById(&quot;aa&quot;).src=&#039;javascript:&quot;&lt;html&gt;&lt;body&gt;wooyun.org&lt;scr&#039;+&#039;ipt&gt;eval(你想使用的代码)&lt;/scr&#039;+&#039;ipt&gt;&lt;/body&gt;&lt;/html&gt;&quot;&#039;;<br>&lt;/script&gt;&quot;</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">lll</span> <span class="reply-time">2015-11-16 11:22:55</span></div><p></p><p>&lt;script&gt;<br>alert(1);<br>&lt;/script&gt;</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">lll</span> <span class="reply-time">2015-11-16 11:21:47</span></div><p></p><p>&lt;iframe src=&quot;data:text/html,&lt;script src=http://www.baidu.com&gt;&lt;/script&gt;&quot;&gt; //IE不支持</p><p>利用 xxx.src=&#039;javascript:&quot;HTML代码的方式&quot;&#039;; 可以去掉refer，IE8要带。<br>&lt;iframe id=&quot;aa&quot; src=&quot;&quot;&gt;&lt;/iframe&gt;<br>&lt;script&gt;<br>document.getElementById(&quot;aa&quot;).src=&#039;javascript:&quot;&lt;html&gt;&lt;body&gt;wooyun.org&lt;scr&#039;+&#039;ipt&gt;eval(你想使用的代码)&lt;/scr&#039;+&#039;ipt&gt;&lt;/body&gt;&lt;/html&gt;&quot;&#039;;<br>&lt;/script&gt;</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">填</span> <span class="reply-time">2014-08-01 17:47:30</span></div><p></p><p>alert(1);</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Focusstart</span> <span class="reply-time">2014-05-14 11:28:06</span></div><p></p><p>mark!</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">墨水心_Len</span> <span class="reply-time">2013-08-01 16:39:25</span></div><p></p><p>如果对token再加上expireTime，会不会多了一道防御~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">z7y</span> <span class="reply-time">2013-07-13 02:54:13</span></div><p></p><p>- 0 - VIP基佬 不错嘛~ @VIP</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Demon</span> <span class="reply-time">2013-07-04 22:29:13</span></div><p></p><p>小朋友写的不错！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">VIP</span> <span class="reply-time">2013-07-02 16:58:09</span></div><p></p><p>能编辑的吗？发现错别字了啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">VIP</span> <span class="reply-time">2013-07-02 13:09:40</span></div><p></p><p>感谢</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瞌睡龙</span> <span class="reply-time">2013-07-02 12:29:15</span></div><p></p><p>@VIP 帮你增加了个0x05 文章看起来饱满些，欢迎继续来投稿~</p><p></p></div></div></div></div></div></main>