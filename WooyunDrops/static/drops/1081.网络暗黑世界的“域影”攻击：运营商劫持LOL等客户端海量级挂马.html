<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">网络暗黑世界的“域影”攻击：运营商劫持LOL等客户端海量级挂马</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">360安全卫士</a> <span class="bull">·</span> <time title="2016/03/10 19:00" ui-time="" datetime="2016/03/10 19:00" class="published ng-binding ng-isolate-scope">2016/03/10 19:00</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 起因</h1><hr><p>从上周末开始，360互联网安全中心监控到一批下载者木马传播异常活跃。到3月7号，拦截量已经超过20W次，同时网页挂马量的报警数据也急剧增加。在对木马的追踪过程中，我们发现木马的传播源头竟然是各家正规厂商的软件，其中来自英雄联盟和QQLive的占了前三天传播量的95%以上。而在受感染用户分布中，河南竟占到了72%。</p><p>木马传播源TOP：</p><pre><code>\英雄联盟\Air\LolClient.exe
\QQLiveBrowser.exe
\youkupage.exe
\QyFragment.exe
\QQGAME\SNSWebBrowser\IEProc.exe
\SogouInput\7.4.1.4880\SohuNews.exe
</code></pre><p>网上的用户反馈：</p><p><img alt="" img-src="37eabdf1eccee3526269da56b29ada4c542cbba1.jpg"></p><h1>0x01 挂马过程分析</h1><hr><p>在对数据分析之后，我们确认，这次攻击事件和去年通过视频客户端挂马是同一个团伙所为，使用的技术手段也比较相似。（《祸起萧墙：由播放器引爆的全国性大规模挂马分析》<a href="http://blogs.360.cn/360safe/2015/06/26/trojan-pass-player/">http://blogs.360.cn/360safe/2015/06/26/trojan-pass-player/</a>）<strong>本次木马传播，主要是通过运营商（ISP）对用户的网络访问做内容劫持，在html代码中插入一段iframe的广告代码所引起的。在这段广告代码中，为客户端引入了带挂马攻击的flash文件。而国内仍有很多桌面客户端使用旧版带有漏洞的flash插件，如英雄联盟，QQLive等。flash的漏洞，造成了这些客户端本身易受攻击，而客户端本身也没有做安全防护，没有对通信进行加密，在ISP的攻击面前不堪一击。</strong>如果用户计算机此时又没有安装带有漏洞防护功能的安全软件，就会造成用户计算机被感染。</p><p>从联系到的用户那里来看，用户的出口IP属于河南郑州移动网络：</p><p><img alt="" img-src="0c02b16052f4bc3837ab88fca2d22d54e31565ac.jpg"></p><p>在联系用户追查问题的时候，发现用户打开任何网页的时候都有可能中毒，显然并不是特定网站被挂马导致的。该用户在打开了一个凤凰网新闻页面的时候便触发了木马，于是我们查看该网页，发现了如下代码：</p><p><img alt="" img-src="f81b43c78c8ead471a4cffc2fc269bb6cb82c32e.jpg"></p><p>很显然，在一个itemscope的div元素下，出现了一个指向majore.b0.upayun.com的脚本元素和一段iframe嵌入页面。</p><p>而在分析人员自己的机器中（北京市电信）访问相同的页面，则显然没有这两个元素：</p><p><img alt="" img-src="d63586add53c868dfc82319627823e844c66f8a8.jpg"></p><p>更为关键的是iframe中又嵌入了一层iframe指向muhlau.cn这个域名。为了方便查看，我们单独打开了这个页面，呈现出来的是一个看似正常的flash广告动画，但仔细看代码发现——这里面还有两层iframe嵌套，而在最里层的，是一个根本看不到的flash文件（截图中红框圈出来的就是这个看不见的flash文件的位置）</p><p><img alt="" img-src="d75b6b4fa2f609e8d876e27f9f790c491facde67.jpg"></p><p>同时，查看浏览器的Network监控，也确认确实加载了这个swf文件：</p><p><img alt="" img-src="7265aeeb599c4a6d24581b029992236dcd0b706a.jpg"></p><p>拿到swf文件后分析来看，本身并没有什么实质性的动画内容，反倒是含有一段经过doswf加密的脚本：</p><p><img alt="" img-src="90114f5ab2047f304e9a3c0a7068512edd61f81e.jpg"></p><p><img alt="" img-src="8e845a0b5f226e6de7c26057dfe1272a64bd594e.jpg"></p><p>通过抓取内存dump可以看到明显的shellcode字串以及加载shellcode的代码：</p><p><img alt="" img-src="754f3fb623c7a2d22fb2a5af380b2baa058a2301.jpg"></p><p><img alt="" img-src="becfa77e7c2c8487b250bf1a562170d1a291d961.jpg"></p><p>含有恶意代码的flash文件一旦被带有漏洞的flash插件展示，便会触发木马下载动作，从3g4s.net域名下获取一个可执行文件，下载到本地并执行。</p><p><img alt="" img-src="e4210c44ceead6ec39841639b4be7b463f8deb73.jpg"></p><h1>0x02 挂马数据展示</h1><hr><p>此次挂马，攻击者通过“上海米劳广告传媒有限公司”投放的广告内容。</p><p>主要的挂马页面：</p><ul><li><code>hxxp://www.muhlau.cn/1/index001.html</code></li><li><code>hxxp://majore.b0.upaiyun.com/06/media_1.html</code></li></ul><p>所挂的flash木马：</p><ul><li><code>hxxp://www.ip.muhlau.cn/LSQZA.swf</code></li></ul><p>服务器地址：<code>222.186.59.36(江苏省镇江市 电信)</code></p><p>截至我们发稿时，flash攻击代码已经有超过1000W次的独立用户访问。单在3月9号一天，就有<strong>534W</strong>独立用户访问到了挂马页面。</p><p><img alt="" img-src="f4fe9b8587e4c0371935e3fea2e2e6f9199f534d.jpg"></p><p>一分钟内，有超过6800次的访问。</p><p><img alt="" img-src="45a6ac544f646be34f4acfb44974892b2e955597.jpg"></p><p>挂马页面的引用来源，主要是广告主的广告跳转页面：</p><p><img alt="" img-src="869cbb57c526eb2e253211793f843ce17028376d.jpg"></p><p>地区分布可以看出，河南占65%以上：</p><p><img alt="" img-src="631a0ce23ff049219d603830b86e1b18531bdc4b.jpg"></p><p>防护中心3月9日，单天统计到的木马传播趋势：</p><p><img alt="" img-src="4c257a3bd07eb8f3cca83f2a23a1b6a6d90c8cd4.jpg"></p><h1>0x03 木马分析</h1><hr><p>此次木马传播者准备了大量木马的免杀版本，在对抗过程中，高峰时木马每分钟均会更新一个版本，并针对多款安全软件做免杀处理。木马本身是一个简单下载者加广告程序，但更新极为频繁，仅3月9号一天就更新超过300次。</p><p>客户端被flash挂马之后下载执行木马的情况截图：</p><p><img alt="" img-src="02220ca44f6bcc895360f3895751c577f6e2e3b1.jpg"></p><p>捕获的各种挂马程序：</p><p><img alt="" img-src="4128b6c2bc320cf9b36ab47aaefc28d4d3082094.jpg"></p><p>360安全卫士拦截木马启动：</p><p><img alt="" img-src="7abfdbcd42ed44403710b7da2dba0c44f71151bb.jpg"></p><p>被恶意flash文件下载到本地后以ad为参数执行；而广告程序通过判断启动参数来决定执行什么行为：</p><p><img alt="" img-src="b94cde3c485d15f25e00651a998c6d75f32bb459.jpg"></p><p>同时，还会检查当前系统环境来判断自己是否在虚拟机环境中：</p><p><img alt="" img-src="6b249492c6ca3e138975bb5eaccd9eb24e23a8b1.jpg"></p><p>在确认可以正常运行后，广告程序会先访问指定的推广服务器获取推广列表：</p><p><img alt="" img-src="eec89b2e80408f5b96252e9cbdea715709383393.jpg"></p><p>之后则根据推广列表的内容打开一个淘宝页面来推广其淘宝店并弹出广告弹窗：</p><p><img alt="" img-src="07b82ac51af03522a5317fcb0640d3e4b6d2c0f3.jpg"></p><p><img alt="" img-src="84cc80827acb273f8b1b173897961d2c2989a163.jpg"></p><p><img alt="" img-src="c20e6699d64412a63478230fd0bc49b0e89a7477.jpg"></p><p>写入开机启动项：</p><p><img alt="" img-src="3ff856eac412eb32b93796109b4e600e11adc97e.jpg"></p><p><img alt="" img-src="c4f394dedf9201417c5b623d060bb1e5eb8a2262.jpg"></p><p>安装大批推广程序：</p><p><img alt="" img-src="2f690c0bff90bce5d16a7c3dd0b43cf4d865757e.jpg"></p><h1>0x04 木马作者追踪</h1><hr><p>在整个木马传播过程中，有3个团体参与其中。<br>渠道由ISP负责，向页面中插入广告，它可以控制其全部用户。<br>广告商是来自上海的米劳传媒，其控制下面几个挂马传播服务器：</p><pre><code>hxxp://www.muhlau.cn/1/index001.html
hxxp://majore.b0.upaiyun.com/06/media_1.html
hxxp://www.ip.muhlau.cn/LSQZA.swf
222.186.59.36
</code></pre><p>真正的木马作者，控制着swf挂马文件触发之后的全部服务器：<br>服务器ip：<code>58.218.205.91</code></p><pre><code>hxxp://down.3g4s.net/files/DeskHomePage_179_1.exe
hxxp://down.seakt.com/tpl.exe
hxxp://tj.takemego.com:808
hxxp://tj.kissyouu.com:808
hxxp://tj.take1788.com
</code></pre><p>服务器ip：<code>58.218.204.251</code></p><pre><code>hxxp://down.shangshuwang.com/tpl.exe
</code></pre><p>对这些服务器whois查询发现，服务器均为今年2月左右新注册域名，并且均作了隐私保护，可谓非常之狡猾。</p><p><img alt="" img-src="5ff63a2c2aa9e2b4740cae45c24dda596b428308.jpg"></p><p>木马作者使用的是微软IIS+ASP的服务器：</p><p><img alt="" img-src="833a52a4a57f703881977bf96ed5f17ad1e4772f.jpg"></p><p>通过挂马服务器后台发现，攻击者来自四川省南充市</p><p><strong>218.89.82.229（四川省南充市 电信） 2016/03/08 08:49:55<br>139.203.94.136（四川省南充市 电信）2016/03/08 13:25:39<br>对其进一步分析，我们获取到了木马作者的联系方式：<br>作者QQ：31577675xx（主号，不常用）<br>测试使用QQ5542447xx（不常用）<br>1256403xx主号（常用）</strong></p><p>通过网上信息，可以看做作者已经从事黑产很多年了。</p><p><img alt="" img-src="6c019671a389855087ef54e6adb5372220483554.jpg"></p><p><img alt="" img-src="927439aba54dc3a390426501e896d9d502408487.jpg"></p><p><strong>还有这个团伙使用的商务推广联盟 QQ1062790099</strong></p><p><img alt="" img-src="413ab7864979b0cf956eff3be01cb3b0d9d0f7af.jpg"></p><p><img alt="" img-src="5420dcf71a11dcd28309fe2208e5547ea986e0b5.jpg"></p><p><img alt="" img-src="32da66babf89ba8515f6d8652e3c8a1442569699.jpg"></p><p><strong>商务合作渠道QQ2797719791</strong></p><p><img alt="" img-src="dc3373eec79cb94037581622eaf5052541023221.jpg"></p><p>通过获取到的各方面信息，我们分析出了这个推广团伙的策略手段。首先他们会通过广告商购买渠道的广告展示量，这个过程中，他们会选择一些监管不严的广告商，使自己带有木马的广告不至于被发现。其次会选取客户端软件来展示广告，由于大多数浏览器会升级flash插件，会影响其木马传播。攻击者更青睐于防护脆弱的客户端软件，最后通过传播的下载者推广软件和广告变现。</p><h2>安全建议</h2><p>做为互联网的基础服务商，运营商应该注意自身行为，切莫使自己的商业广告行为成为木马传播的帮凶；而各大客户端软件，更应该注重用户计算机的安全体验，做好自身漏洞的修复，及时更新所使用的第三方插件，不要再因为已知的软件漏洞再给用户带来安全风险；作为责任的软件厂商，也需要积极推进流量数据加密，来预防在通信过程中被劫持的情况发生；对于广大用户来说，使用一款靠谱的安全软件，开启软件的实时防护尤为重要。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/13755" rel="bookmark" id="re1">云、管、端三重失守，大范围挂马攻击分析</a></li><li><a href="http://drops.wooyun.org/papers/6571" rel="bookmark" id="re2">黑客教你如何在微信强制诱导分享营销广告还不被封！</a></li><li><a href="http://drops.wooyun.org/papers/6788" rel="bookmark" id="re3">来自播放器的你——“中国插件联盟”木马分析</a></li><li><a href="http://drops.wooyun.org/papers/512" rel="bookmark" id="re4">Short XSS</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Kios</span> <span class="reply-time">2016-03-15 14:32:20</span></div><p></p><p>学习！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">123</span> <span class="reply-time">2016-03-14 21:08:21</span></div><p></p><p>@nuomi 缓存是啥你都不懂就开喷？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小表哥</span> <span class="reply-time">2016-03-13 23:04:00</span></div><p></p><p>把222.186.x.x屏蔽掉就能躲过全国一半的木马了，看了一眼drops里木马分析的文章，222.186没有一次缺席。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">hehe</span> <span class="reply-time">2016-03-13 22:21:32</span></div><p></p><p>@Tai7sy 结合之前分析菜刀后门的那篇文章，再说360没上传用户信息，我第一个用刀捅死他。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Tai7sy</span> <span class="reply-time">2016-03-12 00:12:13</span></div><p></p><p>只要你敢开360 他就能通过蛛丝马迹找到你的电脑,并且对你进行远控(屏幕,文件之类的都不在话下),别问我是怎么知道的.................<br>我被远程偷过文件,那边工程师还向我炫耀来着</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">包包</span> <span class="reply-time">2016-03-11 12:19:00</span></div><p></p><p>我一直是觉得大陆的ISP，就是流氓。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xy小雨</span> <span class="reply-time">2016-03-11 12:09:31</span></div><p></p><p>这个码打的我给你1分。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">tom</span> <span class="reply-time">2016-03-11 12:08:51</span></div><p></p><p>验证的逻辑感觉有问题， 总是提交失败</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">tom</span> <span class="reply-time">2016-03-11 12:07:57</span></div><p></p><p>站长的数据报表你们是怎么拿到的？黑了他们的会用么？还是 站长登录有漏洞？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">飘过-_-</span> <span class="weibo"></span> <span class="reply-time">2016-03-11 10:55:21</span></div><p></p><p>QQ号的打码很没诚意啊-_- http://t.cn/RGnQL0l</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">wukelele</span> <span class="reply-time">2016-03-11 10:23:05</span></div><p></p><p>牛逼360</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Mieless</span> <span class="reply-time">2016-03-11 01:03:05</span></div><p></p><p>运营商，呵呵</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">test</span> <span class="reply-time">2016-03-10 21:44:35</span></div><p></p><p>强行拉了把tx~这马打的也太不完全了~~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Chinalover</span> <span class="reply-time">2016-03-10 19:35:33</span></div><p></p><p>ISP劫持是运营商的锅吗</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">nuomi</span> <span class="reply-time">2016-03-10 19:35:05</span></div><p></p><p>去年年底开始，三大运营商疯狂缓存内容。<br>以前还是在本地缓存，现在直接在骨干网缓存了。<br>315 还不炸一下它们，以后更加无法无天。</p><p></p></div></div></div></div></div></main>