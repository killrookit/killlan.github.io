<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">iBackDoor(爱后门)和DroidBackDoor(安后门)：同时影响iOS和Android的”后门”SDK？</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">蒸米</a> <span class="bull">·</span> <time title="2015/11/05 10:11" ui-time="" datetime="2015/11/05 10:11" class="published ng-binding ng-isolate-scope">2015/11/05 10:11</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p><strong>作者：<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="18f08aa0ffa9ab58f180a7f19f94ffbfa3fd92b0fdb691fd9db0">[email&#160;protected]</a>，<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="4aacefd0afe4c30aa3d2f5a3cdc6afe2cba2c9cbacced5add5ef">[email&#160;protected]</a>，<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="ca22754f2275608a235275234d462d6d712f40622f64432f4f62">[email&#160;protected]</a></strong></p><h1>0x00 FireEye报告</h1><hr><p>iOS被XcodeGhost血洗一把之后，Android又被WormHole暴揍一顿。正当大家打算歇一歇的时候，FireEye的Zhaofeng等人又发表了一篇报告叫《iBackDoor: High-Risk Code Hits iOS Apps》。报告中指出FireEye的研究员发现了疑似”后门”行为的广告库mobiSage在上千个app中，并且这些app都是在苹果官方App Store上架的应用。通过服务端的控制，这些广告库可以做到：</p><ol><li>录音和截屏</li><li>上传GPS信息</li><li>增删改查app数据</li><li>读写app的钥匙链</li><li>发送数据到服务器</li><li>利用URL schemes打开其他app或者网页</li><li>安装企业应用</li></ol><p>FireEye的研究员一共在App Store上发现了2,846个app包含具有“后门”特征的mobiSage广告库。并且这些广告库会不断的向服务器端发送请求，并获取执行指令的JavaScript脚本。FireEye的研究员还发现mobiSage广告库一共有17 不同的版本从5.3.3到6.4.4。然而在最新的mobiSage SDK 7.0.5版本中已经将这些”后门”特征删掉了。</p><h1>0x01 iOS样本 - iBackDoor分析</h1><hr><p>看到FireEye的报告后，我们第一时间拿到了iOS上的app样本进行分析（注：在我们分析时，该样本还没有下架）。在广告库的类MSageCoreUIManagerPlugin中，我们的确发现了报告中所提到的各种控制功能。其中包括非常高危的获取录音、截屏功能以及读取修改字符串的函数。</p><p><img alt="enter image description here" img-src="424c05b98e6a8f11fb382be25e5a225d29d24ac2.jpg"></p><p>根据反编译的代码可以看到，iBackDoor在获取到服务器命令后会启动录音功能并将录音保存为audio_[编号].wav，并且可以通过sendHttpUpload函数将文件发送到服务器上。</p><p><img alt="enter image description here" img-src="3f88ddf2eda72b20b4a2446a1993bb953cbff8d2.jpg"></p><p><img alt="enter image description here" img-src="32f53c59b616c11d287943f082550a0bd779c99f.jpg"></p><p>iBackDoor还可以截取当前屏幕的内容，反编译代码如下：</p><p><img alt="enter image description here" img-src="56cc4804f51ae4fbe36cd7dbc502acb49db953aa.jpg"></p><p>iBackDoor还可以读取keychain的数据，也就是iOS上的app用来保存密码信息的容器：</p><p><img alt="enter image description here" img-src="52f1c24a44b84d594d1a593a671a294cb1caa948.jpg"></p><p>一个广告sdk，为什么需要录音，截屏和读取密码等功能呢？的确非常可疑。</p><p><img alt="enter image description here" img-src="48c7ef30008cdf38f264ff7882fc5ff1b5d43641.jpg"></p><p>除此之外，iBackDoor还可以根据服务器的指令调用任意的URL Schemes，也就是说XcodeGhost可以干的事情（打开钓鱼网页，安装企业应用等）iBackDoor也都可以干。比如如下是安装企业应用的反编译代码：</p><p><img alt="enter image description here" img-src="883e2980200b09e19ca7cfd8177969c5834b6764.jpg"></p><h1>0x02 数据流量分析</h1><hr><p>通过分析反汇编代码我们发现中了iBackDoor的app会根据本地的msageJS脚本执行相应的指令。除此之外，iBackDoor还会发送post请求到entry.adsage.com去检查更新，如果有新的JS命令脚本就会到mws.adsage.com下载。</p><p>于是我们分析了一下entry.adsage.com和mws.adsage.com的DNS解析和流量数据：</p><p><img alt="enter image description here" img-src="d7c0cde3caa927f01b68f1f19bb5b6152e236db9.jpg"></p><p>根据DNS解析趋势，可以看到每天请求的数据并没有太大的浮动。但有意思的是，在对流量的分析中，除了adv-ios-&#42;-min.zip外我们还发现了很多机器对adv-android-&#42;-min.zip的下载请求。难道除了iOS的app，android上的app也难逃魔爪？</p><p><img alt="enter image description here" img-src="951665278f9f4743f4b92fba2051f8fc4161badd.jpg"></p><p>并且这个请求的数量还不小，在我们有限的监测流量中，光九月份就有4亿多次对adsage.com的数据发送。并且，最近半年内至少有超过50000次对更新脚本adv-ios-&#42;-min.zip或adv-android-&#42;-min.zip的下载请求。</p><h1>0x03 Android样本 - DroidBackDoor分析</h1><hr><p>上文讲到了我们除了iOS的payload还发现了Android的payload，我们把这个payload下载下来一看，发现原来就是个动态加载的dex文件。这个dex文件包含了非常多的高危代码，我们把它称为DroidBackDoor。DroidBackDoor除了广告sdk都会做的获取手机各种信息，下载和安装任意apk外，还可以获取用户的坐标、打开任意网页、打电话、发短信等。</p><p>收集用户的imei，root信息，地理位置，wifi信息等几十种信息：</p><p><img alt="in1" img-src="aee9102d83e65f2fbda9cc8190a4dae6d817e09b.jpg"></p><p><img alt="in2" img-src="24533646293c7c42ea007b866aa47b45648a1ccd.jpg"></p><p><img alt="in3" img-src="e7cf847a0c6360d31a7fc901a8f402617c088188.jpg"></p><p><img alt="in4" img-src="f5497cdc43face016fe4425ea7301dbf9c76177e.jpg"></p><p><img alt="in5" img-src="cd61793de7cb9dbf1ce2e79e70e57e53efef0ef7.jpg"></p><p><img alt="in6" img-src="7b4ccd5da1a2e2e67b3d81d92772659fa46b1d67.jpg"></p><p><img alt="in7" img-src="10ad6ee2341ad8d33b97a5eaf1726dff0265ad32.jpg"></p><p>获取用户坐标的反汇编代码：</p><p><img alt="enter image description here" img-src="a453188955906ecdc6d5f75ebc5216d077c573da.jpg"></p><p>打开任意网页的反汇编代码：</p><p><img alt="enter image description here" img-src="e151f7678819f5f9f3b417d65437dc5e656d28e0.jpg"></p><p>打电话的反汇编代码：</p><p><img alt="enter image description here" img-src="8f7d827c1f6f0ba31a9fb1d5680f776826f8ab62.jpg"></p><p>发短信的反汇编代码：</p><p><img alt="enter image description here" img-src="7c96319c4b43b57a5ee9824872ccf9c79d863d64.jpg"></p><p>我们将提取的mobisage的特征去后台数据库查询，发现Android上也有超过2000款的app使用了mobisage的sdk。</p><h1>0x04 网站分析</h1><hr><p>通过相关域名网站(http://www.adsage.cn/index.html)，可以知道这家公司的名字叫艾德思奇，并且有很多知名的合作伙伴和案列。我们建议所有使用了这个SDK的厂商应立刻检查自己产品中是否被插入了高危风险的代码，以免被苹果下架。</p><h1>0x05 总结</h1><hr><p>虽然这次”后门”SDK同时影响了iOS和Android，但根据我们的数据分析结果发现影响力是远远不及XcodeGhost和WormHole的。所以用户不用太过担心，在受影响的app下架之前尽量不要安装不知名应用，并记得及时更新自己的app。</p><h1>0x06 参考资料</h1><hr><ol><li>https://www.fireeye.com/blog/threat-research/2015/11/ibackdoor_high-risk.html</li></ol><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/201507292354527496d304665a3c721617737c107e4e87.png" style="width:200px;height:200px"></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/2893" rel="bookmark" id="re1">Intent scheme URL attack</a></li><li><a href="http://drops.wooyun.org/tips/2736" rel="bookmark" id="re2">Samsung S Voice attack</a></li><li><a href="http://drops.wooyun.org/papers/5164" rel="bookmark" id="re3">Android SecureRandom漏洞详解</a></li><li><a href="http://drops.wooyun.org/papers/3030" rel="bookmark" id="re4">一只android短信控制马的简单分析</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">helloheike</span> <span class="reply-time">2016-03-17 12:13:25</span></div><p></p><p>DNS解析趋势和流量分析怎么做的, 有公网监听?</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zeif</span> <span class="reply-time">2016-02-24 11:28:29</span></div><p></p><p>我说呀，你这分析的不到位呀，DroidBackDoor你原文说</p><p>“DroidBackDoor除了广告sdk都会做的获取手机各种信息，下载和安装任意apk外，还可以获取用户的坐标、打开任意网页、打电话、发短信等”</p><p>这个，“用户的坐标、打开任意网页、打电话、发短信”等这个也是广告sdk里的内容好不。。</p><p>而且你说这是BackDoor，那么他的远程指令接收部分在哪？</p><p>这些发短信等等的功能是怎么触发的，，</p><p>你报告中，一样没说，只是把他功能代码罗列出来了，，</p><p>分析的不到位，下结论过早</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">aaa</span> <span class="reply-time">2015-12-06 15:49:19</span></div><p></p><p>@蒸米 图片中的/mobisage/sdk/v6/20150420/adv-android-1.8.5.1-min.zip下载的只有JS文件，能否告知下恶意dex文件的下载链接呢？感兴趣，想看看</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">aa</span> <span class="reply-time">2015-12-06 15:38:42</span></div><p></p><p>图片中的/mobisage/sdk/v6/20150420/adv-android-1.8.5.1-min.zip下载的只有JS文件，能否告知下恶意dex文件的下载链接呢？感兴趣，想看看</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sxyzbbs</span> <span class="reply-time">2015-11-07 15:54:26</span></div><p></p><p>国外新闻报道，那批中了iBackDoor的APP已经全部下架了。。。按苹果的标准就是属于恶意软件。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">aaa</span> <span class="reply-time">2015-11-05 14:35:17</span></div><p></p><p>&quot;FireEye的研究员还发现mobiSage广告库一共有17 不同的版本从5.3.3到6.4.4。然而在最新的mobiSage SDK 7.0.5版本中已经将这些”后门”特征删掉了。&quot;如果是广告sdk正常功能，为什么最新版又把这些&quot;后门&quot;特征删掉了呢？心里有鬼么？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">www</span> <span class="reply-time">2015-11-05 14:22:29</span></div><p></p><p>@www 后头带个呵呵，呵呵。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">www</span> <span class="reply-time">2015-11-05 14:21:20</span></div><p></p><p>建议作者看看微信公众号实现机制吧。这样的话腾讯系也全系下架了。<br>不要崇洋媚外，做事前自己想一想，不要别人说什么就做什么。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">www</span> <span class="reply-time">2015-11-05 14:14:43</span></div><p></p><p>那安卓下几乎没有可以上架的应用了。ios只是一家公司的标准，呵呵。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">www</span> <span class="reply-time">2015-11-05 14:03:15</span></div><p></p><p>国外FireEye公司的标题就是&quot;iBackDoor: High-Risk Code Hits iOS Apps&quot; 并且在文中明确使用了backdoor这个词。这几天他们已经将有问题的app报给了苹果，让我们看看苹果会不会下架这些app吧。如果下架的话，按苹果的标准就是侵犯隐私，这就没好什么说的了，除非你家的app不上AppStore，呵呵。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">key</span> <span class="reply-time">2015-11-05 13:59:11</span></div><p></p><p>是否是后门确实要打引号，因为后门本身就很难定性，有待商榷。但关于是否是恶意sdk，详细看看FireEye的报告和Apple的处理措施以及对就知道了，呵呵。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">www</span> <span class="reply-time">2015-11-05 13:52:22</span></div><p></p><p>很高兴国内已经开始越来越关注安全、隐私方面的问题！<br>对本文的一些见解：<br>1、关于后门，我专门百度了一下：后门程序一般是指那些绕过安全性控制而获取对程序或系统访问权的程序方法。IOS、安卓都有自己的安全机制，明显代码中所指的“恶意”、“高风险”操作都是需要用户同意的，不要以为苹果、谷歌很弱。。集成SDK时候也明确指明了所需权限及理由。再说也无法通过此方法获取超出安全限度的操作。<br>2、关于隐私，这个是个敏感话题，不乏有恶意收集者，借用Lookalike的思想“我们只知道您的画像，但却不会探究您现实中具体是谁”，如果不涉及通讯录、短信等类似记录，只是做定向投放标识，个人认为是良性的。关于侵犯隐私，最好可以能找到其利用数据“做恶”、“恶意收集”的证据，而不是直接定性。<br>3、关于严谨，我觉得乌云平台应该加入审核制度。避免不懂装懂、哗众取宠。注意文章用词，不要直接定性。<br>4、类似于这种具有行业性质的文章，建议发布前了解下行业知识，而不是说出“一个广告sdk，为什么需要录音，截屏和读取密码等功能呢？”等无知话语。<br>5、建议少配图，多看看书。以免丢了东家的面子。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">apple</span> <span class="reply-time">2015-11-05 13:17:21</span></div><p></p><p>这就是我不用android的原因，随便收集个人隐私还当成习以为常的事情。这些sdk厂商真够要脸的。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sxyzbbd</span> <span class="reply-time">2015-11-05 13:14:30</span></div><p></p><p>android用户早就被强暴惯了。。。已经觉得自己的隐私不算回事了。。。要知道iOS上连获取imei都会被下架的好么。。。在android上不要觉得大家都这么干就是对的！要尊重用户的隐私！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">chen23547</span> <span class="weibo"></span> <span class="reply-time">2015-11-05 12:10:53</span></div><p></p><p>在政府的纵容下，个人隐私在中国已经成为了一堆狗屁。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">TT</span> <span class="reply-time">2015-11-05 11:30:32</span></div><p></p><p>ios的咱们不懂，但硬拼凑上个安卓的，就有点牵强了。是不懂还是哗众取宠？做为技术人员这么弄合适嘛？<br>如果想哗众取宠，那就别搞这些截图，直接搞个新闻稿去忽悠大众更好。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">fwang</span> <span class="reply-time">2015-11-05 11:14:56</span></div><p></p><p>哗众取宠!阿里妈妈的吹鼓手而已!<br>所有的功能都是调用苹果公开的api!打电话、发短信都是要用户确认的,这是广告形式决定的!<br>一个广告sdk，为什么需要录音，截屏和读取密码等功能呢？的确非常可疑。<br>录音是使用麦克风,是一种语音互动的广告形式.(使用麦克风同样需要用户同意)<br>截屏是为了验证广告的正确展示<br>keychain是共享的存储区域,你们的密码不加密吗!</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">炯炯虾</span> <span class="reply-time">2015-11-05 11:12:40</span></div><p></p><p>阿里都拿来主义？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">呵呵</span> <span class="reply-time">2015-11-05 11:02:38</span></div><p></p><p>我就呵呵了，哪个平台不获取位置呢？不获取位置能精准定投吗？安卓这些操作都是申请了权限了。不打开任意网页怎么展示广告？发短信打电话也是调用系统界面有问题吗？麻烦研究下各种跨平台技术再来评测吧这些是为了更好的用户体验，谁也阻挡不了技术的进步。你也可以直接用你说的反汇编下载各个平台的sdk直接看，所有你看到的这些不良行为广告sdk本身就有，动态下载逻辑并不表示什么。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">tangzhushou</span> <span class="weibo"></span> <span class="reply-time">2015-11-05 11:01:30</span></div><p></p><p>个人认为安卓的几个截图有些牵强，应用都拉起来了，不算啥恶意行为 从onJsPrompt开始分析获取的隐私数据可能能勉强给他定性吧 但从广告和安卓特性的角度看，这一切又貌似又很正常</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ppt</span> <span class="reply-time">2015-11-05 10:59:24</span></div><p></p><p>holly</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ypzhou</span> <span class="reply-time">2015-11-05 10:34:35</span></div><p></p><p>我勒个去</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">蒸米</span> <span class="reply-time">2015-11-05 10:30:16</span></div><p></p><p>@猪猪侠 猪大大说的极是~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">楚安</span> <span class="weibo"></span> <span class="reply-time">2015-11-05 10:30:05</span></div><p></p><p>我们team第一次和蒸米团队合作</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">珈蓝夜宇</span> <span class="reply-time">2015-11-05 10:26:13</span></div><p></p><p>还是我的诺基亚安全,算了,我还是回火星去吧</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">猪猪侠</span> <span class="reply-time">2015-11-05 10:24:58</span></div><p></p><p>闲时收来急时用，平时想收不好碰。<br>一犹豫一徘徊，用时想收收不来。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ringzero</span> <span class="weibo"></span> <span class="reply-time">2015-11-05 10:20:26</span></div><p></p><p>闲时收来急时用，平时想收不好碰。一犹豫就一徘徊，用时想收收不来。大多数厂商也不知道收集用户数据拿来干嘛，只是看到BAT3都在收集，就顺便收了，反正以后能有用。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">HITMSC_Ukin</span> <span class="weibo"></span> <span class="reply-time">2015-11-05 10:17:24</span></div><p></p><p>神配图</p><p></p></div></div></div></div></div></main>