<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">利用d3.js对大数据资料进行可视化分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">insight-labs</a> <span class="bull">·</span> <time title="2013/12/19 18:18" ui-time="" datetime="2013/12/19 18:18" class="published ng-binding ng-isolate-scope">2013/12/19 18:18</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>作者: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="6d2c0319051f2d35">[email&#160;protected]</a> <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="4381e3222d372b31223b032a2d302a242b376e2f2221306d2c3124">[email&#160;protected]</a></p><h2>0x00 背景</h2><hr><p>对于前段时间流出的QQ群数据大家想必已经有所了解了，处理后大小将近100G，多达15亿条关系数据（QQ号，群内昵称，群号，群内权限，群内性别和年龄）和将近9000万条群信息（群号，群名，创建时间，群介绍），这些数据都是扁平化的2维表格结构，直接查询不能直接体现出用户和群之间的直接或者间接关系。通过数据可视化，可以把扁平结构的数据作为点和线连接起来，从而更加直观的显示出来从而进行分析。</p><p>d3.js是一个近年来推出的基于javascript的数据展示库，全称为Data Driven Document， 在浏览器数据展示领域的地位类似于通用js框架里的jQuery。d3.js的官网是d3js.org，大家可以在上面看到很多例子和应用。d3.js也是图形数据库neo4j所内置的数据展示工具。</p><p>说到图形数据库，其实正确的翻译应该是图数据库，图即所谓的Graph，来自于数学里的图论，比如四色定理和推销员过桥的问题（著名的NP问题之一）。图数据库着重于数据之间的关联和属性，对于关系错综复杂的关系分析效率很高。例如，我想知道谁是我朋友的朋友，并且他们有哪些朋友也认识我。对于这种问题，普通关系型数据库的计算复杂度是O(N^c)左右或者更高，N为选择范围的数据集合大小，你好友数量加上好友的好友的数量等，c为关系层数。图数据库的计算复杂度在O(N^2)左右或者更低，但是基本不会超过O(N^2)。图数据库对于复杂关系数据查询起来效率高的主要原因是在数据输入的时候就已经对关系进行了处理和索引，这样做在查询的时候具有很高的效率，但是在数据导入的时候会很慢。QQ群的15亿个关系在向图数据库neo4j里导入的时候花了3天都没弄完，也没有进度提示，所以后来我直接放弃了。</p><h2>0x01 数据处理</h2><hr><p>在QQ群和群成员关系里面，对于层数我是这么定义的：</p><pre><code>第1层：目标QQ加入的所有群  
第2层：目标QQ加入的所有群的所有成员  
第3层：目标QQ加入的所有群的所有成员加入的所有群  
.  
.  
.  
</code></pre><p>大家可以看出这样的查询是可以递归的，假设每个QQ号所加入的群数量和每个群的成员数量为N，那么查询3层数据时总计算量为<code>N*N*N</code>=n^3，所以当查询层数为c层的时候，计算复杂度是N^c。</p><p>前面说过，图数据库的计算复杂度一般在N^2以下，所以当使用普通的关系型数据库的时候，如果查询的层数不多，效率和图数据库比起来差不多，加上关系数据库自带的便于管理和导入导出的属性，所以我还是选择了mysql数据库。</p><p>对于QQ和QQ群之间的关系，每个QQ号都能加入群，一个群里也有很多QQ，基本都在几十到几百人，所以两个QQ号在同一个群里不一定代表他们的关系很紧密，换句话说QQ和QQ群之间的关系相对于QQ好友而言相对较弱。但是这并不代表我们从中不能分析出有用的资料，俗话说的好，大数据就像一座金矿，只有用力挖才能挖到金子。</p><p>d3.js支持多种数据格式，比如JSON,XML,CSV,HTML等，因为PHP的数组可以很简单的转换为JSON格式，所以我选择用PHP写API来获取JSON数据。QQ和QQ群是一种典型的图数据的应用，QQ和QQ群作为节点(node)，QQ加入了哪些群作为关系(link)，d3.js内置了一个功能很强大的内建布局，叫做Force-Directed Graph（受力导向图），后面简称为force。force布局模拟了一些基本的物理粒子原理，比如引力和斥力（确切的说是模拟了电磁力和引力，在离的远的时候会互相吸引，在离的近的时候斥力急剧增加），并且可以调节力的大小和受力距离等等，可以说是自由度相当高。关于d3.js的force布局，在官网有详细的API和不少例子，这里我就不贴代码了。</p><p>在force布局里面，数据源的JSON可以有很多种不同的格式和属性，但是基本格式如下:</p><pre><code>{"nodes":[{"num":10001,type:"qq"},{"num":12345678,type:"qun"}],"links":[{"source":"10001","target":"12345678","auth":1,"nick":"pony"}]} 
</code></pre><p>其中nodes数组对应的是节点列表，links对应的是关系列表。</p><p>每个节点可以有很多自定义属性，在d3.js可以针对每个节点存取节点的属性，比如我定义num是QQ号或者群号，type代表节点是QQ还是群，另外我在js里设定在type==‘qun’的时候显示群的图标，是qq的时候显示qq的图标。关系里面默认的属性有source和target，分别对应一个关系的两头，默认情况下关系里面的source和target对应的数字是节点在节点数组里面的位置index。但是我自定义成了qq号和群号。另外你也可以定义其他属性，比如auth代表这个QQ号在群里的权限，nick是群昵称。</p><p>对于QQ群这样的关系来说，基本上在第4层和以上的QQ和群的关系就比较弱了，所以为了提高查询速度和减少节点数量，我只查询2层关系（少么？不少，要想想有些群有超过500人……）。</p><p>首先，d3.js需要在浏览器里面运行，我的首选是Google Chrome，V8引擎的效率果然不错，在节点和关系不多的时候基本感觉不到延迟，后来在FF和IE11里面测试了一次，FF比Chrome卡一半左右，IE的话我只能呵呵了……</p><p>先拿小马哥做个测试，QQ号是霸气的10001。当d3.js导入完数据JSON的时候，各种节点会在屏幕上乱飞几秒钟，直到他们的力达到一个稳定的平衡点。结果如下:</p><p>说明：</p><pre><code>企鹅图标的节点代表QQ，群图标的节点是群(废话么)。  
每条线代表一个关系，一个QQ可以加入N个群，一个群也可以有N个QQ加入。  
线的颜色分别代表：  
土豪金：群主  
狗腿绿：群管理员  
屌丝蓝：群成员 
</code></pre><p>大家也可以看到，群主和管理员的关系线也比普通的群成员长一些，这是为了突出群内的重要成员的关系。</p><p>图标旁边自动标注了QQ号和群号，如果有的话还有群名。没有在QQ号旁边标注昵称是因为很多人加入不同的群使用的是不同昵称，所以把昵称放到了其他的地方显示。</p><p>在下图中大家可以隐约的看到，所有的关系都是以QQ 10001为起点的。</p><p><img alt="2013121917474689613.png" img-src="4e038281eef1fc5a5f28b4e3ab8d55e7d67dec66.jpg"></p><p>在图上节点是可以拖拽的，拖拽后会固定在你释放的地方。我们把几个群稍微拖的分开一点，关系就一目了然了</p><p><img alt="2013121917491099821.png" img-src="1a4bdead94eb64a404714aa1a80a42c97a302a70.jpg"></p><p>这个时候我们可以看到在目标的QQ群里也有很多共同QQ号，比如有些QQ号同时加入了2，3个群。群名显示的都是各种产品开发讨论群，这些同时加入2，3个产品群的人估计不是产品经理就是主管吧……</p><p><img alt="2013121917494053558.png" img-src="e4d8c0c2a43ed9c1e41d3edba3ebd07d81d55a7a.jpg"></p><p>鼠标悬停到群图标上可以看到群的详细信息(如果有的话)</p><p>图3.1<br><img alt="2013121917500358308.png" img-src="72c1a67057ac6d5f512e099d596be5db816e603f.jpg"></p><p>因为很多人在不同群里的昵称不一样，所以群内昵称等信息就只能放到link上面了，因为线比较细，所以鼠标比较难对准，这个功能还待修改。</p><p>这个家伙和小马哥一起同时在3个群里，好基友？</p><p>图4<br><img alt="2013121917502854910.png" img-src="1ae750e4df3fabb6bce99d59b2875ae0796952ef.jpg"></p><p>小马哥的QQ群信息展示完了，下面我们来看看更加实际的应用，比如把某圈子里的人找出来。我们先从某土豪大黑阔大牛的QQ号入手：</p><p>初始数据好多……此大黑阔加入的群够杂的，不过就是因为杂所以才能更深入的了解一个人的所有喜好。看看群名神马的，我好像看到了dota，XX国际俱乐部，web技术交流，XXsec等群……充分说明了此人……是个屌丝技术宅大黑阔，XX国际俱乐部又似乎带着那么种高大上的感觉……</p><p>图中错综复杂的各种关系组成了一朵朵盛开的菊花，向我们诉说着他的历史……</p><p><img alt="2013121917525168384.png" img-src="f59a1b08ef86fb4a6b77d22edf7f047b454b40df.jpg"></p><p>为了理清他那不堪回首的过去和关系网，我特地把浏览器窗口拖到第二个屏幕上，然后把群挨个分开。为了保护当事人的隐私，这张图我打码了。</p><p>这张图比较宽，建议大家下载下来放大看</p><p><img alt="2013121917540927073.png" img-src="f59fdd82a08cab4286268e408867e37aba7405b7.jpg"></p><h2>0x02 总结</h2><hr><p>假如把层数扩展到4层，不知能否筛选出中国所有黑阔的QQ号呢？至少我已经在这张图里看到了很多熟悉的名字和号码。</p><p>腾讯总是说漏洞早已修复，不存在问题了，广大网民放心，但实际上信息泄露这种事情，岂是你漏洞修复好了就结束了的事情？</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/2031" rel="bookmark" id="re1">上传文件的陷阱</a></li><li><a href="http://drops.wooyun.org/tips/2834" rel="bookmark" id="re2">HttpOnly 隐私嗅探器</a></li><li><a href="http://drops.wooyun.org/tips/150" rel="bookmark" id="re3">Browser Security-css、javascript</a></li><li><a href="http://drops.wooyun.org/tips/12681" rel="bookmark" id="re4">关于被动式扫描的碎碎念</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">村支书代表</span> <span class="reply-time">2016-03-12 13:28:52</span></div><p></p><p>@hunter 设置一下磁力，是因为磁力大大，相互作用导致一直停不下来的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">5300114591</span> <span class="reply-time">2016-01-15 01:12:31</span></div><p></p><p>1</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Mthy</span> <span class="reply-time">2015-11-28 02:01:51</span></div><p></p><p>@008 你会吗？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Mthy</span> <span class="reply-time">2015-11-28 02:01:12</span></div><p></p><p>近日被网友恶搞，想寻求怎么可以将此数据删除，让其查不到的方法，感谢！如若知晓，麻烦您联系一下Me-Q 38454255</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">008</span> <span class="reply-time">2015-11-18 16:31:43</span></div><p></p><p>不错</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ver007</span> <span class="reply-time">2015-07-17 21:03:08</span></div><p></p><p>@不拘一哥 源码我这边有就是没有查询语句</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">hunter</span> <span class="reply-time">2015-04-04 11:29:03</span></div><p></p><p>求个代码呗，大神！我在做大数据力导向图时，点数有3千，图半天都稳定不下来！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ver007</span> <span class="reply-time">2014-11-17 16:44:54</span></div><p></p><p>哥们源码能分享下吗</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">存在敏感词</span> <span class="reply-time">2014-08-07 17:16:21</span></div><p></p><p>这几天开发正好做类似的东西 帮助很大 非常感谢！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">付弘雪</span> <span class="reply-time">2014-07-23 21:41:01</span></div><p></p><p>我买了一份盗版的，过一阵把加密狗复制一个给你，i2 很nb的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">水煮豆豆</span> <span class="reply-time">2014-05-22 15:49:26</span></div><p></p><p>IBM i2 Analyst's Notebook<br>一个情报分析系统<br>CIA FBI等都在用</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">不好不坏</span> <span class="reply-time">2014-05-02 21:45:26</span></div><p></p><p>+1</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">nodexy</span> <span class="reply-time">2014-03-19 14:44:55</span></div><p></p><p>小马哥 有没有一种被人扒掉衣服的感觉呢？？？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">九九</span> <span class="reply-time">2014-01-14 21:31:42</span></div><p></p><p>I2是什么？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Ivan</span> <span class="reply-time">2014-01-14 15:17:35</span></div><p></p><p>很赞！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">g0t3n</span> <span class="reply-time">2014-01-14 14:16:37</span></div><p></p><p>我能说真的不错么~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">DragonEgg</span> <span class="reply-time">2014-01-13 14:27:34</span></div><p></p><p>6度人脉。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">廷廷</span> <span class="reply-time">2013-12-26 18:46:37</span></div><p></p><p>好思路~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">livers</span> <span class="reply-time">2013-12-24 09:58:01</span></div><p></p><p>真不错 你和A 是一个人么</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">insight-labs</span> <span class="reply-time">2013-12-23 20:23:58</span></div><p></p><p>加了个新功能，去掉只有单一连接的节点。可以用来区分一个圈子内的核心节点，比如同时加了很多群的QQ。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">酱油甲</span> <span class="reply-time">2013-12-23 11:21:38</span></div><p></p><p>密密麻麻……好恐怖……</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瘦蛟舞</span> <span class="reply-time">2013-12-23 09:43:29</span></div><p></p><p>密集恐惧。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">咖啡</span> <span class="reply-time">2013-12-22 11:55:31</span></div><p></p><p>好厉害，学习了#</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">insight-labs</span> <span class="reply-time">2013-12-20 16:18:39</span></div><p></p><p>不要在意那些细节</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">nyannyannyan</span> <span class="reply-time">2013-12-20 13:04:34</span></div><p></p><p>推销员过桥的问题（著名的NP问题之一）<br>= =<br>作为一个学理论计算机科学的表示正确的描述是....<br>旅行推销员问题（著名的NPC问题之一）</p><p>完全不知道过桥哪来的....</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">insight-labs</span> <span class="reply-time">2013-12-20 11:43:50</span></div><p></p><p>求</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">啦绯哥</span> <span class="reply-time">2013-12-20 10:01:59</span></div><p></p><p>一款收费的可视化情报分析产品，现在被IBM收购了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">insight-labs</span> <span class="reply-time">2013-12-20 07:15:30</span></div><p></p><p>I2是神马？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">啦绯哥</span> <span class="reply-time">2013-12-19 23:15:53</span></div><p></p><p>有点意思，前阵子数据入库后在I2中展示，感觉效果比这个要好点</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">dream</span> <span class="reply-time">2013-12-19 20:31:35</span></div><p></p><p>数据可视化，和二哥的《安全圈有多大？也许就这么大！》有一拼啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">国士无双</span> <span class="reply-time">2013-12-19 19:22:07</span></div><p></p><p>RUIN!</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xsser</span> <span class="reply-time">2013-12-19 18:29:20</span></div><p></p><p>表示蛋疼</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">疯狗</span> <span class="reply-time">2013-12-19 18:26:59</span></div><p></p><p>我勒个去，壮观啊，寻找嫖客群中</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">园长</span> <span class="reply-time">2013-12-19 18:21:22</span></div><p></p><p>密密麻麻，情何以堪.....</p><p></p></div></div></div></div></div></main>