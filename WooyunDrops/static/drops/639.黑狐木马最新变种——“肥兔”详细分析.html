<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">黑狐木马最新变种——“肥兔”详细分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">腾讯电脑管家</a> <span class="bull">·</span> <time title="2015/07/14 12:14" ui-time="" datetime="2015/07/14 12:14" class="published ng-binding ng-isolate-scope">2015/07/14 12:14</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 背景</h1><hr><p>近期，腾讯反病毒实验室拦截到了大量试图通过替换windows系统文件来感染系统的木马，经过回溯分析，发现其主要是通过伪装成“37游戏在线”等安装包进行推广传播，感染量巨大。该木马的主要功能是锁定浏览器主页和推广流氓软件，木马管家已经全面拦截和查杀。同时该木马与之前的“黑狐”木马在上报数据包、代码风格、服务器分布等有极大的相似性，可以确定是同一作者所为。而通过该木马多个样本的pdb路径，我们得知该木马项目名称为“肥兔”。</p><h1>0x01 功能简介</h1><hr><p>“肥兔”木马会通过多种方式向下推广，日均推广量10W+，推广后会通过替换系统文件而长期驻留在系统中，对系统稳定性和用户的隐私安全造成极大的威胁，目前该木马主要是通过流氓推广和浏览器锁主页来实现盈利，如果你的浏览器主页被改成www.2345.com/?32420，那么很可能就中了“肥兔”木马。</p><p><img alt="enter image description here" img-src="336047444a966174cd3b2d06587f576c71adc06b.jpg"></p><p>“肥兔”木马功能示意图</p><p><img alt="enter image description here" img-src="00c88267cc42c6f7f847e206a0bae02666cea7b0.jpg"></p><p>“肥兔”木马模块分工示意图</p><h1>0x02 木马作者背景分析</h1><hr><p>通过反查域名<code>tianxinli.org</code>、<code>3gfetion.com</code>得到注册信息如下：</p><pre><code>域名：tianxinli.org  
域名ID： D176563201-LROR
注册时间： 2015-06-15T06:27:28Z
更新时间： 2015-06-15T06:27:28Z
过期时间： 2016-06-15T06:27:28Z
域名所有者：yu ying
注册人邮件：<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="ec8e8394858d8394858d83ddd5d4d4acdddadfc28f8381">[email&#160;protected]</a>

域名： 3GFETION.COM
域名ID: 1938775105_DOMAIN_COM-VRSN
注册时间: 2015-06-15T07:23:07Z
更新时间: 2015-06-15T07:23:07Z
域名所有者: yu ying
注册人邮件: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="a4c6cbdccdc5cbdccdc5cb959d9c9ce49592978ac7cbc9">[email&#160;protected]</a>
</code></pre><p>两个域名是同一天注册，而且是同一个人持有。可以基本判定，网站持有者为病毒发布者。再通过对注册邮箱的反查，可以看到这个组织持有很多域名，并且，故意使持有者姓名不同，来对抗社工。</p><p>将所有<code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="aeccc1d6c7cfc1d6c7cfc19f979696ee9f989d80cdc1c3">[email&#160;protected]</a></code>注册的邮箱的手机号整理后，发现只指向两个号码。进而，通过手机号可以查到该组织成员的一些信息：</p><pre><code>陈*   QQ：383******   865*****    Tel：15869******   18067******    Email：<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="e7848f8289cda7d6d5d1c984888a">[email&#160;protected]</a>    <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="661f4c260b070f0a48">[email&#160;protected]</a>**.com
刘*   QQ：304******   185******   Tel：15957******   15869******    15957******  
</code></pre><p><img alt="enter image description here" img-src="850489828ca5765931dbbe7db05010621538c67a.jpg"></p><p><img alt="enter image description here" img-src="4baf529bbdd4515f6a75749a09e1ced86953d3e1.jpg"></p><p>在QQ上发现工作邮箱，顺手去看了下他们公司官网。</p><p><img alt="enter image description here" img-src="59171d647de1703f5151f1b2adbdd84df1508134.jpg"></p><p>公司域名是由张XX注册的，就查了下，结果：</p><p><img alt="enter image description here" img-src="1dfc9ce684d688daa222024e46253c0a7c985210.jpg"></p><p>可以看出，该公司是有过前科的，而且，刚好是做推广的，不得不怀疑下。</p><p>接下来，就不挖作者信息了，看看统计的后台，扫了下网站，发现源码泄漏。拿下源码看了看整站目录结构、命名并不那么规范。</p><p><img alt="enter image description here" img-src="88b94ec66e257b46aa1b8d62fe97da7856527c05.jpg"></p><p>tj.php是木马要访问的，跟进去发现，它每天都会对推广的数量进行统计。审计源码后，发现，其对要insert的数据没有做过滤处理。于是构造payload，用sqlmap跑起来。得到数据库表信息如下：</p><p><img alt="enter image description here" img-src="0bb08ec59656ba37cb70820804d4f183b1f8dd59.jpg"></p><p>后台每天新建一张表来统计当天安装日志以及前一天的上线日志。</p><p><img alt="enter image description here" img-src="9b097ae84c8a6d27fcffc7a20f4f07af77796d85.jpg"></p><p>随意Dump了其中一张表，看到一个惊人的安装数量：</p><p><img alt="enter image description here" img-src="872da38ab6d9b918767d2fe6ad70b44b55623a6c.jpg"></p><p>从后台数据可以看出，该木马从15年5月11日开始推广，平均日推广量10万以上，在2015年7月11日达到了64万之多。</p><h1>0x03 详细技术分析</h1><hr><p><strong>3.1 setup_3l.exe文件分析</strong></p><pre><code>样本MD5：fc4631e59cf1cf3a726e74f062e25c2e  描述：37最新游戏在线
</code></pre><p>样本运行后下载了一张图片http://less.3gfetion.com/logo.png，该图片尾部附加了大量的二进制数据，将其解密后得到一个名为FeiTuDll.dll的文件，并在内存中加载执行。这也是“肥兔”木马名字的来源，以下是FeiTuDll.dll文件的属性信息，以及PDB路劲信息。</p><p><img alt="enter image description here" img-src="929a0045297bedabe208590362d4897b5bad77e4.jpg"></p><p><img alt="enter image description here" img-src="f1ed05f906d558b2a7f997c052b37c3cb8a6bfad.jpg"></p><p><strong>3.2 FeiTuDll.dll 文件分析</strong></p><p>样本MD5：<code>a5b262da59a352b1c4470169183e094b</code> FeiTuDll.dll运行后，收集以下信息：</p><ol><li>通过int.dpool.sina.com.cn获取本机外网IP及归属地等信息</li><li>检测本机杀软安装情况：检测是否存在zhudongfangyu.exe等360系进程、QQPCTray.exe等管家系进程、kextray.exe等金山系进程；</li><li>检测本机是否为网吧机器：通过检测wanxiang.exe、yaoqianshu.exe等进程来判断是否是网吧机器；</li><li>本机MAC地址</li><li>本机操作系统版本</li></ol><p>收集完成后将信息提交到<code>http://count.tianxinli.org/player/tj.php</code></p><p>参数格式及说明如下：</p><pre><code>op=install （操作）
ri= （当前进程名）
mc= （MAC地址）
vs=1.0.0.1 （木马版本）
dq= （int.dpool.sina.com.cn返回的IP等信息）
sd= （杀毒软件情况：360SecurityGuard、QQhousekeep、KingSoft之一或组合）
os=（操作系统版本）
sc= （屏幕分辨率）
bar= （是否网吧 1：是 0：否）
tm= （当前时间戳）
key= （以上信息的MD5校验）
</code></pre><p>接收服务器返回的信息，判断是否含有“az”字符设置相应的标志，木马后台会根据提交的MAC信息判断此机器是否感染过，如果感染过则返回“az”，否则不返回任何信息。</p><p><img alt="enter image description here" img-src="fc665cfedc66ed1aac07ff86ee629fafc2cfd13d.jpg"></p><p>随后木马会下载“大天使之剑”的安装包到本地，并执行安装。</p><p><img alt="enter image description here" img-src="56375546374dbbc3c164609f47d5a0885e76b25e.jpg"></p><p>安装完成后根据之前是否返回“az”还决定随后行为，如果返回“az”则退出进程，不再有其它行为；如果未返回“az”，则进行以下行为：判断当前操作系统版本是32位或64位加载不同的资源文件，最终在临时目录下释放tmp.exe和yrd.tmp，在windows目录下释放yre.tmp，并将yrd.tmp文件路劲作为参数执行tmp.exe。完成以上行为后判断系统文件是否已经替换成功，并负责关闭windows文件保护相关的警告窗口。</p><p><img alt="enter image description here" img-src="8ebbed1dc8b86e1a84e1e9dca428b0f01b455c71.jpg"></p><p><img alt="enter image description here" img-src="77365a2524d20725a1b9c8962340ee751b4a5ab8.jpg"></p><p><strong>3.3 tmp.exe 文件分析</strong></p><p>根据操作系统类型，首先删除dllcache目录中的Sens.dll或Cscdll.dll（x86）；然后用yrd.tmp替换system32目录中的Sens.dll或Cscdll.dll（x86）。</p><p><strong>3.4 yrd.tmp （Sens.dll、Cscdll.dll）文件分析</strong></p><p>捕捉到的其中几个广度较大的变种MD5如下：</p><pre><code>f749521e9e380ecefec833d440400827
8ccf78082effa9cd3eaffbeb2a04039f
4bf8a7fd3a91e47d816cab694834be65
a18d30fef0a73cce4131faf2726adfdb
8c10cc9cde85457b081ecf7cba997019
</code></pre><p>该文件的PDB信息如下：</p><p><img alt="enter image description here" img-src="2e1cf8cfdc95611f19fe6402907ae0d26ed964da.jpg"></p><p>该文件在系统启动时会被winlogon进程加载，其功能是解密%windir%\yre.tmp文件并保存为%windir%\svchost.exe，最后将其执行两次，即创建两个进程。</p><p><img alt="enter image description here" img-src="16eb4f8c82b245824ecc96d8c67f6440baae89a4.jpg"></p><p><strong>3.5 %WinDir%\svchost.exe文件分析</strong></p><p>该文件pdb信息如下：</p><p><img alt="enter image description here" img-src="47e651bf1dc32ad1eb4cc373af95cc5144fdcdb2.jpg"></p><p>该文件同时被执行两次，根据互斥量来进行如下不同的分工：</p><p>1、先被执行的进程行为：</p><ol><li>释放LKS19.tmp驱动文件并加载</li><li>创建名为sysPipa的管道接收命令</li><li>与驱动进行通信，将命令传递给驱动</li></ol><p>2、后被执行的进程行为：</p><ol><li>获取本机各种信息发送到http://count.tianxinli.org/player/tj.php，参数格式与FeiTuDll.dll相同。</li><li>查找杀软进程，并将pid传递给sysPipa管道，用于结束杀软进程</li><li>从以下地址下载文件到本地执行，在本地存储为SVCH0ST.exe http:<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="4a65652e3d3232642823302223222e64292527650a0f097a79097f0e7b0f7378097f0f7e080b7e0e0c0c7c097b087f7a7d7d7b7c7e7e737d">[email&#160;protected]</a></li><li>关闭UAC</li></ol><p><img alt="enter image description here" img-src="de5d3a10dcf7866b5f80e7948c63361a3e48f064.jpg"></p><p><strong>3.6 驱动文件LKS19.tmp分析</strong></p><p><img alt="enter image description here" img-src="032a4af998cff55aa586f85faa661860f0df9a90.jpg"></p><p>该驱动文件具有以下功能：</p><ol><li>注册CreateProcess回调，通过给浏览器进程添加命令行的方式实现主页锁定</li><li>根据命令修改锁定的主页地址</li><li>根据命令，结束指定的进程</li><li>根据命令，hook指定的SSDT表函数</li></ol><p><strong>3.7 SVCH0ST.exe文件分析：</strong></p><p>该文件PDB信息如下：该模块的功能主要是通过百度有钱推广获利</p><p><img alt="enter image description here" img-src="a2dabdf140334df23b6c62f6bd89e8232eb35eab.jpg"></p><p>推广的软件列表如下：</p><p><img alt="enter image description here" img-src="a3e9aa662d5422dd73298b5d6098fa7d49c39508.jpg"></p><h1>0x04 查杀方式</h1><hr><p><img alt="enter image description here" img-src="a66cd169d6f6278e34195c4cc1ddea4d6082c1fa.jpg"></p><p>对于安装了电脑管家的用户，无需做任何处理，管家已经能够精准拦截该木马及其变种。</p><p><img alt="enter image description here" img-src="a7c6569570b3745ac431354f23b7211ca198c99a.jpg"></p><p>对于未安装管家而感染了该木马的用户，安装管家后使用闪电杀毒可完美清除该木马。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/9106" rel="bookmark" id="re1">WireShark黑客发现之旅（6）—“Lpk.dll劫持+ 飞客蠕虫”病毒</a></li><li><a href="http://drops.wooyun.org/papers/5463" rel="bookmark" id="re2">黑狐”木马分析报告</a></li><li><a href="http://drops.wooyun.org/papers/11718" rel="bookmark" id="re3">32C3 CTF 两个Web题目的Writeup</a></li><li><a href="http://drops.wooyun.org/papers/9251" rel="bookmark" id="re4">360MarvelTeam虚拟化漏洞第二弹 － CVE-2015-5279 漏洞分析</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xsser</span> <span class="reply-time">2015-07-15 12:05:45</span></div><p></p><p>飞兔</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小表哥</span> <span class="reply-time">2015-07-15 09:34:34</span></div><p></p><p>请问遇上uninst.exe被修改的，而且安全模式自启动的安全管家怎么卸载？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">看什麼看</span> <span class="reply-time">2015-07-15 00:30:21</span></div><p></p><p>signed by 張君浩。。。這是故意的嗎？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">167怪兽</span> <span class="reply-time">2015-07-14 22:21:00</span></div><p></p><p>好一个分析，又是默默的推广了腾讯电脑管家。。。。。</p><p></p></div></div></div></div></div></main>