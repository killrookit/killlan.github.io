<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">滥用Accessibility service自动安装应用</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">阿里移动安全</a> <span class="bull">·</span> <time title="2015/12/18 16:55" ui-time="" datetime="2015/12/18 16:55" class="published ng-binding ng-isolate-scope">2015/12/18 16:55</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p><strong>Author:<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="7d94fdfb98cac93d94e5c294faf19adac698f7d598d3f498f8d5">[email&#160;protected]</a></strong></p><h1>0x00 恶意应用简介</h1><hr><p>近年许多的android市场实现免root安装应用，也就是下载完成立即自动安装，而黑产界也同样利用该技术在进行恶意推广，静默安装。最近拦截到大量恶意应用利用系统AccessibilityService静默安装应用。一旦恶意的Accessibility服务被激活，恶意应用将弹出广告，即使用户关闭弹出的广告该应用程序也会在后台下载，随后自动安装推广的恶意应用。</p><h1>0x01 AccessibilityService介绍：</h1><hr><p>AccessibilityService作用：</p><p>Android Accessibility用于那些由于视力、听力或其它身体原因导致不能方便使用Android智能手机的用户，Android提供了Accessibility功能和服务帮助这些用户更加简单地操作设备。开发者可以搭建自己的Accessibility服务，这可以加强应用的可用性。开启AccessibilityService后应用通过它能实时地获取当前操作应用的窗口元素信息，并能够双向交互，既能获取用户的输入，也能对窗口元素进行操作，比如点击按钮。</p><p>AccessibilityService的使用场景：</p><p>Android应用市场使用android Accessibility来免root安装应用；近来火热的抢红包应用也用使用AccessibilityService自动抢红包。</p><h1>0x02 恶意应用分析</h1><hr><p>我们监测到一款名为“WiFi密码查看器(增强版)”的应用滥用AccessibilityService。应用启动后诱导用户开启“WIFI信号增强服”，其实就是开启恶意应用自身的AccessibilityService；以查看WIFI密码让恶意应用获得root权限，而这一切都是为该恶意自动安装做铺垫。下图是该应用运行图</p><p><img alt="p1" img-src="eec738a08c9735812c9ed6f01dbc52f00b25fd14.jpg"> <img alt="p2" img-src="2e3637f2053efd9cf76680b821bc77c182d8859e.jpg"> 图应用启动与引导开启wifi信号增强界面</p><p>应用启动后会引导用户开启WIFI信号增强服务。应用跳转到ACCESSIBILITY_SETTINGS界面，提示用户若要增强Wifi信号强度，请开启WIFI信号增强服务。用户启用恶意应用的该服务之后，手机将疯狂下载该应用云端准备的应用包，并且在手机上自动安装运行。</p><p><img alt="p3" img-src="32b86fe3d16e2abf61238e8f81bbdc55795e95c8.jpg"> <img alt="p4" img-src="9093c7838d6a09033333fec268e2c86b52b6c0e3.jpg"> 图启动Accessibilty Service界面</p><p>以下是恶意代码运行流程</p><p><img alt="p5" img-src="eb3e29ac6e923b9f9594017de3c1886397c17d6c.jpg"> 图恶意代码云信流程</p><p>流程图解析</p><ol><li>Wifi_list模块，恶意应用利用wifi信号增强诱导用户开启<code>Accessiblity Service</code>;查看Wifi密码诱导用户给该应用赋予Root权限。</li><li>PushDownLoad模块，该模块由<code>PushCoreService</code>和<code>ChapingCoreService</code>服务组成，它们利用后台服务上传设备信息，获取待Push的应用包，下载应用包。</li><li>安装模块，恶意应用解析下载成功的包，然后弹出<code>DialogPushActivity</code>的广告框，非Root利用 <code>AccessilbityService</code>安装，root利用 <code>pm install</code>完成静默安装</li><li>daemon模块， daemon是存放在raw目录下的elf文件，它是一个守护进程，保护应用不被杀死。daemon原理是fork出子进程之后，让子进程成为新的会话的领头进程，并与其父进程的会话组和进程组脱离，紧接着就是在子进程中定时去启动java层配置的任务。这里它保证 <code>PushCoreService</code>和<code>ChapingCoreService</code>一直在后台运行。</li></ol><p>以下对核心服务<code>PushCoreService</code>跟踪分析</p><p>首先向目标服务器Post设备的imei,wifimac,SerialNumber信息，服务器返回uuid,并记录在<code>DefaultSharedPreference</code>文件的”uuid”字段</p><p><img alt="p6" img-src="8ddc2ba161c0430f489c4d50adc4599514275fd2.jpg"> 图请求服务器获取uuid</p><p>上图最后调用<code>this.m_context.handler.sendEmptyMessage(1)</code>，启动线程GetPushThread线程。该线程向<code>http://api.findzhibo.com/ad/open?appCode=1&amp;appVersion=appVerion</code>请求获取当前应用的“open&#95;status”字段。只有“open&#95;status”字段为True时，云端服务器才会继续运行，否则表示当前应用版本对应的云端关闭。开启状态向<code>http://api.findzhibo.com/index.php/ad/push</code>，发送post请求，服务器返回待push的应用，写入“cc&#95;push&#95;sp.xml”的push_json字段</p><p><img alt="p7" img-src="32e5c8271d949f47762dd9ffaabadddf78802991.jpg"> 图云端恶意推广app的push_json</p><p><img alt="p8" img-src="9a7b4a5048f6fc94dfdb713b7263ab358a101778.jpg"> 图云端请求获取恶意推广应用</p><p>上图最后调用<code>this.m_context.handler.sendEmptyMessage(2)</code>,解析push_json字段填充intent,启动<code>PushDownloadService</code>进行应用下载和恶意广告页面弹出。<code>PushDownloadService</code>解析appJson,获取下载信息，随后通过handler消息对应用下载安装。</p><p><img alt="p9" img-src="7b68a4bb1d58a3210428cc10512b93a13735d90c.jpg"> 图解析appJson,进行下载安装</p><p>Handler存在4个msg.what值，‘3’处理下载失败；‘4’下载成功；‘5’弹出DialogPushActivity广告框若开启Accessiblity Service，启动WifiZengQiangService； ‘6’弹出DialogPushActivity广告框，启动恶意推广的应用。 首先发送“4“表示开始后台下载，随后启动下载安装的线程。该线程检查本次推送的应用是否已经被下载到指定目录，sdcard/.wifi_ckq保存下载的应用包以及广告图片，appName经过md5加密。</p><p><img alt="p10" img-src="a0e435d7af69cc603194f5dfcaaaa2cbf9d996f2.jpg"> 图sdcard目录存放下载的推广应用包</p><p><img alt="p11" img-src="13243b8d090255a00774b12532babeaa2a065c63.jpg"> 图下载恶意推广应用</p><p>下载完成后发送对应用静默安装，设备非root发送‘5’，root使用 pm install安装应用随后发送‘6’启动应用。</p><p><img alt="p12" img-src="cbd25864402c196a71e396f9f5cbb3fc1a70ee7d.jpg"> 图发送handler安装应用</p><p>handler ‘5’,’6’都会启动DialogPushActivity，</p><p><img alt="p13" img-src="7066f0aa05a89c656e88ed066be3eeb67521522d.jpg"> 图启动DialogPushActivity</p><p>DialogPushActivity其实就是一个ImageView，用户在触摸该界面后推送的应用将被自动安装</p><p><img alt="p14" img-src="79276d27cdefd8cd0e9c17633f23f9c15442ac05.jpg"> <img alt="p15" img-src="4f7fe56a9c793d3145a0952745a0ae305892ba05.jpg"> 图DialogPushActivity界面</p><p>启动WifiZengQiongService自动安装服务。之前的Ghosh Push,Kemoge等病毒家族，都是先对设备root然后植入推广应用。而该恶意应用的AccessibilityService一旦被启动，随后应用弹出恶意广告界面，即使受害者关闭弹出的广告，该应用程序也会被自动下载，随后成功安装。这个过程是调用系统的packageinstaller,获取安装界面的按钮位置，Accessibility提供的模拟用户点击功能，代替用户自动点击下一步，直到安装结束。下图是弹出的广告图，触碰后即可开始下载安装推广的应用。下图AccessibilityService里唤起安装界面</p><p><img alt="p16" img-src="43ecb00491b0f920f8f635e3096f455f48467f95.jpg"> 图调用系统packageInstaller</p><p>AccessibilityService的onAccessibilityEvent方法不仅处理’com.android.packageinstaller’ 的event,还处理一些安全软件，这样该恶意应用将会完全控制安全软件行为，也就意味着该应用可以自动安装，启动任意app，卸载任意应用，而且利用AccessibilityService控制安全软件进行免杀。</p><p><img alt="p17" img-src="4b962cf87543479860541d5868e0db4c758754e9.jpg"> 图AccessibilityService控制指定应用包</p><p>在推广的应用成功安装过后，系统将会发出<code>“android.intent.action.PACKAGE_ADDED”</code>广播消息，AppListenerReceiver类接受该广播并启动应用。</p><h1>0x03 总结与建议</h1><hr><p>到此滥用<code>AccessibilityService</code>过程分析完毕。该应用已增强WIFI信号诱惑用户启用<code>Accessibility</code>，以及查看WIFI密码是应用获取root权限。在此提醒用户谨慎给不受信应用开启<code>AccessibilityService</code>，以免被恶意应用控制；最近火热的抢红包应用也会利用<code>AccessibilityService</code>，实现自动抢功能，我们已发现黑客利用‘自动抢红包’诱导用户开启<code>AccessibilityService</code>控制手机，建议用户在安全渠道下载抢红包软件，以免不必要的损失。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/4386" rel="bookmark" id="re1">One git command may cause you hacked(CVE-2014-9390)</a></li><li><a href="http://drops.wooyun.org/tips/2736" rel="bookmark" id="re2">Samsung S Voice attack</a></li><li><a href="http://drops.wooyun.org/mobile/9055" rel="bookmark" id="re3">进击的短信拦截马</a></li><li><a href="http://drops.wooyun.org/papers/3030" rel="bookmark" id="re4">一只android短信控制马的简单分析</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">路过</span> <span class="reply-time">2015-12-29 17:15:32</span></div><p></p><p>厉害了。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">暗羽</span> <span class="reply-time">2015-12-21 17:21:43</span></div><p></p><p>@vfhe Accessibility可以模拟用户操作，可以看下这个演示视频：Shedun taking advantage of accessibility service—在线播放—优酷网，视频高清在线观看 http://v.youku.com/v_show/id_XMTM5Mzc2MDUwMA==.html<br>相当于是模拟用户完成了点击一步步安装</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zzzmode</span> <span class="reply-time">2015-12-19 19:48:04</span></div><p></p><p>卧槽，这想法不错。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">L.N.</span> <span class="reply-time">2015-12-19 12:45:52</span></div><p></p><p>虽然看不懂，但我知道我海就是吊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">vfhe</span> <span class="reply-time">2015-12-19 11:33:27</span></div><p></p><p>都有root权限了，自动安装当然很容易这跟accessibility有什么关系？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Smilent</span> <span class="reply-time">2015-12-18 23:44:08</span></div><p></p><p>我海就是吊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">厕所打灯笼</span> <span class="reply-time">2015-12-18 17:00:42</span></div><p></p><p>我海就是吊</p><p></p></div></div></div></div></div></main>