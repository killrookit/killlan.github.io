<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">搭建基于Suricata+Barnyard2+Base的IDS前端Snorby</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">rootsecurity</a> <span class="bull">·</span> <time title="2013/10/02 23:46" ui-time="" datetime="2013/10/02 23:46" class="published ng-binding ng-isolate-scope">2013/10/02 23:46</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00</h2><hr><p>关于CentOS+Base+Barnyard2+Suricata就不多说了，这里有文章已经写的很详细了。</p><p>请参考：<a href="http://drops.wooyun.org/tips/413">http://drops.wooyun.org/tips/413</a></p><h2>0x01</h2><hr><p>这里安装CentOS6系统同样是使用最小化安装，<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="84603f01612a0d6c2701c4c6e5f7e1">[email&#160;protected]</a> @Development Tools @Development Library</p><p>系统安装完毕后，初始化安装软件包</p><pre><code>[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="196b76766d5975767a787571766a6d">[email&#160;protected]</a> ~]#yum -y install libyaml libyaml-devel gcc gcc-c++ make file file-devel git libxslt-devel curl curl-devel ImageMagic ImageMagic-devel 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="592b36362d1935363a383531362a2d">[email&#160;protected]</a> ~]#yum -y install mysql mysql-libs mysql-server mysql-devel 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="8bf9e4e4ffcbe7e4e8eae7e3e4f8ff">[email&#160;protected]</a> ~]#/usr/bin/mysql_secure_installation 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="d5a7babaa195b9bab6b4b9bdbaa6a1">[email&#160;protected]</a> ~]#yum -y install httpd httpd-devel apr-utils php php-common php-cli php-pear php-curl php-mcrypt php-pecl php-devel  php-mysql 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="b9cbd6d6cdf9d5d6dad8d5d1d6cacd">[email&#160;protected]</a> ~]#ln -sf /usr/lib64/mysql /usr/lib/mysql 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="32405d5d46725e5d51535e5a5d4146">[email&#160;protected]</a> ~]#sed -i 's/Options Indexes FollowSymLinks/Options FollowSymLinks/g' /etc/httpd/conf/httpd.conf 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="ccbea3a3b88ca0a3afada0a4a3bfb8">[email&#160;protected]</a> ~]#sed -i 's/ServerTokens OS/ServerTokens Prod/g' /etc/httpd/conf/httpd.conf 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="cfbda0a0bb8fa3a0acaea3a7a0bcbb">[email&#160;protected]</a> ~]#sed -i 's/ServerAdmin <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="3c4e5353487c50535f5d5054534f48">[email&#160;protected]</a>/ServerAdmin <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="186b7d7b6d6a716c61587c7775797176367b7775">[email&#160;protected]</a>/g' /etc/httpd/conf/httpd.conf 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="10627f7f64507c7f73717c787f6364">[email&#160;protected]</a> ~]#/etc/init.d/httpd restart 
</code></pre><h2>0x02</h2><hr><p>安装Ruby:</p><pre><code>[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="a5d7cacad1e5c9cac6c4c9cdcad6d1">[email&#160;protected]</a> opt]#wget http://ftp.ruby-lang.org/pub/ruby/1.9/ruby-1.9.3-p327.tar.gz 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="691b06061d2905060a080501061a1d">[email&#160;protected]</a> opt]#tar zxvf ruby-1.9.3-p227/ 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="1a6875756e5a7675797b767275696e">[email&#160;protected]</a> ruby-1.9.3-p227]#./configure 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="fc8e939388bc90939f9d9094938f88">[email&#160;protected]</a> ruby-1.9.3-p227]#make &amp;&amp; make install 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="12607d7d66527e7d71737e7a7d6166">[email&#160;protected]</a> ruby-1.9.3-p227]#cd ../ 
</code></pre><p>安装openssl extensions</p><pre><code>[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="53213c3c27133f3c30323f3b3c2027">[email&#160;protected]</a> ~]#cd /opt/ 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="0b7964647f4b6764686a676364787f">[email&#160;protected]</a> opt]#cd ruby-1.9.3-p227/ext/openssl 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="a1d3ceced5e1cdcec2c0cdc9ced2d5">[email&#160;protected]</a> openssl]#ruby extconf.rb 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="53213c3c27133f3c30323f3b3c2027">[email&#160;protected]</a> openssl]#make &amp;&amp; make install 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="22504d4d56624e4d41434e4a4d5156">[email&#160;protected]</a> openssl]#cd ../../../ 
</code></pre><h2>0x03</h2><hr><p>安装rubygems</p><pre><code>[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="b7c5d8d8c3f7dbd8d4d6dbdfd8c4c3">[email&#160;protected]</a> ~]#cd /opt 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="2755484853674b4844464b4f485453">[email&#160;protected]</a> opt]#tar zxvf rubygems-1.8.24.tar.gz 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="a5d7cacad1e5c9cac6c4c9cdcad6d1">[email&#160;protected]</a> opt]#cd rubygems-1.8.24/ 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="deacb1b1aa9eb2b1bdbfb2b6b1adaa">[email&#160;protected]</a> opt]#ruby setup.rb 
</code></pre><p>更改gem源</p><pre><code>[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="a4d6cbcbd0e4c8cbc7c5c8cccbd7d0">[email&#160;protected]</a> ~]#gem sources -l 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="72001d1d06321e1d11131e1a1d0106">[email&#160;protected]</a> ~]#gem sources -r https://rubygems.org/ 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="20524f4f54604c4f43414c484f5354">[email&#160;protected]</a> ~]#gem sources –a http://ruby.taobao.org/ 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="addfc2c2d9edc1c2ceccc1c5c2ded9">[email&#160;protected]</a> ~]#gem sources -u 
</code></pre><p>安装gems包</p><pre><code>[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="e4968b8b90a4888b8785888c8b9790">[email&#160;protected]</a> ~]#gem install bundle 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="a5d7cacad1e5c9cac6c4c9cdcad6d1">[email&#160;protected]</a> ~]#gem install thor i18n bundler tzinfo builder memcache-client rack rack-test erubis mail rack-mount rails --no-rdoc --no-ri 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="c7b5a8a8b387aba8a4a6abafa8b4b3">[email&#160;protected]</a> ~]#gem install tzinfo-data 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="3d4f5252497d51525e5c5155524e49">[email&#160;protected]</a> ~]#gem install rake --version=0.9.2 --no-rdoc --no-ri 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="30425f5f44705c5f53515c585f4344">[email&#160;protected]</a> ~]#gem uninstall rake --version=0.9.2.2 
</code></pre><h2>0x04</h2><hr><p>安装wkhtmltopdf</p><pre><code>[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="9ceef3f3e8dcf0f3fffdf0f4f3efe8">[email&#160;protected]</a> ~]#cd /opt 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="f684999982b69a9995979a9e998582">[email&#160;protected]</a> ~]#wget http://wkhtmltopdf.googlecode.com/files/wkhtmltopdf-0.9.9-static-amd64.tar.bz2 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="62100d0d16220e0d01030e0a0d1116">[email&#160;protected]</a> ~]#tar jxvf wkhtmltopdf-0.9.9-static-amd64.tar.bz2 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="681a07071c2804070b090400071b1c">[email&#160;protected]</a> ~]#cp wkhtmltopdf-amd64 /usr/local/bin/wkhtmltopdf 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="c5b7aaaab185a9aaa6a4a9adaab6b1">[email&#160;protected]</a> ~]#chown root.root /usr/local/bin/wkhtmltopdf
</code></pre><h2>0x05</h2><hr><p>安装配置snorby:</p><pre><code>[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="9fedf0f0ebdff3f0fcfef3f7f0eceb">[email&#160;protected]</a> ~]#cd /var/www/html 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="80f2efeff4c0ecefe3e1ece8eff3f4">[email&#160;protected]</a> html]#git clone http://github.com/Snorby/snorby.git 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="d6a4b9b9a296bab9b5b7babeb9a5a2">[email&#160;protected]</a> html]#cd /var/www/html/snorby/config/ 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="44362b2b3004282b2725282c2b3730">[email&#160;protected]</a> config]#cp database.yml.example database.yml 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="e99b86869da985868a888581869a9d">[email&#160;protected]</a> config]#cp snorby_config.yml.example snorby_config.yml 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="f0829f9f84b09c9f93919c989f8384">[email&#160;protected]</a> config]#chown -R apache.apache /var/www/html/snorby/ 
</code></pre><p>修改database.yml，在“Enter Password Here”这里填入MySQL数据库的密码</p><p>修改snorby&#95;config.yml，把time&#95;zone前面的注释去掉，并把UTC改为Asia/Chongqing</p><pre><code>[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="41332e2e35012d2e22202d292e3235">[email&#160;protected]</a> config]#cd ../ 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="fb8994948fbb9794989a979388948f">[email&#160;protected]</a> snorby]#bundle exec rake snorby:setup 
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="43312c2c37032f2c20222f2b2c3037">[email&#160;protected]</a> snorby]#bundle exec rails server -e production &amp; 
</code></pre><p>此处开启http://0.0.0.0:3000端口的监听(此步骤需翻墙)</p><pre><code>[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="4c3e2323380c20232f2d2024233f38">[email&#160;protected]</a> snorby]#ruby script/delayed_job start RAILS_ENV=production 
</code></pre><p>此处开启snorby的进程</p><h2>0x06</h2><hr><p>关于Apache+mod_passenger</p><p>关于mod_passenger的配置：</p><p>为了方便访问，每次都手动输入3000端口显得非常麻烦，把ruby跟apache结合起来需要mod_passenger，安装过程如下：</p><p>1、 使用gem安装passenger</p><pre><code>[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="9deff2f2e9ddf1f2fefcf1f5f2eee9">[email&#160;protected]</a> ~]#gem install --no-ri --no-rdoc passenger 
</code></pre><p>2、 安装apache模块</p><pre><code>[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="96e4f9f9e2d6faf9f5f7fafef9e5e2">[email&#160;protected]</a> ~]#/usr/local/bin/passenger-install-apache2-module –a 
</code></pre><p>3、 配置apache</p><pre><code>[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="6e1c01011a2e02010d0f0206011d1a">[email&#160;protected]</a> ~]#cd /etc/httpd/conf.d/ 
</code></pre><p>4、 新建一个snorby.conf</p><pre><code>LoadModule
passenger_module /usr/local/lib/ruby/gems/1.9.1/gems/passenger-4.0.14/buildout/apache2/mod_passenger.so
PassengerRoot /usr/local/lib/ruby/gems/1.9.1/gems/passenger-4.0.14
PassengerDefaultRuby /usr/local/bin/ruby

&lt;VirtualHost *:80&gt; 
ServerName snorby.domain.com # !!! Be sure to point DocumentRoot to 'public'! 
DocumentRoot /var/www/html/snorby/public 
&lt;Directory /var/www/html/snorby/public&gt; # This relaxes Apache security settings. 
AllowOverride all # MultiViews must be turned off. Options -MultiViews 
&lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre><p>5、 重启apache</p><p>6、 界面</p><p><img alt="2013092911345386384.png" img-src="a945dbf0b19c661192693bd0e3ef8f7dc0e73783.jpg"></p><p><img alt="2013092911360595705.png" img-src="13dd2fc9817f4af48c6f89cab730305eae4fc1b5.jpg"></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">imlonghao</span> <span class="reply-time">2015-06-09 13:21:20</span></div><p></p><p>UI很好看~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">疯子</span> <span class="reply-time">2014-09-03 22:08:47</span></div><p></p><p>部署起来坑太多，！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">winsyk</span> <span class="reply-time">2013-10-08 17:48:24</span></div><p></p><p>文章部署起來坑不是一般的多。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">VIP</span> <span class="reply-time">2013-10-03 21:22:29</span></div><p></p><p>好东西</p><p></p></div></div></div></div></div></main>