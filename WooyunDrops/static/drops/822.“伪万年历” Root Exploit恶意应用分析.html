<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">“伪万年历” Root Exploit恶意应用分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">阿里移动安全</a> <span class="bull">·</span> <time title="2015/10/14 10:15" ui-time="" datetime="2015/10/14 10:15" class="published ng-binding ng-isolate-scope">2015/10/14 10:15</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>作者：逆巴，<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="dd345a573b6b729d344562345a513a7a66385775387354385875">[email&#160;protected]</a></p><h1>0x01 木马介绍</h1><hr><p>攻击者将木马制作成用户刚需应用，如色情类、生活服务类，或将恶意代码通过二次打包，注入到合法的应用当中，伪装成为合法应用，上传到android市场或某些论坛，诱导用户下载。一旦用户下载运行了此类应用，木马通过云端推送root 工具包，以及恶意应用；通过短信提取动态密码，第一时间发送给木马作者，直接造成财产损失、隐私泄露等；木马创建不死服务，后台root设备，成功root后将 恶意应用植入系统分区，用户即使恢复出厂设置也无法完全卸载木马。具体执行过程如下图：</p><p><img alt="" img-src="1e3ab39348c8e651ef941856473f38a9bd666e57.jpg"></p><p><strong>图木马执行流程</strong></p><p>被感染应用以及恶意样本数量过千类，以下列出“万年历，清涩笑话，特实惠, 魅力女生动态桌面，开心乐消消-欢乐版，内涵壁纸，开心乐消消，全网充话费，极致腿模，好听音乐，HoloTorch，情趣内涵电台，Accurate Battery，Super Silent，心情天气”</p><p><img alt="" img-src="af4227ebb1559eb353089560de4fabf9980afb51.jpg"></p><p><strong>图木马图标</strong></p><h1>0x02 样本行为分析</h1><hr><p>样本存在大量变种，以下对“伪万年历”样本进行行为分析。木马将恶意代码打包入正常应用。启动“伪万年历”应用后，进入正常的日历界面，而应用的Application 类作为恶意代码入口点。</p><p><img alt="" img-src="375365137f4cef6f2b4db46e93ce334411e89526.jpg"></p><p><strong>图“伪万年历”应用启动界面</strong></p><h2>2.1监听短信彩信，获取动态验证码</h2><p>提取短信中的动态密码，第一时间转发到指定号码并截断短信发送，这样用户将在不之情的情况下，大量账号被盗。拦截用户短信彩信，提取到的动态密码以及手机信息发送到云端服务器。直接造成财产损失，隐私泄露。</p><p>木马动态注册短信监听广播，通过类加载反射等技术进行具体的监控操作。当触发短信消息事件时,木马会动态加载myjar.jar，反射调用smscheck函数。</p><p><img alt="" img-src="2f44671c91bfff4c8a94e49ee135f6bb64fc1d88.jpg"></p><p><strong>图动态注册广播监听短信消息</strong></p><p><img alt="" img-src="ef11aba1142921fc3293ebb5d0d80b7c292b942e.jpg"></p><p><strong>图动态加载dex,反射调用smscheck函数</strong></p><p><img alt="" img-src="947ac9f40e0f33d2a7fb195f51d85d9e0d0033fd.jpg"></p><p><strong>图提取动态密码代码</strong></p><p>对smscheck函数分析，发现若拦截到的短信中存在动态密码，病毒会第一时间发送给指定号码，同时会将动态密码，以及当前手机信息作为参数post提交到云端服务器。<strong>也就是木马作者通过用户手机号码找回密码，这样轻松的盗取用户账号密码，而中马用户完全不知晓。</strong></p><p><img alt="" img-src="33f3f4acc7485ea104f5ea8561ab0880c9ce5987.jpg"></p><p><strong>图将动态密码发送到指定手机</strong></p><p><img alt="" img-src="9c355d6fca6206e6176f6b161b875986ecb73dbe.jpg"></p><p><strong>图将拦截到短信发送到指定服务器</strong></p><p>接下来过滤短信发送者，将短信内容，发送者手机号码，以及手机imsi等发post到指定服务器</p><p>跟踪发现服务器目录，存放了中马手机信息以及root手机的工具</p><p><img alt="" img-src="10a47595b78bc81a6d7c76760015632f7fff8bff.jpg"></p><p><strong>图服务器目录文件</strong></p><h2>2.2启动LocationService</h2><h3>a 监听广播，触发云端交互，下载root 工具包和推广的恶意应用</h3><p>LocationService开启任务线程，在任务线程里动态注册广播，监听网络变化，屏幕唤醒锁屏，应用安装卸载跟新等，监控广播做为病毒行为触发点。获取手机信息做为post参数，上传到云端服务器。 （android.net.conn.CONNECTIVITY&#95;CHANGE，android.intent.action.USER&#95;PRESENT，android.intent.action.SCREEN&#95;OFF，android.intent.action.SCREEN&#95;ON，android.intent.action.PACKAGE&#95;ADDED，android.intent.action.PACKAGE&#95;CHANGED， android.intent.action.PACKAGE&#95;REPLACED，android.intent.action.PACKAGE&#95;REMOVED）</p><p>接下来对病毒下载云端root 工具的分析。木马首先向服务器post手机的imei、imsi、分辨率、手机号等基本信息，服务器返回加密的url指令，解码url获取下载Root手机所需的busybox、su、install-recovery.sh等工具</p><p><img alt="" img-src="de7e2e5df88e0cdfda47706926c62ab8dd584e1f.jpg"></p><p><strong>图post 手机信息到服务器(<code>http://api.wangyan9488.com:8285/api/getShell.jsp</code>),返回加密url</strong></p><p><img alt="" img-src="113b9317680ed5d32f549d01dbd14b6a891a8815.jpg"></p><p><strong>图服务器返回的加密url</strong></p><p><img alt="" img-src="dd620c2576bb5cf43d2f385f16ab0c12618318bb.jpg"></p><p><strong>图shellv5.jar 里的文件 root 工具包</strong></p><p>木马本地解密url，获取到root 工具下载源（http://222.21x.xxx.7:8661/apk/rootsheel/1438654068044948.jar），下载到手机后改名为“shellv5.jar”，其实是一压缩包</p><p>采用同样的过程下载root sdk，访问服务器http://api.wangyan9488.com:8287/api/getAttach.jsp，获取加密url</p><p><img alt="" img-src="6ff6e65ddf959c3383f4ff25c759834604a77ab1.jpg"></p><p><strong>图加密root sdk url</strong></p><p>木马解密url，获取下载源(http://222.21x.xxx.x:8661/apk/dlapp/14386539787043206.jar)下载jar文件，下载到手机后改名为“dlv5.jar”。通过动态加载该文件中的dex文件，同时利用之前下载的工具获取Root权限，随后将同名文件名的apk文件植入到/system/app/下并安装。该apk伪装成系统“下载服务”，而自身是与母样本伪万年历相同行为的木马。</p><h3>b 强制激活设备管理，防止卸载</h3><p>利用设备管理器缺陷，在取消激活设备管理之前，DevicePolicyManagerService会调用应用的onDisableRequested方法获取取消激活的警示信息。下图可以发现病毒在发现取消激活时，会进行屏幕锁屏之后进入系统setting 页面，这样一旦用户激活设备将无法卸载。</p><p><img alt="" img-src="32ee487bf866ac6ca3975799ac1e10e26a5e9c94.jpg"></p><p><strong>图取消设备管理时屏幕锁屏</strong></p><h3>c 最后启动另外一个核心服务blueService</h3><p><img alt="" img-src="1c882c470b60611ec285a77a77c2d2ae512dfbce.jpg"></p><p><strong>图启动BlueService服务</strong></p><h2>2.3 blueService服务</h2><h3>a 强制安装ANDROID&#95;SCREEN&#95;ON_OFF.apk应用</h3><p>伪装成系统“下载管理”应用，同样通过post手机信息到云端服务器，get加密后的url，然后本地解密url获取下载推广的应用。同样的代码模块激活设备管理防止卸载。</p><p><img alt="" img-src="77da3021629221b6ca42ef8db0af82459d8d06c8.jpg"></p><p><strong>图“下载管理”应用</strong></p><p><img alt="" img-src="9a0f2e1727dd9ac754d7a6555f0f9e8943a0940f.jpg"></p><p><strong>图“下载管理”激活设备管理</strong></p><h3>b root 手机</h3><p>下图为BlueService服务的任务线程，红色框动态注册RootReciver，当网络发生变化或手机锁屏唤醒时，在后台尝试root。</p><p><img alt="" img-src="217ae8683ad7f42d39437c83571cf90e8e0aaa0e.jpg"></p><p><strong>图blueService服务任务线程代码</strong></p><p>检测14425728404326709.apk是否被安装，其实这是root之后安装到系统目录下的文件，root的最终目的就是将恶意应用植入system目录，伪装成系统应用，长期驻留用户设备。木马通过DexClassLoader加载云端配置的rootDex,随后反射调用getDex 函数进行root工作。下图动态加载dex,反射调用getDex</p><p><img alt="" img-src="2876633657a5386bb7f65baa5930d84daf6a4431.jpg"></p><p><strong>图动态加载dex,反射调用getDex</strong></p><p>将云端下载到sdcard/.xxx目录里的busybox,su 拷贝到应用文件目录，创建aa.xml文件表示开始进行root 工作。下图创建开始root文件</p><p><img alt="" img-src="49aac7d75673331d8c3a8251ede1b0d2dac1474e.jpg"></p><p><strong>图创建开始root的flag文件</strong></p><p>将云端下载在xxx目录下的root 工具，拷贝到data/files目录下，并在files目录下创建psneuter.js</p><p><img alt="" img-src="d862996187336d34e3b7b5f17269663d6c820bcc.jpg"></p><p><strong>图拷贝root 工具</strong></p><p>root成功后将14425728404326709.apk 安装到system/app目录并启动该应用。动态拦截发现，本次分析下载的root sdk 工具包，应该是刷机大师的MTK ROOT方案。由于云端配置灵活，下载获取的root工具包灵活（根据手机版本等信息，下载不同root工具包）。</p><p><img alt="" img-src="de7b2dbff8098f58bb8bdc3f8cc58ade3e011138.jpg"></p><p><strong>图root 手机代码</strong></p><p><img alt="" img-src="b77be0956d86a9fd88c695aecb589d5738e484c9.jpg"></p><p><strong>图动态拦截返回</strong></p><ol><li><code>suc f0h5zguZ9aJXbCZExMaN2kDhh6V0Uw== /system/bin/sh psneuter.js</code></li><li><code>suc al1s7jBFNtn9faBmC0Jb9A9Ns1GZSg== /system/bin/sh psneuter.js</code></li><li><code>suc HygZRm2IHTKWpp7Hll/sS0uY66xdcw== /system/bin/sh psneuter.js</code></li></ol><p>成功root后执行psneuter.js，木马将成功伪装成系统应用隐藏在用户手机，即使恢复出厂设置也无法卸载。</p><p>psneuter.js文件内容</p><pre><code>#!bash
#!/system/bin/sh
mount -o rw,remount /system
/data/local/tmp/busybox mount -o rw,remount /system
cat /data/local/tmp/14425728404326709.apk &gt; /system/app/14425728404326709.apk
chmod 0644 /system/app/14425728404326709.apk
pm install /system/app/14425728404326709.apk
mount -o ro,remount /system
/data/local/tmp/busybox mount -o ro,remount /system
echo "Now, script finish!”
</code></pre><p><img alt="" img-src="065c58bba946f31c2fb7195181906d5e0a0ba365.jpg"></p><p><strong>图 root成功木马伪装系统软件“下载服务”</strong></p><h3>c 不死服务LocationService, BlueService</h3><p>只要保证两大核心服务LocationService，BlueService 不死，就可以一直在后台执行恶意代码。木马在启动核型服务LocationService,BlueService的同时，会注册守护广播，保证核心服务一直启动。</p><p><img alt="" img-src="d3d4fa500bf4b130c0fa99bc4b624307a0c1d6b9.jpg"></p><p><strong>图启动LocationService服务同时注册守护广播</strong></p><p>守护服务的广播，通过监听屏幕开关、手机电量变化、时间更改，启动被保护的服务。</p><p><img alt="" img-src="85da5fa796dd9478b9b2c966e6b852571f4b8106.jpg"></p><p><strong>图守护广播监听的消息</strong></p><h1>0x03 变种追踪</h1><hr><p>该样本存在大量变种，且都是由LocationService,BlueService核心服务演变而来，从最开始的恶意应用推广到云端root sdk配置，升级到通过短信盗号，对抗杀软检测在native层检测运行环境等。</p><p>对变种木马“内涵壁纸”样本分析，首先在native层检查运行环境，若不是模拟器才启动恶意广播。这样有效的躲避了动态引擎检测，以及逆向分析人员分析。</p><p><img alt="" img-src="6738d721266ccf7098a685af44e21f5b591db824.jpg"></p><p><strong>图native层启动恶意广播</strong></p><p>模拟器检查，若木马运行环境在模拟器内，木马将不会启动恶意广播。模拟检查主要检查cpuinfo是否为goldfish，设备IDS是不是 “000000000000000”， imsi id是不是“310260000000000“，手机运营商等。</p><p><img alt="" img-src="dcd24f52bcef733fd8bef4b97944f287c2d02377.jpg"></p><p><strong>图模拟器检测</strong></p><h1>0x04 建议和解决方案</h1><hr><ol><li><p>使用加固手段增加被恶意者二次打包的成本：如使用阿里聚安全应用加固方案，无需开发者修改源代码或者二次开发，通过加壳，加密，逻辑混淆，代码隐藏等各类应用加固方法，防止应用被逆向分析，反编译，以及二次打包嵌入各类病毒广告等恶意代码。</p></li><li><p>用户下载应用请到官方网站或安全应用市场，切勿点击任何色情链接，尤其是短信、QQ、微信等聊天工具中不熟识的“朋友”发来的链接。</p></li><li><p>如果不确定手机是否毒，可以安装阿里钱盾等手机安全软件，对手机上的应用进行检测，防止高风险恶意应用的安装。</p></li></ol><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/2893" rel="bookmark" id="re1">Intent scheme URL attack</a></li><li><a href="http://drops.wooyun.org/mobile/9055" rel="bookmark" id="re2">进击的短信拦截马</a></li><li><a href="http://drops.wooyun.org/tips/2736" rel="bookmark" id="re3">Samsung S Voice attack</a></li><li><a href="http://drops.wooyun.org/papers/6632" rel="bookmark" id="re4">三星默认输入法远程代码执行</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Seven.Sea</span> <span class="reply-time">2015-12-14 14:26:35</span></div><p></p><p>求样本</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">呆</span> <span class="reply-time">2015-12-01 21:30:24</span></div><p></p><p>凶</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Arya</span> <span class="reply-time">2015-10-20 11:54:15</span></div><p></p><p>学习</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">一升米雾</span> <span class="reply-time">2015-10-15 00:35:53</span></div><p></p><p>高手</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">菜鸟</span> <span class="reply-time">2015-10-14 12:23:05</span></div><p></p><p>厉害</p><p></p></div></div></div></div></div></main>