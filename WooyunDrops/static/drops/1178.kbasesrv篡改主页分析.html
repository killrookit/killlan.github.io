<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">kbasesrv篡改主页分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">人马座实验室</a> <span class="bull">·</span> <time title="2016/04/29 14:33" ui-time="" datetime="2016/04/29 14:33" class="published ng-binding ng-isolate-scope">2016/04/29 14:33</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 前言</h1><hr><p>话说最近浏览器首页莫名其妙变成了金山毒霸网址大全，本来以为是运营商劫持，但仔细排查一遍，才发现是一个名叫kbasesrv的程序在搞鬼，它的数字签名是“Beijing Kingsoft Security software Co.,Ltd”，确定是金山旗下的软件无疑。</p><p>主页劫持本来已经见怪不怪了，一般是推广联盟的渠道商为了赚钱而各种手段无所不用其极，但是像金山这样的名门大厂亲自动手偷偷摸摸篡改主页的，还真是比较少见。今天是429首都网络安全日，一家安全公司却干起了流氓软件的行当，不能不说是一种莫大的讽刺。</p><h1>0x01 分析</h1><hr><p>闲话少叙，接下来深入扒一扒kbasesrv究竟是怎样偷偷篡改主页的：</p><p><img alt="" img-src="4c602555f0743d7c07a2d33730ee34faeb934d23.jpg"></p><p>程序MD5：318330C02C334D9B51F3C88027C4787C</p><p>程序SHA1：A6253F2C2DE7FB970562A54ED4EC0513BE350C66</p><p>该程序由金山旗下软件静默下载安装到电脑里，并用特定参数启动。参数形式如下：</p><p><code>-tid1:30 -tid2:10 -tod1:24 -tod2:27 -xxlock:68_upd3</code></p><p>其中前面的tid1、tid2、tod1、tod2这4个参数固定不变。最后一个xxlock参数会根据推送软件的不同而有所不同，根据网上搜集相关情况和实测验证，目前发现的推广参数统计结果如下：</p><table><thead><tr><th>-xxlock参数值</th><th>对应发起推广的软件</th></tr></thead><tbody><tr><td>68_upd</td><td>金山词霸</td></tr><tr><td>68_upd2</td><td>PPT美化大师</td></tr><tr><td>68_upd3</td><td>WPS</td></tr><tr><td>88dg_upd</td><td>驱动精灵</td></tr></tbody></table><p>给参数后，软件全程静默安装并篡改首页（无参数情况下启动也是静默安装，但不篡改首页）。仅仅是在桌面上释放一个名为“网址导航”的快捷方式。</p><p><img alt="" img-src="76cb465ee46eafc072ea0eb95f16fd5b7b11c224.jpg"></p><p>而这是快捷方式对应的程序目录（目录内所有可执行程序均带有有效的金山公司数字签名，这里就不一一贴出了）：</p><p><img alt="" img-src="3a2ca6ec4164abdec37862c6899c4e10901550d0.jpg"></p><p>当然，必须要承认该软件还是非常“守规矩”地在系统的“添加/删除程序”面板中放置了对应的卸载项的（至于用户能不能猜到是这个kbasesrv，他们可能就不是特别关心了）。</p><p><img alt="" img-src="9cad3e72233210c700c4043ba1f11fb0a3ee591a.jpg"></p><p>双击打开桌面的快捷方式，会启动IE浏览器并访问“毒霸网址大全”：</p><p><img alt="" img-src="b714758749f1260b4cfc8cd5af01d28ab634421d.jpg"></p><p>至此，如果仅仅是释放一个快捷方式，推广一下自己的导航站，或许还情有可原，但事情并不这么简单。该程序还在系统的桌面进程（explorer.exe）中注入了自己的三个dll文件用以劫持桌面操作——尤其是劫持用户双击运行程序的操作。</p><p><img alt="" img-src="56826a2df56dd54db6d1948518f73ba76b3a890e.jpg"></p><p>其中最下面的“knb3rdhmpg.dll”文件（MD5:5A2CCE5BF78C8D0D8C7F9254376A2C46; SHA1: F1EDBCA2065B0B951344987B59F33387804F32BA）中更是大大方方的直接硬编</p><p>码了待推广的网址：</p><p><img alt="" img-src="c84e2a4ac8362d394c16ad69bb3ee28da613e9e9.jpg"></p><p>同时也列出了大量需要“特别对待”的程序：</p><p><img alt="" img-src="11bec9e6f304beb07f57c987105f8ec55a5bab30.jpg"></p><p><img alt="" img-src="2b57dd2d3c4569fc897d323b813c48262b15ee0d.jpg"></p><p><img alt="" img-src="d02e143237773730e054142ced8a6d59da632064.jpg"></p><p>为了验证效果，特意在测试机器中安装了几个比较有代表性的浏览器。可以看到所有快捷方式后面都是没有任何启动参数的，也就是说在干净的环境里双击启动这些浏览器，他们都会打开默认的主页：</p><p><img alt="" img-src="d6c00fd95450588db06a0861c9bcc6f195a84f8e.jpg"></p><p>但是在双击运行这些浏览器的时候，打开的主页却都变成了“毒霸网址大全”</p><p><img alt="" img-src="48ab349df1e9489011d26bc3b1a18846c5e229ae.jpg"></p><p>手法则很简单，因为已经注入了桌面进程，所以只需要在用户双击启动浏览器的时候，悄悄的在桌面进程向对应浏览器主程序发送启动消息的时候插入一条参数就万事大吉了：</p><p><img alt="" img-src="e153e3568a8b58f04848b268cd8ae1d2d4ba0565.jpg"></p><p><img alt="" img-src="30321f7681203fbc7a64f0234c111404fd4133de.jpg"></p><p><img alt="" img-src="13bf8d08fb1c377fbf0494698ad917328bf51fd3.jpg"></p><p><img alt="" img-src="ea51e2a62f2563569a692979618c85133d00e633.jpg"></p><h1>0x02 结语</h1><hr><p>所谓能力越大，责任越大。安全软件作为系统的守护神，名正言顺地拥有系统的高权限，也背负着众多用户的信任。金山却偷偷动用旗下多款软件静默安装流氓软件，而很多用户还蒙在鼓里，不知道该怎么设置回自己习惯的主页。</p><p>若要人不知，除非己莫为。我就想问问金山，无论kbasesrv强奸了多少主页，为金山增加了多少收入，与丢掉的那些用户信任相比，真的值得吗？</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Erised</span> <span class="reply-time">2016-05-05 13:39:23</span></div><p></p><p>流氓太多..</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Mark</span> <span class="reply-time">2016-05-03 16:51:04</span></div><p></p><p>我就喜欢我能看的懂的，ps 求样本</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">打到js</span> <span class="reply-time">2016-05-01 18:47:57</span></div><p></p><p>我的是被词霸丢了一个“爱淘宝”的快捷方式在桌面上。 没有犹豫， 卸载！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">铃儿响叮当-hue</span> <span class="weibo"></span> <span class="reply-time">2016-04-30 09:12:30</span></div><p></p><p>万能的博主，怎么改回来。。主页被毒霸篡改了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">推翻金山</span> <span class="reply-time">2016-04-30 06:42:33</span></div><p></p><p>打倒金山！！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">L_future</span> <span class="weibo"></span> <span class="reply-time">2016-04-29 18:15:24</span></div><p></p><p>金山就是干这事的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">goodshell_NT</span> <span class="weibo"></span> <span class="reply-time">2016-04-29 16:37:18</span></div><p></p><p>正常，前两天路由器灯狂闪，管理器一看毒霸每秒500kb跑数据，即不升级软件又不升级病毒库，这么跑数据正常吗？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Google文化学院</span> <span class="weibo"></span> <span class="reply-time">2016-04-29 16:11:49</span></div><p></p><p>金山安全产品已经边缘化了，锁主页，呵呵</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">战神白云</span> <span class="weibo"></span> <span class="reply-time">2016-04-29 16:11:49</span></div><p></p><p>金山安全产品已经边缘化了，锁主页，呵呵</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">总架构师</span> <span class="weibo"></span> <span class="reply-time">2016-04-29 16:11:49</span></div><p></p><p>金山安全产品已经边缘化了，锁主页，呵呵</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">江木木king</span> <span class="weibo"></span> <span class="reply-time">2016-04-29 15:43:47</span></div><p></p><p>那个姓傅的，在360的时候数字流氓，现在去了金山了，独霸也开始流氓了，真小人一个</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sst</span> <span class="reply-time">2016-04-29 15:13:34</span></div><p></p><p>你这分析的太简单了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">叁無軍師</span> <span class="weibo"></span> <span class="reply-time">2016-04-29 15:03:52</span></div><p></p><p>装一个WPS，送一个全家桶？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">毒食物</span> <span class="weibo"></span> <span class="reply-time">2016-04-29 14:54:39</span></div><p></p><p>真的很无耻了。求个推荐</p><p></p></div></div></div></div></div></main>