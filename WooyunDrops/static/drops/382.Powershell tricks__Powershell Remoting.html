<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Powershell tricks::Powershell Remoting</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">DM_</a> <span class="bull">·</span> <time title="2014/11/03 10:03" ui-time="" datetime="2014/11/03 10:03" class="published ng-binding ng-isolate-scope">2014/11/03 10:03</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x01 简介</h2><hr><p>Powershell Remoting建立在windows WinRM服务之上，可以一对一或一对多远程控制，也可以建立HTTP 或 HTTPS的“listeners”，使用WS-MAM协议接收远程传递的命令。</p><p>Windows 远程管理(WinRM)是 WS-Management 协议的 Microsoft 实现，该协议为使用 Web 服务的本地计算机和远程计算机之间的通信提供了一种安全的方式。 也就是说在WS-MAN协议基础上，客户端运行环境可以多样化。 比如<a href="https://github.com/Openwsman/openwsman">openwsman</a>。</p><p><img alt="enter image description here" img-src="d128a7364fd5adb95c880f5888274a64860d7bd3.jpg"></p><p>图片来源：v3 Secrets of PowerShell Remoting</p><h2>0x02 远程管理</h2><hr><p>Powershell Remoting在windows server 2008以前默认是不开启的，需要通过administrator用户执行Enable-PSRemoting命令开启。</p><p><img alt="enter image description here" img-src="0c88e1c81ee0fed6487f307c93362f45094c359f.jpg"></p><p>在windows server 2012中，Powershell Remoting默认开启。</p><p>在windows下，powershell默认使用winrm进行远程管理，winrm版本不同默认的监听端口也不同。如下：</p><blockquote><p>The default ports for winrm 1.1 are http port 80 and https port 443</p><p>The default ports for winrm 2.x are http port 5985 and https port 5986</p></blockquote><p>可以在参考<a href="http://technet.microsoft.com/en-us/library/ff520073(WS.10).aspx">这里</a>判断winrm版本。</p><p>通过<code>Enable-PSRemoting</code>命令打开PS远程，默认是启动了Kerberos认证。这个方法只适合两台电脑在相同域或信任域内的指定电脑（名字可以带后缀）.但它不支持跨域、域外或IP地址。</p><p>如果要跨域、或指定IP地址执行时我们可以在客户端这里执行下面的代码，需要将所有或单一远程主机添加在信任表中。</p><pre><code>Set-Item WSMan:\localhost\Client\TrustedHosts -Value * -Force
</code></pre><p>删除所有远程信任主机</p><pre><code>Clear-Item WSMan:\localhost\Client\TrustedHosts
</code></pre><p>如果要删除单一远程主机，则可以执行：</p><pre><code>$newvalue = ((Get-ChildItem WSMan:\localhost\Client\TrustedHosts).Value).Replace("computer01,","")
Set-Item WSMan:\localhost\Client\TrustedHosts $newvalue
</code></pre><p>更改computer01。</p><p>列出所有远程信任主机</p><pre><code>Get-Item WSMan:\localhost\Client\TrustedHosts
</code></pre><p>在使用远程执行时如果只提供用户名，那么则会弹窗输入密码。此时我们可以建立PSCredential对象将用户名和密码保存在里面。然后再传递给<code>-Credential</code>参数。<code>-ScriptBlock</code>参数后跟要执行的代码。</p><pre><code>$UserName = "admin3"
$serverpass = "admin123!@"

$Password = ConvertTo-SecureString $serverpass -AsPlainText –Force
$cred = New-Object System.Management.Automation.PSCredential($UserName,$Password)

invoke-command -ComputerName localhost -Credential $cred -ScriptBlock { ipconfig }
</code></pre><p><img alt="enter image description here" img-src="923244f7c9c2d191ddec75dbc28ea8873528d717.jpg"></p><p>使用<code>help * -Parameter computername</code>命令可以列出所有默认可以远程使用的命令。并且认证过程都可以像上面的代码一样传递$cred。</p><p>之后写个for循环就可以一对多的执行了。</p><p><img alt="enter image description here" img-src="1b62fed0321bbb2974bf03184bea4870da3d29ce.jpg"></p><p>如果输出内容过于冗杂，还可以使用<code>ConvertTo-Csv</code>或者<code>ConvertTo-Html</code>将powershell对象的输出转换为html或者csv。</p><p>如果想一对一获取交互式powershell，可以像这样执行<code>Enter-PSSession</code>：</p><pre><code>Enter-PSSession -ComputerName 192.168.200.161 -Credential $cred
</code></pre><p><img alt="enter image description here" img-src="7546b825e97b0294c8079a8456651c56b5281e9c.jpg"></p><h2>0x03 多任务分发</h2><hr><p>在使用<code>invoke-command</code> 的时候，<code>computername</code> 可为多个参数。在执行的时候可以使用<code>-Asjob</code>参数将执行过程放在后台。 接收回显的时候可以使用<code>get-job</code>查看<code>job id</code>，然后用<code>receive-job</code>接收全部回显结果。 但是如果我只是想查看某个远程主机的执行结果呢？ 那么就可以像下面这样做：</p><pre><code>Get-Job -Id 1 | select -ExpandProperty childjobs
</code></pre><p>得到<code>child job id</code>之后，再用 <code>receive-job</code> 接收回显结果。</p><p><img alt="enter image description here" img-src="683959b017684b26f9149d217e14a68eaf85c825.jpg"></p><h2>0x04 域内信息搜集</h2><hr><p>基本的信息搜集(日志、进程、服务等)可以靠上面列出的命令来收集，但是远程执行<code>invoke-command</code>是需要凭证的，如果是在域内我们是不是可以先用<code>nltest</code>搜集下信任域？</p><p>在windows中有个<code>System.DirectoryServices.ActiveDirectory</code>命名空间，和windows域有关。 其下有个类Domain，其中<code>GetAllTrustRelationships()</code>方法可以获得信任域。</p><p>那么在powershell就可以这样执行：</p><pre><code>([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()
</code></pre><p>获得域之前的信任关系。 如果需要自行开发脚本，也可以参考下面的文档。</p><p>除此之外，还记得之前metasploit笔记中那个<code>local_admin_search</code>模块吗？<code>veil-powerview</code>中也有通过相同的方式实现了这一过程。</p><p>两种不同的脚本都通过调用OpenSCManagerA API连接远程主机测试是否成功。</p><p><img alt="enter image description here" img-src="7caedc3ad89886666f4a5e72f803c3107f52e89d.jpg"></p><p>Local&#95;admin&#95;search.rb</p><p><img alt="enter image description here" img-src="2f82c6d972c103831f97a4eee3c06de386b95420.jpg"></p><p>Invoke-CheckLocalAdminAccess</p><p>附<a href="http://www.harmj0y.net/blog/penetesting/finding-local-admin-with-the-veil-framework/">veil-powerview作者博客中</a>的测试截图：</p><p><img alt="enter image description here" img-src="7c1735d22cc06778cabc085820c9ec4ed331f6e3.jpg"></p><h2>0x05 参考</h2><hr><ul><li><a href="http://www.harmj0y.net/blog/redteaming/trusts-you-might-have-missed/">http://www.harmj0y.net/blog/redteaming/trusts-you-might-have-missed/</a></li><li><p><a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.activedirectory.domain(v=vs.110).aspx">http://msdn.microsoft.com/en-us/library/system.directoryservices.activedirectory.domain(v=vs.110).aspx</a></p></li><li><p><a href="https://www.blackhat.com/docs/us-14/materials/arsenal/us-14-Schroeder-The-Veil-Framework-Slides.pdf">https://www.blackhat.com/docs/us-14/materials/arsenal/us-14-Schroeder-The-Veil-Framework-Slides.pdf</a></p></li><li><p><a href="https://www.blackhat.com/docs/us-14/materials/arsenal/us-14-Schroeder-The-Veil-Framework-Slides.pdf">https://www.blackhat.com/docs/us-14/materials/arsenal/us-14-Schroeder-The-Veil-Framework-Slides.pdf</a></p></li><li><p><a href="http://powershell.org/wp/2012/08/06/ebook-secrets-of-powershell-remoting/">v3 Secrets of PowerShell Remoting.pdf</a></p></li></ul><h2>0x06 powershell pentest project 学习推荐</h2><hr><p>整理的过程发现了很多牛人的博客和项目，在这里分享一下。</p><p><strong>Powershell HID attack toolkit</strong> ：<a href="https://github.com/samratashok/Kautilya">https://github.com/samratashok/Kautilya</a></p><p><strong>post exploitation</strong> ：<a href="https://github.com/samratashok/nishang">https://github.com/samratashok/nishang</a></p><p><strong>Remote DLL inject</strong> ：<a href="https://github.com/clymb3r">https://github.com/clymb3r</a></p><p><strong>aspx的Powershell webshell</strong> ：<a href="https://github.com/samratashok/nishang/tree/master/Antak-WebShell">https://github.com/samratashok/nishang/tree/master/Antak- WebShell</a></p><p><strong>Veil Post exploitation</strong> ：<a href="https://github.com/Veil-Framework/Veil-PowerView">https://github.com/Veil-Framework/Veil-PowerView</a></p><p><strong>A PowerShell Post-Exploitation Framework</strong> ：<a href="https://github.com/mattifestation/PowerSploit">https://github.com/mattifestation/PowerSploit</a></p><p><strong>local privilege escalation</strong> : <a href="https://github.com/HarmJ0y/PowerUp">https://github.com/HarmJ0y/PowerUp</a></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/3353" rel="bookmark" id="re1">Powershell tricks::Bypass AV</a></li><li><a href="http://drops.wooyun.org/tips/7358" rel="bookmark" id="re2">在远程系统上执行程序的技术整理</a></li><li><a href="http://drops.wooyun.org/tips/10556" rel="bookmark" id="re3">Powershell tricks::Code Execution &amp; Process Injection</a></li><li><a href="http://drops.wooyun.org/tips/11989" rel="bookmark" id="re4">Powershell 提权框架-Powerup</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">malayke</span> <span class="reply-time">2014-12-12 17:19:25</span></div><p></p><p>thx, It&#039;s Very useful.</p><p></p></div></div></div></div></div></main>