<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Memcache安全配置</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">瞌睡龙</a> <span class="bull">·</span> <time title="2014/01/20 17:59" ui-time="" datetime="2014/01/20 17:59" class="published ng-binding ng-isolate-scope">2014/01/20 17:59</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 Memcache简介</h2><hr><p>Memcache是一个高性能的分布式的内存对象缓存系统，通过在内存里维护一个统一的巨大的hash表，它能够用来存储各种格式的数据，包括图像、视频、文件以及数据库检索的结果等。简单的说就是将数据调用到内存中，然后从内存中读取，从而大大提高读取速度。</p><p>Memcache是danga的一个项目，最早是LiveJournal 服务的，最初为了加速 LiveJournal 访问速度而开发的，后来被很多大型的网站采用。</p><p>Memcached是以守护程序方式运行于一个或多个服务器中，随时会接收客户端的连接和操作。</p><h2>0x01 搭建Memcache服务</h2><hr><pre><code>yum install memcached 
</code></pre><p>安装memcache服务端</p><pre><code>yum -y install php-pecl-memcache 
</code></pre><p>安装php扩展操作memcache</p><pre><code>php -m | grep memcache 
</code></pre><p>查看php扩展是否安装成功</p><pre><code>memcached -d -m 100 -u root -l x.x.x.x -p 11211 -c 512 -P /tmp/memcached.pid
</code></pre><p>参数说明：</p><pre><code>-d选项是启动一个守护进程；
-m是分配给Memcache使用的内存数量，单位是MB，我这里是100MB；
-u是运行Memcache的用户，我这里是root；
-l是监听的服务器IP地址我这里指定了服务器的IP地址x.x.x.x；
-p是设置Memcache监听的端口，我这里设置了11211，最好是1024以上的端口；
-c选项是最大运行的并发连接数，默认是1024，我这里设置了512，按照你服务器的负载量来设定；
-P是设置保存Memcache的pid文件，我这里是保存在 /tmp/memcached.pid；
</code></pre><p>想要结束memcache进程</p><pre><code>kill `cat /tmp/memcached.pid` 
</code></pre><p>设置开机启动</p><pre><code>chkconfig memcached on 
</code></pre><p>phpMemcachedAdmin图形化界面，操作memcache，类似phpmyadmin</p><p><a href="http://blog.elijaa.org/index.php?pages/phpMemcachedAdmin-Installation-Guide">http://blog.elijaa.org/index.php?pages/phpMemcachedAdmin-Installation-Guide</a></p><p>最新版默认界面</p><p><img alt="enter image description here" img-src="90a78a973f93650c2cafd5ba777369f57888a409.jpg"></p><p>Execute Commands on Servers那里可以执行命令。</p><p>当然了用telnet其实是一样的。</p><h2>0x02 memcache匿名访问危害</h2><hr><p>在乌云提交的漏洞当中，有很多因为memecache限制不严格，导致信息泄露的问题：</p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2010-0790">WooYun: memcached未作IP限制导致缓存数据可被攻击者控制</a></p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2013-037301">WooYun: 通过Memcache缓存直接获取某物流网用户密码等敏感数据</a></p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2013-023891">WooYun: 56.com memcached端口可以远程使用</a></p><p>从memcache中获取信息通常是先查看items信息：</p><p>stats items</p><p><img alt="enter image description here" img-src="ac2d6fd52907d2cba6d7eeefb29dd25bdc379257.jpg"></p><pre><code>stats cachedump &lt;item: id&gt; &lt;返回结果数量,0代表返回全部&gt;
</code></pre><p><img alt="enter image description here" img-src="fec70fea74060a178cde99458e982f8dc7a31795.jpg"></p><p>除了查看信息，通用可以修改删除信息。</p><p>phpMemcachedAdmin执行命令那里也有个可以搜索key的脚本，并且支持正则匹配。</p><h2>0x03 查找可匿名访问memcache的方式</h2><hr><p>memcache默认是11211端口，可使用nmap扫描有开11211端口的服务器。</p><pre><code>nmap -n --open -p 11211 X.X.X.X/24
</code></pre><p>然后telnet上，执行下</p><pre><code>stats items
</code></pre><p>看看是否有返回结果。</p><h2>0x04安全配置</h2><hr><p>Memcache服务器端都是直接通过客户端连接后直接操作，没有任何的验证过程，这样如果服务器是直接暴露在互联网上的话是比较危险，轻则数据泄露被其他无关人员查看，重则服务器被入侵，因为Mecache是以root权限运行的，况且里面可能存在一些我们未知的bug或者是缓冲区溢出的情况，这些都是我们未知的，所以危险性是可以预见的。</p><h3>内网访问</h3><p>最好把两台服务器之间的访问是内网形态的，一般是Web服务器跟Memcache服务器之间。普遍的服务器都是有两块网卡，一块指向互联网，一块指向内网，那么就让Web服务器通过内网的网卡来访问Memcache服务器，我们Memcache的服务器上启动的时候就监听内网的IP地址和端口，内网间的访问能够有效阻止其他非法的访问。</p><pre><code># memcached -d -m 1024 -u root -l 192.168.0.200 -p 11211 -c 1024 -P /tmp/memcached.pid
</code></pre><p>Memcache服务器端设置监听通过内网的192.168.0.200的ip的11211端口，占用1024MB内存，并且允许最大1024个并发连接</p><h3>设置防火墙</h3><p>防火墙是简单有效的方式，如果却是两台服务器都是挂在网的，并且需要通过外网IP来访问Memcache的话，那么可以考虑使用防火墙或者代理程序来过滤非法访问。 一般我们在Linux下可以使用iptables或者FreeBSD下的ipfw来指定一些规则防止一些非法的访问，比如我们可以设置只允许我们的Web服务器来访问我们Memcache服务器，同时阻止其他的访问。</p><pre><code># iptables -F
# iptables -P INPUT DROP
# iptables -A INPUT -p tcp -s 192.168.0.2 --dport 11211 -j ACCEPT
# iptables -A INPUT -p udp -s 192.168.0.2 --dport 11211 -j ACCEPT
</code></pre><p>上面的iptables规则就是只允许192.168.0.2这台Web服务器对Memcache服务器的访问，能够有效的阻止一些非法访问，相应的也可以增加一些其他的规则来加强安全性，这个可以根据自己的需要来做。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/20141017203549ef27b55a7921e022214b5780c48f81e0.png" style="width:200px;height:200px"></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/345" rel="bookmark" id="re1">在线支付逻辑漏洞总结</a></li><li><a href="http://drops.wooyun.org/papers/346" rel="bookmark" id="re2">终端机的安全性</a></li><li><a href="http://drops.wooyun.org/tips/2457" rel="bookmark" id="re3">Linux被DDOS&amp;CC攻击解决实例</a></li><li><a href="http://drops.wooyun.org/papers/2035" rel="bookmark" id="re4">一些常见的重置密码漏洞分析整理</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">路人甲他爹</span> <span class="reply-time">2016-06-07 14:22:23</span></div><p></p><p>@路人甲 自己蠢怪谁~ 这个是全禁用 要先设置一个22端口的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">路人甲</span> <span class="reply-time">2016-03-17 22:42:57</span></div><p></p><p>害人不浅，iptables -P INPUT DROP，之后服务器之间断开了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">abc</span> <span class="reply-time">2016-01-20 15:49:57</span></div><p></p><p>iptables -F<br>这能随便写吗？注明一下好吗？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Alex(Lei) Chi</span> <span class="reply-time">2015-12-02 18:52:43</span></div><p></p><p>@mango 赞</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">朦朦胧胧</span> <span class="reply-time">2015-12-01 13:23:17</span></div><p></p><p>http://www.4n5n.com/ 写的很好 学习了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Chinatree</span> <span class="reply-time">2014-08-12 11:33:14</span></div><p></p><p>Memcache这里还有一点建议，运行的用户不建议采用root。</p><p>像Memcache、Redis这些基本都是部署在内网，关于暴露在外网，多数在监听地址选择上的问题。自荐一篇关于进程监听地址选择的文章：http://blog.yuntree.com/index.php/archives/38<br>不管你信不信，反正我遇到不少运维没搞清这些地址监听的差异，一上来直接0.0.0.0 :)</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">秋风</span> <span class="reply-time">2014-01-21 23:11:31</span></div><p></p><p>用得着，收藏了！<br>http://www.fengdingbo.com/memcache-safe-config.html</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小贱人</span> <span class="reply-time">2014-01-21 16:33:56</span></div><p></p><p>mark呀</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">高斯</span> <span class="reply-time">2014-01-21 13:07:46</span></div><p></p><p>mark</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">秋风</span> <span class="reply-time">2014-01-21 10:55:19</span></div><p></p><p>不错，我转了啊？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">mango</span> <span class="reply-time">2014-01-20 21:35:58</span></div><p></p><p>SF</p><p></p></div></div></div></div></div></main>