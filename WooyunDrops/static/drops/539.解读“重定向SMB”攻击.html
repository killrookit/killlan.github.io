<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">解读“重定向SMB”攻击</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">腾讯电脑管家</a> <span class="bull">·</span> <time title="2015/04/17 17:06" ui-time="" datetime="2015/04/17 17:06" class="published ng-binding ng-isolate-scope">2015/04/17 17:06</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>前几天Cylance发布了一个影响Windows系统的漏洞，攻击者可以通过重定向到SMB协议的方式，利用“中间人攻击”来盗取用户认证信息。这个攻击究竟是怎么回事？“重定向SMB”又是什么呢？电脑管家漏洞防御团队对这些问题做了详细的技术分析，现将分析结果分享给大家。</p><h1>0x01 SMB/SMB2(Server Message Block)</h1><hr><p>先简单介绍一下这次事件的主角SMB。</p><p>SMB是对CIFS(Common Internet File System)协议的扩展，主要用于访问网络上的共享文件以及打印服务。SMB和其它协议的关系如下：</p><p><img alt="enter image description here" img-src="bbb7a071c8a50d53fc3278a30ac945691a0050b6.jpg"></p><p>SMB可以直接使用TCP端口进行传输(端口445)，也可以使用NetBIOS进行传输(TCP端口139)。以直接TCP端口传输为例，每一条SMB消息必须有一个4字节的包头。包头第一个字节为0（network byte order，下同），紧跟着的3字节表示SMB消息的长度；包体是变长的。</p><p><img alt="enter image description here" img-src="f701d992e19e3c39fcda17db6ade0a06a219340c.jpg"></p><p>在windows vista以后，引入了SMB2协议，在原有的SMB协议基础上扩展了部分字段。</p><p>SMB/SMB2认证有多种协议，使用最多的就是NTLM认证协议。</p><p>NTLM支持 Challenge/Response方式进行加密通信，安全认证的消息序列如下：</p><p><img alt="enter image description here" img-src="b6748292aec6a2e9740470c9248aac82d480c348.jpg"></p><h1>0x02 利用HTTP重定向到SMB协议</h1><hr><p>以Win7x86+IE11为例，看看IE如何处理HTTP返回的重定向请求。</p><p><img alt="enter image description here" img-src="dd11ef4ed051abfe48fcb9046a72145a6525c717.jpg"></p><p><img alt="enter image description here" img-src="72dd363f59ca5162b6de93d9efe77bfbb67844e7.jpg"></p><p>IE获得HTTP请求返回的状态码后，如果是代表重定向的301、302、303、307，跳转到处理重定向的逻辑，调用CINetHttp::RedirectRequest处理重定向请求。</p><p>构造一个重定向到file协议的网页</p><p><img alt="enter image description here" img-src="5bcf5e8f96f95e93d213f1b1fb317e84b62282b6.jpg"></p><p>当IE访问这个网页时，可以抓到访问SMB服务器的数据包</p><p><img alt="enter image description here" img-src="760dc764e6b73e2d9a97d4759a6f50be8d629ae3.jpg"></p><p>可见本机当前用户的登录凭证通过SMB2协议发送服务器进行认证了。如果这个服务器（上图中的10.4.75.32）是被恶意劫持过的“中间人”，那么用户的登录凭证就泄漏了。</p><p>可能的攻击方式不局限于网页访问，只要能够劫持正常的HTTP网络请求，就可以重定向到SMB协议将个人信息发送到恶意服务器上。</p><h1>0x03 防范建议</h1><hr><p>可以看到，重定向到SMB协议是一个很大的隐患，非用户主动发起的SMB请求都应该禁止；通过SMB协议访问外网共享服务器时也需要特别谨慎。</p><p>作为防范建议，可以关闭对TCP 139和445端口的访问。如果确实需要访问网络上的共享文件或者是打印服务，在确认服务器可信的前提下，临时打开TCP 139和445的端口访问。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/506" rel="bookmark" id="re1">[代码审计]web程序对客户端数据加解密带来的安全问题</a></li><li><a href="http://drops.wooyun.org/papers/287" rel="bookmark" id="re2">密码找回功能可能存在的问题</a></li><li><a href="http://drops.wooyun.org/papers/1210" rel="bookmark" id="re3">第三方账号登陆的过程及由此引发的血案</a></li><li><a href="http://drops.wooyun.org/papers/11692" rel="bookmark" id="re4">黑产godlike攻击: 邮箱 XSS 窃取 appleID 的案例分析</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">是234</span> <span class="reply-time">2016-04-26 19:19:40</span></div><p></p><p>04,年还是05年不就有这个了么，网页中放一个共享位置的文件，访问网页就获取HASH，换个名头又出来了？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">BeenQuiver</span> <span class="reply-time">2016-03-09 16:59:26</span></div><p></p><p>屌屌的赶脚</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Her0in</span> <span class="reply-time">2015-11-23 22:07:06</span></div><p></p><p>SMB是对CIFS(Common Internet File System)协议的扩展? 这句前后颠倒了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">_Evil</span> <span class="reply-time">2015-04-21 09:19:36</span></div><p></p><p>sdadasdasdasd</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">catcat520</span> <span class="reply-time">2015-04-20 20:17:11</span></div><p></p><p>2002年的老漏洞了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">低调的Y哥</span> <span class="reply-time">2015-04-19 10:38:14</span></div><p></p><p>新版的不能收藏文章了吗。。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Taro</span> <span class="reply-time">2015-04-19 10:30:54</span></div><p></p><p>我来打个酱油</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">wooyunjiuba</span> <span class="reply-time">2015-04-18 16:35:41</span></div><p></p><p>卧槽 这就重定向了？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sharecast</span> <span class="reply-time">2015-04-18 16:16:27</span></div><p></p><p>drops升级了呀，变好看了~~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">L.N.</span> <span class="reply-time">2015-04-18 10:18:00</span></div><p></p><p>接下来呢！获取登陆凭证，然后呢。。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">懒懒滴1994</span> <span class="reply-time">2015-04-18 08:12:24</span></div><p></p><p><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="26c0be89c3a3aec3a1a0c382a1c3839bc19c9ec3a0abc29eacc3a8b3c0afa666c3bd8bcfb399">[email&#160;protected]</a></p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sky</span> <span class="reply-time">2015-04-17 22:17:17</span></div><p></p><p>@园长 看的好别扭</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">园长</span> <span class="reply-time">2015-04-17 21:47:02</span></div><p></p><p>为什么验证码在输入框上面</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Defa</span> <span class="reply-time">2015-04-17 20:41:40</span></div><p></p><p>好厉害好厉害</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sky</span> <span class="reply-time">2015-04-17 17:27:37</span></div><p></p><p>我就看看</p><p></p></div></div></div></div></div></main>