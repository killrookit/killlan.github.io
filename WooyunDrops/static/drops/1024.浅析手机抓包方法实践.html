<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">浅析手机抓包方法实践</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">Ms4dam0n</a> <span class="bull">·</span> <time title="2016/01/29 18:07" ui-time="" datetime="2016/01/29 18:07" class="published ng-binding ng-isolate-scope">2016/01/29 18:07</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 摘要</h1><hr><p>在移动逆向分析以及 App 开发的时候，总会需要对其网络行为进行监控测试，本文总结一些抓包思路，并对其使用方法进行实践</p><p>笔者认为在抓包界，Wireshark 应该算是综合排名第一的工具（其实 Wireshark 自带的命令行工具 tshark 更牛逼）</p><p>本文总结记录了 5 种抓包方式，掌握其一即可进行实践，欢迎大家一起交流分享</p><h1>0x01 基于 Wireshark</h1><hr><p><strong>实验步骤：</strong></p><h3>1.1 在电脑主机上使用<code>猎豹 Wifi</code>之类的工具，开启热点，将所要测试的手机连接该热点，记录其IP地址</h3><p><img alt="Alt text" img-src="d1d0b66e314fbee7347beaa79bffa30e5afd74d6.jpg"></p><h3>1.2 使用 Wireshark 对以上 IP 地址进行捕获</h3><p>Capture——Options</p><p><img alt="Alt text" img-src="023ad0505c0994f1d166a69cbb8b98002de59635.jpg"></p><p><img alt="Alt text" img-src="c73a517d17e228308d4248233c3ce5c0909f8d96.jpg"></p><h3>1.3 总结</h3><p>该方法简单粗暴高效，可以将捕获的数据包随时保存下来，便于后续分析或者进行 PCAP 可视化分析。</p><p>关于命令行工具 tshark 在此不做赘述，感兴趣的读者自行研究。</p><h1>0x02 基于 tcpdump</h1><hr><p><strong>实验环境：</strong></p><p>下载安装 Genymotion 安卓虚拟机，在该模拟器环境种进行实践操作（基于实体手机亦然，前提是<strong>手机必须得 ROOT</strong>）</p><p>笔者仅在 Android 系统下测试，未在 iOS 系统下实验</p><p><strong>实验步骤：</strong></p><h3>2.1 说明</h3><p>模拟器中自带的 tcpdump 工具，位于： /system/xbin/ 目录下</p><h3>2.2 数据包捕获</h3><p>可以通过 <code>adb shell</code> 命令在 CMD 模式下连接模拟器，<code>su</code> 到 root 模式进行抓包</p><pre><code>#!bash
tcpdump -vv -s 0 -i eth1 -w /sdcard/capture.pcap
</code></pre><p>参数说明：</p><ul><li>-vv：获取详细的包信息（注意是两个 v 不是 w）</li><li>-s 0：不限数据包的长度，如果不加则只获取包头</li><li>-w xxx.pcap：捕获数据包名称以及存储位置（本例中保存在 sdcard 路径下，数据包名为 capture.pcap）</li><li>-i eth1：捕获制定的网卡（在 genymotion 虚拟机中，使用 busybox ifconfig 命令可以查看相关信息，一般 genymotion 的 ip 地址都为 10.xx.xx.x）</li><li>如果你想指定捕获的数据包长度，可以使用 -c 参数（例如 -c 128）</li></ul><p>捕获结束，直接按 Ctrl + C 即可</p><h3>2.3 数据分析</h3><p>将捕获到的数据包拖到本地使用 Wireshark 进行查看：</p><pre><code>#!bash
adb pull /sdcard/capture.pcap C:\tmp
</code></pre><p><strong>TIPS：将数据包文件 push 到手机上命令为</strong></p><pre><code>#!bash
adb push C:\tmp\capture.pcap /sdcard/
</code></pre><h1>0x03 基于 Fiddler 4</h1><hr><p><strong>实验步骤：</strong></p><h3>3.1 下载 FIddler 4</h3><p><a href="https://www.telerik.com/download/fiddler">点击下载 Fiddler 4</a></p><h3>3.2 设置 Fiddler 4</h3><p>打开Fiddler，Tools-> Fiddler Options （配置完成记得重启 Fiddler）</p><p><img alt="Alt text" img-src="44474420c08cd24b3933c037cf709b21eea5e76f.jpg"></p><p><img alt="Alt text" img-src="d28163cea16d375aa68cbeb0342b010656d482c9.jpg"></p><h3>3.3 设置手机代理</h3><p>首先，获取安装 Fiddler 4 的 PC 对应的 IP 地址（ipconfig）：</p><p><img alt="Alt text" img-src="69cdbdeaf24059a79eb5f14eedc79bab05bf234a.jpg"></p><p>确保手机和 PC 是连接在同一个局域网中！！！</p><p>下面对手机进行设置（笔者使用小米测试机）：点击手机中“设置”——Wi-Fi——选择已经连接的wifi——代理设置改为手动</p><p><img alt="Alt text" img-src="53cc95fa3b4cd4070b42c3edd98d113ddafe7328.jpg"></p><p>下载 Fiddler 的安全证书</p><p>使用手机浏览器访问：<code>http://10.2.145.187:8888</code>，点击"FiddlerRoot certificate"，然后安装证书即可。</p><p>至此，已经全部设置完毕。</p><h3>3.4 数据包捕获</h3><p>重新打开 Fiddler 4，然后打开手机中的浏览器，访问任意网址，Fiddler 抓包信息如下：</p><p><img alt="Alt text" img-src="92cf92ebb37ea8692f59a3569627546cfbf5ab0b.jpg"></p><p>Enjoy！</p><h1>0x04 基于 Charles</h1><hr><p><strong>实验环境：</strong></p><p>win7 + Charles v3.11</p><p>一般使用 Charles 都是基于 MAC OS ，笔者在 mac 平台以及 windows 平台均试验过，操作过程和思路基本一致，因此，本文以 win7 为测试环境</p><p><strong>实验步骤：</strong></p><h3>4.1 捕获 http 数据包</h3><p>手机设置代理：</p><p><img alt="Alt text" img-src="53cc95fa3b4cd4070b42c3edd98d113ddafe7328.jpg"></p><p>打开 Charles 即可捕获数据包（Proxy —— Proxy Settings）：</p><p><img alt="Alt text" img-src="015d22ca37cbb3df0c3697dc8a1f36796598630d.jpg"></p><p><img alt="Alt text" img-src="c0b698e2140424f6bc24f33d90ca34f60c40c975.jpg"></p><h3>4.2 捕获 https 数据包</h3><p>手机端安装证书：</p><p>Android 手机或者 iPhone 均可直接访问 <a href="http://www.charlesproxy.com/ssl.zip">http://www.charlesproxy.com/ssl.zip</a> ，然后根据图示点击证书安装</p><p><img alt="Alt text" img-src="87eafe3873ce734f658e9e2700129d066c613ce9.jpg"></p><p><img alt="Alt text" img-src="6cd45c3d2cd5b17c60095f445ea580822e5be0fd.jpg"></p><p><img alt="Alt text" img-src="cbab2c9e10a660f08c8e939b9831460a9c1d9dbd.jpg"></p><p>设置 Charles：</p><p>选择 Proxy —— SSL Proxying Settings —— Locations —— Add</p><p>在弹出的表单中填写 Host 域名（也就是你想要抓包链接的主机名），以及对应的 Port 端口（此处相当于过滤作用）</p><p>当然，你可以采用更加粗暴的方式：使用通配符，例如你想要捕获所有的 https 包，这里也可以直接都为空，表示捕获所有的主机和端口；或者都分别填“*”星号，匹配所有的字符，捕获所有的 https。</p><p><img alt="Alt text" img-src="1fd288c818eaec8fcc37b95b51492b590182a74e.jpg"></p><p><img alt="Alt text" img-src="c2af40cc916d906b700d6aee85f1c2c9ab8576cc.jpg"></p><p><img alt="Alt text" img-src="6ebc986c4ddc709a18ffba4a6c254ca6588f952d.jpg"></p><h1>0x05 基于 Burpsuite</h1><hr><p><strong>实验步骤：</strong></p><h3>5.1 捕获 http 数据包</h3><p>PC 端 Burpsuite 设置：</p><p><img alt="Alt text" img-src="63eefc0c167bf69783621667cdf9d93126cc2a1e.jpg"></p><p>手机端代理设置方法同以上 3.3 4.1</p><p>打开 Burpsuite 即可捕获 http 数据包：</p><p><img alt="Alt text" img-src="fbd74959e41c3e2d7c2c4885b80c869a3fa7e96b.jpg"></p><h3>5.2 捕获 https 数据包</h3><p>手机端设置好代理之后，使用浏览器访问：<code>http://burp/</code></p><p><img alt="Alt text" img-src="e5be48e742edcebd017ff1a7b5bd6d577ec8532b.jpg"></p><p><img alt="Alt text" img-src="a05a7bee4d8e57ab248a45d9f45daaf8249d08cc.jpg"></p><p>此处存在一个问题：下载的证书是 der 格式的，我们手机端安装的是 crt 格式的，需要使用 firefox 浏览器转一下格式：可以首先在 Brupsuite 中导出 der 格式证书，然后导入火狐浏览器，然后从火狐浏览器导出证书格式为 crt</p><p><img alt="Alt text" img-src="2de1636ea37e2420d07d915850d15834dd683fa7.jpg"></p><p>打开火狐浏览器：工具——选项——高级——证书——查看证书</p><p><img alt="Alt text" img-src="efcfa9703fa1c0e0afd23cd5601a2a2f33da1805.jpg"></p><p><img alt="Alt text" img-src="bfe6f8ae0d0bc30b974f911e0c909d252e06b3c5.jpg"></p><p><img alt="Alt text" img-src="077218ca3bc04278e1a825e4bd320b454409a48b.jpg"></p><p>成功捕获 https 数据包</p><p><img alt="Alt text" img-src="dd8f3ef382372b7c61d056adb851ac97f63b4e78.jpg"></p><h1>0x06 总结</h1><hr><ul><li><p>当我们停止捕获数据包时，将Fiddler 或 Charles 关闭，此时手机端是无法正常访问网络的，因为设置了代理，这时候需要将代理关闭，即可正常浏览网页</p></li><li><p>对于大多数走代理的应用可以选择 Fiddler 或 Charles，无需 root，一次配置，终身使用；对于不走代理的 App 可以利用 tcpdump 捕包，然后使用 Wireshark 查看；最简单便捷的便是第一种方法<strong>「0x01. 基于 Wireshark」</strong></p></li><li><p>以上所有工具各有优劣，读者可以根据工作环境，按需使用，个人觉得一般情况下使用 Wireshark + Fiddler 或者 Wireshark + Charles 即可完成各平台的抓包分析任务</p></li><li><p>以上工具中只有BurpSuite可以对抓包过程进行交互式操作；Wireshark支持的协议最多，也更底层，功能强大，但过于沉重</p></li><li><p>对于本文涉及的相关工具的安装、设置、破解、详细使用，不在本文讨论范围之内（Charles 免费版其实还比较厚道，如果重度需要，建议购买正版），本文旨在浅析捕获移动终端数据包的方法和思路</p></li></ul><h1>0x07 参考文献</h1><hr><ol><li><a href="http://blog.csdn.net/jiangwei0910410003/article/details/19806999">抓包工具Fidder详解</a></li><li><a href="http://blog.csdn.net/jiangwei0910410003/article/details/41620363">Mac上的抓包工具Charles</a></li><li><a href="http://blog.csdn.net/chenyufeng1991/article/details/50370248">网络抓包工具Charles的介绍与使用</a></li><li><a href="http://drops.wooyun.org/tips/2423">charles使用教程指南</a></li><li><a href="http://my.oschina.net/cve2015/blog/545832">Android安全测试之BurpSuite抓包</a></li><li><a href="http://www.trinea.cn/android/tcpdump_wireshark/">Android利用tcpdump和wireshark抓取网络数据包</a></li></ol><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/9651" rel="bookmark" id="re1">Bluetooth Low Energy 嗅探</a></li><li><a href="http://drops.wooyun.org/tips/2457" rel="bookmark" id="re2">Linux被DDOS&amp;CC攻击解决实例</a></li><li><a href="http://drops.wooyun.org/papers/4386" rel="bookmark" id="re3">One git command may cause you hacked(CVE-2014-9390)</a></li><li><a href="http://drops.wooyun.org/tips/1226" rel="bookmark" id="re4">Tor隐身大法 —— 用Tor来帮助我们进行渗透测试</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">px1624</span> <span class="reply-time">2016-05-19 00:02:25</span></div><p></p><p>“此处存在一个问题：下载的证书是 der 格式的，我们手机端安装的是 crt 格式的，需要使用 firefox 浏览器转一下格式：可以首先在 Brupsuite 中导出 der 格式证书，然后导入火狐浏览器，然后从火狐浏览器导出证书格式为 crt”，这个操作完全多此一举啊，直接手机浏览器保存的时候编辑下，把后缀改了就可以了。改成cer或者crt</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zjgwhh</span> <span class="reply-time">2016-05-11 14:16:52</span></div><p></p><p>很全面，好方法</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">MillionSky</span> <span class="reply-time">2016-03-07 11:09:29</span></div><p></p><p>不错</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">seewhy</span> <span class="reply-time">2016-02-23 20:46:33</span></div><p></p><p>还有一种mitmproxy，可以在命令行下抓包，功能和fiddler类似。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">b'b</span> <span class="reply-time">2016-02-23 18:14:32</span></div><p></p><p>@aa 确实是个好方法，对手机完全透明，旁路监听</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">aa</span> <span class="reply-time">2016-02-22 21:12:02</span></div><p></p><p>竟然没有iptables -j TEE这个方法</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">phoenixne</span> <span class="reply-time">2016-02-18 09:29:06</span></div><p></p><p>总结不错<br>一半就用BURP了 ，方便抓 和改</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Gowabby</span> <span class="reply-time">2016-02-15 16:48:50</span></div><p></p><p>熊感觉写的还不全把，你这只是抓包，然后改包没有，而且只是http/https的，私有协议的也开业抓包改包的，算了过两天熊也来写一封帮你补全吧。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zzzmode</span> <span class="reply-time">2016-02-02 19:27:09</span></div><p></p><p>Charles 也可以改加断点修改请求，</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">jye33</span> <span class="reply-time">2016-02-01 11:07:33</span></div><p></p><p>比较适合初学者</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">thanatos</span> <span class="reply-time">2016-02-01 09:17:59</span></div><p></p><p>确实，如果能举个例子更深入的进行对比和讲解，效果更佳！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">详细信息</span> <span class="reply-time">2016-01-30 20:18:50</span></div><p></p><p>TCPDUMP -c是捕获的个数，笔误笔误</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sOnsec</span> <span class="reply-time">2016-01-30 14:02:24</span></div><p></p><p>总结的不错，就是有点浅显？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">天璇</span> <span class="reply-time">2016-01-30 11:09:50</span></div><p></p><p>不错啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">坦克手</span> <span class="reply-time">2016-01-30 07:33:14</span></div><p></p><p>楼下说的很有道理。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">对</span> <span class="reply-time">2016-01-29 22:28:41</span></div><p></p><p>楼下说的对。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">从容</span> <span class="reply-time">2016-01-29 20:15:18</span></div><p></p><p>总结的不错，就是有点浅显？</p><p></p></div></div></div></div></div></main>