<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">爬虫技术实战</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">Manning</a> <span class="bull">·</span> <time title="2015/04/03 9:21" ui-time="" datetime="2015/04/03 9:21" class="published ng-binding ng-isolate-scope">2015/04/03 9:21</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 前言</h1><hr><p>项目开源地址: https://github.com/manning23/MSpider</p><p>上篇文章《爬虫技术浅析》介绍了爬虫的基本技术，分享了一个动态爬虫demo。这篇文章主要讲解爬虫技术的实战效果。 本次介绍的结果如下：</p><ul><li><p>1.爬虫的URL聚焦与过滤</p></li><li><p>2.URL相似度算法抛砖引玉</p></li><li><p>3.爬行策略详解</p></li><li><p>4.Mspider工具使用说明及效果展示</p></li><li><p>5.Mspider的头脑风暴</p></li></ul><h1>0x01 爬虫的URL聚焦与过滤</h1><hr><p>为什么爬虫需要URL聚焦与过滤？因为我们需要控制预期结果！</p><p>举个例子，如果爬行的目的是爬取乌云已知漏洞列表，那么一般类型的爬虫是无法满足的，一般爬虫会进行如下形式的爬取。爬取的URL是杂乱的。</p><p><img alt="enter image description here" img-src="c9614527d48967a0348ab96e23e5306f740fab75.jpg"></p><p>聚焦爬虫爬取的URL是符合预期的。如下图展示。</p><p><img alt="enter image description here" img-src="b80759f0ffc42953a4fd831e78ac3d52e28bf264.jpg"></p><p>可以看出来，聚焦爬虫和非聚焦爬虫都是从www.wooyun.org开始爬取，聚焦爬虫可以按照一定策略尽量控制URL爬取策略，而非聚焦爬虫却完成不了这种特定需求。</p><p>在爬虫过滤模块中，我们需要理解什么是过滤，什么是聚焦。简单的说，如果过滤关键字在url中，则返回False，否则返回True。如果聚焦关键字在url中，则返回True，否则返回False。具体可以查看Mspider中的urlfilter.py文件。</p><h1>0x02 URL相似度算法抛砖引玉</h1><hr><p>URL相似度算法在爬虫里不言而喻，这个算法直接决定着爬虫的爬行效率，我将讲解一下我的算法，算是抛砖引玉。</p><p><img alt="enter image description here" img-src="2a764621da47c832163fd2d8f8e2bc615244bbe3.jpg"></p><p>这个算法主要是依靠对URL的拆解与对拆解对象的HASH，这个算法适用类似的需求常见。这个算法是将一个URL拆解为三个维度，第一个维度是netloc，第二个维度是path的各项长度，第三个维度是query对象的参数排序后列表。通过一个数据结构对以上三个维度组合，构建一个可hash的对象。</p><p><img alt="enter image description here" img-src="8d833ffcefb98d6209c5ffc4fe774946b71ff820.jpg"></p><p>利用集合数据结构进行去重，这个能大幅减小普通URL相似度算法对于hash后结果冲突的问题。实际效果如下图。</p><p><img alt="enter image description here" img-src="947ae16b5326d87a2038574ce5497bded25f6774.jpg"></p><p>当爬取了875个链接时，实际相似页面已达到了269849个，因此对于爬虫效率来讲，是个很好的提升。</p><p>这个算法只是实际经验值，实践后得到良好的实际效果，希望大家也能思考更为优秀的相似度算法。</p><h1>0x03 爬行策略详解</h1><hr><p>一般爬行策略为广度优先、深度优先。深度优先搜索通过栈来实现，而广度优先搜索通过队列来实现。</p><p>下面图中的数字显示了深度优先搜索顶点被访问的顺序。</p><p><img alt="enter image description here" img-src="711be3e8e45d41648da6fd490190d4a79edd7ce2.jpg"></p><p>下面图中的数字显示了广度优先搜索顶点被访问的顺序。</p><p><img alt="enter image description here" img-src="7d6f8436054ebe4c682704e05c51ffc09e8b89e5.jpg"></p><p>Mspider中实现爬行策略，这三种搜索方式都是通过对URL队列的排序方式进行调整，通过队列中URL结点的深度参数进行调整，来达到需求目的，爬行策略根据不同需求设置，能更快的发现可疑URL链接。</p><p><img alt="enter image description here" img-src="377a8aacd02b6456952b3bc634bcc270430a37ea.jpg"></p><p>上图当爬行了810个链接时，实际爬行的深度已达到了15层。在实际测试过程中，深度优先爬行能更好的发现可疑链接。</p><h1>0x04 Mspider工具使用说明及效果展示</h1><hr><p>Mspider是本人开发的一个以CLI方式运行的爬虫工具。此爬虫实现了如下功能。希望大家多多star和fork。也欢迎大家随时给我邮箱发送邮件提bug。</p><p><img alt="enter image description here" img-src="ef596812d16b392487a2b45341abecf6c236c95b.jpg"></p><p>CLI下展示如下：</p><p><img alt="enter image description here" img-src="03204284ed40546e99546b36eb3ec8e5c30f1cf6.jpg"></p><p>此爬虫还可以通过文件的config.py进行更详细的配置，比如爬行间隔，忽略标签列表，动静分配比例，user-agent字典等。</p><p><img alt="enter image description here" img-src="ef3fec0fd568f617251289b660c33b452c1f559d.jpg"></p><p>提供几个测试场景：</p><h2>爬行乌云白帽子列表</h2><p>命令：</p><pre><code>#!bash
python run.py -u "http://www.wooyun.org" -k "wooyun.org" --focus "whitehats" --similarity 1 --storage 3
</code></pre><p>效果：</p><p><img alt="enter image description here" img-src="ae6f7b69aa8ac829a29a4744027445f15ba3517d.jpg"></p><h2>深度优先爬行edu站点，进行url相似度过滤，爬行个数为500个</h2><p>命令：</p><pre><code>#!bash
python -u run.py "http://www.njtu.edu.cn/" -k "edu.cn" --policy 1 --storage 0 --count 500
</code></pre><p>效果：</p><p><img alt="enter image description here" img-src="49a89132cec5d7de3ff58be54d4b8436aafaafb5.jpg"></p><h2>爬行联想域名内连接，域名过滤bbs关键字，动态爬行网页，随机优先策略</h2><p>命令：</p><pre><code>#!bash
python run.py -u "lenovo" -k "lenovo" --ignore "bbs" --model 1 --policy 2
</code></pre><p>效果：</p><p><img alt="enter image description here" img-src="d1733354f980736aa91aed086247e13a5e1a5727.jpg"></p><h1>0x05 Mspider的头脑风暴</h1><hr><p>通过改写Mspider的一些功能，比如页面分析模块，URL过滤模块，数据储存模块，可以获得更深入更有意思的信息。</p><p>举个例子，想要获取乌云中sql注入类型漏洞的SQL注入payload。在聚焦爬虫中，通过对改写数据储存模块，让数据库记录获取的dom树，并储存，接着对dom树进行数据挖掘，便可简单实现。</p><h1>0x06 参考文章</h1><hr><p><a href="http://www.docin.com/p-784393108.html">基于URL规则的聚焦爬虫及其应用</a></p><p><a href="http://www.cnblogs.com/luweiseu/archive/2012/07/14/2591331.html">图的深度优先和广度优先搜索</a></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/688" rel="bookmark" id="re1">Flash CSRF</a></li><li><a href="http://drops.wooyun.org/tips/1166" rel="bookmark" id="re2">header的安全配置指南</a></li><li><a href="http://drops.wooyun.org/tips/7710" rel="bookmark" id="re3">Python中eval带来的潜在风险</a></li><li><a href="http://drops.wooyun.org/tips/2671" rel="bookmark" id="re4">无声杯 xss 挑战赛 writeup</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ABBY</span> <span class="reply-time">2016-05-25 15:18:55</span></div><p></p><p>我觉得对于开发者来说，能脚本化编写爬虫是一件挺开心的事情(￣▽￣)&quot;。所以我们团队开发了一个专门让开发者用简单的几行 javascript 就能在云上编写和运行复杂爬虫的系统，叫神箭手云爬虫开发平台： http://www.shenjianshou.cn 。欢迎同行们来试用拍砖，尽情给俺们提意见。有想法的可以加群讨论： 342953471</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">杨某某</span> <span class="reply-time">2016-04-25 14:47:43</span></div><p></p><p>为什么github下载的和文章里说的差异这么大呀？是修改过的？入库这些功能都舍弃了？<br>PS：看了下crawl.py的代码，form里的post行的link是不爬取的？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sf0l</span> <span class="reply-time">2015-06-11 10:17:28</span></div><p></p><p>坐等楼主下一篇文章 ^_^</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ccSec</span> <span class="reply-time">2015-04-21 10:43:06</span></div><p></p><p>要是能支持AJAX爬行就好了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">月流霜</span> <span class="reply-time">2015-04-09 16:34:17</span></div><p></p><p>菜鸟一枚，请教一下，爬行过程中哪个模块或是哪个函数是控制url去重的？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Manning</span> <span class="reply-time">2015-04-09 08:39:37</span></div><p></p><p>接受！我记下来！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">444</span> <span class="reply-time">2015-04-08 20:31:15</span></div><p></p><p>SIMILARITY与STORAGE_MODEL之间是不是做约束比较好，<br>要不SIMILARITY=0 &amp;&amp; STORAGE_MODEL=0或者<br>SIMILARITY=1 &amp;&amp; STORAGE_MODEL=1<br>都不会存储</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Manning</span> <span class="reply-time">2015-04-07 08:53:24</span></div><p></p><p>说的太绝对了吧？你仔细看代码了吗？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">赵日天</span> <span class="reply-time">2015-04-06 20:00:41</span></div><p></p><p>你的那个去相似度..跟我用都差不多.<br>其实很鸡肋的<br>现在很多站点都是伪静态.各种二级目录.通过过滤完全无法处理.<br>我也在思考这一块。<br>想过用HTML里的一些 元素做判断、<br>额不说了- -LOL了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">风之传说</span> <span class="reply-time">2015-04-04 23:42:12</span></div><p></p><p>python 2.7 运行报错。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">生鲜一手</span> <span class="reply-time">2015-04-04 16:27:40</span></div><p></p><p>学习学习</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">第四维度</span> <span class="reply-time">2015-04-04 11:31:52</span></div><p></p><p>python版本是多少？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">saber</span> <span class="reply-time">2015-04-03 16:46:55</span></div><p></p><p>挺屌，可扩展做的好的话能做很多事^_^</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Manning</span> <span class="reply-time">2015-04-03 11:13:44</span></div><p></p><p>考虑了这个问题，一懒就没移植...其实爬了很多网站，基本都是200w内重复数量，set不用考虑冲突的问题</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">insight-labs</span> <span class="reply-time">2015-04-03 11:09:25</span></div><p></p><p>用set去重不如用bloom filter</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sin</span> <span class="reply-time">2015-04-03 10:21:13</span></div><p></p><p>66666666</p><p></p></div></div></div></div></div></main>