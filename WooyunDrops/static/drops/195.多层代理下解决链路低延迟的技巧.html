<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">多层代理下解决链路低延迟的技巧</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">Xeyes</a> <span class="bull">·</span> <time title="2014/03/22 13:19" ui-time="" datetime="2014/03/22 13:19" class="published ng-binding ng-isolate-scope">2014/03/22 13:19</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 背景</h2><hr><p>大多数小伙伴们在渗透测试的时候经常需要挂多层代理隐藏行踪，往往采取在较小的成本上达到最大化资源的利用实现多层代理，并且保持较低的网络延迟进行正常工作。而想要利用多环链路进行匿名，就必须忍受速度质量的降低，我们往往只能在这二者之间寻找平衡点，所谓鱼和熊掌不可兼得。这里楼主分享一个简单实用的方法，各位看官见笑，这个方法我常用于控制远端Windows Server作为前期信息刺探的扫描平台。</p><p>PS：因为Linux下尚未出现能媲美Netsparker，Acunetix Web Vulnerability Scanner 等这类优秀的WEB扫描软件，所以楼主一般会使用远端的Windows Server来安装这些软件进行前期的扫描工作。</p><h2>0x01 原理</h2><hr><p>主要通过TeamViewer远程控制软件实现这一过程，实测过程中TeamViewer具有流量优化的作用。本机通过TeamViewer软件连接服务器的过程中流量通过TeamViewer服务器的优化跟中转实现了一层代理的效果，还能在远端Windows Server 上再次拨一层VPN再对目标进行代理，而不会发生Windows远程终端（3389）连接因为服务器IP的改变而断开连接。</p><h2>0x03 方法</h2><hr><ol><li><p>本地的环境: 电信8M速率，Backbox Linux + Tor + Proxychains + 2个VPN翻墙账户 。</p></li><li><p>远端Windows Server 安装 TeamViewer 服务器版本，设置好密码，安装好后会分配一个固定ID，客户端通过ID进行连接。服务器版本的好处是安装后可以实现服务器无人职守随时连接。</p></li><li><p>本机安装TeamViewer 客户端，通过连接目标ID验证密码后，连接远端Windows Server（需要Windows登录认证）。</p></li></ol><h2>0x04 图示</h2><hr><p>3层代理：</p><p>本机->  TeamViewer -> 服务器 -> VPN（本机通过TeamViewer连接远端Windows Server，流量已经通过TeamViewer服务器的中转实现了一层代理）</p><p><img alt="2014032203270360352.jpg" img-src="1973dee3c987cb6859c3968fc9682686324b28d0.jpg"></p><p>4层代理：</p><p>本机-> VPN 1 -> TeamViewer -> 服务器 -> VPN 2  （VPN 1我用的是香港的VPN出口，速度快）</p><p><img alt="2014032203310127430.jpg" img-src="cc31747d40c81126987ab49fedd9bcda02b9fdd8.jpg"></p><p>5层代理：</p><p>本机-> VPN-> Tor -> TeamViewer -> 服务器(usa) -> VPN  （第二层使用的是Proxychains本地代理Tor启动TeamViewer  ）</p><p><img alt="2014032203513750413.jpg" img-src="023d009885d8781f339ef2abe7db101e0a143755.jpg"></p><p>以我的网络环境实际使用中，使用5层代理桌面连接模式下传输文件速度平均值在50K左右。画质跟速度都在我可以接受的范围。这个方法适用于Linux下控制Windows终端保持画质跟速度的绝佳方法。当然如果不需要桌面终端，我们直接使用Tor加上多个SSH即可达到效果。</p><p><img alt="2014032204005875355.png" img-src="0bc32f288de76ad8a831b448bbcfb863abb5d132.jpg"></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">abaddon</span> <span class="reply-time">2014-04-01 12:55:28</span></div><p></p><p>应该是这样 为了避免被剔除 努力来学习了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">核攻击</span> <span class="reply-time">2014-03-25 14:02:36</span></div><p></p><p>当你用服务器拨vpn之后，TeamViewer连接到服务器应该也是经过vpn的，如下：</p><p>本机 --&gt; TeamViewer --&gt; VPN ↘<br>服务器<br>目标 &lt;-- VPN ↙</p><p>so?</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Xeyes</span> <span class="reply-time">2014-03-24 14:19:33</span></div><p></p><p>TERMINAL SERVER 上都没有发现任何ATTACK TCP/UDP 连接信息。只有TEAMVIEWER 北美服务器的连接。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Xeyes</span> <span class="reply-time">2014-03-24 14:17:14</span></div><p></p><p>TCP UDP 都没有发现任何ATTACK</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ACGT</span> <span class="reply-time">2014-03-24 11:51:55</span></div><p></p><p>所以不如直接mstsc连terminal server</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ACGT</span> <span class="reply-time">2014-03-24 11:50:25</span></div><p></p><p>TeamViewer这一步可以省略，因为只是建立连接时通过TeamViewer server来UDP pinhole，建立连接以后attack就和terminal server直接连接了，走的UDP</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">aba0</span> <span class="reply-time">2014-03-22 16:34:07</span></div><p></p><p>最后端点可以是4G或者蹭网什么的。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">爱上平顶山</span> <span class="reply-time">2014-03-22 13:39:38</span></div><p></p><p>zhi chi ........</p><p></p></div></div></div></div></div></main>