<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Redis漏洞攻击植入木马逆向分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">阿里云安全</a> <span class="bull">·</span> <time title="2015/11/17 14:24" ui-time="" datetime="2015/11/17 14:24" class="published ng-binding ng-isolate-scope">2015/11/17 14:24</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>作者：梦特（阿里云云盾安全攻防对抗团队）</p><h1>0x00 背景</h1><hr><p>2015年11月10日，阿里云安全团队捕获到黑客大规模利用Redis漏洞的行为，获取机器root权限，并植入木马进行控制，异地登录来自IP：104.219.xxx.xxx（异地登录会有报警）。由于该漏洞危害严重，因此阿里云安全团队在2015年11月11日，短信电话联系用户修复Redis高危漏洞，2015年11月14日，云盾系统检测到部分受该漏洞影响沦为肉鸡的机器进行DDOS攻击，发现后云盾系统已自动通知用户。</p><h1>0x01 木马控制协议逆向分析</h1><hr><p>分析发现木马作者，有2个控制协议未完成。</p><ul><li>Connect协议有处理函数，但没有功能，函数地址为0x8048545。</li></ul><p><img alt="" img-src="aae1aab122a6b567fdedf30d71be71c4322d3325.jpg"></p><ul><li><p>sniffsniff协议没有对应的处理函数，作者未实现该功能。</p><p>完全逆向分析后得到控制协议如下表：</p></li></ul><table border="1"><tr><td>协议</td><td>协议格式</td><td>分析描述</td></tr><tr><td>kill</td><td>kill</td><td>结束自身进程</td></tr><tr><td>dlexec</td><td>dlexec IP filepath port</td><td>在指定IP下载文件并执行</td></tr><tr><td>qweebotkiller</td><td>qweebotkiller</td><td>遍历进程PID为0到65535，查找对应文件，若匹配特征EXPORT %s:%s:%s，则删除文件</td></tr><tr><td>system</td><td>system cmdline</td><td>调用系统的/bin/sh执行shell脚本</td></tr><tr><td>connect</td><td>connect ips arg2 arg3 arg4</td><td>有处理函数，但作者把connect的功能给阉割了，并没有去实现connect协议的功能，因此我们只分析出协议1个参数的意议，另外3个参数不知道意义。</td></tr><tr><td>icmp</td><td>icmp IPs attacktime PacketLen</td><td>发动icmp协议攻击</td></tr><tr><td>tcp</td><td>tcp ips port attacktime flags packetlen</td><td>发动TCP的(fin,syn,rst,psh,ack,urg)DDOS攻击，攻击时间为秒。</td></tr><tr><td>udp</td><td>udp ips port attacktime packetlen</td><td>发动UDP攻击。</td></tr><tr><td>sniffsniff</td><td>sniffsniff</td><td>这个协议木马并没有实现功能。</td></tr></table><ul><li><p>协议完成逆向后，我们用Python写了一个控制端，并实现全部协议控制木马，如下图：</p><p><img alt="" img-src="49d6a9f683121a1f2338b6963185f77e5bca2762.jpg"></p></li></ul><h1>0x02 木马概述</h1><hr><p>从逆向得到的协议分析可以发现，该木马的功能主要包括：</p><ul><li>发动DDoS攻击（ICMP、UDP、TCP）</li><li>远程执行命令</li><li>远程下载文件执行</li><li>清除其他后门文件</li></ul><p>文件MD5：9101E2250ACFA8A53066C5FCB06F9848</p><h2>进程操作</h2><ul><li><p>木马启动，木马接受1个参数，参数为要kill的进程PID。函数地址为0x8049C77.</p><p><img alt="" img-src="a158176af1bf0ff3b4aed274650fc55741330279.jpg"></p></li><li><p>木马会启动一个孙子进程执行木马功能，然后当前进程退出。</p></li></ul><h2>文件操作</h2><ul><li><p>暴力关闭文件，关闭0到0xFFFF的文件，调用系统调用sys_close()，函数地址为0x8049C77。</p><p><img alt="" img-src="a5674b849f3232ed2f87c29ecfcf9c7822f38517.jpg"></p></li><li><p>自我删除，调用系统调用<code>sys_readlink()</code>读取<code>/proc/self/exe</code>获取文件路径，<code>sys_unlink()</code>进行删除，处理函数地址为0x80494F3。</p><p><img alt="" img-src="7f686d9842343b2b180e66bffb90e508812a4b1f.jpg"></p></li></ul><h2>网络操作</h2><ul><li><p>连接8.8.8.8的53端口，探测网络是否连接到Internet，处理函数地址为0x8049B90。</p><p><img alt="" img-src="13ed65471a9fbcf60d400c0dba5b89778be2a89a.jpg"></p></li><li><p>连接木马控制端37.xxx.xxx.x的53端口，处理函数地址为0x8049C77。</p><p><img alt="" img-src="41252429b8664c856271e05e496e747dbad748ea.jpg"></p></li></ul><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tools/427" rel="bookmark" id="re1">InsightScan:Python多线程Ping/端口扫描 + HTTP服务/APP 探测，可生成Hydra用的IP列表</a></li><li><a href="http://drops.wooyun.org/tips/783" rel="bookmark" id="re2">远程备份数据库和文件的方法</a></li><li><a href="http://drops.wooyun.org/tips/4707" rel="bookmark" id="re3">Powershell and Windows RAW SOCKET</a></li><li><a href="http://drops.wooyun.org/mobile/9055" rel="bookmark" id="re4">进击的短信拦截马</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Sakura丶小樱</span> <span class="reply-time">2015-11-20 20:41:03</span></div><p></p><p>然并卵系列=。=</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">野驴~</span> <span class="reply-time">2015-11-17 21:43:07</span></div><p></p><p>孙子进程:)</p><p></p></div></div></div></div></div></main>