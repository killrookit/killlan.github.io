<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">一只android短信控制马的简单分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">瘦蛟舞</a> <span class="bull">·</span> <time title="2014/09/18 14:51" ui-time="" datetime="2014/09/18 14:51" class="published ng-binding ng-isolate-scope">2014/09/18 14:51</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 起因</h2><hr><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2014-076180">WooYun: 仿冒电信运营商掌上营业厅的大规模钓鱼事件(大量用户银行卡中招CVV2与密码泄露)</a></p><p>然后有大牛在某电信网厅钓鱼站找到一款android app让我看看，就有了接下来的分析。</p><h2>0x01 观察</h2><hr><p>拿到应用后先装到测试机上观察下,启动程序后立即监控到其向15501730287号码发送短信，内容为<em>软件已安装，但未被jh。当前手机型号nexus5。</em></p><p><img alt="pic" img-src="81a74d62561fb8f822f03ee7d8867713cd39ea04.jpg"></p><p>之后跳转到<em>要激活设备管理器吗？</em>的界面，如果不小心点了激活那卸载就将需要点手法了。</p><p><img alt="pic" img-src="3acf348cfb720d7b49c2e7e50793e9c2eb8e192c.jpg"></p><p>不root的话需要到设备管理器里取消勾选才能正常卸载，如果root也可以直接删文件。</p><p><img alt="pic" img-src="3ee88a2bdadeec0dd468ca0a4f67b523b318b5c3.jpg"></p><p>当受害者点击激活后还会发送短信通知黑客</p><p><img alt="pic" img-src="e14db590b70fa536362441bbc51c9c8bad9569e1.jpg"></p><p>当然你点取消同样也发送短信黑客</p><p><img alt="pic" img-src="18d1e1d670551ec6bac0ee3a4bd2700a43fcea73.jpg"></p><p>当完成这一系列动作后发现木马程序图片消失，并且无法通过系统自带应用管理直接卸载。</p><h2>0x02 分析</h2><hr><p>之后是解包反编译看源码咯，当然没有想象的顺利。因为这些个木马要对抗杀软肯定经过加壳处理的。在apk包中看到了libAPKProtect.so这个东西，那接下来就要针对性的脱壳啦。选择使用zjdroid（需xposed框架）脱壳。大致流程如下：</p><pre><code>添加locat：zjdroid-shell-com.oliuyht.iujyhtgr.m
得到PID：the app target id = 5585

am broadcast -a com.zjdroid.invoke --ei target 5585 --es cmd '{"action":"dump_dexinfo"}'

filepath:/data/app/com.oliuyht.iujyhtgr.m-1.apk mCookie:1899531496

am broadcast -a com.zjdroid.invoke --ei target 5585 --es cmd '{"action":"dump_class","dexpath":"/data/app/com.oliuyht.iujyhtgr.m-1.apk"}'


am broadcast -a com.zjdroid.invoke --ei target 5585 --es cmd '{"action":"backsmali","dexpath":"/data/app/com.oliuyht.iujyhtgr.m-1.apk"}'

the dexfile data save to =/data/data/com.oliuyht.iujyhtgr.m/files/dexfile.dex
</code></pre><p>之后在用JEB或dex2jar反编译，然后就可以静态分析app了。文件较少功能肯定不会太复杂，之前有提到过程序采用了apkprotect防护。</p><p><img alt="pic" img-src="24fb64cb21f998f35f044723b6c00e5bfcc5201f.jpg"></p><p>查看配置申请权限如下（到这里目测是个短信劫持马）</p><pre><code>&lt;uses-permission android:name="android.permission.WRITE_SMS"/&gt;
&lt;uses-permission android:name="android.permission.SEND_SMS"/&gt;
&lt;uses-permission android:name="android.permission.INTERNET"/&gt;
&lt;uses-permission android:name="android.permission.READ_SMS"/&gt;
&lt;uses-permission android:name="android.permission.RECEIVE_SMS"/&gt;
</code></pre><p>配置文件还注册了两个activity和两个broadcast。</p><p>再看主界面代码，当主界面被第一次调用后就禁用此组件相应桌面图片也会消失。</p><p><img alt="pic" img-src="6e4f4057a3262d9b4f611924ac4c118f0ba2b0b9.jpg"></p><p>然后执行发送短信<em>软件已安装，但未被jh。n当前手机型号Build.MODEL</em>，通知黑客。</p><p><img alt="pic" img-src="c8b6f223d71812233455069fbe9b840f48b64888.jpg"></p><p>启动“激活设备管理”界面等待用户点击（一定程度防卸载）。</p><p><img alt="pic" img-src="1fbee97b64ac0078ebe7cc4b074ef1cfced443fe.jpg"></p><p>程序总共发了7条短信6条是发给15501730287其中四条是<em>安装成功，激活成功，发送成功</em>这类消息用来判断受害者状态，剩余两条是用来窃验证码之类的机密短信。只有一条短信是根据黑客发送的短信提取出号码以及内容再发送。就是说黑客可以用短信控制你发送指定短信到指定号码。</p><p><img alt="pic" img-src="e5f6be601b55a9633a937091560bfe9973b85b2f.jpg"></p><p><em>kigdgc</em>类中硬编码了黑客接收短信的号码</p><p><img alt="pic" img-src="71e2587276c70837560a0f53a208c044ad5dd170.jpg"></p><p>整个app大致功能如下</p><p><img alt="pic" img-src="772436c77a05a7bbe6962433acb42289490d9beb.jpg"></p><h2>0x03 总结</h2><hr><p>大致就分析到这里，是一款可以窃取用户电信以及通过短信远程控制手机发送任意短信的短信劫持木马。黑客做了一系列的伪造和防御比如：伪装系统应用、隐藏图标、加壳、<em>this.abortBroadcast();</em>隐藏指令短信。预计黑客可以通过短信控制受害者发送一些吸费软短信，或者发送欺诈短信（比如大宝剑被抓给xxxxxxxx打2W块才能放人）当然短信是从本人手机发出就更具欺骗性了。还可以借此绕过一些验证如预留手机确认等（结合上文提到的钓鱼漏洞这个可能是主要目的）。</p><h2>0x04 查杀</h2><hr><p>LBE正常查杀(安装时就拦截到了)</p><p><img alt="pic" img-src="4388cc6fed17020343e9a3796d1d02b822ae4d90.jpg"></p><p>腾讯手机管家未检测到</p><p><img alt="pic" img-src="fd7949e5aa9d38760f5055fc8bbb6e39bb7ee20f.jpg"></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/20141223141529d33ebc5e18e728db5f4a24d40002e9d1.jpg" style="width:200px;height:200px"></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/2736" rel="bookmark" id="re1">Samsung S Voice attack</a></li><li><a href="http://drops.wooyun.org/papers/548" rel="bookmark" id="re2">WebView中接口隐患与手机挂马利用</a></li><li><a href="http://drops.wooyun.org/tips/3936" rel="bookmark" id="re3">Android Activtity Security</a></li><li><a href="http://drops.wooyun.org/tips/4314" rel="bookmark" id="re4">Android Content Provider Security</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">可乐</span> <span class="reply-time">2016-01-05 09:41:18</span></div><p></p><p>@动后河 错！是卸载腾讯手机管家，再。。。。。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">格列高尔</span> <span class="reply-time">2014-11-10 22:39:00</span></div><p></p><p>可以再发一遍网址么，非常感谢，原来的失效了~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">咖啡</span> <span class="reply-time">2014-10-17 09:11:39</span></div><p></p><p>好牛逼的软文。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ifs</span> <span class="reply-time">2014-09-25 10:28:40</span></div><p></p><p>能不能再发一下下载地址啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小菜一碟</span> <span class="reply-time">2014-09-20 20:56:27</span></div><p></p><p>360 直接扫描就秒杀了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瘦蛟舞</span> <span class="reply-time">2014-09-19 17:56:15</span></div><p></p><p>目测你的样本和我的有点不一样~可以共享出来看看。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">疯子</span> <span class="reply-time">2014-09-19 14:04:30</span></div><p></p><p>这APP不光是欺骗短信，而是结合其他的进行大规模诈骗，感谢技术的分析！<br>http://www.madmaner.com/post/39964f_25fc1d6</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瘦蛟舞</span> <span class="reply-time">2014-09-19 13:38:46</span></div><p></p><p>把360查杀的那张图删了，哈哈</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">冰心</span> <span class="reply-time">2014-09-19 09:48:53</span></div><p></p><p>thank!</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瘦蛟舞</span> <span class="reply-time">2014-09-19 08:59:26</span></div><p></p><p>为什么不装lbe了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瘦蛟舞</span> <span class="reply-time">2014-09-19 08:56:54</span></div><p></p><p>http://pan.baidu.com/s/1bnjHSIV 密码: 08iv</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">动后河</span> <span class="reply-time">2014-09-18 23:23:47</span></div><p></p><p>明白了，马上安装360手机卫士！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">冰心</span> <span class="reply-time">2014-09-18 21:30:16</span></div><p></p><p>这个木马程序还有没？能否发我一份研究下</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">军哥哥</span> <span class="reply-time">2014-09-18 18:19:06</span></div><p></p><p>好牛逼的软文。</p><p></p></div></div></div></div></div></main>