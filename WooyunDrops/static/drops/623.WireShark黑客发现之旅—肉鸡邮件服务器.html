<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">WireShark黑客发现之旅—肉鸡邮件服务器</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">聚锋实验室</a> <span class="bull">·</span> <time title="2015/07/06 10:45" ui-time="" datetime="2015/07/06 10:45" class="published ng-binding ng-isolate-scope">2015/07/06 10:45</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 背景</h1><hr><p>肉鸡也称傀儡机，是指可以被黑客远程控制的机器。一旦成为肉鸡，就可以被攻击者随意利用，如：窃取资料、再次发起攻击、破坏等等。下面将利用WireShark一起学习一种肉鸡的用途：广告垃圾邮件发送站。</p><h1>0x01 发现问题</h1><hr><p>在对某企业服务器群进行安全检测时发现客户一台服务器（10.190.214.130）存在异常，从其通信行为来看应该为一台空闲服务器。 经过一段时间的抓包采集，对数据进行协议统计发现，基本均为SMTP协议。</p><p><img alt="enter image description here" img-src="6b646e05638647ac47831a0a255965735acac04c.jpg"></p><p><img alt="enter image description here" img-src="69ce8f0293b58bc73c38759ed23e6b3ff4b4db2b.jpg"></p><p>SMTP协议为邮件为邮件传输协议。正常情况下出现此协议有两种情况：</p><pre><code>1、用户发送邮件产生。
2、邮件服务器正常通信产生。
</code></pre><p>该IP地址属于服务器，所以肯定非个人用户利用PC机发送邮件。</p><p>那这是一台邮件服务器？如果是，为什么仅有SMTP协议，POP3、HTTP、IMAP等等呢？</p><p>带着疑问我们统计了一下数据的IP、端口等信息：</p><p><img alt="enter image description here" img-src="bb5ab67b510398d850b8f944903e2aca4f2684f7.jpg"></p><p>统计信息表明：所有通信均是与61.158.163.126（河南三门峡）产生的SMTP协议，且服务器（10.190.214.130）开放了TCP25端口，它的的确确是一台邮件服务器。</p><p>到这，很多安全分析人员或监控分析软件就止步了。原因是IP合理、逻辑也合理、SMTP协议很少有攻击行为，以为是一次正常的邮件通信行为。那么很可惜，你将错过一次不大不小的安全威胁事件。</p><p>职业的敏感告诉我，它不是一台合理的邮件服务器。这个时候需要用到应用层的分析，看一看它的通信行为。继续看看SMTP登陆过程的数据。</p><p><img alt="enter image description here" img-src="a6938a671fe8c2c93ae41e86ee30c33989371dda.jpg"></p><p>从数据看出，邮箱登陆成功，右键Follow TCPStream可以看见完整登陆信息。</p><p><img alt="enter image description here" img-src="cfb0d9862f8255188a4703501ebacfead6c57ed0.jpg"></p><pre><code>334 VXNlcm5hbWU6          // Base64解码为：“Username:”
YWRtaW4=  //用户输入的用户名，Base Base64解码为：“admin”
334 UGFzc3dvcmQ6         //Base64解码为：“Password:”
YWRtaW4=  //用户输入的密码，Base Base64解码为：“admin”
235 Authentication successful.  //认证成功
MAIL FROM:&lt;<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="95f4f1f8fcfbd5e6ece6e1f0f8bbf8f4fcf9">[email&#160;protected]</a>&gt;  //邮件发送自……
</code></pre><p>这段数据表明：61.158.163.126通过SMTP协议，使用用户名admin、密码admin，成功登陆邮件服务器10.190.214.30，<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="769ff4d892cdc090eafb93fcd793efde91ecf293e9e993e6fb92cecc36050f0502131b581b171f1a">[email&#160;protected]</a>，<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="ac4814384924054b3804cdc8c1c5c2ecdfd5dfd8c9c182c1cdc5c049233d452c2d452e0248171a4f2c2e">[email&#160;protected]</a></p><p>一看用户名、密码、邮箱，就发现问题了：</p><blockquote><p>1、admin账号一般不会通过互联网登陆进行管理。</p><p>2、“二货”管理员才会把admin账号设为密码。</p><p><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="f7c414777612686812677ab7848e8483929ad99a969e9b134f79125955117f40116057134c4c134a6212724410444c147775">[email&#160;protected]</a></p></blockquote><p>很显然，这是一台被控制的邮件服务器—“肉鸡邮件服务器”。</p><h1>0x02 行为跟踪</h1><hr><p>发现问题了，下一步跟踪其行为，这个肉鸡服务器到底是干什么的。查看Follow TCPStream完整信息可发现：<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="fd1542641b655219457d184d7c1a694c9c99909493bd8e848e899890d3909c94911a435918726c1a6779147f5319464b">[email&#160;protected]</a>，收件人包括： <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="40373737767571747179707677007172766e232f2da3c0c137393170727074">[email&#160;protected]</a>@<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="d1a8b0b9bebeffb2bebcffb2bf325150abb9b0beb2bde091e0e7e2ffb2bebc367c58e0e135697b356b6b">[email&#160;protected]</a>（带QQ的邮箱暂时抹掉，原因见最后），邮件内容不多。</p><p><img alt="enter image description here" img-src="b4cb64c0346d92ef59ca8a2a2a1e7057a411045e.jpg"></p><p><img alt="enter image description here" img-src="d1182a3f6e77aa3f9b12e78723e0d3f4c8abdb27.jpg"></p><p>为看到完整邮件内容，我们可以点击Save As存为X.eml，用outlook等邮件客户端打开。</p><p><img alt="enter image description here" img-src="d484829fa9f06826050549e552d6d0bafb9e5409.jpg"></p><p>一看邮件，所有谜团都解开了。邮件内容就是一封“巧虎”的广告垃圾邮件，该服务器被攻击者控制创建了邮件服务器，用于垃圾邮件发送站。再用同样的方法还原部分其它邮件：</p><p><img alt="enter image description here" img-src="38df7a54494fbd65b619d82e1e14acbceabe6c70.jpg"></p><p><img alt="enter image description here" img-src="24193bc03edb6a3e29fe4955e45b918135155a76.jpg"></p><p>可以看出邮件内容完全一样，从前面图中可看出短时间的监控中SMTP协议有几十次会话，也就说发送了几十次邮件，涉及邮箱几百人。邮件中的域名http://url7.me/HnhV1打开后会跳转至巧虎商品的广告页面。</p><p><img alt="enter image description here" img-src="61fa8fcbefebb21166a4b83d15c987d433b527fe.jpg"></p><h1>0x03 分析结论</h1><hr><blockquote><p>1、该服务器经简单探测，开放了TCP25/110/445/135/3389/139等大量高危端口，所以被攻击控制是必然。</p><p>2、该服务器已被控制创建了肉鸡邮件服务器（WinWebMail），<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="20c9a28ec49b96c6bcadc5aa81c5b988c5bfbfc5b0adc4989a6053595354454d0e4d41494c">[email&#160;protected]</a>，由61.158.163.126（河南省三门峡市）<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="90742d2f770438f1f4fdf9fed0e3e9e3e4f5fdbefdf1f9fc77043876182777092b752d05">[email&#160;protected]</a>，通过邮件客户端或专用软件往外发送垃圾邮件。</p><p>3、简单百度一下，<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="3edb80b6db9aa4da8484da82a4d985b1db8686d8aa88dbb68ed8a39bd6b9945f5a5357507e4d474d4a5b5310535f5752d9a4badba0bddba280d7bc90da8588">[email&#160;protected]</a>，今天终于弄清了它的来龙去脉。</p><p>4、垃圾邮件发送不是随便发的，是很有针对性的。巧虎是幼儿产品，从接受邮件的QQ号码中随便选取4位查询资料发现发送对象可能都为年轻的爸爸妈妈。</p></blockquote><p><img alt="enter image description here" img-src="6a90e525e55491feb13f2d8c3485ac35a5d8db90.jpg"></p><p><img alt="enter image description here" img-src="0703fa0f4c3c542044323e51488207685a0ebb0f.jpg"></p><p><img alt="enter image description here" img-src="dacf169d1ba947e1227981e55ce2e33ecb31c0f8.jpg"></p><p>申明：文章中出现IP、邮箱地址等信息均为安全监控、攻击防范学习交流所用，切勿用于其它用途，否则责任自负。</p><h1>0x04 后续文章初步设计</h1><hr><p>对于后续文章内容，初步设计WireShark黑客发现之旅--暴力破解、端口扫描、Web漏洞扫描、Web漏洞利用、仿冒登陆、钓鱼邮件、数据库攻击、邮件系统攻击、基于Web的内网渗透等。但可能会根据时间、搭建实验环境等情况进行略微调整。 （By：Mr.Right、K0r4dji）</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/7779" rel="bookmark" id="re1">Wireshark黑客发现之旅（4）——暴力破解</a></li><li><a href="http://drops.wooyun.org/tips/6631" rel="bookmark" id="re2">WireShark黑客发现之旅--开篇</a></li><li><a href="http://drops.wooyun.org/tips/7300" rel="bookmark" id="re3">WireShark黑客发现之旅（3）—Bodisparking恶意代码</a></li><li><a href="http://drops.wooyun.org/tips/9106" rel="bookmark" id="re4">WireShark黑客发现之旅（6）—“Lpk.dll劫持+ 飞客蠕虫”病毒</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">打不过就哭</span> <span class="reply-time">2016-06-23 16:09:07</span></div><p></p><p>@怎么来 因为这个就是个肉鸡服务器，账号还加密不麻烦吗</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">聚锋实验室</span> <span class="reply-time">2016-06-17 12:39:07</span></div><p></p><p>@怎么来 邮件客户端到邮件服务器之间任何地方流量监控都可以获取，前提是没有加密。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">怎么来</span> <span class="reply-time">2016-05-05 11:48:42</span></div><p></p><p>请教作者，邮件服务器登陆的账号信息，怎么能从邮件客户端监测得到呢？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">神笔马良</span> <span class="reply-time">2015-12-04 23:38:58</span></div><p></p><p>值得学习</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">豌豆</span> <span class="reply-time">2015-09-06 17:00:57</span></div><p></p><p>估计是做CPA是赚佣金的吧，一个6元</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">evethunder</span> <span class="reply-time">2015-07-27 11:43:24</span></div><p></p><p>很厉害，确实有学习。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小弟</span> <span class="reply-time">2015-07-23 10:25:23</span></div><p></p><p>又学到新姿势了！以前做应急响应的时候人家把日志什么滴都清除了，完全没头绪进行下去..</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">BugMeOut</span> <span class="reply-time">2015-07-08 12:37:18</span></div><p></p><p>nice，跟看小说一样。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Fvckyou</span> <span class="reply-time">2015-07-07 17:05:05</span></div><p></p><p>特别赞。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">聚锋实验室</span> <span class="reply-time">2015-07-06 23:04:40</span></div><p></p><p>@cmxz<br>我认为有两个用处：<br>1、每次发送垃圾邮件需发送成千上万甚至更多，所以一般需要一台服务器的性能才能快速处理，小黑才看中了人家闲置的服务器。<br>2、肉鸡邮件服务器也有Vps的功能，能更好隐藏发送者的ip地址。</p><p>至于是不是被其它邮件服务器过滤，和是否用肉鸡发没关系。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">cmxz</span> <span class="reply-time">2015-07-06 17:29:20</span></div><p></p><p>用肉鸡的IP发邮件又有何优点呢？仅仅是一个新IP，其他邮件服务器直接丢入垃圾箱？</p><p></p></div></div></div></div></div></main>