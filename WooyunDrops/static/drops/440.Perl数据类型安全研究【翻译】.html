<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Perl数据类型安全研究【翻译】</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">路人甲</a> <span class="bull">·</span> <time title="2015/01/06 14:53" ui-time="" datetime="2015/01/06 14:53" class="published ng-binding ng-isolate-scope">2015/01/06 14:53</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 背景</h1><hr><p><img alt="enter image description here" img-src="323df8606f9a449df31f56f8010a840687410aa6.jpg"></p><p>前几天有个人在某大会上讲了一个在perl中存在了20年的问题。作为一个只会perl不会python的人，真的很心痛。看完视频后感觉被黑的吃不下东西。</p><p>这俨然就是一场对perl的吐槽批斗大会，整个演讲充满了sucks、fuck等和谐词汇，也能看出演讲者是多么的义愤填膺，场下一次次的鼓掌和附，嗯，让我想起了郭德纲。</p><h1>0x01 问题</h1><hr><p><img alt="enter image description here" img-src="a2df43af534c3e38596523df8f2ad457329399ae.jpg"></p><p>言归正传，这个在perl中存在了20年的问题到底是啥呢？抛去perl的语法的槽点，真正的问题在data types上，对的，就是数据类型。</p><p>Perl对数据类型的处理真是有点匪夷所思了。</p><p>我们先了解一下perl中的变量有哪几种。</p><p>perl中的变量</p><p>perl的数据类型分为三类：标量$，数组@，哈希%。</p><p>具体定义在这里不多说，我们来看几个例子：</p><p><img alt="enter image description here" img-src="6d230619aec9983ea3403ba36f201158c3ce5bbb.jpg"></p><p>不管是标量、数组还是哈希（字典），定义跟其他语言没什么区别。</p><p><img alt="enter image description here" img-src="3fab97d63f754e38764a604968c6cc862f73b89f.jpg"></p><p>我们来看看几个特殊的情况，下面每个预期值为正常人类理解应该得到的结果。</p><pre><code>#!perl
@array =(1, 2, 'a', 'b', 'c');
print $array[0];
</code></pre><p>预期值 1</p><p><img alt="enter image description here" img-src="59553c8fcf7b4c2e16708571ea476c55d77306f5.jpg"></p><p>实际值 1</p><pre><code>#!perl
$scalar = (1, 2, 'a', 'b', 'c'); 
print $scalar;
</code></pre><p>预期值 1</p><p><img alt="enter image description here" img-src="024c10ac60599e780f7dea1badc3cacff903f378.jpg"></p><p>实际值 c 我擦泪，为毛会是c！太不科学了，继续往下看。</p><pre><code>#!perl
@list = (1, 2, 'a', 'b', 'c'); 
print scalar @list;
</code></pre><p>预期值 1</p><p><img alt="enter image description here" img-src="3075c367fe1171af919a4e5ae78d0cb46fe2a953.jpg"></p><p>实际值 5 呵呵，他把数组的长度输出了。</p><p>再看看这个哈希的例子</p><pre><code>#!perl
%hash = (1, 2, 'a', 'b', 'c'); 
print $hash{'a'};
</code></pre><p>预期值 木有</p><p><img alt="enter image description here" img-src="b580757312079952726e6bd4af50eb6bab6740db.jpg"></p><p>实际值 b 为毛把b给输出了，谁能告诉我这头草泥马是怎么处理的。</p><h1>0x02 漏洞</h1><hr><p>这些问题会产生什么漏洞呢？</p><p>一起看看在web中php跟perl处理的对比。</p><p><img alt="enter image description here" img-src="7714a92eca89a307a5ae170a6553d813740a8d34.jpg"></p><p><img alt="enter image description here" img-src="89dc23be04e9e02e93c1918f3d54f57fc34f8bcb.jpg"></p><p>这么看来是木有任何问题的，那么使用复参的时候呢？</p><p><img alt="enter image description here" img-src="d2c2402ee340e5472a911083cf3f9cf8cc3ae612.jpg"></p><p>php很好的处理了传入的数据，而perl的做法就是草泥马在奔腾%>_&lt;%他是直接可以传入数组的。</p><p>再深入一下，看看当数组和哈希结合的时候的情况。</p><pre><code>#!perl
@list = ('f', 'lol', 'wat');
$hash = {'a' =&gt; 'b',
         'c' =&gt; 'd', 
         'e' =&gt; @list
};
print $hash;
</code></pre><p>预期值</p><pre><code>#!perl
{
'a' =&gt; 'b',     
'c' =&gt; 'd',     
'e' =&gt; ['f','lol','wat'] 
} 
</code></pre><p><img alt="enter image description here" img-src="4ca7fe1249fc23d9fc48c00d63e158505ec97d4f.jpg"></p><p>神马情况，数组中的“，”变成了“=>”又给赋值了？e=>f、lol=>wat，what the f*cuk！</p><p><img alt="enter image description here" img-src="c55ca189c3f88ced368e1ba925a2c9bf3efaab45.jpg"></p><p>这是多大的一个坑啊！看Bugzilla是怎么掉进去的。</p><p>http://zone.wooyun.org/content/15628</p><p>关于数据类型的这些问题我不想再说了，有些恶心。</p><h1>0x03 GPC的问题</h1><hr><p><img alt="enter image description here" img-src="33322cec56433ca76137a7cfcfeef5cd5433cb6c.jpg"></p><p><img alt="enter image description here" img-src="3ce23f54fd41fc9f623cbcc8100ca9b9384936c4.jpg"></p><p>屌屌的棒棒的，对吧，可是……</p><p><img alt="enter image description here" img-src="7837f21d6f87dc8524dbd9b88f9827d19e0eff21.jpg"></p><p>我了个*，一个都不给转义了，就这么罢工了，可以顺顺畅畅的注入了好么。</p><p><img alt="enter image description here" img-src="1ae9c6b913d1edb5fa1099125dead29f1fd6af32.jpg"></p><p>我想静静。</p><h1>0x04 来源</h1><hr><p>Pdf：</p><p>http://events.ccc.de/congress/2014/Fahrplan/system/attachments/2542/original/the-perl-jam-netanel-rubin-31c3.pdf</p><p>视频地址：</p><p>http://media.ccc.de/browse/congress/2014/31c3_-<em>6243</em>-<em>en</em>-<em>saal_1</em>-<em>201412292200</em>-<em>the&#95;perl&#95;jam&#95;exploiting&#95;a&#95;20&#95;year-old_vulnerability</em>-&#95;netanel&#95;rubin.html#video</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Crise</span> <span class="reply-time">2016-02-02 18:24:00</span></div><p></p><p>这些容易出错的地方 明眼人的预期就是和实际的值相同，perl对上下文环境敏感 根据你所吐槽的这些内容在perl实际应用中根本就不存在<br>%hash = (1, 2, &#039;a&#039;, &#039;b&#039;, &#039;c&#039;); ＃比如说这个 预期的值就是b阿，hash是成对出现的 也就是说相当于 %hash = (1=&gt;2,<br>&#039;a&#039;=&gt;&#039;b&#039;,<br>&#039;c&#039; =&gt;&#039;&#039;</p><p>);<br>print $hash{&#039;a&#039;};<br>预期值 也就是b啦，这是根本没用过perl的人在台上竭力吐槽么？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">cnhacktnt</span> <span class="reply-time">2015-04-09 08:27:25</span></div><p></p><p>敢黑我大 Perl</p><p>『演讲者是多么的义愤填膺，场下一次次的鼓掌和附』</p><p>演讲者是个逗比吧， 二货处处有，国外也很多。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">helen</span> <span class="reply-time">2015-02-28 14:00:51</span></div><p></p><p>那个带Load URL的工具是什么</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">px1624</span> <span class="reply-time">2015-01-09 15:58:41</span></div><p></p><p>这图是骆驼还是草泥马？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">乌帽子</span> <span class="reply-time">2015-01-09 11:51:30</span></div><p></p><p>各种奇葩的配图啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Jea</span> <span class="reply-time">2015-01-08 12:51:33</span></div><p></p><p>Perl是很灵活的语言,但太灵活了,导致一些使用者不知其然,不知其所以然!如同大家所知道的,让你去照顾另一个人用Perl创造的生命!理解不了结果就是使用出错,不知道Larry Wall会不会理他</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">gainover</span> <span class="reply-time">2015-01-08 11:50:49</span></div><p></p><p>原pdf里几个例子还确实蛮经典的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Perler</span> <span class="reply-time">2015-01-07 17:26:35</span></div><p></p><p>不是 bind，是 execute 。估计你这是头脑中和起端口的概念混了。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">kkk</span> <span class="reply-time">2015-01-07 11:19:11</span></div><p></p><p>微博跑过来的，就知道肯定要被喷了。虽然不精通perl，但真的还是用过一段时间的，感觉灵活度很高。文主的基础有点令人堪忧啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">tanjiti</span> <span class="reply-time">2015-01-07 10:28:34</span></div><p></p><p>我认为<br>@list = (1, 2, &#039;a&#039;, &#039;b&#039;, &#039;c&#039;);<br>print scalar @list;<br>等价于<br>$b = @list = (1, 2, &#039;a&#039;, &#039;b&#039;, &#039;c&#039;);<br>print $b;<br>所以说在<br>【在标量上下文环境中的列表赋值操作，会返回赋值操作符右边元素的个数】</p><p>flw有句话是赞同的，这是perl的特性，灵活但容易出错。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瞌睡龙</span> <span class="reply-time">2015-01-07 10:20:53</span></div><p></p><p>这说的是，作者列举的perl特性可能很多perl程序员不会意识到会有什么问题，也可以看出Bugzilla都踩进去了一个坑，导致了一个很严重的漏洞，一个语言如果你研究的很透彻了会避免产生这种问题，但我觉得语言的本身应该降低理解门槛。至于DBI注入的问题，很多程序员的第一想法应该就是你本身做了防注入处理我可以安心使用了，再传参进去竟然就可以安心的闭合单引号进行注入，这个问题明显也是没有考虑周到。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">s0mun5</span> <span class="reply-time">2015-01-07 10:10:23</span></div><p></p><p>论一个程序员的自尊，哈哈，我只是翻译而已，大神们来骂我干嘛？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">lxj616</span> <span class="reply-time">2015-01-07 10:08:36</span></div><p></p><p>数据类型本身没有问题，但如果开发者对perl理解不够深入，就容易发生问题，文章说的并不是perl本身有逻辑错误，说的是容易被误用而导致漏洞的语言难点</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">c0lc</span> <span class="reply-time">2015-01-07 09:52:33</span></div><p></p><p>这水平堪忧啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">winsyk</span> <span class="reply-time">2015-01-07 09:42:08</span></div><p></p><p>-_- 居然把flw大神都引来了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">就是</span> <span class="reply-time">2015-01-07 09:28:06</span></div><p></p><p>看了前2个就笑喷了，还说只会perl，我看是只会perl的拼写吧<br>，只说明一下：<br>$scalar = (1, 2, &#039;a&#039;, &#039;b&#039;, &#039;c&#039;);<br>跟<br>($s0mun5,$is,$sb) = (&#039;s0mun5&#039;,&#039;is&#039;,&#039;sb&#039;);<br>sprintf(&#039;%s %s %s&#039;,$s0mun5,$is,$sb);<br>有异曲同工之妙</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Perler</span> <span class="reply-time">2015-01-07 00:19:11</span></div><p></p><p>不要说大骆驼，即使好好读遍小骆驼也不至于出来现眼。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">flw</span> <span class="reply-time">2015-01-07 00:11:49</span></div><p></p><p>亏这帖子还是发在【乌云】上呢！！！<br>用拼接字符串的方式生成 SQL 这就是一切 SQL 注入漏洞之源！！！</p><p>为什么不用 prepare 然后 bind 参数的方式？<br>不管是什么编程语言，你只要涉及到数据库操作，<br>你就记住，你不要拼凑 SQL 语句，而是留占位符，prepare，然后 bind，就不会有任何问题了！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">flw</span> <span class="reply-time">2015-01-07 00:09:20</span></div><p></p><p>你一开始写的完全不对自己意识到了就姑且不论了。<br>后来你纠正了一次还是不对：<br>你第二条提到的 print scalar @list 根本不是什么【在标量上下文环境中的列表赋值操作】，这里的列表赋值操作是妥妥的列表上下文，没有任何问题。在标量上下文的不是列表复制操作，而是【数组】，数组在标量上下文中返回它的元素个数（长度），没有任何问题 —— Perl 就是这么设计的。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">flw</span> <span class="reply-time">2015-01-07 00:06:31</span></div><p></p><p>楼主就你这水平也好意思说自己“只会 Perl”？<br>连基本的赋值语句都没搞明白就出来混了？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">wostis</span> <span class="reply-time">2015-01-07 00:00:54</span></div><p></p><p>无脑黑，基础都没学好就在这跟风黑，这就是只会perl的水平？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">3xpl0it</span> <span class="reply-time">2015-01-06 23:19:44</span></div><p></p><p>静看骆驼了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">泳少</span> <span class="reply-time">2015-01-06 23:11:46</span></div><p></p><p>valo别闹！！！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">winsyk</span> <span class="reply-time">2015-01-06 21:46:06</span></div><p></p><p>MM 说的是。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">tanjiti</span> <span class="reply-time">2015-01-06 19:36:07</span></div><p></p><p>纠正我说错的地方：<br>没有得到预期的值，是因为混淆了列表、数组、散列之间的区别</p><p>1.<br>$scalar = (1, 2, &#039;a&#039;, &#039;b&#039;, &#039;c&#039;);<br>print $scalar;</p><p>输出结果&#039;c&#039;的原因是<br>逗号操作符在标量上下文中会返回最右边的元素</p><p>2.<br>@list = (1, 2, &#039;a&#039;, &#039;b&#039;, &#039;c&#039;);<br>print scalar @list;</p><p>输出结果5的原因是<br>在标量上下文环境中的列表赋值操作，会返回赋值操作符右边元素的个数</p><p>3.<br>%hash = (1, 2, &#039;a&#039;, &#039;b&#039;, &#039;c&#039;);</p><p>print $hash{&#039;a&#039;};<br>输出结果b的原因是</p><p>列表赋值给散列时，会按key，value，key，value，key，value...的方式映射<br>%hash实际是<br>&#039;1&#039;=&gt;2<br>&#039;a&#039;=&gt;&#039;b&#039;<br>&#039;c&#039; 单了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">tanjiti</span> <span class="reply-time">2015-01-06 18:33:58</span></div><p></p><p>讨厌说perl坏话<br>我来解释一下<br>@list = (1, 2, &#039;a&#039;, &#039;b&#039;, &#039;c&#039;);<br>print scalar @list;<br>为什么会是c</p><p>上面的语句等价于<br>perl -e &quot;print scalar(1,2,&#039;a&#039;,&#039;b&#039;,&#039;c&#039;)&quot;<br>而逗号操作符在标量上下文中会返回最右边的元素</p><p>p.s.文章还没看完,但讨厌说perl坏话，讨厌</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Matt</span> <span class="reply-time">2015-01-06 17:17:57</span></div><p></p><p>复参的问题 apache本身对复参只取后面的value.并不是php的问题。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">shawshank</span> <span class="reply-time">2015-01-06 17:17:48</span></div><p></p><p>我只想说草泥马和骆驼是两个物种...</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Net 胡来</span> <span class="reply-time">2015-01-06 16:09:07</span></div><p></p><p>静静是谁...</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">肉肉</span> <span class="reply-time">2015-01-06 15:25:32</span></div><p></p><p>第一次看到这么可爱地阐述观点的文章，被萌哭</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">story</span> <span class="reply-time">2015-01-06 15:15:23</span></div><p></p><p>为毛这么多草泥马</p><p></p></div></div></div></div></div></main>