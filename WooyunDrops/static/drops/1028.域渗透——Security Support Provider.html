<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">域渗透——Security Support Provider</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">三好学生</a> <span class="bull">·</span> <time title="2016/02/02 11:54" ui-time="" datetime="2016/02/02 11:54" class="published ng-binding ng-isolate-scope">2016/02/02 11:54</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 前言</h1><hr><p>在之前的文章中介绍了一些域环境中的渗透方法和技巧，所以这次接着介绍一个用来维持域控权限的方法——SSP.</p><p><img alt="Alt text" img-src="376d1de312b12de24e2269d065ba6894ccb545e4.jpg"></p><h1>0x01 简介</h1><hr><p><strong>SSP：</strong></p><p>Security Support Provider，直译为安全支持提供者，又名Security Package.</p><p>简单的理解为SSP就是一个DLL，用来实现身份认证，例如：</p><pre><code>#!bash
NTLM
Kerberos
Negotiate
Secure Channel (Schannel)
Digest
Credential (CredSSP)
</code></pre><p><strong>SSPI：</strong></p><p>Security Support Provider Interface，直译为安全支持提供程序接口，是Windows系统在执行认证操作所使用的API。</p><p>简单的理解为SSPI是SSP的API接口</p><p><strong>LSA：</strong></p><p>Local Security Authority，用于身份认证，常见进程为lsass.exe</p><p>特别的地方在于LSA是可扩展的，在系统启动的时候SSP会被加载到进程lsass.exe中.</p><p>这相当于我们可以自定义一个dll，在系统启动的时候被加载到进程lsass.exe！</p><p><img alt="Alt text" img-src="bfea4fc7e262e4f9acb95447d4b5cfd018d63d74.jpg"></p><p>此图片来自于https://dl.mandiant.com/EE/library/MIRcon2014/MIRcon_2014_IR_Track_Analysis_of_Malicious_SSP.pdf</p><p>如图，这是正常的SSPI结构图，Client APP是我们自定义的dll，通过Secur32.dll可以调用 "<code>credential capture API</code>"来获取LSA的信息</p><p><img alt="Alt text" img-src="034aa8380a54d60e229e6a73a66fffbf74be0d0f.jpg"></p><p>此图片来自于https://dl.mandiant.com/EE/library/MIRcon2014/MIRcon_2014_IR_Track_Analysis_of_Malicious_SSP.pdf</p><p>上图展示了攻击思路，既然可以自定义dll,那么我们就可以定制dll的功能，通过<code>Named Pipe</code>和<code>Shared Memory</code>直接获取<code>lsass.exe</code>中的明文密码，并且能够在其更改密码时立即获得新密码！</p><h1>0x02 mimilib SSP</h1><hr><p>mimikatz早已支持这个功能，而这个文件就是我们使用的时候常常忽略的mimilib.dll</p><p><img alt="Alt text" img-src="6beca4935f489db0fbc12cbc03ad3bc2ff9fe626.jpg"></p><p>下面就实际测试一下如何通过mimilib伪造SSP记录明文密码.</p><p><strong>mimikatz poc地址：</strong><br><a href="https://github.com/gentilkiwi/mimikatz/blob/bb371c2acba397b4006a6cddc0f9ce2b5958017b/mimilib/kssp.c">https://github.com/gentilkiwi/mimikatz/blob/bb371c2acba397b4006a6cddc0f9ce2b5958017b/mimilib/kssp.c</a></p><h1>0x03 实际测试</h1><hr><p><strong>测试环境</strong></p><pre><code>#!bash
域控：server 2008 r2 x64
域内主机： win7 x64
</code></pre><p><strong>测试步骤：</strong></p><h3>1、添加SSP</h3><p>将mimilib.dll复制到域控<code>c:\windows\system32</code>下</p><blockquote><p><strong>注：</strong></p><p>64位系统要用64位的mimilib.dll，32位的会失败</p></blockquote><h3>2、设置SSP</h3><p>修改域控注册表位置：</p><pre><code>#!bash
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\Security Packages\
</code></pre><p>如图 <img alt="Alt text" img-src="758325ec1166eab6e7903573c484fd59b2140fcb.jpg"></p><p>在Security Packages下添加mimilib.dll</p><p>如图 <img alt="Alt text" img-src="6d7ff324f89a81cf349844514023986d94b6f868.jpg"></p><p>点击确认，Security Packages已被添加mimilib.dll</p><p>如图 <img alt="Alt text" img-src="fd4edb79635c31ef4d0147db03211764cc2fbcd1.jpg"></p><h3>3、重启系统</h3><p>域控重启后在<code>c:\windows\system32</code>可看到新生成的文件kiwissp.log</p><p>如图 <img alt="Alt text" img-src="0d73cd7e03bca290f393ca1696b6696c1e11fd8c.jpg"></p><p>kiwissp.log记录了登录账户和密码，如图 <img alt="Alt text" img-src="fcb7603c2fd7ff85d4fea286ae132a16e5239782.jpg"></p><blockquote><p><strong>Tips：</strong></p><p>mimilib只实现了将密码保存到本地，如果把密码发送到远程服务器岂不是威力无穷？</p></blockquote><h1>0x04 补充</h1><hr><h3>1、Memory Updating of SSPs</h3><p>mimikatz同时还支持通过内存更新ssp，这样就不需要重启再获取账户信息</p><p>需要使用mimikatz.exe，命令如下：</p><pre><code>#!bash
privilege::debug
misc::memssp
</code></pre><p><strong>注：</strong></p><p><strong>1、</strong>64系统需要64位的mimikatz，如图</p><p>32位mimikatz失败 <img alt="Alt text" img-src="2034fd6feb1f73b5cf9b3994a33e8b305251df4f.jpg"></p><p>64位mimikatz成功 <img alt="Alt text" img-src="e29043cc4597f4d76888ee7bcf4711ac05247880.jpg"></p><p><strong>2、</strong>内存更新的方法在重启后会失效.</p><h1>0x05 检测</h1><hr><h3>1、注册表</h3><p>检测注册表位置：</p><pre><code>#!bash
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\Security Packages\
</code></pre><h3>2、dll</h3><p>检测<code>%windir%\System32</code>是否有可疑dll</p><h3>3、Autoruns</h3><p>使用工具Autoruns检测LSA</p><p>如图，可以发现添加dll的位置 <img alt="Alt text" img-src="68370d3b9e7423c3f2c2524bf46d828f17a0fc62.jpg"></p><h1>0x06 小结</h1><hr><p>本文仅对SSP的常规用法做了演示，实现了在本地保存域控的账户和密码，而且基于这个思路，可以开发出更多高级的利用方法。</p><p>如果站在防御的角度，常规方法已经力不从心，只有更多的了解攻击才能更好的防御。</p><h1>0x07 参考资料</h1><hr><ul><li><a href="https://en.wikipedia.org/wiki/Security_Support_Provider_Interface">https://en.wikipedia.org/wiki/Security&#95;Support&#95;Provider_Interface</a></li><li><a href="https://dl.mandiant.com/EE/library/MIRcon2014/MIRcon_2014_IR_Track_Analysis_of_Malicious_SSP.pdf">https://dl.mandiant.com/EE/library/MIRcon2014/MIRcon&#95;2014&#95;IR&#95;Track&#95;Analysis&#95;of&#95;Malicious_SSP.pdf</a></li><li><a href="https://msdn.microsoft.com/en-us/library/bb742535.aspx">https://msdn.microsoft.com/en-us/library/bb742535.aspx</a></li><li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms721625(v=vs.85).aspx#_security_security_support_provider_gly">https://msdn.microsoft.com/en-us/library/windows/desktop/ms721625(v=vs.85).aspx#&#95;security&#95;security&#95;support&#95;provider_gly</a></li><li><a href="https://adsecurity.org/?p=1760">https://adsecurity.org/?p=1760</a></li><li><a href="https://technet.microsoft.com/en-us/library/dn408187.aspx">https://technet.microsoft.com/en-us/library/dn408187.aspx</a></li></ul><p><strong>本文由三好学生原创并首发于乌云drops，转载请注明</strong></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/4314" rel="bookmark" id="re1">Android Content Provider Security</a></li><li><a href="http://drops.wooyun.org/tips/1067" rel="bookmark" id="re2">解密MSSQL链接数据库的密码</a></li><li><a href="http://drops.wooyun.org/tips/11804" rel="bookmark" id="re3">Bypass Windows AppLocker</a></li><li><a href="http://drops.wooyun.org/tips/12074" rel="bookmark" id="re4">JavaScript后门深层分析</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">lanyan</span> <span class="reply-time">2016-02-06 19:41:37</span></div><p></p><p>看完第一个懂的就是...骚年该努力学英语了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">chartly2001</span> <span class="reply-time">2016-02-03 22:01:13</span></div><p></p><p>有问题请教淘宝漏洞高手，麻烦大神加扣1793394045。万分感谢</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">带脚镣跳舞</span> <span class="weibo"></span> <span class="reply-time">2016-02-03 17:10:46</span></div><p></p><p>→_→</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Tai7sy</span> <span class="reply-time">2016-02-02 16:25:55</span></div><p></p><p>表示lsass.exe,winlogin.exe在后门中很常见</p><p></p></div></div></div></div></div></main>