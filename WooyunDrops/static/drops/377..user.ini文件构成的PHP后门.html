<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">.user.ini文件构成的PHP后门</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">phith0n</a> <span class="bull">·</span> <time title="2014/10/30 10:51" ui-time="" datetime="2014/10/30 10:51" class="published ng-binding ng-isolate-scope">2014/10/30 10:51</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 背景</h2><hr><p>这个估计很多同学看了不屑，认为是烂大街的东西了：</p><p><a href="http://zone.wooyun.org/content/16114">.htaccess文件构成的PHP后门</a></p><p>那么我来个新的吧：<code>.user.ini</code>。它比<code>.htaccess</code>用的更广，不管是nginx/apache/IIS，只要是以fastcgi运行的php都可以用这个方法。我的nginx服务器全部是fpm/fastcgi，我的IIS php5.3以上的全部用的fastcgi/cgi，我win下的apache上也用的fcgi，可谓很广，不像.htaccess有局限性。</p><h2>0x01 .user.ini</h2><hr><p>那么什么是.user.ini？</p><p>这得从php.ini说起了。php.ini是php默认的配置文件，其中包括了很多php的配置，这些配置中，又分为几种：<code>PHP_INI_SYSTEM</code>、<code>PHP_INI_PERDIR</code>、<code>PHP_INI_ALL</code>、<code>PHP_INI_USER</code>。 在此可以查看：<a href="http://php.net/manual/zh/ini.list.php">http://php.net/manual/zh/ini.list.php</a> 这几种模式有什么区别？看看官方的解释：</p><p><img alt="enter image description here" img-src="5ad87a713b6248f47c25c28c881e204bb3f92b16.jpg"></p><p>其中就提到了，模式为PHP&#95;INI&#95;USER的配置项，可以在ini_set()函数中设置、注册表中设置，再就是.user.ini中设置。 这里就提到了.user.ini，那么这是个什么配置文件？那么官方文档在<a href="http://php.net/manual/zh/configuration.file.per-user.php">这里</a>又解释了：</p><p>除了主 php.ini 之外，PHP 还会在每个目录下扫描 INI 文件，从被执行的 PHP 文件所在目录开始一直上升到 web 根目录（<code>$_SERVER['DOCUMENT_ROOT']</code> 所指定的）。如果被执行的 PHP 文件在 web 根目录之外，则只扫描该目录。</p><p>在 <code>.user.ini</code> 风格的 INI 文件中只有具有 PHP&#95;INI&#95;PERDIR 和 PHP&#95;INI&#95;USER 模式的 INI 设置可被识别。</p><p>这里就很清楚了，<code>.user.ini</code>实际上就是一个可以由用户“自定义”的php.ini，我们能够自定义的设置是模式为“PHP&#95;INI&#95;PERDIR 、 PHP&#95;INI&#95;USER”的设置。（上面表格中没有提到的PHP&#95;INI&#95;PERDIR也可以在.user.ini中设置）</p><p>实际上，除了<code>PHP_INI_SYSTEM</code>以外的模式（包括PHP&#95;INI&#95;ALL）都是可以通过.user.ini来设置的。</p><p>而且，和<code>php.ini</code>不同的是，<code>.user.ini</code>是一个能被动态加载的ini文件。也就是说我修改了<code>.user.ini</code>后，不需要重启服务器中间件，只需要等待<code>user_ini.cache_ttl</code>所设置的时间（默认为300秒），即可被重新加载。</p><p>然后我们看到php.ini中的配置项，可惜我沮丧地发现，只要稍微敏感的配置项，都是<code>PHP_INI_SYSTEM</code>模式的（甚至是php.ini only的），包括<code>disable_functions</code>、<code>extension_dir</code>、<code>enable_dl</code>等。 不过，我们可以很容易地借助<code>.user.ini</code>文件来构造一个“后门”。</p><p>Php配置项中有两个比较有意思的项（下图第一、四个）：</p><p><img alt="enter image description here" img-src="da88a3b19d2342cda25cf96e28993fd57dee4559.jpg"></p><p><code>auto_append_file</code>、<code>auto_prepend_file</code>，点开看看什么意思：</p><p><img alt="enter image description here" img-src="e9620fbd3fbc9aa5fc043cb4079b3361595cc926.jpg"></p><p>指定一个文件，自动包含在要执行的文件前，类似于在文件前调用了require()函数。而auto&#95;append&#95;file类似，只是在文件后面包含。 使用方法很简单，直接写在.user.ini中：</p><pre><code>auto_prepend_file=01.gif
</code></pre><p>01.gif是要包含的文件。</p><p>所以，我们可以借助.user.ini轻松让所有php文件都“自动”包含某个文件，而这个文件可以是一个正常php文件，也可以是一个包含一句话的webshell。</p><p>测试一下，我分别在IIS6.0+Fastcgi+PHP5.3和nginx+fpm+php5.3上测试。 目录下有.user.ini，和包含webshell的01.gif，和正常php文件echo.php：</p><p><img alt="enter image description here" img-src="3a69a5d69cb337bb5ee67d9cc452d239b8cec0dc.jpg"></p><p><img alt="enter image description here" img-src="1c054af65f57ca9063a7446ccc7de65da38c7e8a.jpg"></p><p>访问echo.php即可看到后门：</p><p><img alt="enter image description here" img-src="7df48ae02617076a3d1912def51b76d2ad374ebd.jpg"></p><p>Nginx下同样：</p><p><img alt="enter image description here" img-src="097abc067a74ab351d5769a9e47e6c3c0b40e190.jpg"></p><p><img alt="enter image description here" img-src="8a9fbe51fc4c149b3f15096d28e35394e4eb9ce3.jpg"></p><p>那么，我们可以猥琐地想一下，在哪些情况下可以用到这个姿势？ 比如，某网站限制不允许上传.php文件，你便可以上传一个.user.ini，再上传一个图片马，包含起来进行getshell。不过前提是含有.user.ini的文件夹下需要有正常的php文件，否则也不能包含了。 再比如，你只是想隐藏个后门，这个方式是最方便的。</p><h2>0x02 参考文献：</h2><hr><ul><li><a href="http://php.net/manual/zh/ini.list.php">http://php.net/manual/zh/ini.list.php</a></li><li><a href="http://php.net/manual/zh/configuration.changes.modes.php">http://php.net/manual/zh/configuration.changes.modes.php</a></li><li><a href="http://php.net/manual/zh/configuration.file.per-user.php">http://php.net/manual/zh/configuration.file.per-user.php</a></li><li><a href="http://php.net/manual/zh/configuration.changes.php">http://php.net/manual/zh/configuration.changes.php</a></li></ul><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/2016012414014966dd256dd9219030aec2a4c8fbe00433.jpg" style="width:200px;height:200px"></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/7679" rel="bookmark" id="re1">php比较操作符的安全问题</a></li><li><a href="http://drops.wooyun.org/tips/870" rel="bookmark" id="re2">hackyou2014 CTF web关卡通关攻略</a></li><li><a href="http://drops.wooyun.org/tips/3978" rel="bookmark" id="re3">PHP绕过open_basedir列目录的研究</a></li><li><a href="http://drops.wooyun.org/tips/7279" rel="bookmark" id="re4">创造tips的秘籍——PHP回调后门</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">tt</span> <span class="reply-time">2015-10-25 14:44:09</span></div><p></p><p>@mantis .user.ini 应该是从php5.3.0 起用，你可以升级下看看</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">mantis</span> <span class="reply-time">2015-06-10 18:00:12</span></div><p></p><p>windows+phpnow（php-5.2.14-Win32）测试不成功，求指教</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">_Evil</span> <span class="reply-time">2015-01-14 17:02:30</span></div><p></p><p>赞</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Fire ant</span> <span class="reply-time">2014-12-14 13:10:33</span></div><p></p><p>略屌</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">phith0n</span> <span class="reply-time">2014-11-03 12:55:18</span></div><p></p><p>wamp没有使用fastcgi解析php，所以没有这个选项。<br>windows+phpstudy下测试可以通过。<br>感谢测试，不过更希望您仔细看文章。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">1ee</span> <span class="reply-time">2014-11-03 10:36:40</span></div><p></p><p>wamp(php版本5.5.12)测试不通过。<br>lnmp(php版本PHP 5.3.28)测试通过。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">乌帽子</span> <span class="reply-time">2014-11-02 21:33:19</span></div><p></p><p>官方文档仔细看的人真不多!难得。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Neeke</span> <span class="reply-time">2014-10-31 19:55:27</span></div><p></p><p>这个好</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小森森</span> <span class="reply-time">2014-10-31 08:36:20</span></div><p></p><p>厉害</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">mramydnei</span> <span class="reply-time">2014-10-31 02:51:06</span></div><p></p><p>再看了一遍。文章写的确实很有意思！非常支持这类的研究。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">泳少</span> <span class="reply-time">2014-10-30 23:35:36</span></div><p></p><p>还是不错的嘛</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Knight</span> <span class="reply-time">2014-10-30 19:20:53</span></div><p></p><p>够猥琐，我喜欢。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">/fd</span> <span class="reply-time">2014-10-30 17:00:43</span></div><p></p><p>!</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">pangshenjie</span> <span class="reply-time">2014-10-30 16:47:36</span></div><p></p><p>JJ boom</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">squn</span> <span class="reply-time">2014-10-30 15:49:47</span></div><p></p><p>猥琐流</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">luwikes</span> <span class="reply-time">2014-10-30 15:28:19</span></div><p></p><p>好淫荡</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">justforfun</span> <span class="reply-time">2014-10-30 14:05:06</span></div><p></p><p>好淫荡</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">laterain</span> <span class="reply-time">2014-10-30 13:04:58</span></div><p></p><p>呀呀呀，屌飞了</p><p></p></div></div></div></div></div></main>