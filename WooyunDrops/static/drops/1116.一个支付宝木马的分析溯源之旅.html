<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">一个支付宝木马的分析溯源之旅</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">360安全卫士</a> <span class="bull">·</span> <time title="2016/03/29 14:35" ui-time="" datetime="2016/03/29 14:35" class="published ng-binding ng-isolate-scope">2016/03/29 14:35</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p><strong>Author: 360天眼实验室</strong></p><h1>0x00 引子</h1><hr><p>人在做，天在看。</p><p>与网络的黑暗面斗争中，我们看到太多的年轻人陷入黑产的陷井，少数人暴发横财及时收手还能全身而退，多数人身处产业链的底端所得不多却受牢狱之灾。年轻人是国家的未来，他们敢想敢干而又无知鲁莽，希望他们不要为一时的无知付出太大的代价，今天的这个文章可以算作一个警醒，千金不换回头路。</p><p>网络从来就是一把双刃剑，越来越便捷的知识传播让广大的网络黑产工作者们只需简单修改别人的代码就可以制作出所谓的原创木马病毒，并进一步出售进行获利。近期，360天眼实验室拦截到一类盗取用户支付宝余额的木马，追根溯源揪出了木马制造者及一批木马放马者，而背后的造马者竟是一个高三学生，我们想说考不考得上大学还在其次，这位同学现在最应该读一下网络犯罪相关法条立即收手以免终身受此所累。</p><h1>0x01 样本分析</h1><hr><p>为了对抗查杀，使用易语言做木马开发极其常见，我们所看到的这个样本即是如此，相关的信息如下，供大家参考。</p><p>木马文件MD5: 1976f6cbbc32fcbd7eaa75318642a182</p><p>尽管分析起来有点麻烦，但搞清楚木马行为只是时间问题，主要包括：</p><ul><li>代码加入花指令，对抗分析调试</li><li>过期自动失效（失效后想再次使用木马就要向木马作者缴费再次购买）</li><li>访问腾讯微博、新浪微博链接地址获取支付宝交易的钱数、次数、频率</li><li>开线程监控用户的支付宝转账操作，同时将转账地址替换成放马者指定的支付宝账户</li></ul><h3>加入花指令，对抗分析调试</h3><p>部分花指令如下：</p><p><img alt="" img-src="b4a7264e8ce13247c38fa4115eae68f910004506.jpg"></p><h3>判断木马是否过期</h3><p>过期时间是2016年1月14日，如图：</p><p><img alt="p2" img-src="ce6f7e9986ec948e9d07f13f5d6f3e9e80ba170c.jpg"></p><h3>访问微博链接获取交易欺诈参数</h3><p>访问<code>http://t.qq.com/q912xxx937</code>微博地址，匹配出木马所需的信息，微博内容为：</p><p><img alt="p3" img-src="b983f0c3a7454cf8cb3d76b8e8d63a0453ee1c9f.jpg"></p><p>解密出微博地址：</p><p><img alt="p4" img-src="41db8245de66b781159610bffe5ba3bf592a5178.jpg"></p><p>访问腾讯微博地址，得到微博内容：</p><p><img alt="p5" img-src="11dc9b32e15cb110323de5bab33c7885863e411c.jpg"></p><p>从微博页面中匹配“支付宝读取头部”和“支付宝读取尾部”，匹配出木马预留信息：</p><p><img alt="p6" img-src="215e8f420c3e9d1bf8543e7875c5a530d742630a.jpg"></p><p>获取到页面数据后，通过作者预先写好的开始标记和结束标记读取到用到的数据：</p><p><img alt="p7" img-src="7d46890f13002b844f94faa9ef2ec915e70d80ce.jpg"></p><p>从微博读取到的支付宝所需数据格式为"13267932191|1100|80|1100"，其中的13267932191表示支付宝账号，1100表示快捷金额，80表示触发金额，1100 是最大限额。当然，如果腾讯微博格式发布信息格式不正确，木马还会弹窗报错，提示发布正确格式的微博内容。</p><p><img alt="p8" img-src="2a795eed118cbdb119ab43c5bbb835927b147a16.jpg"></p><p>对于木马转账的支付宝账号：13267932191，推测应该是一个手机号，从搜索引擎搜索结果得知，手机归属地是广州惠州的，如图：</p><p><img alt="p8" img-src="82e6d14d084982ffa7c093c2e81a574d878227e8.jpg"></p><p><img alt="p9" img-src="735695023a9532ea10bfe1300a2d848a35b6443e.jpg"></p><h3>账号替换</h3><p>木马程序打开后起线程不停查找浏览器的窗口，直到浏览器的地址栏包含alipay字符后，木马开始对支付过程进行劫持：</p><p>调用易语言的类库，获取当前的URL地址，用于判断用户是否正在进行支付操作。</p><p><img alt="p10" img-src="ee4c5105b140160abac2b5234231bbdb60ea7226.jpg"></p><p>如果用户正在进行支付操作，就查找<code>https://personalweb.alipay.com/portal/newhome.htm</code>网址中的<code>&lt;span class="integer"</code>标签和<code>&lt;input type="hidden" id="J-mfund-balance" value=</code>标签分别得到用户的账户余额和余额宝的余额。</p><p><img alt="p11" img-src="37bb45c8b663799adb5dacbb540ae87fe9787e25.jpg"></p><p><img alt="p12" img-src="6ba116705eb6e98062f1b5b9e6a2ad51ba7d1e55.jpg"></p><p>在后台进行封包劫持：</p><p><img alt="p13" img-src="2b0f63193ac78796b094f238f09bad4ba2359cc1.jpg"></p><p><img alt="p14" img-src="1d0b945898abc7c6bd3bf6e9e5a3f25da82ac7f4.jpg"></p><p>木马通过注入浏览器，后台Post提交参数的方式，用户从浏览器中看不出有任何的异常，而只有在支付之后的交易记录中，才有可能发现收款人已被替换。而一切都以为时晚矣。</p><h1>0x02 推手追索</h1><hr><p>通过搜索引擎搜索“支付宝读取头部”关键字，我们找到了一批有问题的腾讯微博账号，这些账号大多都是直接从木马作者手中购买木马的“放马者”：</p><p><img alt="p15" img-src="7a08c1d136347c979288c2734a7f7060d65a6961.jpg"></p><p>然后，我们就从这批放马者的账号中发现一个亮瞎眼的账号内容</p><p><code>http://t.qq.com/hy617xxx31</code></p><p>至于亮瞎眼的原因见下图，由此，我们定位到了可疑造马者，QQ号为：5500xxx39和617xxx31 ：</p><p><img alt="p16" img-src="6648d59a5a60c874cc68739329853804da3f6e03.jpg"></p><p>下面我就将按照”造马者”与“放马者”两条线索分别展开。</p><h3>造马者追踪</h3><p>通过对造马者的发微博时的实时位置，定位到造马者经常在四川省南充市活动，如图：</p><p><img alt="p17" img-src="46405c1e503d003f74564cada4b90dbaffe18e82.jpg"></p><p><img alt="p18" img-src="c3298eb7daf760ca43fb4e85dacf934419e09d44.jpg"></p><p>另外，通过对上面两个QQ号公开的信息比较，也确定这两个QQ号都是造马者的QQ号，其中5500xxx39的QQ号为造马者的小号。</p><p><img alt="p19" img-src="2e7d52af583877f1b2fb776cf4becbce220b43c2.jpg"></p><p>而617xxx31为造马者联系木马业务的常用号码：</p><p><img alt="p20" img-src="db67dfe98f1e3854f967c0447cc57fec7d900d00.jpg"></p><p>从搜索引擎也得知，造马者曾被人举报，称造马者盗源码写软件：</p><p><img alt="p21" img-src="b0bc5deeb4790c1c6e20fdc2a7f0fca72301129f.jpg"></p><p>造马者为了销售木马，还专门成立了一个QQ群，推测群里应该有好多放马者，当然根据群位置信息，也可以进一步确定造马者所在的地理位置正是南充，与前面关于造马者地理的推断一致。</p><p><img alt="p22" img-src="832341739ede6f92ed45f4864d0eb4f6a091a2c4.jpg"></p><p>过对造马者QQ持续的关注，基本可以断定造马者是高中生。</p><p>2015年12月份，造马者QQ的修改签名为“秒余额，快捷，余额宝免杀马代秒鱼。回5。需要的私聊大量收家庭肉鸡，有的窗口。”，如下图</p><p><img alt="p23" img-src="01f68cd1986f9ad98ee84df72a232077affc0ce1.jpg"></p><p>而2016年2月29日，QQ个性签名更改为“3月份停工，高考后复出，学习新技能”，可以推断出造马者是高中生：</p><p><img alt="p24" img-src="5c11dfabd75291596d5924736811a8e1aac11de4.jpg"></p><p>与此同时，我们还在造马者的腾讯微博中看到造马者对木马书写的“产品说明书”（支持Windows所有版本）、“广告语”（高度人性化，可操作性强，稳定性强）、价格（支付宝收款700/月，银行卡收款1000/月）等，见下图：</p><p><img alt="p24" img-src="0ecfe1cd65390fba873608e8073096b192f6747d.jpg"></p><p>查询QQ群关系数据库，得到造马人的另外一个常用的QQ号码:963xxxx39：</p><p><img alt="p25" img-src="62bf7a617990ff0cb17aa67f4387b8f01059ee38.jpg"></p><p><img alt="p28" img-src="27911b44df95a200d80288bc63395d73b543cfc8.jpg"></p><p>通过网上搜索QQ963xxxx39，发现造马者经常关注一些网络上的黑客教程，并且曾经从易语言论坛下载过支付宝支付账单源代码，如图：</p><p><img alt="p27" img-src="167ce7c479eb1f5001e59ea03fa3a80493abd8b7.jpg"></p><p><img alt="p28" img-src="9312a55eaf008b12d276744a765a32167a1a3a6d.jpg"></p><p><img alt="p29" img-src="7c04cb46f1a5449c20996e2817aadc16bab12501.jpg"></p><p>把易语言论坛上的这份“支付宝支付账单的源代码”下载后得知，代码的作用是查询支付宝交易记录，造马者在造马的过程中参考过这份源码。如图：</p><p><img alt="p30" img-src="9f668f69ee294d031a86fb92ebf305d00257d8c8.jpg"></p><p>索引擎查询造马者QQ号关键字找到了这个人的优酷账号，其上传的视频中表明造马者的另一个身份：dnf玩家。</p><p><img alt="p31" img-src="d2807a8d5fe55cd8605bcbaf0cdb602bf04230ac.jpg"></p><p>同时搜索引擎告诉我们的还包括造马者的淘宝账号：a963xxxx39</p><p><img alt="p32" img-src="37dfa6f582496c61714e095562cb176699e095bb.jpg"></p><p>在此，我们推测这人的邮箱地址可能为：<code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="8aebb3bca0a0a0a0a0b9b3cabbbcb9a4e9e5e7">[email&#160;protected]</a></code></p><p>通过163找回密码，发现账号绑定的手机号码的后三位与淘宝账号中的手机的后三位是相同的，这就断定<code><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="cfaef6f9e5e5e5e5e5fcf68ffef9fce1aca0a2">[email&#160;protected]</a></code>邮箱是属于造马者的，如图：</p><p><img alt="p33" img-src="6b08bf57b7761198253922bea8ad254168720eb6.jpg"></p><p>通过尝试，找到了造马者的163邮箱密码：96xxxxx39</p><p>在邮箱中的已发送邮件中，大量的cf木马发送的邮件，邮件内容里面都是木马盗取的cf账号和密码等游戏信息。</p><p><img alt="p34" img-src="8085b15a4e618472aee75a3ef6fc5a3a3d93603d.jpg"></p><p><img alt="p35" img-src="4d69f747b01048da709ce266c8d16551aeff6811.jpg"></p><p>此外，观察到邮箱中有作者的MAC地址：00-50-56-c0-00-01，应该是造马者在测试程序时发送的，如图：</p><p><img alt="p36" img-src="8491e85454279d7dbfd5615076fdecb9d8d52802.jpg"></p><p>总结：<br>造马者经常活动于南充，可能的身份为：在校高中学生。机器mac地址可能为： 00-50-56-c0-00-01，作者不仅编写支付宝木马，还曾经盗取过cf游戏账号，常用邮箱为：<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="e283dbd49a9a9a9ad1dba2d3d4d1cc818d8f">[email&#160;protected]</a>，常用密码为：a96xxxxx39，常用的三个QQ号为617xxx31，5500xxx39，和963xxxx39，其中617xxx31号多用来卖支付宝木马；963xxxx39号多用来盗取游戏账号；5500xxx39为小号，不常使用。淘宝账号为：a963xxxxx39，手机号为：136xxxx5205</p><h3>放马者分析</h3><p>购买木马的人数众多，根据360威胁情报中心的数据，木马买家超过40人。我们随意抽取一个购买木马的用户进行探讨。</p><p>以下都是通过搜索引擎得到的放马者的微博地址：</p><ul><li>http://t.qq.com/g29q200w4231975</li><li>http://t.qq.com/r12tb9753197</li><li>http://t.qq.com/oclt519753</li><li>http://t.qq.com/k93y642086</li><li>http://t.qq.com/chenjiaxi88</li></ul><p><img alt="p37" img-src="d8080f542a08dbc2ea5d458240437518ac7aa5f5.jpg"></p><p><img alt="p38" img-src="33857bfe4b7c887efaaf1b9b7662d992a44353b6.jpg"></p><p>对于其中一个放马者，<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="59b0d9c3b1e6debce7f7bcd4c3bcd6c8bed7e9193a313c3733303821306161bec3ddbecdf1bfd1eebec3ddbcc9d4bcf4cebde1e3b0c0d1bde4eab1fce6">[email&#160;protected]</a>，腾讯微博中有其上传的生活照，如下：</p><p><img alt="p39" img-src="35a3a21c5d7a9afd94655ee547e299fbb7192b8a.jpg"></p><p>最后，用这位放马者的QQ群关系来结束这次的追踪之旅：</p><p><img alt="p40" img-src="5339debda5386355bbe7bf759381e354f9270e18.jpg"></p><h1>0x03 总结</h1><hr><p>我们看到的木马本身的技术并不复杂，传播手段也不见得高明，低技术门槛使网络犯罪的参与者呈现年轻化的分布。本次的攻击者溯源完全依赖公开可搜索的数据，甚至无需运用社工技巧，木马开发与使用者的无知无畏实在让人心惊。从造马者自发暴露的大量信息来看，他似乎并不觉得自己在违法犯罪，我们的中学教育在法律学习方面应该加入网络犯罪的内容。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">神盾局</span> <span class="reply-time">2016-06-15 09:15:13</span></div><p></p><p>分析的很棒，学习了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">uuiitwp</span> <span class="reply-time">2016-04-19 20:45:49</span></div><p></p><p>社工好评</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">大风</span> <span class="reply-time">2016-04-10 12:01:00</span></div><p></p><p>造马者和放马者的利益怎么分？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Post</span> <span class="reply-time">2016-03-30 18:01:47</span></div><p></p><p>那么问题来了，这算不算CSRF？<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="cd2b4952256a442868702a7c762971712e4d4f8d245572244a41287a79287a79">[email&#160;protected]</a></p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zifangsky</span> <span class="reply-time">2016-03-30 13:31:27</span></div><p></p><p>通过尝试，找到了造马者的163邮箱密码：96xxxxx39。。。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">jye33</span> <span class="reply-time">2016-03-30 10:26:42</span></div><p></p><p>我是过来看社工的，看来360手里裤子真不小</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">DD叉叉</span> <span class="reply-time">2016-03-30 09:52:17</span></div><p></p><p>只想知道，到底是通过什么“尝试”，找到造马者邮箱密码的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">phoenixne</span> <span class="reply-time">2016-03-30 09:10:09</span></div><p></p><p>技术是其次，这个社工过程是亮点</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">123</span> <span class="reply-time">2016-03-30 08:16:06</span></div><p></p><p>我们的中学教育在法律学习方面应该加入网络犯罪的内容。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">子非海绵宝宝</span> <span class="weibo"></span> <span class="reply-time">2016-03-30 07:58:13</span></div><p></p><p>法律意识淡泊啊。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">刺刺</span> <span class="reply-time">2016-03-30 06:16:08</span></div><p></p><p>00-50-56 这样开头的MAC地址 不是vmware 虚拟机的吗？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">啊啊</span> <span class="reply-time">2016-03-29 19:19:02</span></div><p></p><p>熟悉的界面,OD啊,多年没碰了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">六六</span> <span class="reply-time">2016-03-29 17:16:08</span></div><p></p><p>牛逼啊！！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">康小泡</span> <span class="reply-time">2016-03-29 16:55:21</span></div><p></p><p>好屌</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">test</span> <span class="reply-time">2016-03-29 16:28:52</span></div><p></p><p>通过尝试，找到了造马者的163邮箱密码：96xxxxx39。。。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">roy</span> <span class="reply-time">2016-03-29 16:03:20</span></div><p></p><p>@0xxxxx 应该是通过360后台查询得到造马者的163邮箱密码</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">撸至深</span> <span class="reply-time">2016-03-29 15:30:35</span></div><p></p><p>360屌</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">别逼我改名字啊</span> <span class="weibo"></span> <span class="reply-time">2016-03-29 15:12:38</span></div><p></p><p>乌云君，我这样奔三的菜鸟还能学安全嘛？觉得在这么多黑暗势力前面好无力</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">别逼我改名字啊</span> <span class="weibo"></span> <span class="reply-time">2016-03-29 15:10:28</span></div><p></p><p>已满16岁，独立刑事责任，大学没得上了，3年后见不谢。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">px1624</span> <span class="reply-time">2016-03-29 15:05:52</span></div><p></p><p>卧槽！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">0xxxxx</span> <span class="reply-time">2016-03-29 15:05:43</span></div><p></p><p>通过尝试，找到了造马者的163邮箱密码：96xxxxx39。。。。。</p><p></p></div></div></div></div></div></main>