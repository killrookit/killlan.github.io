<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">使用sqlmapapi.py批量化扫描实践</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">Manning</a> <span class="bull">·</span> <time title="2015/06/19 10:31" ui-time="" datetime="2015/06/19 10:31" class="published ng-binding ng-isolate-scope">2015/06/19 10:31</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 前言</h1><hr><p>sqlmap可谓是sql注入探测的神器,优秀的探测功能可以让任何一个使用者无基础挖掘sql注入。wooyun上关于sqlmap的文章已经有6篇了,都没有科 普sqlmapapi.py。因此我打算分享下这方面的实践。利用sqlmap测试SQL注入的效率很低,每一个url都需要手动测试,这样肯定不是理想状态。 sqlmap的作者肯定也察觉到这一点了,默默的开发了sqlmapapi.py,当你使用了sqlmapapi.py后才能体会到sqlmap的强大。sqlmap构建了一个自动化 分布式的扫描帝国!这篇文章我主要从sqlmapapi.py的代码角度和AutoSqli类的设计与实现的角度展开。</p><h1>0x01 sqlmapapi.py综述</h1><hr><p>sqlmapapi.py给使用者提供了一个强大的功能,服务功能。使用者可以利用sqlmapapi.py开启服务端口,以后只要向sqlmapapi发送请求,就可以进行sql注入,然后发送查询请求,就可以得到这个url是否是注入点,以及详细的内容。同学们看到这里是不是有些小激动呢? sqlmapapi.py的help,我们需要用的是-s参数,也许你也有可能用到-p参数。</p><p><img alt="enter image description here" img-src="b08be8ea92b7b78dfd0cdf300f86ae6eda4a4430.jpg"></p><p>从sqlmapapi.py文件可以看出来,我们利用的文件的调用关系是</p><p><img alt="enter image description here" img-src="ba0b8acd8396d66503a4e0193cbb03979bbdba29.jpg"></p><p>进入到lib/utils/api.py的server类,可以发现通过向server提交数据进行与服务的交互。 一共分为3种类型。</p><ul><li>Users' methods 用户方法</li><li>Admin function 管理函数</li><li>sqlmap core interact functions 核心交互函数</li></ul><p>可以提交数据的种类如下。</p><p>用户方法</p><ul><li>@get("/task/new")</li><li>@get("/task//delete")</li></ul><p>管理函数</p><ul><li>@get("/admin//list")</li><li>@get("/admin//flush")</li></ul><p>核心交互函数</p><ul><li>@get("/option//list")</li><li>@post("/option//get")</li><li>@post("/option//set")</li><li>@post("/scan//start")</li><li>@get("/scan//stop")</li><li>@get("/scan//kill")</li><li>@get("/scan//status")</li><li>@get("/scan//data")</li><li>@get("/scan//log//")</li><li>@get("/scan//log")</li><li>@get("/download///<filename:path>")</filename:path></li></ul><p>不难发现这些操作可以完全满足我们的测试需求,因此利用这些就可以批量了。当然每一种请求都会有不同的返回值,这些返回值是json的形式传回, 解析就好了。其实这些我已经替大家做好了,调用AutoSqli类就可以了,但是还是要挑一些讲下。</p><p>task/new 任务建立</p><pre><code>#!bash
GET /task/new Response:
{
    "taskid": "1d47d7f046df1504" 
}

    /scan/&lt;task_id&gt;/status 扫描任务状态
GET /scan/&lt;task_id&gt;/status Response:
{
    "status": "terminated",
    "returncode": 0 
}
</code></pre><p>详细内容请各自查阅代码。</p><h1>0x02 AutoSqli类</h1><hr><p>我封装AutoSqli类的作用是想轻松的与sqlmapapi.py建立的server进行交互。</p><p>AutoSqli的run方法的执行逻辑图</p><p><img alt="enter image description here" img-src="36e727a02a8fe10b835921ea0131ceaf57c9a8ea.jpg"></p><p>这些步骤就是正常sqlmap扫描的逻辑,因此调用AutoSqli就可以正常执行。</p><p>Show code</p><p><img alt="enter image description here" img-src="fd52a3be47253a9fc62abf389c3f4a9977745ba3.jpg"></p><p>具体代码查看Mspider项目的Autosqli.py文件。</p><p>https://github.com/manning23/MSpider</p><h1>0x03 使用心得</h1><hr><p>AutoSqli类的初始化可以添加url的data,cookie,referer。因此无需顾虑探测需要登陆的页面。</p><p><img alt="enter image description here" img-src="b1828bd77af500b0d65ebb754d7873132fcdfe81.jpg"></p><p>对于AutoSqli类的使用,主要注意option&#95;set()方法的使用,其数据结构为字典,由于可添加的内容超长,因此想添加自动的测试设置请参考Mspider项 目的set&#95;option.txt文件。</p><p><img alt="enter image description here" img-src="ea2787ec54d87d350df0ef30bd2d2f6c85a04c67.jpg"></p><p>说道使用场景,其实我自己已经玩了好久了,说实话效果没达到我的预期,分析下原因。</p><p>现在网站的sql注入确实少了,烧饼类型的主要点更少。</p><p>sqlmap的初始探针不怎么样,想要精准判断还需要研究,个人研究发现对于mysql数据库,使用时间类型探针效果最好,当然需要自己写探针,详 细的参考Mayikissyou牛的文章。顺便吐槽下,Mayikissyou牛的文章,对于探针的改写真是蜻蜓点水啊,我研究了好久才把lijiejie的那些方法加 上:)</p><p>有想法的同学肯定希望我把Mspider和AutoSqli结合下,可是我觉得方法我已经分享了,剩下的同学自己实践吧。实践才能有新的想法。</p><p>sqlmapapi.py就是sqlmap为了分布式扫描SQL注入做的,但是资料真的很少,实践的结果更少,希望这篇分享就当抛砖引玉了,有问题欢迎随时和我交流。还有,Mayikissyou牛的文章真心推荐大家读下,配合我这篇文章,sql注入真是想怎么玩就怎么玩了。</p><h1>0x04 资料</h1><hr><p>http://volatile-minds.blogspot.jp/2013/04/unofficial-sqlmap-restful-api.html</p><p>http://drops.wooyun.org/tips/5254</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/12681" rel="bookmark" id="re1">关于被动式扫描的碎碎念</a></li><li><a href="http://drops.wooyun.org/tools/601" rel="bookmark" id="re2">跑wordpress用户密码脚本</a></li><li><a href="http://drops.wooyun.org/tips/2504" rel="bookmark" id="re3">Burp Suite使用介绍（四）</a></li><li><a href="http://drops.wooyun.org/tools/427" rel="bookmark" id="re4">InsightScan:Python多线程Ping/端口扫描 + HTTP服务/APP 探测，可生成Hydra用的IP列表</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">superfish</span> <span class="reply-time">2016-06-20 13:09:55</span></div><p></p><p>sqlmapapi支持对伪静态url以及http头部字段的检测吗？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zjgwhh</span> <span class="reply-time">2016-05-21 10:39:12</span></div><p></p><p>谢谢分享</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">杨某某</span> <span class="reply-time">2016-04-25 16:34:08</span></div><p></p><p>Mspider项目中的autosqli代码删除了？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">我在不想理你</span> <span class="reply-time">2016-04-08 09:21:34</span></div><p></p><p>@GreyH4t sqlmapapi如何执行-r参数</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">无敌情痴</span> <span class="reply-time">2016-04-04 10:27:50</span></div><p></p><p>谢谢LZ分享，收藏了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">国光</span> <span class="reply-time">2016-03-31 19:48:20</span></div><p></p><p>涨姿势了 感谢分享</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">niexinming</span> <span class="reply-time">2016-03-10 23:35:47</span></div><p></p><p>@1c3z 表哥有用过吗</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ning1022</span> <span class="reply-time">2016-01-30 13:09:43</span></div><p></p><p>不错！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">D＆G</span> <span class="reply-time">2016-01-28 15:28:34</span></div><p></p><p>感谢分享</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">D＆G</span> <span class="reply-time">2016-01-28 15:27:44</span></div><p></p><p>感谢分享</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">D＆G</span> <span class="reply-time">2016-01-28 15:27:29</span></div><p></p><p>dddddd</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">一己</span> <span class="reply-time">2015-12-24 18:03:41</span></div><p></p><p>不错，感谢分享[´・ω・`]</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Manning</span> <span class="reply-time">2015-10-10 09:41:31</span></div><p></p><p>@1c3z 是的，确实这里有bug</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">chizhe</span> <span class="reply-time">2015-09-29 01:57:12</span></div><p></p><p>真的不错</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">1c3z</span> <span class="reply-time">2015-09-05 16:34:15</span></div><p></p><p>def option_set(self):<br>headers = {&#039;Content-Type&#039;: &#039;application/json&#039;}<br>option = {&quot;options&quot;: {<br>&quot;smart&quot;: True,<br>...<br>}<br>}<br>这里实现有点问题，应该把options这层去掉</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">BeenQuiver</span> <span class="reply-time">2015-08-16 09:26:26</span></div><p></p><p>且看sql-hunter</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">2mi</span> <span class="reply-time">2015-07-29 00:01:52</span></div><p></p><p>想实现一下。 在看这方面的资料。最好能实现批量扫描的。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">玉林嘎</span> <span class="reply-time">2015-07-08 17:13:46</span></div><p></p><p>@wilson post可以的 不过这个autosqli不行 改点代码就可以啦</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Ztz</span> <span class="reply-time">2015-06-28 21:04:45</span></div><p></p><p>这个有没有网络方面的功能。比如读取指定txt里的代理列表，并定时自动更换啥的。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">smarttang</span> <span class="reply-time">2015-06-25 12:34:45</span></div><p></p><p>点个赞! 之前一直都是用python写个比较简单的，结果导出到execl，然后用python读取。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">feather</span> <span class="reply-time">2015-06-21 13:44:41</span></div><p></p><p>@neal 同问，汉字dump变成乱码，而且特别慢。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">GreyH4t</span> <span class="reply-time">2015-06-19 20:03:57</span></div><p></p><p>@wilson 抱歉，看错了，sqlmapapi没玩过，不知道</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">GreyH4t</span> <span class="reply-time">2015-06-19 20:03:02</span></div><p></p><p>@wilson 可以的,将post请求复制下来放到文本文档里,用-r参数加载就可以了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">range</span> <span class="reply-time">2015-06-19 18:14:14</span></div><p></p><p>@neal --charset？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sin</span> <span class="reply-time">2015-06-19 16:30:29</span></div><p></p><p>楼主真高产，感谢分析</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">neal</span> <span class="reply-time">2015-06-19 14:26:17</span></div><p></p><p>想知道 sqlmap --dump 乱码 怎么办</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">wilson</span> <span class="reply-time">2015-06-19 11:51:15</span></div><p></p><p>sqlmapapi 好像 只能get注入检测。。post注入检测不知道可不可以。。。</p><p></p></div></div></div></div></div></main>