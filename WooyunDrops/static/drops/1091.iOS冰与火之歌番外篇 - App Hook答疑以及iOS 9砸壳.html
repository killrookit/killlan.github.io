<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">iOS冰与火之歌番外篇 - App Hook答疑以及iOS 9砸壳</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">蒸米</a> <span class="bull">·</span> <time title="2016/03/16 10:29" ui-time="" datetime="2016/03/16 10:29" class="published ng-binding ng-isolate-scope">2016/03/16 10:29</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 序</h1><hr><p>上一章我们讲到了在非越狱的iOS上进行App Hook。利用这个技术，你可以在非越狱的iOS系统上实现各种hook功能（e.g., 微信自动抢红包，自动聊天机器人，游戏外挂等）。但因为篇幅原因，有一些细节并没有讲的非常清楚。没想到阅读量非常大，很多人都来私信问我一些hook中遇到的问题，并且问的问题都很类似。于是我专门写了一篇答疑的文章来帮助大家解决一些常见的问题，顺便介绍一下如何在iOS 9上进行app 砸壳 (Dumpdecrypted)。另外想看主线剧情的读者也不要着急，下一篇就会给大家带来如何过沙盒的文章。</p><p>《iOS冰与火之歌》系列的目录如下：</p><ol><li>Objective-C Pwn and iOS arm64 ROP</li><li>在非越狱的iOS上进行App Hook（番外篇）</li><li>App Hook答疑以及iOS 9砸壳（番外篇）</li><li>█████████████</li><li>█████████████</li></ol><p>另外文中涉及代码可在我的github下载:<br><a href="https://github.com/zhengmin1989/iOS_ICE_AND_FIRE">https://github.com/zhengmin1989/iOS&#95;ICE&#95;AND_FIRE</a></p><h1>0x01 如何编译hook.dylib</h1><hr><p>很多人私信给我提到hook.dylib无法编译成功，这个问题大多是因为没有安装Command Line Tools和越狱开发环境iOSOpenDev造成的，这两个工具都是搞iOS安全必备的环境，可以按照以下步骤进行安装：</p><p>Command Line Tools 是Xcode的一个命令行工具插件，安装方法有两种：</p><p><strong>(1) 打开终端，输入：</strong></p><pre><code>#!bash
xcode-select --install
</code></pre><p><strong>(2) 去苹果官网下载安装包</strong></p><p><a href="https://developer.apple.com/downloads/">https://developer.apple.com/downloads/</a></p><p><img alt="p1" img-src="184737854a166b358daaf059afa9dae34041d413.jpg"></p><p>iOSOpenDev里提供了很多越狱开发的模板，可以在<a href="http://iosopendev.com/download/">http://iosopendev.com/download/</a>下载到。安装完iOSOpenDev后就可以在Xcode里通过新建一个project看到我们进行非越狱Hook的时候需要用的CaptainHook了。</p><p><img alt="p2" img-src="19b1c6723e9a603b6d9f644865ca22f58774f2e3.jpg"></p><h1>0x02 如何得到App Store上解密后的ipa</h1><hr><p>我们开发时的app默认是没有加密的，但App Store上下载的app却被加了密。如果我们想要进行hook以及重打包的话，我们需要拿到解密后的app才行，否则的话，就算hook成功，签名成功，安装成功，app还是会闪退。</p><p><strong>(1) 查看app是否加密：</strong></p><p>首先用file来看一下ipa解压后的二进制文件包含哪些架构（e.g., armv7, arm64）。如果有多个架构的话，最好是把所有的架构都解密了。但理论上只要把最老的架构解密就可以了，因为新的cpu会兼容老的架构。比如我们拿微博作为例子，可以看到weibo的客户端包含了armv7和arm64这两个架构。</p><p><img alt="p3" img-src="b5b47a3e62700f90a4f6a341d553d7ade3ae1f86.jpg"></p><p>随后我们可以通过”<code>otool –l</code>”来输出app的load commands，随后再查看cryptid这个标志位来判断app是否被加密了。如果是1的话代表加密了，如果是0的话代表解密了。</p><p><img alt="p4" img-src="9b865d9604298ed17fe5c695108d2aab02d8a576.jpg"></p><p>从上图可以看到，weibo的armv7架构的代码被加密了，arm64架构却是解密的，原因是我已经通过dumpdecrypted对arm64架构的代码砸过壳了。如果没有解密的话，用ida打开app会看到加密的提示：</p><p><img alt="p5" img-src="db1944c3d7b2bb849e6c5322b03370c001c7356d.jpg"></p><p><strong>(2) dumpdecrypted砸壳：</strong></p><p>如果需要解密的话，我们就需要用工具进行砸壳。最有名的砸壳工具就是dumpdecrypted了。他的原理是让app预先加载一个解密的dumpdecrypted.dylib，然后在程序运行后，将代码动态解密，最后在内存中dump出来整个程序。这个工具可以在: <a href="https://github.com/stefanesser/dumpdecrypted">https://github.com/stefanesser/dumpdecrypted</a>下载到。但下载完的只是源码，我们还需要编译一下，这里我会放一份编译好后的dumpdecrypted.dylib到我的github上。</p><p>虽然hook可以在越狱的环境下实现，但是想要砸壳的话，必须具备越狱的环境，比如这篇文就使用的越狱后的iOS 9。用ssh连接上iOS设备后，我们打开想要砸壳的app。然后输入<code>ps ax</code>，就可以在进程中找到这个app的二进制文件的地址：</p><p><img alt="p6" img-src="74741a928c081c05379eba677b4b19b68f0b858d.jpg"></p><p>因为每个app目录下都有一个Info.plist。我们可以通过这个Info.plist得到app的Bundle ID：</p><pre><code>#!bash
cat /var/mobile/Containers/Bundle/Application/19A9AE5E-22DC-449A-A530-C793D88ACB24/Weibo.app/Info.plist
</code></pre><p><img alt="p7" img-src="2fb2495e71a8293426ce425dabb51c5fa1a49675.jpg"></p><p>比如Weibo的Bundle ID就是：com.sina.weibo。得到BundleID后我们下一步要知道app的data目录，原因是app的运行会受到沙盒的限制，因此dump出来的app只能保存在自己的data目录下，这里我们可以通过Bundle ID和一个private API得到data目录的位置：</p><p><img alt="p8" img-src="86af6f75a4fdcc7d1e3899b1a466cf811947b730.jpg"></p><p>代码如下：</p><pre><code>#!objc
NSString* bundleID = [[NSString alloc] init];
bundleID = @"com.sina.weibo";
id dataID = [[NSClassFromString(@"LSApplicationProxy") applicationProxyForIdentifier:bundleID] dataContainerURL];
NSLog(@"%@",dataID);
</code></pre><p>得到data目录的地址后，我们将dumpdecrypted.dylib 拷贝到data的tmp目录下，然后在tmp目录下执行<code>DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib /var/mobile/Containers/Bundle/Application/19A9AE5E-22DC-449A-A530-C793D88ACB24/Weibo.app/Weibo</code>进行砸壳。</p><p><img alt="p9" img-src="a0bf413d1fdd4156735061a1c3e05b9dfc5b00c0.jpg"></p><p>然后在目录下就可以得到砸壳后的二进制文件了，要注意的是我们砸壳后的app只能解密砸壳运行时的架构，所以我建议找个armv7架构的iOS设备进行砸壳，然后执行：</p><pre><code>#!bash
lipo app -thin armv7 -output app_armv7
</code></pre><p>就可以把app的armv7架构抽取出来。这样的话，就可以保证app只在armv7的模式下运行了。</p><p>(3) 越狱市场下载：</p><p>当然，除了利用dumpdecrypted获取解密后的app还可以直接在PP助手的越狱市场上下载到，这些越狱应用都是解密后的app。但不能保证下载到AppStore上所有的app。</p><p><img alt="p10" img-src="7189051866bafa7624166e8bdb0e85f848f075e2.jpg"></p><h1>0x03 获取embedded.mobileprovision的技巧</h1><hr><p>有人会问如何获取embedded.mobileprovision这个文件，因为自己开发的app默认会有embedded.mobileprovision，但从AppStore上下载app并没有。其实，除了在developer center上通过录入device的UDID，然后下载embedded.mobileprovision之外，我们还可以利用xcode自动生成embedded.mobileprovision。比如我们想要重打包微博这个app，只要新建一个app（为了确保万无一失，可以把app的Bundle ID也起为com.sina.weibo），然后把手机连接上电脑，编译并在手机上运行这个app。然后只要去app的目录下拷贝embedded.mobileprovision就可以了。这样获取的embedded.mobileprovision可以保证能够适配重打包的app。如下图所示：</p><p><img alt="p11" img-src="50cebb0b2c9b3dadf03775ae64e4114ac8d785b7.jpg"></p><h1>0x04 签名的技巧</h1><hr><p>签名的时候我们需要提供entitlement的信息，这个entitlement是什么呢？其实这个entitlement是用来做iOS权限管理的，通过声明不同的entitlement就能得到不同的权限。并且这个信息已经保存到了二进制文件里。比如我们可以通过”<code>ldid –e</code>”来查看一个二进制文件的entitlement。比如Weibo的entitlement为：</p><p><img alt="p12" img-src="9f1541a393effd514d58052d7e7ef48678e545df.jpg"></p><p>理论上需要给app签上原app对应的所有entitlement才行。</p><p>另外，除了app本身需要签名以外，app的PlugIn，WatchNative App，WatchNative App的PlugIn如果有的话，都需要签名才行，拿WeChat举例，我们要对如下的内容都签名才可以：</p><pre><code>#!bash
codesign -f -s "iPhone Developer: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="057f6d606b62686c6b343c3d3c456268646c692b666a68">[email&#160;protected]</a> (**********)" WeChat.app/Watch/WeChatWatchNative.app/PlugIns/WeChatWatchNativeExtension.appex
codesign -f -s "iPhone Developer: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="b6ccded3d8d1dbdfd8878f8e8ff6d1dbd7dfda98d5d9db">[email&#160;protected]</a> (**********)" WeChat.app/Watch/WeChatWatchNative.app
codesign -f -s "iPhone Developer: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="a2d8cac7ccc5cfcbcc939b9a9be2c5cfc3cbce8cc1cdcf">[email&#160;protected]</a> (**********)" WeChat.app/PlugIns/WeChatShareExtensionNew.appex
codesign -f -s "iPhone Developer: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="cbb1a3aea5aca6a2a5faf2f3f28baca6aaa2a7e5a8a4a6">[email&#160;protected]</a> (**********)" WeChat.app/hook2.dylib
codesign -f -s "iPhone Developer: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="4b31232e252c2622257a7273720b2c262a222765282426">[email&#160;protected]</a> (**********)" --entitlements Entitlements.plist WeChat.app
</code></pre><h1>0x05 安装大ipa的方法</h1><hr><p>上一篇中介绍了一种利用libimobiledevice来安装ipa的方法。但我在尝试安装特别大的ipa的时候（大于50M），经常会失败，需要尝试多次才行。这里有个小技巧，如果有条件的话，可以使用windows下的itools来辅助我们安装，基本上一次就能搞定了。</p><p><img alt="p13" img-src="6b9ef5974197b339773cdd64908dc8789675147b.jpg"></p><h1>0x06 总结</h1><hr><p>这篇文章基本上解决了app hook过程中遇到的常见问题，还介绍了iOS 9上砸壳的技术。如果还遇到问题的话，大家可以通过xcode里的log来分析原因，然后尝试解决问题。至此，iOS app的安全（番外篇）就告一段落了。下一章将会进入主线剧情，给大家带来app过沙盒的技术，敬请期待。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/201507292354527496d304665a3c721617737c107e4e87.png" style="width:200px;height:200px"></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/12803" rel="bookmark" id="re1">iOS冰与火之歌番外篇 - 在非越狱手机上进行App Hook</a></li><li><a href="http://drops.wooyun.org/papers/12045" rel="bookmark" id="re2">iOS 8.1.2 越狱过程详解及相关漏洞分析</a></li><li><a href="http://drops.wooyun.org/papers/5309" rel="bookmark" id="re3">iOS URL Scheme 劫持-在未越狱的 iPhone 6上盗取支付宝和微信支付的帐号密码</a></li><li><a href="http://drops.wooyun.org/papers/12355" rel="bookmark" id="re4">iOS冰与火之歌 – Objective-C Pwn and iOS arm64 ROP</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">千百度</span> <span class="reply-time">2016-04-28 18:05:52</span></div><p></p><p>可不可以上传到腾讯的bugly内测分发平台上面来安装呢？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Ives</span> <span class="reply-time">2016-04-08 17:21:44</span></div><p></p><p>这个导出来的可执行文件有设备支持列表的信息吧，这个怎么处理呢，比如用iPod导出来就只支持iPod，甚至连iPod几都有要求</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Startry</span> <span class="reply-time">2016-04-06 20:19:07</span></div><p></p><p>如果能有一个非越狱环境下的砸壳工具多好。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Onelong</span> <span class="reply-time">2016-04-01 09:55:53</span></div><p></p><p>@gfyxyz2008 有成功案例？？？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Onelong</span> <span class="reply-time">2016-03-31 08:42:15</span></div><p></p><p>iOSOpenDev 安装不了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Acorld</span> <span class="reply-time">2016-03-30 14:49:03</span></div><p></p><p>@gfyxyz2008 同感，没那么麻烦，费点心思。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">gfyxyz2008</span> <span class="reply-time">2016-03-24 10:07:04</span></div><p></p><p>Clutch是一个好工具</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ruby</span> <span class="reply-time">2016-03-17 16:04:41</span></div><p></p><p>android 7武器也要继续呀</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">谏太宗十思疏</span> <span class="reply-time">2016-03-17 08:57:17</span></div><p></p><p>再好的美剧也逃不过烂尾的命运。<br>终究是善始者实繁 克终者盖寡啊。<br>希望乔治啊啊马丁早日出完书。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">111111</span> <span class="reply-time">2016-03-16 15:30:47</span></div><p></p><p>yumen</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sxyzbbs</span> <span class="reply-time">2016-03-16 14:19:21</span></div><p></p><p>感谢答疑！！！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Kuuki</span> <span class="reply-time">2016-03-16 12:47:57</span></div><p></p><p>果然还是需要一个越狱的环境...</p><p></p></div></div></div></div></div></main>