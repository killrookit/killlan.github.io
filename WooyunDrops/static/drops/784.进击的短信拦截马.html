<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">进击的短信拦截马</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">瘦蛟舞</a> <span class="bull">·</span> <time title="2015/09/22 15:27" ui-time="" datetime="2015/09/22 15:27" class="published ng-binding ng-isolate-scope">2015/09/22 15:27</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>木马利用短信感觉受害者通信录中好友.利用"看你做的好事","看你做的龌龊事"等语句诱导用户安装.</p><p><img alt="" img-src="884c207c2bb8ece729832e7c037f8ad0eecf2523.jpg"></p><p>开始分析木马,首先查看其Manifest文件.从其申请短信/联系/联网的权限来看已经可以基本确认这是一款短信拦截马,貌似没啥新意不过可以从中发现一些以前没有的细节.感觉这个木马还是挺用心的。</p><p>首先是installLocation属性的设置.</p><pre><code>android:installLocation="internalOnly" 
</code></pre><p>设置这个属性的目的是不让木马 app 被安装到 sdcard 中.因为如果 app 被安装 sdcard 中而非手机内置存储的话会失去以下特性导致木马的功能不健全</p><ul><li>系统会在加载外部存储介质之前发送ACTION&#95;BOOT&#95;COMPLETED广播,所以程序将不能接受开机广播 (无法开机启动)</li><li>DeviceAdminReceiver失效 (无法激活设备管理器防止卸载)</li><li>Service无法正常工作,会被 kill 且无法 restart (无法在后台持续运行)</li><li>Alarm Service 闹钟服务将被取消 (减少一个入口点)</li></ul><p>第二个有意思的点 excludeFromRecents 是在 activity 标签中设置的.</p><pre><code>android:excludeFromRecents="false"
</code></pre><p>这样设置的目的是不让木马 app 现在在最近程序列表中减少被普通用户发现的概率.类似处理还有将此 Activity 在代码中 disable</p><p><img height="528" width="300" img-src="9ed294a0abadf9aac39ace87df0fa011c68f0c4f.jpg"></p><p>第三个特点是随机字符串包名</p><pre><code>package="tjkxyfmjhvdg.oprbrvvgeevv.uxqjjuqxympd"
</code></pre><p>要抓取几个样本后发现,包名是随机的字符串,但是代码特助以及签名都是一样的.应该是通过程序自动生成的,猜测目的是躲避一些杀软.</p><hr><p>继续观察程序入口点: 1.主Activity,用户点一次后将会被禁用</p><pre><code>    &lt;activity android:excludeFromRecents="false" android:label="@string/app_name" android:name="com.phone.stop.activity.MainActivity"&gt;
        &lt;intent-filter&gt;
            &lt;action android:name="android.intent.action.MAIN" /&gt;
            &lt;category android:name="android.intent.category.LAUNCHER" /&gt;
        &lt;/intent-filter&gt;
    &lt;/activity&gt;
</code></pre><p><img alt="" img-src="cebef326ab27572b6360c44b080b7e702d083dde.jpg"></p><p>功能老几样:</p><ul><li>禁用Main Activity组件隐藏图标</li><li>激活设备管理器,防止卸载</li><li>短信通信木马使用者肉鸡已经上线.</li><li>异步邮件发送受害者通信录以及短信记录</li><li>启动后台服务实时监控短信</li></ul><p><img alt="" img-src="fb8e14aa27e0c60d9798c5660cadafe86973ae7b.jpg"></p><p>sevice 的主要功能是</p><ul><li>动态注册短信广播接收器和观察这</li><li>被destory后自动启动</li><li>判断木马是否过期.(这点显然可以看出,使用木马的人是从它处购买的木马,还有有效期的)</li></ul><p>其他入口点: 2.开机广播 3.网络切换广播 4.短信相关广播 ,总计4处可以触发拦截马行为.</p><pre><code>    &lt;receiver android:name="com.phone.stop.receiver.BootReceiver"&gt;
        &lt;intent-filter android:priority="2147483647"&gt;
            &lt;action android:name="android.intent.action.BOOT_COMPLETED" /&gt;
            &lt;action android:name="android.net.conn.CONNECTIVITY_CHANGE" /&gt;
            &lt;action android:name="android.provider.Telephony.SMS_RECEIVED" /&gt;
            &lt;action android:name="android.provider.Telephony.GSM_SMS_RECEIVED" /&gt;
            &lt;action android:name="android.provider.Telephony.SMS_RECEIVED_2" /&gt;
            &lt;action android:name="android.provider.Telephony.SMS_DELIVER" /&gt;
        &lt;/intent-filter&gt;
    &lt;/receiver&gt;
</code></pre><p>短信广播接收器和观察者的代码就不贴了,发出的邮件是这样的:</p><p><img alt="" img-src="c038f09061ae5ab0aaad550358cdd290d4ec0fb0.jpg"></p><p><img alt="" img-src="7e3965a875dbcd1fb98617f04a1afbd5747ecb09.jpg"></p><p>那么这个木马是肿么存储邮箱帐号木马的了,发现这些个短信马都喜欢用163.</p><p><img alt="" img-src="807ae64db040e52d870ca3a1ea0021e2430f2446.jpg"></p><p><img alt="" img-src="cf0db28bca9241b859e01c1566727aa829ff8fc8.jpg"></p><p>这款木马选择对邮箱帐号密码使用 des 加密.破解这个也很简单现在有三个途径:</p><ul><li>根据密钥使用 DES脚本解密</li><li>hook API 方法 javax.mail.Service#connect(java.lang.String host, int port, java.lang.String user, java.lang.String password)</li><li>查看程序私有目录下配置文件</li></ul><p>大概两天不到的时间已经有上千受害者中招,部分数据如下:</p><p><img alt="" img-src="38e8b8fbb5fe8c5031256d378be49614ac66dd32.jpg"></p><p><img alt="" img-src="864286a48fa0a71314eaa854ea03a327fb061e60.jpg"> <img alt="" img-src="3fc316e4f960f1d67a0a5c8ee7f1d1967f24dbd0.jpg"> <img alt="" img-src="9f85827ba93ea8778df10dba8ccccd5265d070b1.jpg"></p><p>通信录</p><p><img alt="" img-src="2bed39b5955d525a9ac13a06cb0017a625692685.jpg"></p><p>短信记录</p><p><img alt="" img-src="9389a5cb4011010f67a7fbff0f80977aa4aee1f7.jpg"></p><p><strong>总结木马功能:</strong></p><ul><li>短信指令控制</li><li>通过 SMTP 协议邮件发送受害者通信录以及短信记录</li><li>通过"短信广播接收器"和"观察者"实时监控短信</li></ul><hr><p>在这些用 SMTP 上传受害者信息的短信木马中,有些木马作者比较 low 就直接硬编码在 java 代码中,有些会选择像上述的加密,也有往底层迁移</p><p><img alt="" img-src="af9184f73a3d966a0a2bab49459d323ac3932f37.jpg"></p><p><img alt="" img-src="b7fd1d6deb2869d4355c5a31351cac9373411274.jpg"></p><hr><p><strong>木马传播途径:</strong></p><p>1.伪基站\钓鱼\定向群发</p><p>2.受害者感染通信录好友</p><p><img alt="" img-src="1373cbdc2b35d26104dc784180e6f60166ab09d5.jpg"></p><hr><p><strong>木马使用者手机号码:</strong></p><p>15168430384</p><p>13894651855</p><p>13660414800</p><p>13430222795</p><p>已验证为黑卡,未实名认证.</p><p><strong>传播站点:</strong></p><p>118.193.170.149:2100</p><p>118.193.157.132:1123</p><p>http://www.shunlilao.com/hyl/xiangni.apk</p><p>http://wusha66.net/erw2fs.apk</p><p>主要来自香港的 VPS.</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/20141223141529d33ebc5e18e728db5f4a24d40002e9d1.jpg" style="width:200px;height:200px"></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">跟很刚</span> <span class="reply-time">2016-04-17 08:58:11</span></div><p></p><p>风狠狠狠干</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">SymenKnight</span> <span class="reply-time">2015-12-29 21:39:05</span></div><p></p><p>你好，还有这个apk吗？可以让我分析一下哈</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">潇洒</span> <span class="reply-time">2015-11-13 21:08:19</span></div><p></p><p>出售短信拦截马：进入空间照片处看货物：的确好联系：http://user.qzone.qq.com/3300505494/4</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">短信</span> <span class="reply-time">2015-11-13 19:50:11</span></div><p></p><p>购买短信拦截马：出售10086积分兑换网站源码和网站：需要联系：3300505494</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">fuzz-ing</span> <span class="reply-time">2015-09-22 22:36:14</span></div><p></p><p>我是奔着人渣进来的</p><p></p></div></div></div></div></div></main>