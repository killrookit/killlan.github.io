<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">手把手教你当微信运动第一名 – 利用Android Hook进行微信运动作弊</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">蒸米</a> <span class="bull">·</span> <time title="2015/09/06 10:29" ui-time="" datetime="2015/09/06 10:29" class="published ng-binding ng-isolate-scope">2015/09/06 10:29</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 序</h1><hr><p>随着带协处理器和买手环的人越来越多，微信运动一下子火了，只要你在微信关注微信运动，手机就能自动记录你每天行走的步数，还可以跟朋友圈里的好友PK运动量。并且每日排名第一的用户可以占据当日排行榜的封面。这充分激起了大家的求胜的欲望，于是出现了很多励志的和悲伤的故事……</p><p><img alt="enter image description here" img-src="d9dc7859813e19cfe396e593567d972828fcd0e1.jpg"></p><p><img alt="enter image description here" img-src="3f096d7ed244695c59212e57befc74f6b7a7c2bd.jpg"></p><h1>0x01微信运动作弊大法</h1><hr><p>其实想要拿第一没有那么麻烦，只要会一点Android的Hook知识，就可以轻松冲到排行榜第一名。接下来我就手把手教你如何变成第一。</p><p>首先我们需要一台带协处理的root后的android机器，比如说nexus 5。然后我们装上作弊用的XPosed Hook框架和作弊插件。这两个apk可以在我的github上下载到。</p><p><a href="https://github.com/zhengmin1989/WechatSportCheat">https://github.com/zhengmin1989/WechatSportCheat</a></p><p>下载完后，先安装<code>XPosed.apk</code>。接着打开Xposed，选择“<code>安装/更新</code>”，然后根据提示重启手机。</p><p><img height="480" width="270" img-src="037449dd5f3c151b76d96139a95d86ebf1b657a3.jpg"></p><p>重启完后，再安装<code>xposedwechat.apk</code>插件。然后打开Xposed的模块界面，会看到xposedwechat这个插件。我们在这里将它选中，然后再根据提示重启手机。</p><p><img height="480" width="270" img-src="bbbdec8aedbed9caae690b5051139f0511b581fc.jpg"></p><p>接下来就是见证奇迹的时刻…你随意走两步，然后打开微信运动，咦，怎么就多了1000步？再随便走几步，咦，怎么又多了1000步？… demo视频如下：</p><p><embed src="http://static.wooyun.org//drops/20150906/2015090602172891853wechat-sport-YouTube-720p.mp4" autostart="0" width="480" height="390"></p><p>仅仅刷步数还是不够过瘾吧？微信运动还推出了益行家活动，可以用每天的步数换取爱心捐款。有了微信运动作弊大法，我们可以每天在家随便走几步然后换取爱心捐款（如图所示）。</p><p><img height="480" width="270" img-src="e75b5a5c1e3380aba59b6393e1d85a4b0d222fb8.jpg"></p><h1>0x02 微信运动作弊原理</h1><hr><p>我们是如何作弊的呢？简单来说，当微信运动想要知道我们走了多少步的时候，微信app会询问android系统的计数传感器，随后计数传感器会返回我们行走的步数。因此，如果我们能够拦截微信运动和计数传感器之间的对话，然后伪造一个步数传递给微信运动就可以达到我们想要的作弊效果。</p><p>具体怎么做呢？首先我们可以用Xposed框架来hook计数传感器的队列函数<code>dispatchSensorEvent()</code>，这个函数在 <code>android.hardware.SystemSensorManager$SensorEventQueue</code>这个类中。随后在微信运动每次询问行走步数的时候，我们先获取当前步数，然后在目前的步数的基础上加1000步，然后将信息返回给微信运动。微信运动就会误以为我们运动了1000步，从而达到了欺骗的效果。</p><p>关键代码如下：</p><p>首先<code>hook android.hardware.SystemSensorManager$SensorEventQueue</code>这个类的<code>dispatchSensorEvent()</code>函数：</p><pre><code>final Class&lt;?&gt; sensorEL = findClass("android.hardware.SystemSensorManager$SensorEventQueue",lpparam.classLoader);
XposedBridge.hookAllMethods(sensorEL, "dispatchSensorEvent", new XC_MethodHook() 
</code></pre><p>接着我们在记步传感器把步数信息返回给微信运动之前，将返回的步数加上1000步：</p><pre><code>protected void beforeHookedMethod(MethodHookParam param) throws
Throwable {
XposedBridge.log(" mzheng  Hooked method: " +  param.method);
 ((float[]) param.args[1])[0]=((float[]) param.args[1])[0]+1000*WechatStepCount;
WechatStepCount+=1;
…
</code></pre><p>另外我们还可以使用一些传感器的接口获取一些数据的信息：</p><pre><code>Sensor ss = ((SparseArray&lt;Sensor&gt;) field.get(0)).get(handle);                            
XposedBridge.log("   SensorEvent: sensor=" + ss);
</code></pre><p><img alt="enter image description here" img-src="1595c859f1d6b0b68aac045587339c97c875cb9f.jpg"></p><p>比如说x就代表开机以来行走的步数，timestamp是获取步数时候的时间戳等。</p><p>另外，我们不仅在android上可以hook计步器，在iOS上也是可以通过越狱后hook iHealth的API接口达到同样的作弊效果，有兴趣的同学可以继续研究。</p><p><img height="480" width="270" img-src="5b0be18eb8c56c7ef8f93ad1b0705d4dba889267.jpg"></p><p><img height="480" width="270" img-src="70eae80dd7ca65d3c3ea9246c07046cf7b1d5035.jpg"></p><h1>0x03微信运动反作弊建议</h1><hr><p>如何防止这种作弊发生呢？我的第一个建议是加强服务器端的逻辑检测功能。比如说一个人是不可能十分钟内走一万步的，如果他做到了，那么他一定是在作弊。 我的第二个建议是增加对hook的检测功能。虽然微信运动作下弊无非就是满足一下大家争强好胜的虚荣心，并不会对大家的隐私和财产产生损失。但是既然微信运动可以被hook，同样也意味着语音聊天，微信支付等功能也是可以被hook的，当黑客利用hook技术对你的隐私和财产产生危害的时候可就不是那么好玩的事了。之前我们在Hacking Team事件中也亲眼目睹了利用hook技术来获取微信语音消息的android木马，所以一定要增加针对hook的检测才行。</p><h1>0x04 总结</h1><hr><p>此文只是介绍了Android Hook的简单场景应用，关于Android Hook的原理以及更多的利用方式，比如说调试，关键API拦截，外挂等技巧，敬请期待WooYun Book系列的文章《安卓动态调试七种武器之离别钩 - Hooking》。 https://github.com/zhengmin1989/TheSevenWeapons</p><h1>0x05 参考文章</h1><hr><ol><li><p><a href="http://drops.wooyun.org/tips/7488">Android.Hook框架xposed篇(Http流量监控)</a></p></li><li><p><a href="http://drops.wooyun.org/news/6977">人手一份核武器 - Hacking Team 泄露（开源）资料导览手册</a></p></li></ol><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/201507292354527496d304665a3c721617737c107e4e87.png" style="width:200px;height:200px"></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小西</span> <span class="reply-time">2016-05-13 23:15:08</span></div><p></p><p>好像不行了。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">masker</span> <span class="reply-time">2016-04-14 20:52:47</span></div><p></p><p>好像已经失效了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">cyang</span> <span class="reply-time">2016-04-02 19:21:53</span></div><p></p><p>你好，这个插件挺好用的。使用两天后觉得占领全部好友封面实在太酷了。可是有时候这个步数实在太多，有没有考虑过改小一点，不要超过朋友太多。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">啊呀</span> <span class="reply-time">2016-02-13 09:51:43</span></div><p></p><p>救命啊，魅族note刷机后，微信运动一直是0啊！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">y</span> <span class="reply-time">2015-12-16 12:55:30</span></div><p></p><p>可以把1000的数字改小一点吗？比如100,500这样？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">兮兮</span> <span class="reply-time">2015-12-08 09:15:31</span></div><p></p><p>似乎不能刷步捐款了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">TID丶千世</span> <span class="reply-time">2015-10-18 23:16:05</span></div><p></p><p>微信运动刷步数 100%可用 https://item.taobao.com/item.htm?spm=a1z10.3-c.w4002-86958057.12.HtfPq5&amp;id=523146660304</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">mramydnei</span> <span class="reply-time">2015-09-08 07:17:08</span></div><p></p><p>awesome</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">GixMore</span> <span class="reply-time">2015-09-07 09:51:04</span></div><p></p><p>忍不住评论一下</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">phith0n</span> <span class="reply-time">2015-09-07 02:18:05</span></div><p></p><p>我说那些混蛋怎么每天都走99999步</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">JoyChou</span> <span class="reply-time">2015-09-06 23:15:22</span></div><p></p><p>当然还有第三方和微信运动联调的数据源</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">海蓝</span> <span class="weibo"></span> <span class="reply-time">2015-09-06 14:26:09</span></div><p></p><p>iOS系统的的可以用我刚写的APP，可以直接刷任意步数 http://t.cn/RyLFsG7</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">乌云-漏洞报告平台</span> <span class="weibo"></span> <span class="reply-time">2015-09-06 14:22:41</span></div><p></p><p>微信运动是个好东西，它让人们被动的重视运动，不过也相继出现了很多广告暴走族。经过揭秘我们知道原来还有“狗流”、“电机流”等民间神技，到现在技术流也出现了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">傻蛋搜</span> <span class="weibo"></span> <span class="reply-time">2015-09-06 14:11:01</span></div><p></p><p>#傻蛋分享#</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">winsyk</span> <span class="reply-time">2015-09-06 11:31:14</span></div><p></p><p>狠。。。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">夏殇</span> <span class="reply-time">2015-09-06 11:09:04</span></div><p></p><p>不能愉快的玩耍了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">咣铛一声巨响</span> <span class="weibo"></span> <span class="reply-time">2015-09-06 11:02:57</span></div><p></p><p>三星s5 9008w 不兼容</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瘦蛟舞</span> <span class="reply-time">2015-09-06 10:54:42</span></div><p></p><p>哈哈,前阵子还有问我咋针对这个记步的作弊了...</p><p></p></div></div></div></div></div></main>