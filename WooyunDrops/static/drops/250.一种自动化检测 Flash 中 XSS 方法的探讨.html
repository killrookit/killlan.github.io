<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">一种自动化检测 Flash 中 XSS 方法的探讨</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">新浪安全中心</a> <span class="bull">·</span> <time title="2014/05/16 17:09" ui-time="" datetime="2014/05/16 17:09" class="published ng-binding ng-isolate-scope">2014/05/16 17:09</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>作者：piaca</p><h2>0x00 前面的话</h2><hr><p>对于如何检测 Flash 中的 XSS，每个人都有自己的方法，无论是使用成型的自动化工具（比如 swfscan）还是自己开发自动化工具（先反编译，再对 actionscript 代码审计）还是直接人工对代码进行审计。都能够检测到 Flash 中存在的 XSS 漏洞。但是这些方法会存在一些问题，如：</p><ul><li>自动化工具属于静态分析，误报比较高，需要投入大量人工精力去加以分析</li><li>完全人工效果最好，但是也更加耗费精力</li></ul><p>在这里我们来探讨一种动态检测 Flash 中 XSS 的方法，该方法有自己的优点，但是也有比较明显的缺点，所以本文的标题定位于“探讨”。</p><h2>0x01 原理</h2><hr><p>所谓动态检测，就是通过程序加载 Flash 插件，然后再载入 Flash 文件，对事件和错误信息进行捕捉，再对信息分析来判断 Flash 中是否存在 XSS 漏洞。</p><p>先来看下面两张图，以 Firefox 浏览器为例：</p><p><img alt="enter image description here" img-src="2b50abc7f899f8a923f5e00a4d02acbd8a5d3e2a.jpg"></p><p>Firefox 访问 <a href="http://test.com/xss.swf?alert=1">http://test.com/xss.swf?alert=1</a>，Flash 成功执行 JS 代码，弹出对话框。</p><p><img alt="enter image description here" img-src="7a25d08805bdb13df503d9931fd6736d200922af.jpg"></p><p>Firefox 访问 <a href="http://test.com/xss.swf?alert=1%5C%22">http://test.com/xss.swf?alert=1\"</a>，Flash 执行 JS 报错，显示错误详细信息。Firefox 能够显示 Flash 执行 JS 错误时的详细错误信息。</p><p>到这里也就明白检测的原理了，就是：</p><ul><li>程序调用 Firefox</li><li>Firefox 加载 Flash 插件</li><li>Firefox 访问对参数经过构造的 Flash 链接，比如 <a href="http://test.com/xss.swf?alert=1%5C%22">http://test.com/xss.swf?alert=1\"</a></li><li>程序捕捉错误信息或者 alert 事件</li><li>根据错误信息或者 alert 事件信息来判断该 Flash 是否存在 XSS 漏洞</li></ul><h2>0x02 具体实现</h2><hr><p>具体如何实现呢？我们不会真的调用 Firefox，而是直接采用一套开源的可以解析 JS 的工具包：CasperJS。下面看下 CasperJS 官网的一段介绍：</p><pre><code>CasperJS is an open source navigation scripting &amp; testing utility written in Javascript for the PhantomJS WebKit headless browser and SlimerJS (Gecko).
</code></pre><p>CasperJS 目前支持两种引擎：PhantomJS（WebKit内核）和 SlimerJS（Gecko内核）。Gecko内核就是 Firefox 所使用的内核，又通过 CasperJS 文档了解到，使用 SlimerJS 引擎时候可以通过 loadPlugins 来加载 Flash 插件。</p><p>所以我们就可以通过 CasperJS 来完成我们的功能需求，下面是代码实现：</p><p>flash_detect.js</p><pre><code>#!js
var casper = require('casper').create({
    pageSettings: {
        loadImages:  true, 
        loadPlugins: true // load flash plugin
    },
    logLevel: "info",
    verbose: false
});

casper.start('about:blank', function() {});

// catch alert 
casper.on('remote.alert', function(message) {
    this.echo('{"type": "alert", "msg":"' + message + '"}');
});

// catch page error info
casper.on('page.error', function(message, trace) {
        this.echo('{"type": "error", "msg":"' + message + '"}');
});

var url = casper.cli.get(0);

casper.thenOpen(url, function() {
        this.wait(2000, function(){})   // delay 2's
});

casper.run();
</code></pre><p>代码很简单，就是通过 CasperJS 来访问 Flash 文件，然后捕捉页面中的错误信息和 alert 事件。在这里有一点需要注意就是有的 Flash 不会立即执行 JS 代码，所以我们在打开一个 Flash 文件后，在当前的页面停留 2 秒。</p><h2>0x03 执行效果</h2><hr><p>我们刚才那个 Flash 文件用这个检测代码检测下看看效果 ，如下：</p><pre><code>#!bash
piaca at piaca in ~/source$ casperjs --engine=slimerjs flash_detect.js "http://test.com/xss.swf?alert=1"
{"type": "alert", "msg":"1"}

piaca at piaca in ~/source$ casperjs --engine=slimerjs flash_detect.js "http://test.com/xss.swf?alert=1\\\""
{"type": "error", "msg":"SyntaxError: missing ) after argument list"}
</code></pre><h2>0x05 写在后面的话</h2><hr><p>实际中我通过访问网上的一些业务，把其中的 Flash 抓下来，然后通过程序去检测，效果还是不错的。当然这其中包括我们自己业务中的 Flash XSS 漏洞。</p><p>但是目前的检测程序只能是一个 Demo，要想在生产环境中使用，还需要解决以下问题：</p><ul><li>效率：目前是单进程单线程进行检测，会影响检测效率，同时由于 SlimerJS 会打开一个 GUI 窗口，在一定程度上也会影响效率；</li><li>误报：在 Demo 中我们没有过多的处理错误信息，所以在实际测试中会有比较多的误报；</li><li>参数：这里的参数只是 Flash 文件接收的参数，我们通过日志分析等可以快速获取业务中的 Flash 文件，但是如何获取 Flash 接收的所有参数名呢？</li></ul><p>上面几个问题并不是致命的问题，我们可以通过多种方法去解决，但是正如前面所说的这个检测程序有个致命的缺点，那就是：</p><ul><li>这个检测脚本只能检测很明显的 XSS 漏洞，如果 Flash 中对参数有一定的处理措可能就无法进行检测了；</li></ul><p>所以本文仅仅做自动化检测 Flash 中 XSS 漏洞的探讨，如果你有好的方法，希望能与我交流。thx。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">路飞</span> <span class="reply-time">2015-01-21 18:56:17</span></div><p></p><p>这些测试漏洞的源代码能否发出来？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">_Evil</span> <span class="reply-time">2015-01-16 11:35:25</span></div><p></p><p>piaca是我偶像</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">啊L川</span> <span class="reply-time">2014-05-26 09:16:02</span></div><p></p><p>黑阔雪狼 膜拜</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">啊L川</span> <span class="reply-time">2014-05-26 09:15:44</span></div><p></p><p>学习了 皮擦 威武霸气 膜拜一下</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">insight-labs</span> <span class="reply-time">2014-05-19 11:10:51</span></div><p></p><p>piaca是我偶像</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">bitcoin</span> <span class="reply-time">2014-05-17 23:43:27</span></div><p></p><p>支持一个</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">qwerty</span> <span class="reply-time">2014-05-17 23:21:39</span></div><p></p><p>思路不错</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Ak48</span> <span class="reply-time">2014-05-17 11:49:36</span></div><p></p><p>大犇</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">龙臣</span> <span class="reply-time">2014-05-16 17:36:48</span></div><p></p><p>偶像</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">阿峰</span> <span class="reply-time">2014-05-16 17:35:56</span></div><p></p><p>有内涵</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">风萧萧</span> <span class="reply-time">2014-05-16 17:32:02</span></div><p></p><p>piaca是我偶像</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zcy</span> <span class="reply-time">2014-05-16 17:25:03</span></div><p></p><p>高大上</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">孤独雪狼</span> <span class="reply-time">2014-05-16 17:23:42</span></div><p></p><p>低奢华</p><p></p></div></div></div></div></div></main>