<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">美玉在外，败絮其中——色播病毒的那些事儿</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">腾讯电脑管家</a> <span class="bull">·</span> <time title="2015/10/17 7:37" ui-time="" datetime="2015/10/17 7:37" class="published ng-binding ng-isolate-scope">2015/10/17 7:37</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>长期以来,色播类App屡见不鲜,其背后是巨大的金钱利益,是病毒主要栖息之地。为了保护用户切身利益,腾讯手机管家长期以来对此类病毒进行及时查杀。</p><p>色播类病毒每日感染用户数如下图所示,感染用户数在周末日与假日期间尤为严重</p><p><img alt="" img-src="a67f351352e17643f17ef475c0fb364bfd5c0622.jpg"></p><p>为了进行有效的查杀,我们对色情类病毒进行实时的监控。以某约爱色播视频为例,下图所示,晚上8点后会进行爆发,每小时以千为单位,库中总量达80万。</p><p><img alt="" img-src="74226ca38fc0a2a345f705874ec4733ff2d26f0a.jpg"></p><p>美玉在外,败絮其中,此类色播病毒常以美女色情图片或者视频来诱导用户安装,不断提示用户安装难以卸载的恶意插件,进行广告的推送,甚至在后台静默下载安装应用和发送扣费短信,给用户造成很大的影响</p><p>色播病毒执行的流程如下图所示:</p><p><img alt="" img-src="fb9efe462b509e5b51e72249d74e923afe79c2a0.jpg"></p><h1>0x01 色播类病毒主要行为分析</h1><h2>1.1 通过继承Application来解密Dex,隐藏真正的Dex来躲避查杀</h2><p><img alt="" img-src="b6b7dc2a1b35ec273bc91d062142a1656fa86106.jpg"></p><h2>1.2 解密Dex:</h2><p>通过包名中的数字截断来确定需要解密的文件的名称,此时文件名为26a6.fdc</p><p>解密后的Dex名称由:Md5加密(包名+”.Core”)+“.apk”组成</p><h2>1.3 通过DexClassLoader加载Dex,读取资源解密释放出文件:</h2><p><img alt="" img-src="fa6214f1efa21bd2de1b632f0a9d4f7c234d5fc2.jpg"></p><p>命名方式为:MD5加密(包名+“.original”+versionCode),此时的文件为一个Loader</p><h2>1.4 Loader联网获取恶意插件:</h2><p>01f61033344309ee8aa69bfab53f8196.apk即为Loader,</p><p>包com.jmedia.loader.ad的函数AdApkHandler为加载插件函数</p><h3>1) 联网获取数据,配置广告文件config_ad.xml</h3><p><img alt="" img-src="27d9163e31406adcf6832b9f5c2c3adb6f207ce9.jpg"></p><h3>2) 读取json数据,通过解密字符串获得需要的字段downloadurl,filesize,outStartActivity等</h3><p><img alt="" img-src="a26199364d261ce840f664bbd5d80714a0fdb654.jpg"></p><p>对应的字符串</p><p><img alt="" img-src="2b91b692fdd8e268d027f3a5d234f4ec97e45382.jpg"></p><p>解密函数主要过程:将密钥 进行MD5 加密,取前17位作为AES解密的key</p><p>解密函数如下:</p><p><img alt="" img-src="7abe096bb29b342f72ae86e42ce52e3f490c11f6.jpg"></p><h3>3）写SharedPreferences文件config_ad.xml,内容如下</h3><p><img alt="" img-src="6e1bb1a0d88806cc5b270e309b36deb9b660e735.jpg"></p><h3>4）获取到config_ad.xml的downloadUrl下载解密</h3><p>下载到的文件ad20150513.apk文件,命名为game.properties, 该文件为加密文件,读取config_ad.xml的secretKey进行AES解密,释放解密后的文件到sdcard中的SAdAssets目录下,命名为game20141210.apk,该文件即为我们要的com.android.system.contact.app推广的APP</p><p><img alt="" img-src="f63e4ae416574fc7fe6b3f1454a7ffa92f09ec45.jpg"></p><p>其中config_ad.xml中的字段：outStartActivityAction, outStartActivity , serviceClassName 为需要启动的组件信息</p><h2>1.5 推广的<code>com.android.system.contact.app</code> 主要行为</h2><ol><li>激活设备管理器</li><li>监听设备管理器DeviceAdminReceiverm,当用户禁用时,返回字符串:“取消激活将导致手机系统不稳定,部分安卓程序无法运行”,且记录是否禁用</li><li>联网下载推广信息,banner广告,悬浮窗广告,推送消息等</li></ol><p><img alt="" img-src="b3fb1cc1551eab5e9bffe8b00fd85a7db430d90d.jpg"></p><h1>0x02 色播类病毒追踪</h1><hr><h2>2.1批量生成灵活配置后台进行推广:色播类病毒中含大量重打包的应用,其推广应用可灵活配置</h2><p><img alt="" img-src="c6506f5625368aaf43e44921b27be39349aa31a3.jpg"></p><h3>1)根据Manifest配置文件的Appid来决定访问的网址</h3><p><img alt="" img-src="70c092865728d599a142be97da29eedf2d2731b1.jpg"></p><h3>2) 后台含需要推广的应用,及其诱导信息</h3><p><img alt="" img-src="5684f275a9b9310b363d668535e9b44fd8bd6eff.jpg"></p><p><img alt="" img-src="0404089ab67de45e04779b27dcb77ae43f01587d.jpg"></p><p><img alt="" img-src="cb929650ab578fb8986ffe79029d0394a5faabc8.jpg"></p><h2>2.2 静默发送短信或者诱导点击来达到扣费的效果,以云端控制的方式返回 待发送短信和号码,此种方式能控制发送任意短信内容</h2><h3>1)除了偷偷发送短信,还会以诱惑性或者模糊的词来诱导用户进行点击</h3><p><img alt="" img-src="0336438103d841f647daa5a3f2d8e579f851a42f.jpg"></p><h3>2）以云控的方式来控制短信内容</h3><p><img alt="" img-src="4cbbd1b91e010232ee78cfad21b0e12b290796ee.jpg"></p><h2>2.3我们在实时监控的过程中,发现色播类病毒和大量插件,App捆绑相关联,可见病毒作者在开发时,在捆绑的测试也下过不少功夫。</h2><p><img alt="" img-src="4296e67d1e9e1bfbe5d98ad88c1591bb54c4545d.jpg"></p><h1>0x03 色播伪装的羊皮</h1><hr><p>色播类病毒在隐藏伪装方面也着实下了不少功夫</p><h2>1. 将推广应用或者dex伪装成so,mp3等各种格式</h2><p><img alt="" img-src="fc4f67613b0f2ee83afda51bbd50d8e45eea2e3a.jpg"></p><p>实际上Media.mp3为Apk文件,如下图所示</p><p><img alt="" img-src="dff0daab9a769e0e7a25716a9b4002105f6bf7c3.jpg"></p><h2>2. 少量使用主流加固,大多数通过私有加固,加解密的方式来躲避查杀,并且使用公开的隐藏Apk方式</h2><h3>1) 如下图所示,样本为dex文件,但其数据的尾部隐藏着一个APK文件</h3><p><img alt="" img-src="6a38fa4b879b62c5ebda8200996bfb27d2cb91e5.jpg"></p><h3>2) 直接以字符串的形式存储在字符串中,进行解密写文件</h3><p><img alt="" img-src="51b72fd7499b241d68f7064500f0163fc92e29ea.jpg"></p><h3>伪装成正常的类名</h3><p><img alt="" img-src="4a534cdc139f7b05796bf3692b514a3400783b8f.jpg"></p><h3>通过So来调用android代码下载插件,色播逐步转向Native层将成为一大趋势</h3><p><img alt="" img-src="51d7150b9a0eeeb49019c5b22c8722c04bf28e5a.jpg"></p><h1>0x04 总结</h1><hr><p>色播类的样本使用各种伪装,加解密的方式的手段来加载恶意代码,此种通过云端控制、插件化加载的方式,可达到加载各种恶意app,并且含推广应用,推送消息,恶意扣费的行为,将对用用户造成很大的影响。</p><h1>0x05 解决方案与安全建议</h1><hr><ol><li>使用腾讯手机管家可进行精确的查杀与防御</li><li>健康上网,不安装来历不明的应用软件</li></ol><p><img alt="" img-src="06de42c089ddcafce10b5617ffd182361e8810b3.jpg"></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/2736" rel="bookmark" id="re1">Samsung S Voice attack</a></li><li><a href="http://drops.wooyun.org/papers/3030" rel="bookmark" id="re2">一只android短信控制马的简单分析</a></li><li><a href="http://drops.wooyun.org/mobile/7195" rel="bookmark" id="re3">Hacking Team不需越狱即可监控iOS用户</a></li><li><a href="http://drops.wooyun.org/mobile/9055" rel="bookmark" id="re4">进击的短信拦截马</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">无花果</span> <span class="reply-time">2015-10-20 23:28:59</span></div><p></p><p>我喜欢</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">昌维</span> <span class="reply-time">2015-10-20 16:36:13</span></div><p></p><p>这个广告做的漂亮</p><p></p></div></div></div></div></div></main>