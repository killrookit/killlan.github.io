<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">MongoDB安全配置</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">zhangsan</a> <span class="bull">·</span> <time title="2014/07/01 12:31" ui-time="" datetime="2014/07/01 12:31" class="published ng-binding ng-isolate-scope">2014/07/01 12:31</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 MongoDB权限介绍</h2><hr><p>1.MongoDB安装时不添加任何参数,默认是没有权限验证的,登录的用户可以对数据库任意操作而且可以远程访问数据库，需以--auth参数启动。</p><p>2.在刚安装完毕的时候MongoDB都默认有一个admin数据库,此时admin数据库是空的,没有记录权限相关的信息。当admin.system.users一个用户都没有时，即使mongod启动时添加了--auth参数,如果没有在admin数据库中添加用户,此时不进行任何认证还是可以做任何操作(不管是否是以--auth 参数启动),直到在admin.system.users中添加了一个用户。</p><p>3.MongoDB的访问分为连接和权限验证，即使以--auth参数启动还是可以不使用用户名连接数据库，但是不会有任何的权限进行任何操作</p><p>4.admin数据库中的用户名可以管理所有数据库，其他数据库中的用户只能管理其所在的数据库。</p><p>5.在2.4之前版本中，用户的权限分为只读和拥有所有权限；2.4版本的权限管理主要分为：数据库的操作权限、数据库用户的管理权限、集群的管理权限，建议由超级用户在admin数据库中管理这些用户。不过依然兼容2.4版本之前的用户管理方法。</p><h2>0x01 MongoDB中用户的角色说明</h2><hr><h3>1. read角色</h3><p>数据库的只读权限，包括：</p><pre><code>aggregate,checkShardingIndex,cloneCollectionAsCapped,collStats,count,dataSize,dbHash,dbStats,distinct,filemd5，mapReduce (inline output only.),text (beta feature.)geoNear,geoSearch,geoWalk,group 
</code></pre><h3>2. readWrite角色</h3><p>数据库的读写权限，包括：</p><p>read角色的所有权限</p><pre><code>cloneCollection (as the target database.),convertToCapped，create (and to create collections implicitly.)，renameCollection (within the same database.)findAndModify,mapReduce (output to a collection.) 
drop(),dropIndexes,emptycapped,ensureIndex() 
</code></pre><h3>3. dbAdmin角色</h3><p>数据库的管理权限，包括：</p><pre><code>clean,collMod,collStats,compact,convertToCappe 
create,db.createCollection(),dbStats,drop(),dropIndexes 
ensureIndex()，indexStats,profile,reIndex 
renameCollection (within a single database.),validate 
</code></pre><h3>4. userAdmin角色</h3><p>数据库的用户管理权限</p><h3>5. clusterAdmin角色</h3><p>集群管理权限(副本集、分片、主从等相关管理)，包括：</p><pre><code>addShard,closeAllDatabases,connPoolStats,connPoolSync,_cpuProfilerStart_cpuProfilerStop,cursorInfo,diagLogging,dropDatabase 
shardingState,shutdown,splitChunk,splitVector,split,top,touchresync 
serverStatus,setParameter,setShardVersion,shardCollection 
replSetMaintenance,replSetReconfig,replSetStepDown,replSetSyncFrom 
repairDatabase,replSetFreeze,replSetGetStatus,replSetInitiate 
logRotate,moveChunk,movePrimary,netstat,removeShard,unsetSharding 
hostInfo,db.currentOp(),db.killOp(),listDatabases,listShardsgetCmdLineOpts,getLog,getParameter,getShardMap,getShardVersion 
enableSharding,flushRouterConfig,fsync,db.fsyncUnlock() 
</code></pre><h3>6. readAnyDatabase角色</h3><p>任何数据库的只读权限(和read相似)</p><h3>7. readWriteAnyDatabase角色</h3><p>任何数据库的读写权限(和readWrite相似)</p><h3>8. userAdminAnyDatabase角色</h3><p>任何数据库用户的管理权限(和userAdmin相似)</p><h3>9. dbAdminAnyDatabase角色</h3><p>任何数据库的管理权限(dbAdmin相似)</p><h2>0x02 MongoDB安装注意事项</h2><hr><h3>1. 安装的时候需要加--auth</h3><p>加了--auth之后MongoDB才需要验证</p><h3>2. 需要加--nohttpinterface</h3><p>不加会有一个28017的端口监听，可以通过网页管理mongodb，不需要请去掉</p><h3>3. 可以加--bind_ip</h3><p>加之后可以限制访问的ip</p><h3>4. 可以加--port</h3><p>加了之后可以重新制定端口，默认为27017</p><h3>5. 安装完之后需立即在admin数据库中添加一个用户</h3><p>只有在admin数据库中添加一个用户后才能使认证生效</p><p>注：安装的过程其实就是添加1个服务，指定启动时候的参数。</p><h2>0x03 用户授权</h2><hr><h3>1. 2.4之前版本的用户管理方式</h3><h4>1.1、进入admin创建一个管理账号</h4><pre><code>use admin 
db.addUser("test","test") 
</code></pre><h4>1.2、进入需要使用的数据库中创建一个程序使用用户</h4><pre><code>use test 
db.addUser("test","test")默认拥有读写权限 
db.addUser("test","test",True)拥有读取权限 
</code></pre><h3>2. 2.4版本的用户管理，也可使用之前版本的方式</h3><h4>2.1、进入admin创建一个管理账号</h4><pre><code>use admin 
db.addUser("test","test") 
</code></pre><p>2.2、进入admin给使用的数据库test创建一个对数据库及日志拥有读写权限的账户</p><pre><code>use admin 
db.addUser({
    "user": "test", 
    "pwd": "test", 
    "roles": [ ], 
    "otherDBRoles": {
        "test": [
            "readWrite"
        ], 
        "test_log": [
            "readWrite"
        ]
    }
}) 
</code></pre><h2>0x04 安全配置方案</h2><hr><h3>1. 安装的时候加--auth，并立即在admin数据库创建一个用户</h3><p>默认情况下MongoDB是无需验证的，所以这是至关重要的一步</p><h3>2. 可以考虑安装的时候修改端口和指定访问ip</h3><p>具体根据实际情况来设定，也可以直接在服务器防火墙上做</p><h3>3. 安装的时候建议加上--nohttpinterface取消默认的一个网页管理方式</h3><p>默认的web管理一般不会用，且很多人不知道，最好关闭</p><h3>4. 管理用户处理</h3><p>因需要在admin中建立一个管理账户用于管理，最好是设置强密码，但是不要给其他程序使用</p><h3>5. MongoDB服务运行账户</h3><p>windows下可以使用network service 或者新建一个用户，使用默认的USERS组，然后添加给予数据库文件及日志存储目录的写权限，并建议取消对cmd等程序的执行权限。</p><p>linux下新建一个账户，给予程序的执行权限和数据库文件及日志目录的读写权限，并建议取消对sh等程序的执行权限。</p><h3>6. 控制好网站或者其他程序使用的连接用户权限</h3><p>网站或者其他程序使用的用户只给予对应库的权限，不要使用admin数据库中的管理账户。</p><h2>0x05 常用命令</h2><hr><h3>1. 安装</h3><pre><code>mongod --dbpath d:\mongodb\data --logpath d:\mongodb\log\mongodb.log ----nohttpinterface --auth --install
</code></pre><h3>2. 添加用户</h3><pre><code>use admin 
db.addUser("test","test") 
</code></pre><h3>3. 显示所有数据库</h3><pre><code>show dbs 
</code></pre><h3>4. 使用某个数据库</h3><pre><code>use test 
</code></pre><h3>5. 连接数据库</h3><pre><code>mongo test -uroot -p123456 
</code></pre><h3>6. 添加用户认证</h3><pre><code>db.auth("username","password") 
</code></pre><h3>7. 查看用户</h3><pre><code>db.system.users.find() 
</code></pre><p>就写几个基本的，其他的网上很多，或者用工具连上去之后操作。</p><h2>0x06 管理工具</h2><hr><h3>1. MongoVUE</h3><p>客户端形式的管理工具</p><h3>2. rockmongo</h3><p>基于php的web管理</p><p>不足之处求大牛指正！</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/2457" rel="bookmark" id="re1">Linux被DDOS&amp;CC攻击解决实例</a></li><li><a href="http://drops.wooyun.org/papers/161" rel="bookmark" id="re2">Rsync安全配置</a></li><li><a href="http://drops.wooyun.org/tips/1424" rel="bookmark" id="re3">Iptables入门教程</a></li><li><a href="http://drops.wooyun.org/tips/2245" rel="bookmark" id="re4">Mysql安全配置</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ejzhang</span> <span class="reply-time">2016-01-13 16:02:44</span></div><p></p><p>@www.pvlaba.com MongoDB 3.0 用户创建：http://www.cnblogs.com/zhoujinyi/p/4610050.html</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">www.pvlaba.com</span> <span class="reply-time">2015-11-11 16:58:06</span></div><p></p><p>非常棒的教程啊，感谢了,从3.0开始，是不是增加用户的方法修改过了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Manning</span> <span class="reply-time">2014-12-11 10:53:50</span></div><p></p><p>相见恨晚，就怪自己眼瞎</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Shell</span> <span class="reply-time">2014-11-17 10:25:55</span></div><p></p><p>必须上iptables啊！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Hisoka-J</span> <span class="reply-time">2014-08-17 21:57:38</span></div><p></p><p>集群可以使用keyFile参数，但默认允许在启用验证后localhost依然能够无验证登录，可以按需关闭。</p><p>mongodb从2.6开始弃用了addUser()和removeUser()，改为createUser()和dropUser()，另外权限控制更加细化。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">wefgod</span> <span class="reply-time">2014-07-19 13:16:48</span></div><p></p><p>mongodb默认情况下不用用户名密码就可以登录成功？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">chock</span> <span class="reply-time">2014-07-05 16:02:14</span></div><p></p><p>iptables足矣</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小禾吉</span> <span class="reply-time">2014-07-02 16:06:00</span></div><p></p><p>nosqlmap</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zhangsan</span> <span class="reply-time">2014-07-02 13:04:40</span></div><p></p><p>直接扫描28017是否有web</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">px1624</span> <span class="reply-time">2014-07-01 17:50:25</span></div><p></p><p>求检测方法？有么有直接扫描的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">chock</span> <span class="reply-time">2014-07-01 16:11:55</span></div><p></p><p>哈哈，早些时候误打误撞都把坑填上了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">疯狗</span> <span class="reply-time">2014-07-01 14:36:42</span></div><p></p><p>正需要这篇文章，赞，mongodb默认坑太多，乌云上好多案例了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ihacku</span> <span class="reply-time">2014-07-01 14:22:36</span></div><p></p><p>赞</p><p></p></div></div></div></div></div></main>