<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Fragment Injection漏洞杂谈</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">路人甲</a> <span class="bull">·</span> <time title="2015/08/21 10:23" ui-time="" datetime="2015/08/21 10:23" class="published ng-binding ng-isolate-scope">2015/08/21 10:23</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 背景</h1><hr><p>13年的时候，IBM的安全研究人员发现了1个<code>Google</code>框架层的漏洞<code>Fragment</code>注入漏洞，该漏洞可以导致<code>Android</code>手机的PIN码被重置，大家应该对图1不陌生。这个漏洞之后，业界对该漏洞的影响没有进一步的探讨，本文将对该漏洞进行进一步的探讨，欢迎拍砖。</p><p><img alt="enter image description here" img-src="65bfa8e1caeb0d01d811e77c5321081e631a5812.jpg"></p><h1>0x01 Fragment注入漏洞详情</h1><hr><p><code>Android Framework</code>提供了<code>android.preference.PreferenceActivity</code>这个类来对<code>preference</code>进行展示，我们可以继承这个类来展示<code>preference</code>，并进行扩展。基类中会接收<code>Intent</code>数据，并进行一定检查，其中两个比较重要：</p><p><code>PreferenceActivity.EXTRA_SHOW_FRAGMENT (’:android:show_fragment’) and PreferenceActivity.EXTRA_SHOW_FRAGMENT_ARGUMENTS (’:android:show_fragment_arguments’)</code>。第一个<code>extra</code>域包含<code>PreferenceActivity</code>要动态加载的<code>Fragment</code>，第二个<code>extra</code>域包含传给该<code>Fragment</code>的参数。<code>Fragment</code>也可以通过<code>Fragment.getActivity</code>这个函数来获取传进来的参数。<code>PreferenceActivity</code>会调用<code>Fragment.instantiate</code>来动态加载<code>Fragment</code>.这个函数通过反射来加载<code>Fragment</code>，并把它变成<code>Fragment</code>对象。如图2所示。</p><p><img alt="enter image description here" img-src="b26df4f31e940fbd4e385291976898ff194971db.jpg"></p><p>任何继承自<code>PreferenceActivit</code>y并对外导出的组件，都会受到攻击。恶意app可以传<code>:android:show_fragment</code>这个<code>extra</code>值来指定要动态加载的类。在<code>PreferenceActivity</code>的<code>context</code>里，通过<code>dalvik.system.PathClassLoader</code>函数来动态加载类，由于没有对请求的app进行校验，恶意app可以动态加载有漏洞app里面的任何类（包括未导出类），使得恶意app可以访问有漏洞app的隐私信息。</p><h1>0x02 Fragment注入漏洞利用</h1><hr><h3>1.拒绝服务</h3><p>由于通过该漏洞可以加载app里面的任何类，包括未导出类，如果未导出类对畸形消息处理不当，将会导致本地拒绝服务漏洞。下面以<code>IRCCloud软件</code>为例。</p><p><code>com.irccloud.android.activity.PreferencesActivity</code>组件对外导出：</p><p><img alt="enter image description here" img-src="973118366b624cc035334f189daec5d715320897.jpg"></p><p><code>com.irccloud.android.activity.PreferencesActivity</code>组件继承自<code>PreferenceActivity</code>：</p><p><img alt="enter image description here" img-src="1ab9b39571375ec68a60e615b75e19d9e266fa34.jpg"></p><p>由于没有对<code>Fragment</code>注入漏洞进行防御，可通过该漏洞加载app内任意不导出的组件。选择<code>com.irccloud.android.fragment.ServerReorderFragment</code>作为攻击目标：</p><p><img alt="enter image description here" img-src="f40d63a9bd33e8ac52e8d2d87cf78332f253b876.jpg"></p><p><code>ServerReorderFragment</code>没有对畸形消息进行处理，导致拒绝服务，见下图。</p><p><img alt="enter image description here" img-src="6481db3e320d0c2b39c3d8e202d143fab8743df4.jpg"></p><h3>2.远程命令执行</h3><p>由于现在很多组件都是基于<code>Webview</code>来展示页面，并且<code>Fragment</code>组件应用越来越广，以后将会有越来越多的<code>Webview</code>组件是基于<code>Fragment</code>来展示。由于<code>Fragment</code>注入漏洞可以加载app内任意未导出组件，如果基于<code>Fragment</code>的<code>Webview</code>组件存在<code>addJavascriptInterface</code>漏洞，将会导致远程命令执行漏洞。在市面上的app里找了下，发现很多<code>Webview</code>组件基于<code>Fragment</code>，但是继承自<code>PreferenceActivity</code>的组件是不导出的，因此下面将自己写个demo来验证下可行性。</p><p><code>MainActivity</code>导出，并继承自<code>PreferenceActivity</code>。</p><p><img alt="enter image description here" img-src="01f865207a29ae0eab01961a96b9014748f1502f.jpg"></p><p>WebviewFragment导出js接口，并加载url。</p><p><img alt="enter image description here" img-src="e81a143b44deddbc9a7eaa2b8e8f0c1f6bcbfab0.jpg"></p><p>利用<code>Fragment Injection</code>漏洞对<code>WebviewFragment</code>攻击。</p><p><img alt="enter image description here" img-src="c5b8c9676e6f035114c9427713cc3d0e0c501ce7.jpg"></p><p>通过<code>Fragment Injection</code>漏洞，<code>WebviewFragment</code>已加载恶意html，存在远程代码执行漏洞攻击，见图。</p><p><img alt="enter image description here" img-src="eba870693b7a2ac93f74867f257dcb1fa6a5cb56.jpg"></p><h1>四、总结</h1><hr><p>由于可以加载app内的任意未导出组件，因此<code>Fragment</code>注入漏洞可攻击点还是挺多的。本文对<code>Fragment</code>注入漏洞进行抛砖引玉，希望大牛们能对该漏洞进一步开发。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/mobile/9055" rel="bookmark" id="re1">进击的短信拦截马</a></li><li><a href="http://drops.wooyun.org/mobile/10775" rel="bookmark" id="re2">Android平台下二维码漏洞攻击杂谈</a></li><li><a href="http://drops.wooyun.org/tips/3936" rel="bookmark" id="re3">Android Activtity Security</a></li><li><a href="http://drops.wooyun.org/tips/2736" rel="bookmark" id="re4">Samsung S Voice attack</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">theone</span> <span class="reply-time">2015-08-21 18:02:49</span></div><p></p><p>先mark下，细看</p><p></p></div></div></div></div></div></main>