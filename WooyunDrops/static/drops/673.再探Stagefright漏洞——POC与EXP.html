<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">再探Stagefright漏洞——POC与EXP</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">猎豹移动安全中心</a> <span class="bull">·</span> <time title="2015/08/01 7:12" ui-time="" datetime="2015/08/01 7:12" class="published ng-binding ng-isolate-scope">2015/08/01 7:12</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p><strong>作者:Qever</strong></p><h1>0x00 前言</h1><hr><p>在之前的《抛砖引玉——Stagefright漏洞初探》中，我们确定了漏洞的产生位置，然后整篇文章就戛然而止了。此漏洞毕竟影响很深，有些细节不知当讲不当讲。本篇文章来简单扒一扒漏洞利用的方案。只论思路，具体的Exp还是等漏洞具体细节公布后再做讨论。</p><h1>0x01 手把手教你构造POC</h1><hr><p>在上篇文章里面，给出了一个POC文件，现在我们就来说说这个文件是怎么构造的。</p><p>首先，需要准备一个MP4文件。这里使用的是从网上随意下载的一个文件。</p><p>之后，需要为这个mp4文件添加一个封面。笔者使用的工具是iTunes，在显示简介的插图里面可以为其添加封面图片。</p><p><img alt="enter image description here" img-src="aea9f47b539c05ad78223c26ab59b50c59bd8b20.jpg"></p><p>下一部，使用010Editor打开添加封面的poc.mp4文件。然后搜索字符串”covr”。</p><p><img alt="enter image description here" img-src="af3338e11d6af627da11663f820f3853e63754c1.jpg"></p><p>最后，把”covr”前面4个字节改为<code>00 00 00 01</code>，后面8个字节改为<code>00 00 00 01 00 00 00 0F</code></p><p><img alt="enter image description here" img-src="3c85daa3b5bc62c7135921a7fc3448bc103acd3a.jpg"></p><p>保存之后，扔到手机中打开。由于mediaserver崩溃之后，会立刻重启。所以我们需要系统Log来辅助验证漏洞的触发。</p><p><img alt="enter image description here" img-src="4457b6cb14f36ea48fe27d410d2f06abbcafa3c4.jpg"></p><p>通过Log就能发现，mediaserver。其实这幅图还包含了其他的信息，后面再说。</p><h1>0x02 知其所以然</h1><hr><p>要搞清楚，POC为什么要这样做，就必须要从源码下手。 我们在<code>/frameworks/av/media/libstagefright/MPEG4Extractor.cpp</code>中继续看相关源码。</p><p><img alt="enter image description here" img-src="605cb96c751c185cbad4ed0f2f1096d0bc8d434e.jpg"></p><p>前面说过，这个漏洞的原因，在于<code>chunk_data_size = 0xFFFFFFFF</code>。使得<code>chunk_data_size + 1 = 0</code>，造成了申请内存的长度为0，然后往内存中拷贝数据时越界写。</p><p><img alt="enter image description here" img-src="e986437296d05f5178793b7fb2a9a3935e94a320.jpg"></p><p>那么我们就看看<code>chunk_data_size</code>如何才能等于0xFFFFFFFF。</p><p><img alt="enter image description here" img-src="372f18b3a8162831345c0696b1f0d811b3e31e1e.jpg"></p><p>从这里就能看出来。<code>*offset – data_offset = 8</code>。也就是说,<code>chunk_data_size</code>要等于<code>0xFFFFFFFF</code>。Chunk_size就必须等于<code>0xFFFFFFF + 8</code>。</p><p><img alt="enter image description here" img-src="695eac08fd93843aa4ef0d2e652974963f87ab5f.jpg"></p><p>但是，可以看到chunk&#95;size是从*offset处读取了4个字节进行转换的，最大值也就是0xFFFFFFFF了。 同时注意chunk&#95;type，后面可以看到，chunk_type的值是<code>FOURCC('c', 'o', 'v', 'r')</code>，也就是<code>(int)’covr’</code>，这就是为什么要用字符串”covr”做定位的原因。</p><p>回来继续看chunk&#95;size，发现类型实际上是uint64&#95;t，也就是说有可能会大于0xFFFFFFFF。继续看代码。</p><p><img alt="enter image description here" img-src="cb8ff41fb3e4fe59848dede03cd608c84ed0c102.jpg"></p><p>这段就很清楚了。如果之前读取到的<code>chunk_size == 1</code>，那么就读取*offset + 8处的8个字节，作为chunk&#95;size的值，同时data&#95;offset会加8。</p><p>由此可以确定。当*offset处内存值设置为</p><pre><code>00 00 00 01 ‘c’ ‘o’ ‘v’ ‘r’ 00 00 00 01 00 00 00 0F
</code></pre><p>可以使chunk&#95;data&#95;size的值成为0xFFFFFFFF达到攻击的目的！</p><h1>0x03 没Exp你说个铲铲</h1><hr><p>看过上面的内容，相信大家也该了解到，POC还是非常简单的，实际上就是没啥技术含量。相信大多数人关心的还是Exp。不过因为是未修复的漏洞，所以想伸手要Exp的就不要想了。下面只是来讲讲利用的思路。没兴趣的就可以直接跳过了。</p><p>根据之前的分析，可以确定该漏洞是堆的越界写引起的。那么利用思路就只有一个，就是越界修改其他对象的值，造成在使用或者析构的时候出错，跳入shellcode执行。</p><p>但是这个漏洞的难点在于，攻击载体是一个视频文件，本身没有执行代码的能力，也就没办法干涉到内存布局，也没办法获取内存布局信息。由此使得基本无法稳定利用。由于内存地址问题，反正笔者目前尚未发现能比较稳定的利用方法，如果哪位大牛有，欢迎分享！</p><h1>0x04 如何寻找Exp</h1><hr><p>事实上，要寻找Exp的思路还是比较简单的。从前面<code>00 00 00 01 00 00 00 0F</code>开始，逐渐增加文件大小，然后一直测试，收集崩溃信息。找寻利用点。</p><p>笔者还算是幸运，并没有费多大的力气，就找到了一个非常明显的利用点。 还是回到之前的崩溃截图，我们来看堆栈信息。</p><p><img alt="enter image description here" img-src="15b89e4fdc1ca662367d9f470ece8d684269d6d6.jpg"></p><p>根据堆栈，可以看到，是一个HTTPBase的智能指针，在析构的时候崩溃了。</p><p>等等，<code>android::RefBae::decStrong</code>和<code>android_atomic_dec</code>，之前研究过Android漏洞人，是不是觉得有点眼熟？这个东西实际上已经出现过一次了，是在CVE-2014-7911里面。</p><p>我们来看看decStrong的实现。</p><p><img alt="enter image description here" img-src="c43853c93ab279ee178d8b8715c0f36e9c353d70.jpg"></p><p>可以看出，当<code>android_atomic_dec</code>返回值为1的时候。会触发一句BLX R2。 这段通俗一点讲，就是</p><pre><code>#!c++
If(*(*(offset + 4)) == 1){
    r2 = *(*(*(offset + 4) + 8) + 0xC)
    blx r2;
}
</code></pre><p>代码执行！！数据可控！！！</p><p>我们随后可以把mp4进行填充一下，得到以下的结果</p><p><img alt="enter image description here" img-src="e2567bb1955041907c489df57fa9c872ff3289f2.jpg"></p><p>也就是说，针对我的mp4文件，文件偏移在<code>0x96a8-4</code>处的值，就是上面所说的offset。</p><p>知道offset之后，就可以构造数据，达到代码执行的目的！！！！！</p><h1>0x05 现实很骨感</h1><hr><p>到此，找到了一种利用漏洞的方案。虽然理论上可行，但是在实际操作中，并不是那么如意。</p><p>最主要的一点，在于堆越界写的地址上面，这个地址并不是固定的。好在经过测试，我们发现是在一定范围内变化。在笔者的Nexus5手机上，这个范围大概是<code>0xb7000000~0xb9000000</code>之间。如果通过大量的测试和调整，还是够覆盖准确的。</p><p>另外一个问题就是执行权限。在堆上申请的内存本身是没有执行权限的。所以需要一个跳板才行，但是由于攻击载体只是一个视频文件，所以这并不是一件简单的事情。</p><p>至于后续怎么编写shellcode，本身也存在一些问题。</p><p>当然，这些都不是本篇文章所考虑的内容 =。=</p><h1>0x06 总结</h1><hr><p>还是那句话，本漏洞由于未修复。我们只能根据情况逐渐公开研究结果，以免造成不好的影响。</p><p>在厂商发布更新补丁之前，我们来说说防御。</p><p>对于该漏洞的防范，建议是关闭彩信自动下载。但是实际上通过任何渠道传播的视频，都可能利用该漏洞。包括通过微信发送视频，接收者根本无法分辨是否为mp4格式文件，点击播放就可能被黑客攻击。</p><p>目前大部分厂商都在尝试主动查杀视频文件的防御方案。但是笔者认为这完全是事倍功半，而且由于无法监控所有途径传播的视频文件，所以无法真正达到防御的目的。</p><p>目前，猎豹移动安全中心正在尝试一种被动式的防御方案，可以有效降低攻击危害。敬请关注猎豹移动相关资讯。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/7558" rel="bookmark" id="re1">Stagefright漏洞公告</a></li><li><a href="http://drops.wooyun.org/papers/7506" rel="bookmark" id="re2">关于libStagefright系列漏洞分析</a></li><li><a href="http://drops.wooyun.org/papers/1440" rel="bookmark" id="re3">Android Adobe Reader 任意代码执行分析(附POC)</a></li><li><a href="http://drops.wooyun.org/papers/5232" rel="bookmark" id="re4">Android DropBox SDK漏洞（CVE-2014-8889）分析</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小荷才露尖尖角</span> <span class="reply-time">2015-08-02 20:57:31</span></div><p></p><p>感谢</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ACGT</span> <span class="reply-time">2015-08-02 14:07:43</span></div><p></p><p>@QEver 谢谢分享。大家都是搞技术的，就别管什么厂商了，那是公关的工作。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">QEver</span> <span class="reply-time">2015-08-02 11:18:56</span></div><p></p><p>目前我们只有技术人员，所以写的难免偏重技术方面，不像友商那么通俗易懂。但论技术目前并没有见到比我们讲的更深入的。并不是说别人没能力，相反我知道很多厂商研究更深入，但却敝扫自珍，我见到有朋友要POC都各种理由不愿拿出来分享，才决定写这篇文章。<br>这种文章对一般人确实用处不大，但是如果研究此漏洞陷入瓶颈的同行，肯定会有所收获。但这个漏洞真正要用，依旧有个关键问题没有解决。这只能等漏洞发现者来解惑了。<br>@0x4d5c @路人甲</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">0x4d5c</span> <span class="reply-time">2015-08-02 10:20:42</span></div><p></p><p>有点浮躁,不能说出来的，就不要表现出来，所说的exp，如果不能稳定，最好谦虚的称它为poc.....</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">bupter</span> <span class="reply-time">2015-08-02 10:11:31</span></div><p></p><p>非常不错啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">QEver</span> <span class="reply-time">2015-08-01 20:29:10</span></div><p></p><p>哈哈~有些东西目前是不好拿到明面上说的，但我已经暗地里指出来了。如果你看不懂的话，<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="f810574f1d7d701d76431f586c1f514e1e407d1e5d62bbaebdd5cac8c9ccd5cfc1c9c91d685f1b787ab81f7f6d1d55681c4658">[email&#160;protected]</a></p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">燕子侠</span> <span class="reply-time">2015-08-01 17:27:19</span></div><p></p><p>这是刷存在感的文章吧，跟没写一样</p><p></p></div></div></div></div></div></main>