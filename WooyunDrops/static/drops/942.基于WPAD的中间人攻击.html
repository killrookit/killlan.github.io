<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">基于WPAD的中间人攻击</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">三好学生</a> <span class="bull">·</span> <time title="2015/12/14 10:33" ui-time="" datetime="2015/12/14 10:33" class="published ng-binding ng-isolate-scope">2015/12/14 10:33</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 前言</h1><hr><p><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="97723a31732e37d7dff2e5a7fef974171dc0fef9f3f8e0e472071a7030277f3034710907710b2d721f21711935703e2172181d702b2d7e0e20721f3e70033f74171c">[email&#160;protected]</a>很受启发，于是对其实际利用做了进一步研究，发现基于WPAD的中间人攻击很是有趣，现将收获分享给大家。</p><p><img alt="p1" img-src="a16935adf7c053fc3a81706945caf1ee318ed72e.jpg"></p><h1>0x01 简介</h1><hr><p><strong>WPAD:</strong></p><p>全称网络代理自动发现协议（Web Proxy Autodiscovery Protocol）,通过让浏览器自动发现代理服务器，定位代理配置文件，下载编译并运行，最终自动使用代理访问网络。</p><p><strong>PAC：</strong></p><p>全称代理自动配置文件（Proxy Auto-Config），定义了浏览器和其他用户代理如何自动选择适当的代理服务器来访问一个URL。</p><p>要使用 PAC，我们应当在一个网页服务器上发布一个PAC文件，并且通过在浏览器的代理链接设置页面输入这个PAC文件的URL或者通过使用WPAD协议告知用户代理去使用这个文件。</p><p>WPAD标准使用 wpad.dat，PAC文件举例：</p><pre><code>#!js
function FindProxyForURL(url, host) {
   if (url== 'http://www.baidu.com/') return 'DIRECT';
   if (host== 'twitter.com') return 'SOCKS 127.0.0.10:7070';
   if (dnsResolve(host) == '10.0.0.100') return 'PROXY 127.0.0.1:8086;DIRECT';
   return 'DIRECT';
}
</code></pre><h1>0x02 WPAD原理</h1><hr><p>如图</p><p><img alt="这里写图片描述" img-src="1b3e6c3e3d85ccae2b04caddc2729afea6783b6c.jpg"></p><p>此图片修改于http://wenku.baidu.com/link?url=KFoXTvqgxnNR1lxM_2dHCCRlJXp0D2GXa80fI7BCjR7XSoDqv2jmLJ8WJoSaew9MFSpKmTDV9lxNF2XKhTaJ1T8rSghDrhZ71OqlQ1yqx-a</p><p>用户在访问网页时，首先会查询PAC文件的位置，具体方式如下：</p><p><strong>1、通过DHCP服务器</strong></p><p>如图</p><p><img alt="这里写图片描述" img-src="c98ddbc0d484bf3ab69e7c043d308330ffb786ca.jpg"></p><p>web浏览器向DHCP服务器发送DHCP INFORM查询PAC文件位置</p><p>DHCP服务器返回DHCP ACK数据包，包含PAC文件位置</p><p><strong>2、通过DNS查询</strong></p><p>web浏览器向DNS服务器发起 WPAD＋X 的查询</p><p>DNS服务器返回提供WPAD主机的IP地址</p><p>web浏览器通过该IP的80端口下载wpad.dat</p><p><strong>3、通过NBNS查询</strong></p><blockquote><p>Tips：</p><p>Windows 2K , XP , 2K3 只支持 DNS 和 NetBIOS</p><p>Windows Vista 之后（包括 2K8 ， Win7，Win8.x，Win 10）支持DNS、NBNS、LLMNR</p></blockquote><p>如果DHCP和DNS服务器均没有响应，同时当前缓存没有所请求的主机名，就会发起如下名称解析：</p><p>如果当前系统支持LLMNR（Link-Local Multicast Name Resolution），先发起广播LLMNR查询，如果没有响应再发起广播NBNS查询</p><p>如果有主机回应PAC文件位置</p><p>web浏览器通过该IP的80端口下载wpad.dat</p><h1>0x03 WPAD漏洞</h1><hr><p>对照WPAD的原理，不难发现其中存在的漏洞，如图</p><p><img alt="这里写图片描述" img-src="b8535e7814bd67884cad39bb3c7ae6b4bc932049.jpg"></p><p>此图片修改于 http://wenku.baidu.com/link?url=KFoXTvqgxnNR1lxM_2dHCCRlJXp0D2GXa80fI7BCjR7XSoDqv2jmLJ8WJoSaew9MFSpKmTDV9lxNF2XKhTaJ1T8rSghDrhZ71OqlQ1yqx-a</p><p>如果在被攻击用户发起NBNS查询时伪造NBNS响应，那么就能控制其通过伪造的代理服务器上网，达到会话劫持的目的。</p><h1>0x04 WPAD漏洞测试</h1><hr><p><strong>测试环境：</strong></p><pre><code>被攻击用户：
win7 x86
192.168.16.191

攻击用户：
kali linux
192.168.16.245
</code></pre><p><strong>测试过程：</strong></p><p><strong>1、监听NBNS查询</strong></p><pre><code>use auxiliary/spoof/nbns/nbns_response
set regex WPAD
set spoofip 192.168.16.245
run
</code></pre><p>如图</p><p><img alt="这里写图片描述" img-src="f55f58bb70d9c72074958471a15cb1c54fc26845.jpg"></p><p><strong>2、设置WPAD服务器</strong></p><pre><code>use auxiliary/server/wpad
set proxy 192.168.16.245
run
</code></pre><p>如图</p><p><img alt="这里写图片描述" img-src="331831e6414df0763405154a59520146cc4a182a.jpg"></p><p><strong>3、被攻击用户发起查询</strong></p><p>构造广播NBNS查询</p><p>需要使当前dbcp和dns服务器均无法提供的PAC文件位置</p><p><strong>4、响应被攻击机用户的广播NBNS查询</strong></p><p>如图</p><p><img alt="这里写图片描述" img-src="86b214d8c323e9af0c8fff5ede6befa5b6358416.jpg"></p><p>攻击主机响应广播NBNS查询并指定PAC文件位置</p><p>被攻击主机访问指定的PAC位置请求下载</p><p>wireshark抓包如图</p><p>广播NBNS查询包，如图</p><p><img alt="这里写图片描述" img-src="3d2431db022730daa54dd1af503cb643511b3e73.jpg"></p><p>NBNS查询响应包，如图</p><p><img alt="这里写图片描述" img-src="88a49d8cc57ea103466ff13b882ad5624d01750b.jpg"></p><p>被攻击主机请求PAC文件位置，如图</p><p><img alt="这里写图片描述" img-src="f686f2087eae6eeac5bec55a2c024ddd30519ca6.jpg"></p><p>攻击主机回复PAC文件信息，如图</p><p><img alt="这里写图片描述" img-src="e64205950fb25b9ff16d3cd54be53320e50802ca.jpg"></p><blockquote><p>Tips：</p><p>虚拟机环境下使用wireshark只抓本地数据包，需要取消混杂模式</p></blockquote><p>如图</p><p><img alt="这里写图片描述" img-src="4fa7248729f6168d0d0d10b8a5d5013199063d23.jpg"></p><p><strong>5、被攻击机用户使用伪造的代理配置上网</strong></p><p>可在伪造的代理上面抓取被攻击用户的数据包，中间人攻击成功。</p><h1>0x05 WPAD实际利用</h1><hr><p>基于WPAD的中间人攻击有多大威力，超级电脑病毒Flame给了我们很好的示范。</p><p>其工作模式如下：</p><p><strong>1、SNACK: NBNS spoofing</strong></p><p>监听当前网络，如果收到了NBNS查询包含WPAD字符，立即伪造NBNS响应</p><p><strong>2、MUNCH: Spoofing proxy detection and Windows Update request</strong></p><p>提供WPAD服务，用来更改被攻击主机的WPAD设置</p><p>当其成功作为被攻击主机的代理后，会劫持特定的Windows更新请求，提供带有后门的windows更新文件给用户下载</p><p>如图为测试环境下抓到的windows更新请求包</p><p><img alt="这里写图片描述" img-src="857772bab27a381ece288be18b6d5852cb1fc091.jpg"></p><p>Burp suite抓到的数据包：</p><p><img alt="这里写图片描述" img-src="937561339b797fb4c34f33d89ce5df2a10aa7b66.jpg"></p><p>Flame最终成功实现了基于WPAD实施中间人攻击，篡改windows更新数据，最终感染了内网其他主机。</p><h1>0x06 防护</h1><hr><p>可通过如下设置关闭WPAD应用来避免此种攻击：</p><p>Internet Explorer-Internet Options-Connections-LAN settings</p><p>取消选中Automatically detect settings</p><p>如图</p><p><img alt="这里写图片描述" img-src="8e930033604de2150ceac6a8b6000f1ce8e5b3c4.jpg"></p><p><img alt="这里写图片描述" img-src="51505c7ea03e762b624f65ad372d7f9d78a4e328.jpg"></p><p>如果已被NBNS中间人攻击，可通过查看netbios缓存检查</p><pre><code>nbtstat -c
</code></pre><p>如图</p><p><img alt="这里写图片描述" img-src="189af2e6440754653a6f17acbe26772f3c2adccc.jpg"></p><h1>0x07 补充</h1><hr><p>Responder：</p><blockquote><p>Responder is a LLMNR, NBT-NS and MDNS poisoner, with built-in HTTP/SMB/MSSQL/FTP/LDAP rogue authentication server supporting NTLMv1/NTLMv2/LMv2, Extended Security NTLMSSP and Basic HTTP authentication.</p></blockquote><p>Responder可以说是内网中间人攻击神器，很值得尝试</p><p>简单使用命令如下：</p><pre><code>git clone https://github.com/SpiderLabs/Responder.git
cd Responder/

python Responder.py -I eth0 -i 192.168.16.245 -b
</code></pre><p>当被攻击主机访问主机共享时就能抓到其hash，如图</p><p><img alt="这里写图片描述" img-src="2c66a87ad83056fcac856c6ba170476622aabc31.jpg"></p><h1>0x08 小结</h1><hr><p>虽然WPAD不是很新的技术，但是对其了解的都不太多，在内网渗透中应该被重视。</p><p><strong>参考资料：</strong></p><ul><li><a href="http://drops.wooyun.org/papers/10887#comments">http://drops.wooyun.org/papers/10887#comments</a></li><li><a href="http://www.netresec.com/?page=Blog&amp;month=2012-07&amp;post=WPAD-Man-in-the-Middle">http://www.netresec.com/?page=Blog&amp;month=2012-07&amp;post=WPAD-Man-in-the-Middle</a></li><li><a href="http://wenku.baidu.com/link?url=KFoXTvqgxnNR1lxM_2dHCCRlJXp0D2GXa80fI7BCjR7XSoDqv2jmLJ8WJoSaew9MFSpKmTDV9lxNF2XKhTaJ1T8rSghDrhZ71OqlQ1yqx-a">http://wenku.baidu.com/link?url=KFoXTvqgxnNR1lxM_2dHCCRlJXp0D2GXa80fI7BCjR7XSoDqv2jmLJ8WJoSaew9MFSpKmTDV9lxNF2XKhTaJ1T8rSghDrhZ71OqlQ1yqx-a</a></li><li><a href="http://www.ibm.com/developerworks/cn/linux/1309_quwei_wpad/">http://www.ibm.com/developerworks/cn/linux/1309&#95;quwei&#95;wpad/</a></li><li><a href="https://securelist.com/blog/incidents/33002/flame-replication-via-windows-update-mitm-proxy-server-18/">https://securelist.com/blog/incidents/33002/flame-replication-via-windows-update-mitm-proxy-server-18/</a></li><li><a href="https://github.com/SpiderLabs/Responder">https://github.com/SpiderLabs/Responder</a></li><li><a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/spoof/nbns/nbns_response.rb">https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/spoof/nbns/nbns_response.rb</a></li><li><a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/server/wpad.rb">https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/server/wpad.rb</a></li><li><a href="https://www.trustwave.com/Resources/SpiderLabs-Blog/Responder-2-0---Owning-Windows-Networks-part-3/">https://www.trustwave.com/Resources/SpiderLabs-Blog/Responder-2-0&#45;--||||||Owning-Windows-Networks-part-3/</a></li><li><a href="https://github.com/lgandx/Responder-Windows">https://github.com/lgandx/Responder-Windows</a></li><li><a href="http://www.censornet.com/pdf/WPAD-Configuration-Guide.pdf">http://www.censornet.com/pdf/WPAD-Configuration-Guide.pdf</a></li><li><a href="http://findproxyforurl.com/wpad-introduction/">http://findproxyforurl.com/wpad-introduction/</a></li></ul><p>本文由三好学生原创并首发于乌云drops，转载请注明</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/8638" rel="bookmark" id="re1">通过.PAC进行网络钓鱼</a></li><li><a href="http://drops.wooyun.org/pentesting/11799" rel="bookmark" id="re2">利用 NetBIOS 协议名称解析及 WPAD 进行内网渗透</a></li><li><a href="http://drops.wooyun.org/tips/2943" rel="bookmark" id="re3">mitmproxy中libmproxy简单介绍</a></li><li><a href="http://drops.wooyun.org/papers/10887" rel="bookmark" id="re4">Windows 名称解析机制探究及缺陷利用</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">0x1</span> <span class="reply-time">2016-04-28 17:36:07</span></div><p></p><p>@三好学生 我在内网抓到这样一个cap包,看上去符合,但是他的查询源的mac地址都是一个.这个是什么鬼呢?</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">三好学生</span> <span class="reply-time">2015-12-22 08:05:15</span></div><p></p><p>@Touya https://github.com/3gstudent/pdf</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Touya</span> <span class="reply-time">2015-12-21 09:35:11</span></div><p></p><p>@三好学生 劳烦写下github的地址，我找了下没找到，谢谢！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">三好学生</span> <span class="reply-time">2015-12-15 15:33:37</span></div><p></p><p>@ashimida 我在win8 ie10上测试成功；<br>@Touya 文章已共享到github；<br>@stgxygxy @help 如果是研究wpad，不需要研究病毒样本，抱歉无法提供</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Touya</span> <span class="reply-time">2015-12-15 11:33:00</span></div><p></p><p>@三好学生 《POSTER: Sniffing and Propagating Malwares through WPAD Deception in LANs》文章可以共享下么？貌似要付费，嘿嘿。。。。非常羞愧。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">help</span> <span class="reply-time">2015-12-15 01:02:54</span></div><p></p><p>非常感谢楼主的文章，很有收获，楼主能不能共享下超级电脑病毒Flame的样本，我想自己抓包学习下，谢谢！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zyq8709</span> <span class="reply-time">2015-12-14 17:39:12</span></div><p></p><p>@三好学生 赞一个，心态真好，都是玩耍嘛</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zyq8709</span> <span class="reply-time">2015-12-14 17:37:06</span></div><p></p><p>@ashimida 脸皮越来越薄了，还能不能玩耍了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小飞侠罗宾</span> <span class="reply-time">2015-12-14 17:06:42</span></div><p></p><p>@三好学生 赞，说的真好</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ashimida</span> <span class="reply-time">2015-12-14 17:04:09</span></div><p></p><p>@zyq8709 一个实验，无论多简单，只要数据是真实、有用的，就不丢人。一片文章，不论是论文、poster、还是博客，只要可以为他人提供思路或节省学习时间，就不丢人。一片poster没啥可炫耀的，但内容是真实的，说出来不丢人。没事多看看书，写写代码，别没事老见谁和谁撕逼，没意思。最后说一句，大家交流也不是一次两次了，我不是在和你撕逼，我是在教你。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">肥猪</span> <span class="reply-time">2015-12-14 16:54:10</span></div><p></p><p>@zyq8709 你发了什么文章？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ashimida</span> <span class="reply-time">2015-12-14 16:34:28</span></div><p></p><p>@三好学生 一篇文章没啥好撕逼的，这样的文章发出来就是为了大家可以互相学习的，只是和楼主说声其实是有人做过的。<br>那篇文章的实验是有局限性的，还顺便想请教楼主一下，这个实验笔者在IE9以上实验了一下没有成功，后来就没有再尝试了，感觉理论上应该是可行的，可能代码哪里有点问题，不知楼主在IE9上是否实验成功了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">stgxygxy</span> <span class="reply-time">2015-12-14 16:34:26</span></div><p></p><p>非常感谢楼主的文章，很有收获，楼主能不能共享下超级电脑病毒Flame的样本，我想自己抓包学习下，谢谢！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">三好学生</span> <span class="reply-time">2015-12-14 16:05:01</span></div><p></p><p>@ashimida @帮主 @小飞侠罗宾 @zyq8709<br>感谢你们的回复，给我提供了另一个参考链接《POSTER: Sniffing and Propagating Malwares through WPAD Deception in LANs》，我已学习了全文，有了新收获，很开心。至于拿这两篇文章做比较我认为没有任何意义，对内网渗透感兴趣的同学自然能发现文章的价值。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zyq8709</span> <span class="reply-time">2015-12-14 15:04:09</span></div><p></p><p>@帮主 只是一片poster，比ccs的正会还是差的比较远的，<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="c62f677c22787923697f86a7b5aeafabafa2a7">[email&#160;protected]</a> 再放个嘲讽：）</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ashimida</span> <span class="reply-time">2015-12-14 11:39:46</span></div><p></p><p>@三好学生 额。。。内容差不多，都是中国人写的，不难懂，还是自己看吧，里面有个默认开启wpad的列表，可以参考一下。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">_Evil</span> <span class="reply-time">2015-12-14 11:28:32</span></div><p></p><p>hao hao hao</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">帮主</span> <span class="reply-time">2015-12-14 11:25:47</span></div><p></p><p>CCS 2013 上的一篇文章里讲过 ~(╯﹏╰)~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">三好学生</span> <span class="reply-time">2015-12-14 11:23:47</span></div><p></p><p>@ashimida 分享或者翻译出来给大家学习一下呗</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小飞侠罗宾</span> <span class="reply-time">2015-12-14 11:19:18</span></div><p></p><p>2年前 别人就已经有分析了。。。。。。。。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ashimida</span> <span class="reply-time">2015-12-14 11:11:22</span></div><p></p><p>13年就已经有分析了，http://dl.acm.org/citation.cfm?id=2512520</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">三好学生</span> <span class="reply-time">2015-12-14 10:56:43</span></div><p></p><p><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="7d9af4c498f5d69bf9e295cddf3d35180f4d141398d2c49be1d19bebfa9ae7f99bf1fa98d2c1">[email&#160;protected]</a>：D</p><p></p></div></div></div></div></div></main>