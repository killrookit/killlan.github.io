<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">域渗透——Hook PasswordChangeNotify</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">三好学生</a> <span class="bull">·</span> <time title="2016/03/21 10:30" ui-time="" datetime="2016/03/21 10:30" class="published ng-binding ng-isolate-scope">2016/03/21 10:30</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 前言</h1><hr><p>在之前的文章中介绍了两种维持域控权限的方法——<code>SSP</code>和<code>Skeleton Key</code>，这两种方法均需要借助Mimikatz来实现，或多或少存在一些不足，所以这次接着介绍一个更加隐蔽且不需要使用Mimikatz的后门方法——<code>Hook PasswordChangeNotify</code>.</p><p><img alt="Alt text" img-src="4d171de776e949e8c085b6dfb7345daae46c924d.jpg"></p><h1>0x01 简介</h1><hr><p>Hook PasswordChangeNotify这个概念最早是在2013年9月15日由clymb3r提出，通过Hook PasswordChangeNotify拦截修改的帐户密码。</p><p>需要了解的相关背景知识如下：</p><ol><li><p>在修改域控密码时会进行如下同步操作：</p><p>a. 当修改域控密码时，LSA首先调用PasswordFileter来判断新密码是否符合密码复杂度要求 b. 如果符合，LSA接着调用PasswordChangeNotify在系统上同步更新密码</p></li><li><p>函数PasswordChangeNotify存在于rassfm.dll</p></li><li><p>rassfm.dll可理解为Remote Access Subauthentication dll，只存在于在Server系统下，xp、win7、win8等均不存在</p></li><li><p>可以使用dumpbin查看rassfm.dll导出函数来验证结论2：</p><pre><code>#!bash
dumpbin /exports c:\windows\system32\rassfm.dll
</code></pre></li></ol><p>如图 <img alt="Alt text" img-src="1cc024d7693aa688650edde7f3c7a6b818ca8219.jpg"></p><h1>0x02 特点</h1><hr><p>对于之前介绍过的Security Support Provider，在实际使用过程中不可避免的会有以下不足：</p><ol><li>安装后需要重启系统</li><li>需要在System32文件夹下放置dll</li><li>需要修改注册表</li></ol><p>而使用Hook PasswordChangeNotify却有如下优点：</p><ol><li>不需要重启</li><li>不需要修改注册表</li><li>甚至不需要在系统放置dll</li></ol><p>可以说在隐蔽性上，使用Hook PasswordChangeNotify优于Security Support Provider</p><h1>0x03 技术实现</h1><hr><p>根据clymb3r提供的poc，实现Hook PasswordChangeNotify共包含两部分：</p><h3>1、Hook dll</h3><p>下载链接：<br><a href="https://github.com/clymb3r/Misc-Windows-Hacking">https://github.com/clymb3r/Misc-Windows-Hacking</a><br><strong>（1）</strong>为PasswordChangeNotify创建一个inline Hook，将初始函数重定向到PasswordChangeNotifyHook<br><strong>（2）</strong>在PasswordChangeNotifyHook中实现记录密码的操作，然后重新将控制权交给PasswordChangeNotify</p><h3>2、dll注入</h3><p>可以利用 Powershell tricks中的Process Injection将我们自己编写的dll注入到lsass进程，实现Hook功能</p><h1>0x04 实际测试</h1><hr><p><strong>测试环境：</strong></p><pre><code>Server 2008 R2 x64
Server 2012 R2 x64
</code></pre><p><strong>测试步骤：</strong></p><h3>1、生成Hook dll</h3><p>poc下载地址：<br><a href="https://github.com/clymb3r/Misc-Windows-Hacking">https://github.com/clymb3r/Misc-Windows-Hacking</a></p><p>使用VS2015开发环境，MFC设置为在静态库中使用MFC<br>编译工程，生成HookPasswordChange.dll</p><p><img alt="Alt text" img-src="5b3ee1af421ee2fc3cf83160837ed3fc525c25f1.jpg"></p><h3>2、生成dll注入的powershell脚本</h3><p>下载Powershell的dll注入脚本<br><a href="https://github.com/clymb3r/PowerShell/blob/master/Invoke-ReflectivePEInjection/Invoke-ReflectivePEInjection.ps1">https://github.com/clymb3r/PowerShell/blob/master/Invoke-ReflectivePEInjection/Invoke-ReflectivePEInjection.ps1</a></p><p>在代码尾部添加如下代码：</p><p><code>Invoke-ReflectivePEInjection -PEPath HookPasswordChange.dll –procname lsass</code></p><p>并命名为HookPasswordChangeNotify.ps1</p><h3>3、Hook PasswordChangeNotify</h3><p>上传HookPasswordChangeNotify.ps1和HookPasswordChange.dll</p><p>管理员权限执行：</p><pre><code>#!bash
PowerShell.exe -ExecutionPolicy Bypass -File HookPasswordChangeNotify.ps1
</code></pre><p>如图 <img alt="Alt text" img-src="9e3d205f9ec85608b18092700e2864d0a94e2f7a.jpg"></p><h3>4、自动记录新密码</h3><p>在Server 2012 R2 x64下，手动修改域控密码后<br>在C:\Windows\Temp下可以找到passwords.txt，其中记录了新修改的密码</p><p>如图 <img alt="Alt text" img-src="a96efddb6911b2b98383d09526c74cfaeddc7ec1.jpg"></p><p>在Server 2008 R2 x64下，同样成功</p><p>如图 <img alt="Alt text" img-src="692d75de19ee524fc09d5bdc3e0e56681ef64f37.jpg"></p><h1>0x05 小结</h1><hr><p>本文依旧是对常规功能做了演示，后续可自定义dll代码实现更多高级功能，如自动上传新密码。</p><p>以下链接中的代码可作为参考，其中实现了将获取的新密码上传至Http服务器</p><p><a href="http://carnal0wnage.attackresearch.com/2013/09/stealing-passwords-every-time-they.html">http://carnal0wnage.attackresearch.com/2013/09/stealing-passwords-every-time-they.html</a></p><p>使用Hook PasswordChangeNotify来记录新密码，如果放在以前，进程注入的操作很容易被检测，但是得益于Powershell应用的发展，通过Powershell来进程注入可以绕过常规的拦截。</p><p>当然，Hook PasswordChangeNotify仅仅是众多Hook方法中的一个。</p><p>我已经Fork了clymb3r的代码，并结合本文需要的代码做了更新，下载地址如下：</p><p><a href="https://github.com/3gstudent/Hook-PasswordChangeNotify">https://github.com/3gstudent/Hook-PasswordChangeNotify</a></p><h1>0x06 参考资料</h1><hr><ul><li><a href="https://clymb3r.wordpress.com/2013/09/15/intercepting-password-changes-with-function-hooking/">https://clymb3r.wordpress.com/2013/09/15/intercepting-password-changes-with-function-hooking/</a></li><li><a href="http://carnal0wnage.attackresearch.com/2013/09/stealing-passwords-every-time-they.html">http://carnal0wnage.attackresearch.com/2013/09/stealing-passwords-every-time-they.html</a></li><li><a href="http://www.processlibrary.com/en/directory/files/rassfm/305529/">http://www.processlibrary.com/en/directory/files/rassfm/305529/</a></li><li><a href="https://github.com/clymb3r/Misc-Windows-Hacking/tree/master/HookPasswordChange">https://github.com/clymb3r/Misc-Windows-Hacking/tree/master/HookPasswordChange</a></li><li><a href="http://www.slideshare.net/nFrontSecurity/how-do-password-filters-work">http://www.slideshare.net/nFrontSecurity/how-do-password-filters-work</a></li></ul><p><strong>本文由三好学生原创并首发于乌云drops，转载请注明</strong></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">猎艳</span> <span class="reply-time">2016-03-25 17:26:15</span></div><p></p><p>又可以玩很久了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">闰土。</span> <span class="reply-time">2016-03-24 13:38:22</span></div><p></p><p>简直厉害。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Mark</span> <span class="reply-time">2016-03-23 11:45:40</span></div><p></p><p>一颗赛艇（我表示我的vs2015编译不了 ，后来用的vs2012才编译成功的）</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">_Evil</span> <span class="reply-time">2016-03-22 15:34:28</span></div><p></p><p>顶。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">missdiog</span> <span class="reply-time">2016-03-21 18:22:15</span></div><p></p><p>果真是三好学生</p><p></p></div></div></div></div></div></main>