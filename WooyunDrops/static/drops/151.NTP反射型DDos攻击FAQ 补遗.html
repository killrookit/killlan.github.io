<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">NTP反射型DDos攻击FAQ/补遗</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">polestar</a> <span class="bull">·</span> <time title="2014/02/22 12:37" ui-time="" datetime="2014/02/22 12:37" class="published ng-binding ng-isolate-scope">2014/02/22 12:37</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 背景</h2><hr><p>前两天，心伤的胖子发表了一篇<a href="http://drops.wooyun.org/papers/926">《浅谈基于 NTP 的反射和放大攻击》</a></p><p>我之所以又写一篇和NTP有关的文章，是因为前面有些东西没提，或说的不够清楚，浅陋之处，欢迎大家指正留言，我再求教改进。</p><p>名词解释:</p><blockquote><p>ntp server ：和原子钟同步同步，或以自己为标准时间的ntp服务器。</p><p>ntp relay server：在/etc/ntp.conf中配置顶级 服务器，以它们为权威ntp server 的时间中继服务器，也向其它ntp 服务器和终端用户提供时间同步功能。大多数机构和个人自行搭建的ntp server均属于这种。</p><p>ntp client :ntp 服务器之间，ntp服务器与终端用户之间有多种关联关系，其中一种为server /client 模式。所以，个人理解ntp client这个词相对而言的。</p></blockquote><p>即当一台ntp 服务器（代号ABC）向权威/顶级 ntp server 同步时，此时的ABC的角色就是ntp client，当其响应下层ntp server的同步请求或响应终端用户的ntpdate请求时，ABC就是ntp server。</p><p>以上理解，如有谬误，请指正。</p><p>ntp服务器 关联关系（Association Modes ）参考：<a href="http://doc.ntp.org/4.2.2/assoc.html">http://doc.ntp.org/4.2.2/assoc.html</a></p><h2>0x01 FAQ</h2><hr><h3>1. NTP Reply Flood Attack （NTP反射型DDos攻击） 影响的范围？</h3><h3>仅影响 ntp server 还是对 ntp client 也影响？</h3><p>不论是ntp server 还是 ntp relay server 只要能响应monlist请求，其就应该能被利用发起NTP反射型DDos攻击。</p><p>也就是说，只要是没有加固的，低于 4.2.7p26 版本的 ntpd 服务（Linux平台）应该受到此漏洞影响。Windwos平台未测试。</p><p>个人为验证此问题，搭建了一台 ntp relay server做测试，其步骤也极为简单。</p><p>环境：RHEL6.2；ntpd 4.2.4p8。</p><pre><code>#!shell
1# yum install ntp -y 

2# vi /etc/ntp.conf 

server 0.rhel.pool.ntp.org //默认值**** 
restrict 10.10.20.0 mask 255.255.255.0 nomodify //允许同网段向此ntp relay server进行时间同步请求。 

3# service ntpd restart 
</code></pre><p>OK，搭建完成。</p><p>自己搭建的ntp relay server，测试结果如下。</p><pre><code>#!shell
#nmap -sU -pU:123 -n --script=ntp-monlist 10.10.10.200 

Nmap scan report for 10.10.10.200 
Host is up (0.00013s latency). 
PORT STATE SERVICE 
123/udp open ntp 
| ntp-monlist: 
| Target is synchronised with 218.75.4.130 
| Public Servers (2) 
| 97.107.134.213 218.75.4.130 
| Private Clients (1) 
| 10.10.10.210 
| Other Associations (2) 
| 10.10.10.180 (You?) seen 5 times. last tx was unicast v2 mode 7 
|_ 0:0:0:0:0:0:0:1 seen 775 times. last tx was unicast v2 mode 6 

MAC Address: 00:0C:29:E1:28:65 (VMware) 
Nmap done: 1 IP address (1 host up) scanned in 2.02 seconds 
</code></pre><h3>2. 一些扫描器好像是根据NTP服务版本来判断此漏洞，且不分ntp server、ntp client端，可能误报率会比较高，哪位高人有解决办法？</h3><p>个人理解，应该不必区分目标是 ntp server 还是 ntp client，因为所谓的 ntp server /client 应该均受影响。</p><p>国内某事业单位应急公告中的“未开启NTP Server服务或者只开启了NTP Client的情况不必进行任何处理；” 怀疑其对 ntp client 理解有误，或其ntp client指的不是运行了ntpd的服务器。理由请参考第一个回答。</p><h3>3. monlist是什么东东？跟NTP反射型DDos攻击有何关系？</h3><p>胖子的文章写得很清楚了，我就直接引用了：</p><p>NTP 包含一个 monlist 功能，也被成为 MON_GETLIST，主要用于监控 NTP 服务器，NTP 服务器响应 monlist 后就会返回与 NTP 服务器进行过时间同步的最后 600 个客户端的 IP，响应包按照每 6 个 IP 进行分割，最多有 100 个响应包。</p><p>可执行如下指令测试：</p><pre><code>#!shell
ntpdc -n -c monlist ntp_server-IP 
</code></pre><p>同 nmap 的脚本扫描是一致的。</p><pre><code>#!shell
nmap -sU -pU:123 -Pn -n --script=ntp-monlist NTP_Server_IP 
</code></pre><h3>4. 相比加ACL防御的方式，NTP官方有更简单的缓解办法，把monlist功能关掉就好了</h3><p><a href="http://support.ntp.org/bin/view/Main/SecurityNotice#DRDoS_Amplification_Attack_using">http://support.ntp.org/bin/view/Main/SecurityNotice#DRDoS&#95;Amplification&#95;Attack_using</a></p><p>我倒是挺好奇升级是怎么解决这个问题的，把这个功能默认关掉？UDP也没法校验源地址啊。</p><p>monlist(monitor list)是有缺陷版本的ntpd服务的一个特性，其源代码为ntpdc.c，编译后的文件为/usr/sbin/ntpdc</p><pre><code>#!shell
strings /usr/sbin/ntpdc 
</code></pre><p>可在第833行 看到这个函数（ntpd 4.2.4p8 ）。</p><p>具体升级为什么能解决，请参考第五个问题。</p><h3>5. 防止ntp server被利用进行DDOS攻击的方法？</h3><p>缓解/防御措施有以下几种，详见参考链接中的英文原文。</p><ol><li>此漏洞在4.2.7以前版本均默认存在。所以将 NTP 服务器升级到 4.2.7p26或更高版本，当前最新版本为4.2.7p430。个人在ntpd 4.2.7p422测试通过。</li><li>4.2.7以前版本，可在ntp.conf文件中增加<code>disable monitor</code>选项来禁用 monlist 功能。</li></ol><p>也可以使用restrict ... noquery 或 restrict ... ignore 来限制ntpd服务响应的源地址。个人在ntpd 4.2.4p8测试通过。</p><p>缓解措施参考：</p><p><a href="https://www.us-cert.gov/ncas/alerts/TA14-013A">https://www.us-cert.gov/ncas/alerts/TA14-013A</a></p><p>这个链接防御部分内容如下：</p><p>Recommended Course of Action  //美国 CERT 的说明</p><p>As all versions of ntpd prior to 4.2.7 are vulnerable by default, the simplest recommended course of action is to upgrade all versions of ntpd that are publically accessible to at least 4.2.7.</p><p>However, in cases where it is not possible to upgrade the version of the service, it is possible to disable the monitor functionality in earlier versions of the software.</p><p>To disable “monlist” functionality on a public-facing NTP server that cannot be updated to 4.2.7, add the “noquery” directive to the “restrict default” line in the system’s ntp.conf, as shown below:</p><p>restrict default kod nomodify notrap nopeer noquery restrict -6 default kod nomodify notrap nopeer noquery</p><p>Secure NTP Template //多种设备的此漏洞防御方法</p><p><a href="http://www.team-cymru.org/ReadingRoom/Templates/secure-ntp-template.html">http://www.team-cymru.org/ReadingRoom/Templates/secure-ntp-template.html</a></p><h2>0x02 综合参考</h2><hr><p><a href="http://blog.cloudflare.com/understanding-and-mitigating-ntp-based-ddos-attacks">Understanding and mitigating NTP-based DDoS attacks</a></p><p>《<a href="http://blog.sina.com.cn/s/blog_459861630101b4wf.html">NTP Reply Flood Attack （NTP反射型DDos攻击）原载黑防2011-06</a>》Linxinsnow[N.N.U]</p><p><a href="http://drops.wooyun.org/papers/926">《浅谈基于 NTP 的反射和放大攻击》</a></p><p></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/926" rel="bookmark" id="re1">浅谈基于 NTP 的反射和放大攻击</a></li><li><a href="http://drops.wooyun.org/papers/4486" rel="bookmark" id="re2">发掘和利用ntpd漏洞</a></li><li><a href="http://drops.wooyun.org/papers/534" rel="bookmark" id="re3">邮箱伪造详解</a></li><li><a href="http://drops.wooyun.org/tools/650" rel="bookmark" id="re4">tunna工具使用实例</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">woodyle</span> <span class="reply-time">2014-12-11 17:21:30</span></div><p></p><p>只用acl的话，伪造IP攻击很难防范吧。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Ivan</span> <span class="reply-time">2014-02-28 16:43:32</span></div><p></p><p>学习下！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">winsyk</span> <span class="reply-time">2014-02-25 16:37:57</span></div><p></p><p>有点不同意见，这个本身就是内网安全问题，简单的解决办法从ntp server上解决也行，但通过acl限制入站规则不是更好？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">心伤的胖子</span> <span class="reply-time">2014-02-24 11:25:38</span></div><p></p><p>我倒是挺好奇升级是怎么解决这个问题的，把这个功能默认关掉？UDP也没法校验源地址啊。</p><p>这个新的版本默认是禁用 monlist 的，其次通过随机数来校验源地址，也就是无法伪造 IP 进行攻击了，但是我觉得还是可以对 NTP Server 进行 DDoS。</p><p></p></div></div></div></div></div></main>