<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">BetaBot 木马分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">阿里云安全</a> <span class="bull">·</span> <time title="2015/11/06 14:38" ui-time="" datetime="2015/11/06 14:38" class="published ng-binding ng-isolate-scope">2015/11/06 14:38</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p><strong>作者:喔欧（阿里巴巴安全部安全威胁情报中心）</strong></p><h1>0x00 背景介绍</h1><hr><p>在当下全球网络威胁活动中，国外攻击者主要使用Zeus、CryptoWall、Bedep、各类常见RAT工具等作为恶意负载，但在最近我们监控恶意威胁的过程中，发现个别高级样本攻击中使用了较为少见的BetaBot木马，关于此木马很少有相关的分析资料。在进一步了解、分析后发现，该木马还是具有很强的危害和对抗手段。为了方便监控BetaBot木马恶意攻击活动，所以记录相关分析结果，以供参考。</p><h1>0x01 功能介绍</h1><hr><p>BetaBot，又被称为Neurevt，大概从2013年3月出现在地下市场被出售，售价大约在$120到$500。使用HTTP协议进行通信，使用RC4算法进行加密，代码使用C++语言编写，功能强大。据作者声称，该木马具备破坏杀软、自保护、BotKiller、Userkit(Ring3 Rootkit)、自定义注入技术、防其他木马感染、、DDoS、网络监视/阻塞、USB设备感染、SOCKS4代理、自校验保护、过UAC、反Sandbox等功能。</p><p>下图为示例的BetaBot服务端界面</p><p><img alt="" img-src="af9246844fa78f500b17893edb0289a4ef509617.jpg"></p><h1>0x02 木马功能</h1><hr><h2>系统驻留</h2><p>添加注册表自启动</p><p><img alt="" img-src="78627b77648ef2014dae99dbede4ce5eb6834759.jpg"></p><p>添加Windows Tasks</p><p><img alt="" img-src="9c74b6ef42d64f366dc95767d85d6b6a292ee4c6.jpg"></p><h2>收集信息</h2><p>运行环境、系统信息、硬件信息、软件信息等</p><p>例如软件信息搜集</p><p><img alt="" img-src="22f265c3f49b51430fb6a196ca05fca9ceee6230.jpg"></p><h2>启动参数</h2><p>部分命令以程序启动参数传入解析并执行</p><p><img alt="" img-src="b63aee5b539a576be56993612a08941cbbe9fae9.jpg"></p><h2>DDoS</h2><p>支持4种类型的DDoS攻击方式</p><p><img alt="" img-src="d7b0df859e575db733132eba55ddd4a69cb6e0fd.jpg"></p><h2>System Wide Userkit(Ring3 Rootkit)</h2><p>功能名称引用作者描述，用于隐藏保护木马。</p><p>HOOK API列表</p><p><img alt="" img-src="cbab7ace0e247335f7afe3179ba11bf8b6d3db6d.jpg"></p><p><img alt="" img-src="51d23e1e90566745cd72e01c2321657b0b58ee1d.jpg"></p><h2>UAC欺骗绕过</h2><p>根据用户语言习惯构造错误信息，欺骗用户</p><p><img alt="" img-src="2afb948d7355477c24f3c31f59dbf3905787cf84.jpg"></p><p>调用cmd.exe或者rundll32.exe触发UAC，实际调用木马自身</p><p><img alt="" img-src="f4c4cd5d2d0f059488a7dd41fceb6a703524fc3a.jpg"></p><p>根据用户语言习惯构造错误信息</p><p><img alt="" img-src="43e0c14a41a1daede1a1c4b173c73248ba1a1449.jpg"></p><p>在BetaBot木马对抗杀软介绍时作者也提到了使用”社会工程学”的手段</p><p><img alt="" img-src="ae839e6d929a60b336d1419777779e4f90077eae.jpg"></p><h2>配置解密</h2><hr><p>BetaBot的配置数据包含运行时所需要的释放目录位置、C&amp;C、通信密钥等重要信息，并加密存放在木马文件内。</p><p>配置数据解密流程可以分为:</p><ol><li>解密整体Config</li><li>依次解密C&amp;C Entry</li></ol><p>配置文件结构大小是0x0D56字节(随木马版本更新)，下图为解密整体config初始化代码，构造参数，动态解密执行代码，替换启动线程。</p><p><img alt="" img-src="d51a597c7427b9eaa14e7d7bf8a7b79506796189.jpg"></p><p>解密线程从imagebase搜索加密config特征，通过RC4和4字节异或进行解密，RC4解密key在自身代码中保存，解析出所需数据后，使用自更新的加密key重新加密。</p><p><img alt="" img-src="600559984c0ae04ce006e1025ed98e94a7977ff0.jpg"></p><p><img alt="" img-src="227460d0e6300cb97383a3194133daf1c48f1532.jpg"></p><p>解密结果如下</p><p><img alt="" img-src="ec1ace03ff4c5dedce0b20895d010e86e4cde4eb.jpg"></p><p>上图中前半部分已经解密，偏移0x156起始的C&amp;C Entry还需要使用图中偏移0x6选中内容作为key解密，解密流程见下图</p><p><img alt="" img-src="fbaf82b14980cface81bd9b538da481fe5805ab3.jpg"></p><p>可以看出该木马最多可以支持16个C&amp;C配置。</p><p>例如解密出的一条C&amp;C配置，其中包含了域名(偏移0x26)、端口(偏移0x14)、path(偏移0x66)、C&amp;C通信key1(偏移0xAA)、key2(偏移0XB7)。</p><p><img alt="" img-src="099c93470f693a444f70e69b0418e9c20a5b884e.jpg"></p><h2>C&amp;C通信解密</h2><hr><h3>请求过程</h3><p><img alt="" img-src="aa7dda5f067c75860a296db0d985a4b29038afcf.jpg"></p><p>构造请求数据</p><p><img alt="" img-src="7cf50d5274d8f01786e4d9897c32cd4a760a2ac0.jpg"></p><p>RC4加密请求数据并进行bin2hex转换，加密key是由C&amp;C Entry配置的key1和随机字节序列拼接处理得到。</p><p><img alt="" img-src="3bf72f6566f3dce5e5207d7a908f7e36a3678e7c.jpg"></p><p>第一次请求会附上额外信息。</p><p><img alt="" img-src="a65167dbebe1e808ea49f985f9c354225f0929e8.jpg"></p><p>额外信息异或特定值并进行bin2hex转换。</p><p><img alt="" img-src="c37257fd025178f10400524da9de96fb8eebf07f.jpg"></p><p>最后将参与加密请求数据的随机字节序列进行bin2hex转换和上述bin2hex转换信息一起发送到服务端。</p><p><img alt="" img-src="dcc60180527e3ff09fb6fe5a05ef0851be3bd058.jpg"></p><p>发送数据如下</p><p><img alt="" img-src="750b77c78a77e68296690e1f936576fcb0973942.jpg"></p><h3>响应过程</h3><p><img alt="" img-src="8fd1b170031ca7ba5f1b66edd439d15edbbee06a.jpg"></p><p>服务器响应包含两部分，header和body。</p><p><img alt="" img-src="d08ffecdd8bc3f4d7dffedd44722a78cd40fc906.jpg"></p><p>首先需要解密header，其中最重要的是8个DWORD组成的数组streams_array，位于偏移0x3C，表示body各个结构的长度。</p><p>解密过程如下，RC4加密key是由C&amp;C Entry的key1和response数据的前四个字节组合异或得到。</p><p><img alt="" img-src="26a183c8373e885f28710123c341587d1188f3da.jpg"></p><p>最后根据streams_array计算body长度然后解密。</p><p><img alt="" img-src="7dfc44603b6966831cc9f6bfb8e84b5922cc8249.jpg"></p><p>加密的body位于偏移0x5C，解密过程如下，RC4加密key是由C&amp;C Entry的key2和response数据偏移0x4四个字节组合异或得到。</p><p><img alt="" img-src="9b3cccdfd9e6c5953cba202109341a1002004df9.jpg"></p><p>最终解密结果如下图，此图所示是服务端下发的监视域名列表配置。</p><p><img alt="" img-src="987632b610a83db14f4cd337976c232ab10a8bf1.jpg"></p><h2>其他</h2><p>DNS阻断、表格抓取等功能可见参考链接。</p><h1>0x03 对抗手法</h1><hr><h2>反调试</h2><p><strong>1.ZwQueryInformationProcess检测DebugPort</strong></p><p><img alt="" img-src="fb77cdd52bb3bffac49be43054880a291c9ca1fe.jpg"></p><p><strong>2.DbgBreakPoint对抗</strong></p><p><img alt="" img-src="74e8087f9dd34d7039c4e016b5ca11bfee8e5d9d.jpg"></p><p><strong>3.ZwSetInformationThread</strong></p><p><img alt="" img-src="2ae32cbbbc374868ee5a3eb28b06318f5b8df599.jpg"></p><p><strong>4.多处代码执行过程反调试对抗</strong></p><p>例如解密config代码中</p><p><img alt="" img-src="cbf075e1a90d2f05982678b63bd6317a28b032d2.jpg"></p><h2>反虚拟机</h2><p><img alt="" img-src="458ef2981f4c840469f9347c34f74e4dcc273631.jpg"></p><h2>反JoeBox,GFI,Kasperksy,CWSandbox,Anubis等沙箱</h2><p><img alt="" img-src="df40ea42554307267d4fdf7e2069dcdfb3e1acba.jpg"></p><h2>反Sandboxie沙箱</h2><p><img alt="" img-src="35c0c43321252e26e95b30ec160335c1a4e99837.jpg"></p><h2>反wine</h2><p><img alt="" img-src="33ab1e5b8d1513c98cfda6a01dabce00dbc94df8.jpg"></p><h2>导入API加密</h2><p>通过遍历系统dll导出表，拼接成moduleName+’.’+APIName计算hash进行搜索</p><p>Hash计算方式</p><p><img alt="" img-src="7ca8491fa1fff2fc1bc829c100a3ba20a8a90b7f.jpg"></p><h2>对抗杀软</h2><p>检测杀软类型</p><p><img alt="" img-src="58caafd44f3228121958384ac1acfd72446eefb0.jpg"></p><p><img alt="" img-src="efcdbc15ed6ac3aea872adb3cfd746b73a16391d.jpg"></p><p><img alt="" img-src="f12c334e5898de82718d0c2a1367cb39298bfa3d.jpg"></p><p>禁用杀软</p><p><img alt="" img-src="491042670c894d7afe3b19707c3a2aa0be5d518a.jpg"></p><p><img alt="" img-src="589baf55cfc3ece802bd86d6448b13597fba2f9e.jpg"></p><p><img alt="" img-src="78cb4d15736c48863a7925e0a63852e0d688ad4c.jpg"></p><h2>代码加密、动态替换</h2><p>解密执行代码过程，例如解密Config线程函数体内容</p><p><img alt="" img-src="8deb968f7f5f96b94061043708c21bdef182d79e.jpg"></p><p>在一些函数调用时通过替换stub参数实现。例如stub原始代码</p><p><img alt="" img-src="9a68f8f8b5a6f893511a5d598000f7406e66c8e9.jpg"></p><p>替换参数</p><p><img alt="" img-src="43d2428af814e4b05cec53f901df0ecd4f857a4c.jpg"></p><h2>Snort检测规则</h2><pre><code>alert http any any -&gt; any any (msg: "Betabot Windows RAT Trojan Online Request"; flow: established, to_server; content: "POST"; http_method; content:"="; http_client_body; pcre: "/=\d{8}&amp;/P"; content: "1="; distance:1; http_client_body; content: "2="; distance:1; content: "3="; distance:1; content: "4="; distance:1; content: "5="; distance:1; flowbits: set, betabot_online; classtype: trojan-detect; sid:010200291; rev:1; )
</code></pre><h1>0x04 参考链接</h1><hr><ul><li><a href="https://securityintelligence.com/beta-bot-phish/">https://securityintelligence.com/beta-bot-phish/</a></li><li><a href="http://www.slideshare.net/securityxploded/dissecting-betabot">http://www.slideshare.net/securityxploded/dissecting-betabot</a></li></ul><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/6788" rel="bookmark" id="re1">来自播放器的你——“中国插件联盟”木马分析</a></li><li><a href="http://drops.wooyun.org/papers/926" rel="bookmark" id="re2">浅谈基于 NTP 的反射和放大攻击</a></li><li><a href="http://drops.wooyun.org/papers/5868" rel="bookmark" id="re3">针对以色列和巴勒斯坦的apt式攻击</a></li><li><a href="http://drops.wooyun.org/papers/9894" rel="bookmark" id="re4">Linux系统下的HDD Rootkit分析</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Sic</span> <span class="reply-time">2015-11-08 23:25:06</span></div><p></p><p>长见识了，之前一直不知道那些专业的木马是啥样</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">阿里云安全</span> <span class="weibo"></span> <span class="reply-time">2015-11-06 15:50:05</span></div><p></p><p>关于BetaBot木马的分析资料一直较少，但这篇文章细而全，欢迎参看</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">phunter_lau</span> <span class="weibo"></span> <span class="reply-time">2015-11-06 15:41:09</span></div><p></p><p>慎入了解</p><p></p></div></div></div></div></div></main>