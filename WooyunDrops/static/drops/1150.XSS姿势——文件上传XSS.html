<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">XSS姿势——文件上传XSS</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">Zeroyu</a> <span class="bull">·</span> <time title="2016/04/15 10:14" ui-time="" datetime="2016/04/15 10:14" class="published ng-binding ng-isolate-scope">2016/04/15 10:14</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p>原文链接：<a href="http://brutelogic.com.br/blog/">http://brutelogic.com.br/blog/</a></p><h1>0x01 简单介绍</h1><hr><p>一个文件上传点是执行XSS应用程序的绝佳机会。很多网站都有用户权限上传个人资料图片的上传点，你有很多机会找到相关漏洞。如果碰巧是一个self XSS，你可以看看这篇文章。</p><h1>0x02 实例分析</h1><hr><p>首先基本上我们都可以找到类似下面的一个攻击入口点，我觉得这个并不难。</p><h3>姿势一：文件名方式</h3><p>文件名本身可能会反映在页面所以一个带有XSS命名的文件便可以起到攻击作用。</p><p><img alt="p1" img-src="efdf0dd13e8defd2facb0aa4c02d991ebfc1cf6d.jpg"></p><p>虽然我没有准备靶场，但是你可以选择在<a href="http://www.w3schools.com/jsref/tryit.asp?filename=tryjsref_fileupload_value">W3Schools</a>练习这种XSS 。</p><h3>姿势二：Metadata</h3><p>使用<a href="http://www.sno.phy.queensu.ca/~phil/exiftool/">exiftool</a>这个工具可以通过改变EXIF  metadata进而一定几率引起某处反射：</p><pre><code>#!bash
$ exiftool -field = XSS FILE
</code></pre><p>例如：</p><pre><code>#!bash
$ exiftool -Artist=’ “&gt;&lt;img src=1 onerror=alert(document.domain)&gt;’ brute.jpeg
</code></pre><p><img alt="p2" img-src="3fc86e67859d6541c30c25af07de48c8a3ab5ffa.jpg"></p><h3>姿势三：Content</h3><p>如果应用允许上传SVG格式的文件（其实就是一个图像类型的），那么带有以下content的文件可以被用来触发XSS：</p><pre><code>#!html
&lt;svg xmlns="http://www.w3.org/2000/svg" onload="alert(document.domain)"/&gt;
</code></pre><p>一个 PoC用来验证。你可以通过访问brutelogic.com.br/poc.svg看到效果</p><h3>姿势四：Source</h3><p>建立一个携带有JavaScript payload的GIF图像用作一个脚本的源。这对绕过CSP（内容安全策略）保护“script-src ‘self’”（即不允许使用示例的这种xss方式进行攻击<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>）是很有用的，但前提是我们能够成功地在相同的域注入，如下所示。</p><p><img alt="p3" img-src="5c262757d15d923ce2c3428b97aeae6dd63c859f.jpg"></p><p>要创建这样的图像需要这个作为content 和 name，并使用.gif扩展名：</p><pre><code>#!html
GIF89a/*&lt;svg/onload=alert(1)&gt;*/=alert(document.domain)//;
</code></pre><p>这个GIF的图片头——GIF89a，作为alert function的变量分配给alert function。但是他们之间，还有一个被标注的XSS变量用来防止图片被恢复为text/HTML MIME文件类型，因此只需发送一个对这个文件的请求payload 就可以被执行。</p><p>正如我们下面看到的，文件类unix命令和PHP函数中的exif_imagetype（）和getimagesize（）会将其识别为一个GIF文件。所以如果一个应用程序仅仅是使用这些方式验证是否是一个图像，那么该文件将可以上传成功（但可能在上传后被杀掉）。</p><p><img alt="p4" img-src="8b723d6907c1bed14c38a607127044b04f47cf6a.jpg"></p><h1>0x03 最后</h1><hr><p>如果你想知道更多的有其标志性ASCII字符可以用于一个javascript变量赋值的文件类型，看我随后的文章。</p><p>也有很多比较详细的使用XSS和图像文件相结合绕过图形处理函数库过滤的例子。这方面的一个很好的例子是<a href="https://github.com/d0lph1n98/Defeating-PHP-GD-imagecreatefromgif">here</a></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Zeroyu</span> <span class="reply-time">2016-05-05 21:27:10</span></div><p></p><p>@aaa 都是大脑洞</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Zeroyu</span> <span class="reply-time">2016-05-05 21:26:42</span></div><p></p><p>@Kevini 呃？有吗？习惯这样写了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">smarttang</span> <span class="reply-time">2016-05-02 15:55:37</span></div><p></p><p>真心牛逼。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Zeroyu</span> <span class="reply-time">2016-04-23 15:44:52</span></div><p></p><p>https://en.wikipedia.org/wiki/List_of_file_signatures<br>文件签名</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">dafeng</span> <span class="reply-time">2016-04-17 16:13:02</span></div><p></p><p>总结的不错</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Kevini</span> <span class="reply-time">2016-04-17 16:11:46</span></div><p></p><p>标题反了吧</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">aaa</span> <span class="reply-time">2016-04-17 13:48:53</span></div><p></p><p>记得有一年的iscc的题目就是图片exif里写一个xss。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Explo1t</span> <span class="reply-time">2016-04-15 21:07:34</span></div><p></p><p>脑洞嗷嗷嗷嗷嗷</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xiao</span> <span class="reply-time">2016-04-15 16:08:18</span></div><p></p><p>好水啊......</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">浅唱青春伤</span> <span class="weibo"></span> <span class="reply-time">2016-04-15 13:23:01</span></div><p></p><p>没看明白这篇文章跟self xss有什么关系</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Sinyu1012</span> <span class="weibo"></span> <span class="reply-time">2016-04-15 12:56:25</span></div><p></p><p>mark</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Mfweb</span> <span class="weibo"></span> <span class="reply-time">2016-04-15 11:13:41</span></div><p></p><p>mark</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Zeroyu</span> <span class="reply-time">2016-04-15 11:01:29</span></div><p></p><p>@range 捕捉一只ran牛</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">会飞的小丁诶</span> <span class="weibo"></span> <span class="reply-time">2016-04-15 10:36:33</span></div><p></p><p>mark</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">默之</span> <span class="reply-time">2016-04-15 10:32:13</span></div><p></p><p>脑洞大开</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">range</span> <span class="reply-time">2016-04-15 10:29:54</span></div><p></p><p>牛逼</p><p></p></div></div></div></div></div></main>