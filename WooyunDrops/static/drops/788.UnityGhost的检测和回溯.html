<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">UnityGhost的检测和回溯</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">百度安全攻防实验室</a> <span class="bull">·</span> <time title="2015/09/23 15:45" ui-time="" datetime="2015/09/23 15:45" class="published ng-binding ng-isolate-scope">2015/09/23 15:45</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x01 问题描述和速查方法</h1><hr><p>此次XcodeGhost病毒并不仅仅只篡改Xcode的dmg安装文件，百度安全实验室发现Unity3D也同样被插入了恶意代码。Unity是由Unity Technologies开发的用于创建诸如三维视频游戏、实时三维动画等类型互动内容的多平台的综合型游戏开发工具，Unity可发布游戏至Windows、OS X、Wii、iPhone、Windows phone 8和Android平台。但目前安全实验室搜集到的样本只有感染iOS app，还未发现感染安卓或是Windows平台代码</p><p>目前我们观察到Unity OS X平台和Windows平台的安装包版本4.x至5.1.x（范围可能更大）, 64/32位版本均有被修改的现象，被修改后文件均没有数字签名，在文件安装前可以很容易的区分开，对于OS X下dmg文件中包含的pkg文件，可以使用 pkgutil –check-signature Unity.pkg来进行检查。这里附上Windows和OS X下正确版本数字签名校验的截图：</p><p><img alt="" img-src="ca4fe4084a807d79e04f5fb90665b3695180cfe8.jpg"></p><p><img alt="" img-src="72ec5b39edcf31644042b7386250dfe75bc41575.jpg"></p><p>病毒作者修改了<code>libiPhone-lib-il2cpp.a</code>文件, 在其中增加了<code>libiPhone-lib-il2cpp.a-arch-masterx.x.o</code>，其中arch为具体的架构名，并修改了project.pbxproj的配置信息。<code>libiPhone-lib-il2cpp.a</code>在 mac平台下位于<code>./Unity/Unity.app/Contents/PlaybackEngines/iossupport/Trampoline/Libraries/ libiPhone-lib-il2cpp.a</code>，windows平台上的路径为：<code>Unity/Editor/Data/PlaybackEngines/iossupport/Trampoline/Libraries/libiPhone-lib-il2cpp.a</code>。</p><p>快速自查方法：由于.a是复合的archive文件，解压比较麻烦，可以直接检查<code>./iossupport/Trampoline/Unity-iPhone.xcodeproj/project.pbxproj</code>中，是否含有”-ObjC”字符串，如果有则属于被感染版本。下图左侧为受感染文件，右侧为正常文件。</p><p><img alt="" img-src="a762890a5729e48777936c0a65d86b20222cfd91.jpg"></p><h1>0x02 代码逻辑</h1><hr><p>整体来说，Unity上受感染的恶意代码行为和XcodeGhost行为基本一致，更详细的信息可参看之前<a href="http://drops.wooyun.org/papers/9024">关于XcodeGhost分析</a>。通过这些分析，可以见到，恶意代码作者有着很强的躲避检测的动机。下图是OS X平台上的一个受感染文件<code>libiPhone-lib-il2cpp.a-armv7-master.o</code>。</p><p><img alt="" img-src="b8a3d91cb046138986fca4ceba3c229099fe442f.jpg"></p><h1>0x03制作时间</h1><hr><p>通过对于恶意DMG和官方DMG中的文件信息，我们能够非常清楚的看到恶意代码作者进行打包修改文件的时间，以<code>unity-4.6.6.dmg</code>为例：</p><p><img alt="" img-src="3780b71b106f14a1b5098f4626f5d733c26800cf.jpg"></p><p>可以看出，UnityGhost作者在今年6月29日下午进行的修改操作。</p><p>下面是我们搜集到的官方发布版本和样本篡改时间的时间轴：</p><p><img alt="" img-src="9b0288bb244a4afe59e04bfbaa45db418a1cd9f5.jpg"></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/9024" rel="bookmark" id="re1">你以为服务器关了这事就结束了？ - XcodeGhost截胡攻击和服务端的复现，以及UnityGhost预警</a></li><li><a href="http://drops.wooyun.org/web/5282" rel="bookmark" id="re2">分析WordPress中esc_sql函数引起的注入危害</a></li><li><a href="http://drops.wooyun.org/tips/2460" rel="bookmark" id="re3">用Burpsuite 来处理csrf token</a></li><li><a href="http://drops.wooyun.org/papers/10047" rel="bookmark" id="re4">有米iOS恶意SDK分析</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"></div></div></div></main>