<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">用Nginx分流绕开Github反爬机制</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">携程信息安全部</a> <span class="bull">·</span> <time title="2016/03/10 10:30" ui-time="" datetime="2016/03/10 10:30" class="published ng-binding ng-isolate-scope">2016/03/10 10:30</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 前言</h1><hr><p>如果哪天有hacker进入到了公司内网为所欲为，你一定激动地以为这是一次蓄谋已久的APT，事实上，还有可能只是某位粗线条的员工把VPN信息泄露在了Github上恰巧被一个好奇的计算机junior发现了而已。</p><h1>0x01 意识缺失</h1><hr><p>先贴张图：</p><p><img alt="p1" img-src="f8dddff57881d375d60b8d740ccc3b47973838e7.jpg"></p><blockquote><p>有记者给溧阳卫生局局长拨通电话，该局长面对记者的采访慌张答道：<br>“你看到我们发微博的啊？呵呵，你怎么看到的啊？这个都能看得到啊？！这不可能吧？我们两个发微博你都能看得到啊？不可能吧？”……</p></blockquote><p>同样，互联网企业的员工流动性很强，各自的安全（隐私）意识也参差补齐。庞大的企业难免有些人由于无知或由于偷懒把含有敏感信息（如数据库连接串，邮箱账号，VPN信息）的代码直接丢到github上去。如果这些信息被有心人看到了，那就能让黑客花最小的成本，达到APT的效果了。</p><p>另附一篇漏洞盒子关于github泄露企业机密信息的报告：<br><a href="https://www.vulbox.com/news/detail-15">https://www.vulbox.com/news/detail-15</a></p><h1>0x02 反爬机制</h1><hr><p>于是，我们想实现github代码的监控，定制诸多关键词如password，mysql，account，email，希望通过爬虫程序来实现对github上敏感代码的监控，如果有可疑信息泄露，程序通过邮件通知负责人，负责人去进行二次人工审核。这样，能在第一时间发现敏感代码的泄露，并及时联系提交者进行处理。</p><p>期望是美好的，但是在连续高频访问若干次github.com之后：</p><p><img alt="p2" img-src="c907a7653beec50b9424dce0b83e7c75c254d026.jpg"></p><p>触发了github的反爬机制，难道项目要流产？</p><h1>0x03 绕开</h1><hr><p>机智的楼主想起之前团队购买了5台阿里云机器，何不用阿里云机器搭建一套代理实现分IP访问绕开反爬机制？</p><p>于是就有了下图。</p><p><img alt="p3" img-src="ca6bdede337b6917c367bbca915a37a003859e55.jpg"></p><p>一次敏感代码爬取的流程：</p><ol><li>Github爬虫引擎发起一次爬虫请求</li><li><p>请求发送到负载均衡Nginx，Nginx将请求按照同权重的方式转发到流量转发Nginx</p><p><strong>注：负载均衡Nginx设置为两台，防止出现单点故障。</strong></p></li><li><p>收到负载均衡Nginx发过来的流量，流量转发Nginx将请求转想github.com</p></li><li><p>github.com返回的内容通过Nginx原路返回给Github爬虫引擎</p></li></ol><p>这样，对于github.com而言，他看到的是三台机器在一样频率的交替访问，频率是原先的1/3，巧的是，这个频率就不会触发反爬机制。从而实现了Github爬虫引擎的连续访问，效率大大提升。</p><p>同时，这套方案的扩展性还很强，如果再次被github.com反爬机制封锁，可以通过平行加流量转发Nginx机器的方式来实现水平扩展。</p><p>附负载均衡Nginx的核心配置：</p><p><img alt="p4" img-src="34a1ea4a338fac4233ea21378a7d924f03ee6be9.jpg"></p><p>附流量转发Nginx的核心配置：</p><p><img alt="p5" img-src="a97bc5336ae70116f999fffcd9bc4dbc2c94af83.jpg"></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/4605" rel="bookmark" id="re1">SQL Injection via DNS</a></li><li><a href="http://drops.wooyun.org/tips/2736" rel="bookmark" id="re2">Samsung S Voice attack</a></li><li><a href="http://drops.wooyun.org/tips/3029" rel="bookmark" id="re3">fail2ban防暴力破解介绍使用</a></li><li><a href="http://drops.wooyun.org/tips/8242" rel="bookmark" id="re4">SQL注入速查表（下）与Oracle注入速查表</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">我笑了</span> <span class="reply-time">2016-03-25 17:13:46</span></div><p></p><p>去爬点免费代理完全可以绕过这种反爬机制</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">我笑了</span> <span class="reply-time">2016-03-25 17:12:56</span></div><p></p><p>这个防爬策略也是蛋疼</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">llc</span> <span class="reply-time">2016-03-11 15:10:48</span></div><p></p><p>github有api</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">爱捣蛋的鬼</span> <span class="reply-time">2016-03-10 15:18:37</span></div><p></p><p>你就找你们公司自己的关键词就行了啊，做爬虫，居心何在~~</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">科科</span> <span class="reply-time">2016-03-10 14:56:34</span></div><p></p><p>真好（xxx）文章</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">black</span> <span class="reply-time">2016-03-10 12:47:13</span></div><p></p><p>这广告打的，我给1分～</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">NULL</span> <span class="reply-time">2016-03-10 12:19:36</span></div><p></p><p>我说访问github咋这么慢，原来是你们这群人不停的在用爬虫爬。。。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">路过泸沽</span> <span class="reply-time">2016-03-10 11:18:36</span></div><p></p><p>这种行为算什么呢呢？、<br>又没技术含量有没公德<br>太low了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">testtest</span> <span class="reply-time">2016-03-10 11:18:30</span></div><p></p><p>不就是个Nginx的负载均衡么？</p><p></p></div></div></div></div></div></main>