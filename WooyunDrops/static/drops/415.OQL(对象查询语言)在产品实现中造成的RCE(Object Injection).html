<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">OQL(对象查询语言)在产品实现中造成的RCE(Object Injection)</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">Nebula</a> <span class="bull">·</span> <time title="2014/12/02 9:09" ui-time="" datetime="2014/12/02 9:09" class="published ng-binding ng-isolate-scope">2014/12/02 9:09</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h1>0x00 前言</h1><hr><p>前几天,有几个屌丝高帅富给我看一个这样的漏洞类型:</p><p>地址:http://blog.emaze.net/2014/11/gemfire-from-oqli-to-rce-through.html</p><p>GemFire内存数据库是来自云计算公司Pivotal(未来我最看好的云计算产品提供商,由EMC、VMware、通用电气这三家公司合资等方式组成,这里有我们熟悉Spring技术团队支撑的就是这家公司云计算前端开发框架)的产品.</p><h1>0x01 内存数据库基础</h1><hr><p>那什么是内存数据库,为什么需要它?给大家举个简单的例子:</p><p>在百度中搜索: GemFire,排在第5位的结果就是我们的答案</p><p><img alt="enter image description here" img-src="cfa5fcb1692cfdcf8eee395d7d93bc48a7ca05b4.jpg"></p><p>我们知道中国是个人口大国,由于地域经济差异大,外出打工挣钱的人特别多.逢年过节买火车票一直有个头痛的问题,就是关键时候这个网站就打不开了.无论它体验及性能有多烂,我们还是要去上它,因为要回家(这是刚需),随着国人网上预订越来越多,存在并发访问量爆表的问题,庆幸的是它一直在通过技术手段解决这个问题.</p><p>并发访问与数据库技术的演变简单描述可能是:开始使用关系数据库,如:Oracle,并发量大会挂;然后使用数据在内存做缓存，如：memcached (因为读写内存要比读写硬盘快很多,可极大提升访问性能),还是有性能问题;所有后来就干脆使用云计算数据库解决产品GemFire（充当一下国外新产品的小白鼠）,不知道今年过年买票能否不挂?拭目以待!</p><p>但GemFire内存数据库在数据存储中并非简单的字符串,如:"123456"；而是Java对象，所以它也是个对象数据库，比如：我们在J2ME开发中使用的DB4o也是。学过J2EE持久层框架的人都知道,如: Hibernate; ibatis等,就是把关系数据库中的每张表映射到内存中(ORM,表的字段对应内存中Java对象的属性),另外还有一个特点,Java对象中可以放更为复杂的对象结构(如:迭代对象,数据集合).再进行数据传输操作,就非常方便了,抛弃传统关系数据库操作概念.而GemFire内存数据库支持更为强大的对象操作API,OQL(Object Query Language)</p><p>那什么是OQL?百度就简单几句话,大家很难理解:</p><p>http://baike.baidu.com/view/2554236.htm?fr=aladdin</p><p>这里举个例子就清晰了:它类似SQL</p><p>如，sql查询表user的字段name为test的数据，sql语句是：</p><blockquote><p>sql ="select * from where name ='test' ";</p></blockquote><p>而oql可能就是这样：</p><blockquote><p>oql=" select referrers(u) from xxx.xxx.User u where u.name = 'test' ";</p></blockquote><p>这里简单解释一下语法及语义：xxx.xxx为对象包路径，在返回引用对象xxx.xxx.User中name对象为test的引用对象。是不是更为强大？OQL还有更多更为强大的API.</p><p>而形成的新漏洞类型对比SQL注入漏洞就更好理解了，sql注入是外部参数污染sql语句，OQL注入是外部参数污染oql语句。这里更要命的是oql语句是支持java代码语义及语法解析的（可以理解为我们之前熟悉的OGNL表达式注入），所以这个漏洞类型为：OQL注入漏洞（Object Injection），最大的利用就是远程代码执行，最大危害就是执行系统命令了。</p><h1>0x02 实例分析</h1><hr><p>说了这么多，大家肯定会说给个例子吧,别光YY! 我们知道学习技术也是要成本的，GemFire内存数据库，对于我这样的穷人现在是用不起的！但不影响我们去学习OQL这门对象查询语言。</p><p>它其实就在我们的JDK中：</p><p>首先，我们启动任何一个Java程序，我这里是个Tomcat,再找到它的PID,如图：</p><p><img alt="enter image description here" img-src="94b9ea3eb9a0e51ad4902564aef2c0c266191f76.jpg"></p><p>然后使用jmap命令生成堆转储快照，如图：</p><p><img alt="enter image description here" img-src="5f4783210821a7adf0320886ce8ac24693a8ff5f.jpg"></p><p>然后使用堆分析命令jhat,它是个http服务，默认端口7000，如图：</p><p><img alt="enter image description here" img-src="48297ed5054c3d13c4bc4971bdeaa4a24faea029.jpg"></p><p>我们就可以使用浏览器查看堆信息了，它还提供我们前面需要的OQL查询功能，如图：</p><p><img alt="enter image description here" img-src="a83f243be0a2e3fc0e665150693a2449979867ae.jpg"></p><p>查询长度大于100的字符串：</p><p><img alt="enter image description here" img-src="29729adf9719b98b9055f5e29d88ea3efd8ac5d7.jpg"></p><p>Java代码执行系统命令也不需要老外说的那么复杂，还使用反射？（当然，看语句拼接情况）：</p><p><img alt="enter image description here" img-src="9f9367ebf87b1a24832d5dfe1aff30914cc78c3a.jpg"></p><p><img alt="enter image description here" img-src="0574e0736a0b7e9a0ff3fed3eb9ff0e4235a6231.jpg"></p><p>未来使用对象数据库会越来越多，而漏洞类型已经不是我们之前熟悉的SQL注入漏洞了，而是OQL注入，危害就更为严重了(不仅限于Java)。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/20141029134414dab631e232f29abd6908a1eacf4f6ae3.png" style="width:200px;height:200px"></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小飞</span> <span class="reply-time">2014-12-03 17:51:08</span></div><p></p><p>内存数据库<br>我就是16G内存土豪</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">子墨</span> <span class="reply-time">2014-12-03 08:28:43</span></div><p></p><p>长见识了！！</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">nk_z</span> <span class="reply-time">2014-12-02 22:43:42</span></div><p></p><p>大牛 收下我膝盖吧</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">园长</span> <span class="reply-time">2014-12-02 22:04:18</span></div><p></p><p>你不说不搞么？知道怎么注入才能和土豪做朋友啊。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">r00tgrok</span> <span class="reply-time">2014-12-02 22:01:58</span></div><p></p><p>沙发，长见识</p><p></p></div></div></div></div></div></main>