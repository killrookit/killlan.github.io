<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Rsync安全配置</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">瞌睡龙</a> <span class="bull">·</span> <time title="2013/07/08 18:58" ui-time="" datetime="2013/07/08 18:58" class="published ng-binding ng-isolate-scope">2013/07/08 18:58</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h3>0x00 Rsync简介</h3><hr><p>Rsync，remote synchronize顾名思意就知道它是一款实现远程同步功能的软件，它在同步文件的同时，可以保持原来文件的权限、时间、软硬链接等附加信息。</p><p>rsync是用 “rsync 算法”提供了一个客户机和远程文件服务器的文件同步的快速方法，而且可以通过ssh方式来传输文件，这样其保密性也非常好，另外它还是免费的软件。</p><p>rsync 包括如下的一些特性：</p><pre><code>能更新整个目录和树和文件系统；
有选择性的保持符号链链、硬链接、文件属于、权限、设备以及时间等；
对于安装来说，无任何特殊权限要求；
对于多个文件来说，内部流水线减少文件等待的延时；
能用rsh、ssh 或直接端口做为传输入端口；
支持匿名rsync 同步文件，是理想的镜像工具；
</code></pre><h3>0x01 架设Rsync服务器</h3><hr><p>安装Rsync与xinetd包</p><pre><code>$ yum -y install xinetd rsync
</code></pre><p>确保xinetd运行在levels 3或4或5。</p><pre><code>$ chkconfig --level 345 xinetd on
</code></pre><p>修改rsync xinetd配置文件，把<code>disable = yes</code>改成<code>disable = no</code></p><pre><code>$ vi /etc/xinetd.d/rsync
</code></pre><p>创建rsync的密码文件，格式 <code>username:password</code></p><pre><code>$ vi /etc/rsyncd.secrets
</code></pre><p>创建rsync共享配置文件</p><pre><code>$ vi /etc/rsyncd.conf
</code></pre><p>添加如下内容：</p><pre><code>secrets file = /etc/rsyncd.secrets #密码文件位置，认证文件设置，设置用户名和密码
#motd file = /etc/rsyncd.motd #欢迎信息文件名称和存放位置（此文件没有，可以自行添加）
read only = no # yes只读 值为NO意思为可读可写模式，数据恢复用NO
list = yes
uid = nobody #以什么身份运行rsync
gid = nobody

[out]  #模块名
comment = Welcome #欢迎信息
path = /home/rsync/out #rsync同步的路径
auth users = rsync #授权帐号,认证的用户名，如果没有这行则表明是匿名，多个用户用,分隔。
hosts allow = X.X.X.X #允许访问的IP
auth users = username #/etc/rsyncd.secrets中的用户名
</code></pre><p>还有很多参数没有使用。</p><p><a href="http://www.samba.org/ftp/rsync/rsyncd.conf.html">http://www.samba.org/ftp/rsync/rsyncd.conf.html</a>里详细解释了rsyncd.conf各个参数的意思。</p><p>修改权限与所有权，重启xinetd服务：</p><pre><code>$ chown root.root /etc/rsyncd.*
$ chmod 600 /etc/rsyncd.*
$ service xinetd restart
</code></pre><p>然后就可以通过如下命令访问了：</p><p>下载文件： ./rsync -vzrtopg --progress --delete <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="ec999f899e828d8189ac949494c2949494c2949494c2949494">[email&#160;protected]</a>::out /home/test/getfile</p><p>上传文件： /usr/bin/rsync -vzrtopg --progress /home/test/getfile <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="f78284928599969a92b78f8f8fd98f8f8fd98f8f8fd98f8f8f">[email&#160;protected]</a>::out</p><p>Rsync 同步参数说明</p><pre><code>-vzrtopg里的v是verbose，z是压缩，r是recursive，topg都是保持文件原有属性如属主、时间的参数。
--progress是指显示出详细的进度情况
--delete参数会把原有getfile目录下的文件删除以保持客户端和服务器端文件系统完全一致
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="f98c8a9c8b9798949cb9818181d7818181d7818181d78181811d41541e637d8c8a9c8b9798949c1f61561f757e1c57631c567f1e59781f6f7e1d424f1d41541e637d">[email&#160;protected]</a>用户名,xxx为ip地址
out是指在rsyncd.conf里定义的模块名
/home/test/getfile 是指本地要备份目录
</code></pre><p>如果不想每次都再输入一次密码可以使用<code>--password-file</code>参数</p><pre><code>/usr/bin/rsync -vzrtopg --progress /home/test/getfile  <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="22575147504c434f47625a5a5a0c5a5a5a0c5a5a5a0c5a5a5a">[email&#160;protected]</a>::out --password-file=/test/rsyncd.secrets
</code></pre><p>本机上的/test/rsyncd.secrets文件里只需要保存密码即可，用户名已经在命令中有了，并且权限应为600。</p><h3>0x02 匿名访问危害</h3><hr><p>wooyun出现不少没有限定任何ip并且允许匿名访问，而导致严重后果的实际案例：</p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2013-026232">WooYun: 我是如何沦陷ChinaZ下载站服务器的，可登录3389、篡改源码等</a></p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2013-021589">WooYun: 新浪漏洞系列第三弹-微博内网遭入侵</a></p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2012-010093">WooYun: Discuz旗下5d6d某服务器Rsync任意文件上传</a></p><h3>0x03 寻找匿名访问Rsync方式</h3><hr><p>Rsync默认的端口是873，可以使用nmap扫描哪些ip开放了873端口。</p><pre><code>nmap -n --open -p 873 X.X.X.X/24
</code></pre><p>找到开放的873端口后，连接能否查看模块名：</p><pre><code>rsync X.X.X.X::
</code></pre><p>如果可以，就尝试上传，下载文件试一下。</p><h3>0x04 安全配置注意事项</h3><hr><p>注意两种方式防御，一是限定访问的IP，另一个是不允许匿名访问，添加用户口令。</p><h4>限定IP的两种方式</h4><p>IPTables防火墙</p><p>给rsync的端口添加一个iptables。</p><p>只希望能够从内部网络（192.168.101.0/24）访问：</p><pre><code>iptables -A INPUT -i eth0 -p tcp -s 192.168.101.0/24 --dport 873 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 873 -m state --state ESTABLISHED -j ACCEPT
</code></pre><p>除此之外rsyncd.conf中的<code>hosts allow</code>也可以设置只允许来源ip。</p><pre><code>hosts allow = X.X.X.X #允许访问的IP
</code></pre><h4>添加用户口令</h4><p>添加rsync用户权限访问，注意配置的是rsyncd.conf中的：</p><pre><code>secrets file = /etc/rsyncd.secrets #密码文件位置，认证文件设置，设置用户名和密码
auth users = rsync #授权帐号,认证的用户名，如果没有这行则表明是匿名，多个用户用,分隔。
</code></pre><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/20141017203549ef27b55a7921e022214b5780c48f81e0.png" style="width:200px;height:200px"></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/12173" rel="bookmark" id="re1">OpenSSH CVE-2016-0777私钥窃取技术分析</a></li><li><a href="http://drops.wooyun.org/web/5410" rel="bookmark" id="re2">XML安全之Web Services</a></li><li><a href="http://drops.wooyun.org/tips/7358" rel="bookmark" id="re3">在远程系统上执行程序的技术整理</a></li><li><a href="http://drops.wooyun.org/web/11861" rel="bookmark" id="re4">Web应用隐形后门的设计与实现</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">情痴</span> <span class="reply-time">2016-02-21 21:54:58</span></div><p></p><p>谢谢分享，学习了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Mark0smith</span> <span class="reply-time">2015-09-13 17:34:58</span></div><p></p><p>话说瞌睡龙大大的nmap用的好熟练啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Mark0smith</span> <span class="reply-time">2015-09-13 17:21:28</span></div><p></p><p>这个不配置好的话，很吓人啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">__Happy</span> <span class="reply-time">2015-02-03 10:10:15</span></div><p></p><p><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="03716c6c77434b6273737a">[email&#160;protected]</a>:~# rsync x.x.x.x::~~~<br>drwxr-xr-x 4096 2014/09/29 16:14:33 .<br>-rw-r--r-- 41 2014/09/29 16:14:33 2222<br>-rw-r--r-- 27781951 2014/09/29 16:01:01 1<br>我可以直接读取 2222 中的内容吗？还有，<br>./rsync -vzrtopg --progress --delete <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="bdc8ced8cfd3dcd0d8fdc5c5c593c5c5c593c5c5c593c5c5c5">[email&#160;protected]</a>::out /home/test/getfile<br>我要把我要下载的文件名加在哪里呢？<br>谢谢了，求解</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">__Happy</span> <span class="reply-time">2015-02-02 14:02:33</span></div><p></p><p>rsync -av xxx.xxx.xxx.xxx::<br>www public archive<br>这是我利用时出现的状况，ip以用xxx代替了，我没理解下面出现的www 和 p.....是什么意思！<br>然后我试了试下载，依然失败！！<br>能在具体点么？小白，谢谢大牛了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">_Evil</span> <span class="reply-time">2015-01-28 18:45:27</span></div><p></p><p>you dian yi si</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瞌睡龙</span> <span class="reply-time">2014-12-30 18:01:38</span></div><p></p><p>参考 http://zone.wooyun.org/content/12799</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">酷帥王子</span> <span class="reply-time">2014-12-30 17:11:47</span></div><p></p><p>楼主，我有个例子不能列出模块名是不是不允许匿名登陆呢<br>如果不允许还有什么思路呢，有没有rsync的默认账号和密码呢，我看文章说有个test rsync的账号密码，也不知道如何用账号密码登陆呢，还有有没有办法暴力破解呢，求您给个思路</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">wangy3e</span> <span class="reply-time">2014-03-25 16:47:34</span></div><p></p><p>very nice</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">jaojan</span> <span class="reply-time">2013-12-12 12:09:31</span></div><p></p><p>nice</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">神倦懒言</span> <span class="reply-time">2013-07-14 22:36:33</span></div><p></p><p>这个在生产环境下有必要定时开启同步和定时杀掉进程</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">园长</span> <span class="reply-time">2013-07-09 11:25:46</span></div><p></p><p>他开挂了.....</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小胖胖要减肥</span> <span class="reply-time">2013-07-09 00:28:44</span></div><p></p><p>龙哥真是什么都懂啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">nyannyannyan</span> <span class="reply-time">2013-07-08 19:01:55</span></div><p></p><p>拿来做简单的双机热备也不错</p><p></p></div></div></div></div></div></main>