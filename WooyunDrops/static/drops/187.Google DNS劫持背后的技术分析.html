<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">Google DNS劫持背后的技术分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">insight-labs</a> <span class="bull">·</span> <time title="2014/03/18 15:58" ui-time="" datetime="2014/03/18 15:58" class="published ng-binding ng-isolate-scope">2014/03/18 15:58</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 背景</h2><hr><p>最近世界真是越来越不太平了，尤其是对于大部分普通人而言。昨天又传来噩耗，根据网络监测公司BGPMon，Google的公开DNS服务器 IP 8.8.8.8被劫持到了委内瑞拉和巴西超过22分钟。</p><p>Google DNS 服务器平均每天处理超过1500亿个查询，在被劫持的22分钟里起码几百万个查询包括金融系统，政府和个大商业网站的DNS查询流量都被劫持走了。</p><p><img alt="enter image description here" img-src="eaace8de677fbf8745d0e25a67ea15c7fc7835bd.jpg"></p><p>根据砖家们的推测，这次劫持可能是黑客利用了Border Gateway Protocol(BGP) 协议中一个众所周知的漏洞来实现的，BGP协议为ISP级的路由协议，一般用来协调大型ISP之间的路由走向。这次劫持可以让黑客把网上的部分流量劫持从而经过他们所控制的路由。</p><p><img alt="enter image description here" img-src="cd7c5c80df6bb1ca44b86d28ce44d2b3620e51ca.jpg"></p><p>这已经不是Google DNS服务器被第一次劫持了，在2010年也Google DNS的流量也曾经被劫持到了罗马尼亚和奥地利境内。</p><p>BGP劫持攻击是一种大规模的中间人攻击，并且较难发现，因为数据包的最终目的地并没有变，只是绕了下路而已。</p><h2>0x01 BGP劫持详解</h2><hr><p>本部分来源于Tony Kapela 和 Alex Pilosov在2008年 Defcon会议上的演讲。</p><h3>什么是BGP</h3><p>首先互联网整体上来说是一个分布式的网络，并没有整个网络的中心。但是整个互联网实际上是由成百上千个不同的ISP的子网络组成的。</p><p>这些子网络互相连接，通过BGP协议告诉对方自己子网络里都包括哪些IP地址段，自己的AS编号（AS Number）以及一些其他的信息。</p><p>这里又要扯到互联网的IP地址分配方式。互联网的IP地址分配是中心化的，ICANN这个机构把IP地址大段分给Regional Internet Registries（RIR），区域互联网注册管理机构。RIR再把IP地址段细分后分给ISP们。</p><p>大部分情况下，AS Number和分给该AS什么IP段是没有任何关系的。</p><p>下面问题来了，BGP协议里虽然有一些简单的安全认证的部分，但是对于两个已经成功建立BGP连接的AS来说，基本会无条件的相信对方AS所传来的信息，包括对方声称所拥有的IP地址范围。</p><p>对于ISP分配给大公司客户的地址段，ISP往往会对BGP做一些有限的过滤。但是对于大型ISP来说，因为对方所拥有的IP地址段可能过于分散，所以一般是按最大范围设置BGP prefix 地址过滤。比如假设ISP A拥有地址段20.1.0.0/16和20.200.0.0/16，那么ISP B可能会设置过滤对方传来的20.0.0.0/8以外的路由。</p><p>当然这种情况比较极端，一般ISP分配到的IP地址段都是连续的，但是基本也都有可操作的空间，可以把数百到几万个不属于自己的IP合法加到自己的BGP信息里。</p><p>多数ISP甚至都没有把自己本身的IP段过滤掉，也就是说如果其他AS声称拥有该ISP自己的IP段，这个ISP的BGP路由也会相信。</p><p>为了解决这个问题，有人发明了一个叫Internet Routing Registry (IRR)的东西，相当于一个开放式的数据库，像DNS 根服务器一样采用分布式镜像服务器放在世界各地。</p><p>ISP可以向IRR注册自己的IP地址段和路由策略，其他ISP就可以查询IRR从而对自己的BGP路由器做过滤。这样做的确防止了一些由于无意而导致的路由劫持。</p><p>但是IRR这个东西本身也是不靠谱的。IRR里存了大约10万条记录，如果全部加载进路由器的话是个不小的负担。另外IRR基本没人管，任何人可以可以往里面注册任何路由记录。</p><p>所以在大部分ISP都无条件相信IRR的时代，IRR也带来了不少的麻烦。</p><p>最简单的方式就是通过Whois找到目标IP段的 管理员邮箱，如果该邮箱或者邮箱所在的域名已经过期，那么就自己注册一个，然后就可以随便通过邮件向IRR修改记录了。</p><p>或者直接通过BGP路由向ISP发送，反正大家都不care……</p><h3>实际案例</h3><p>现在我们来看一个Youtube被劫持的案例:</p><p>youtube有5个网段，其中一个是</p><pre><code>208.65.152.0/22  
</code></pre><p>因为觉得Youtube不和谐，于是巴基斯坦政府决定封锁Youtube。</p><p>巴基斯坦电信在路由器上加了条static route把</p><pre><code>208.65.153.0/24
</code></pre><p>弄到了null0接口（GFW之黑洞路由大法）</p><p>巴电信的工程师手抖把static route redistribute到BGP了(Cisco路由器上同步不同协议路由表的方法)，也就是说把该路由器上的静态路由表添加到BGP的路由表了，静态路由同步到其他路由表里的优先值最高。</p><p>BGP把这条路由向其他AS的路由器同步了，最先中枪的是香港的电讯盈科（PCCW），然后接着被逐渐同步到了全世界。</p><p>这时互联网的大部分用户想上Youtube的时候数据包都跑到巴基斯坦了，结果当然是打不开了（因为进来就被弄到null0了）。</p><p>Youtube发现后重新用BGP声明了对该IP段和其他IP段的所有权，成功刷新了部分ISP路由器的路由表。</p><p>两小时后PCCW断开了和巴基斯坦电信路由器的BGP连接。3-5分钟后，一切恢复正常，除了苦逼的巴基斯坦用户们。</p><p>这意味着只要控制了任何一个ISP的任何一个BGP路由，都将具备影响全世界互联网的能力。</p><p>BGP劫持很难被发现，如果不是因为巴基斯坦电信把youtube的IP段转发到了null0接口，数据包就只会在巴基斯坦网络里绕一圈然后再到达Youtube。</p><p>如果攻击者的路由器具备篡改TTL的功能，那么即使通过traceroute也很难发现数据包被劫持，唯一的方法就是像前面所说的BGPmon那样检测全世界范围内的AS路由表和BGP信息。</p><h3>BGP劫持理论</h3><p>当我们控制了ISP的BGP路由后，像平常一样发送路由信息。通过修改AS Path等BGP信息，让其他AS认为你到目标网络的距离最短。</p><p>为了让回来的数据包也经过你的路由器，你需要记录trace route到目标网络的时候都会经过哪些AS。</p><p>使用AS-PATH prepend list包括这些AS Number</p><p>设置static route到traceroute出现的第一个ASN</p><h4>详解：</h4><p>目标IP段</p><pre><code>10.10.220.0/22
</code></pre><p>在AS 200中<br>ASN 200向相邻的AS 20和30发送BGP通告。<br>此时为正常的状态。</p><p><img alt="2014031815415353677.png" img-src="fec958ccaac296e935e43369bbcb95f6c8cce3f9.jpg"></p><p>攻击者控制了AS 100的BGP路由。</p><p>AS 100的路由表和BGP表显示到达</p><pre><code>10.10.200.0/22
</code></pre><p>需要经过 AS 10.</p><p>于是我们把AS10，20和200加入我们的AS PATH prepend list</p><p><img alt="2014031815423285580.png" img-src="7f40577604459a6af54da3351396ecda256428cf.jpg"></p><p>通过route-map把目标IP段加入BGP路由表</p><pre><code>10.10.220.0/24 is announced with a route-map:  
route-map hijacked permit 10  
match ip address prefix-list jacked  
set as-path prepend 10 20 200  
</code></pre><p>然后在AS100的路由器中加入static route，把流向目标IP段的数据包指向AS10</p><pre><code>ip route 10.10.220.0 255.255.255.0 4.3.2.1 
</code></pre><p><img alt="2014031815431276804.png" img-src="d6a19a966a896f56345b0606240efb6b1df9edfa.jpg"></p><p>完成后可以看出，AS30 40 50 60的数据包如果想要到AS 200去，都会先经过AS 100.</p><p>到了这里我们已经可以分析出，BGP劫持的本质再次回到安全的本质既是信任这一点，因为BGP直接无条件信任对方AS发来的路由信息，并且缺乏有效的认证和过滤手段，导致BGP劫持屡次得手。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/974" rel="bookmark" id="re1">Google Chrome 开发者工具漏洞利用</a></li><li><a href="http://drops.wooyun.org/tips/2976" rel="bookmark" id="re2">Denial of App - Google Bug 13416059 分析</a></li><li><a href="http://drops.wooyun.org/papers/12645" rel="bookmark" id="re3">中间人攻击 -- Cookie喷发</a></li><li><a href="http://drops.wooyun.org/mobile/11263" rel="bookmark" id="re4">Android WebView File域攻击杂谈</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">kickass</span> <span class="reply-time">2015-12-01 14:12:51</span></div><p></p><p>BGP劫持的理论很详细，但是没有说明google DNS劫持的原因，难道是运营商的失误？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">fireblue</span> <span class="reply-time">2014-12-23 21:50:07</span></div><p></p><p>学习了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Moses</span> <span class="reply-time">2014-06-28 16:12:29</span></div><p></p><p>所谓的巴基斯坦电信实际是中国电信吧...</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">小贱人</span> <span class="reply-time">2014-04-28 00:05:09</span></div><p></p><p>mark</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">insight-labs</span> <span class="reply-time">2014-03-20 06:56:45</span></div><p></p><p>208.65.152.0/22里面包括了208.65.153.0/24</p><p>巴基斯坦电信的工程师为了减少影响，故意没有封整个/22段而是从/22网段里面把那个/24挑出来封。</p><p>第二个问题是这样的：</p><p>BGP路由选择有一个优先值是基于网段的(Prefix)。如果同时有两个互相冲突的BGP路由路线，BGP会倾向于更加精确的网段/24而不是/22。所以当巴基斯坦把youtube的/24段加到BGP里的时候，优先值比原本的/22段高，所以BGP会发送路由更改通知到其他BGP peer，其他路由收到后发现也比他们的优先值高，就都改了。<br>后面那个10.10.220和200的地方可能是打错了？要劫持的话是需要把小的网段包括在大的网段里才能触发BGP更改的。</p><p>详细可以看这个：<br>http://www.renesys.com/2008/02/pakistan-hijacks-youtube-1/</p><p>第三个问题。<br>和第二个一样。<br>关于AS path prepend可以看这个<br>http://ciscodreamer.blogspot.com.au/2009/07/bgp-as-path-prepending.html</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">乌帽子</span> <span class="reply-time">2014-03-19 21:37:56</span></div><p></p><p>很吊的样子，实施这种流量劫持的中间人攻击，是不是要有BGP级路由权限以及大量DNS服务器群?</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">心伤的胖子</span> <span class="reply-time">2014-03-19 12:30:33</span></div><p></p><p>自建机房来做这个成本太高了吧，并且搞一次攻击之后还能不能搞下次的攻击都不好说啊。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">justdoit</span> <span class="reply-time">2014-03-19 12:20:29</span></div><p></p><p>有几点疑问，求解：</p><p>1. 208.65.152.0/22 和 208.65.153.0/24不在同一网段，怎么封</p><p>2. ASN/200 的网段既然是10.10.220.0/22,那为什么在AS 100的路由表和BGP表显示到达</p><p>10.10.200.0/22（与ASN/200不在同一网段）</p><p>需要经过 AS 10.</p><p>3. AS30这些怎么就信ASN/100的路由信息，而不信ASN/200的呢？这不有冲突吗？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">踏雁寻花</span> <span class="reply-time">2014-03-19 11:37:53</span></div><p></p><p>看不懂呢</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">独行猫儿</span> <span class="reply-time">2014-03-19 10:12:01</span></div><p></p><p>运营商耍流氓谁都挡不住的样子</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">1ee</span> <span class="reply-time">2014-03-18 23:16:01</span></div><p></p><p>学习了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">haha</span> <span class="reply-time">2014-03-18 21:02:14</span></div><p></p><p>自建机房</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">xsser</span> <span class="reply-time">2014-03-18 16:46:32</span></div><p></p><p>需要控制BGP路由器啊，这个成本不知道有多高</p><p></p></div></div></div></div></div></main>